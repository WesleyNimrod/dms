<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management Information System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tahoma:wght@400;700&display=swap');
    
        body {
            font-family: 'Tahoma', Geneva, sans-serif;
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow-x: hidden;
        }     
        .custom-btn {
            background: linear-gradient(135deg, #1A3A4A 0%, #3C063D 100%);
            transition: all 0.3s;
        }
        .custom-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .gradient-primary {
            background: linear-gradient(135deg, #1A3A4A 0%, #3C063D 100%);
        }
        
        .success-indicator {
            background: linear-gradient(135deg, #FFD1D1 0%, #59E3FF 100%);
            color: #333;
            padding: 8px 12px;
            border-radius: 4px;
            position: fixed;
            top: 20px;
            right: 20px;
            animation: fadeOut 2s forwards;
            animation-delay: 1s;
            z-index: 100;
            font-weight: 500;
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #1A3A4A;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-field {
            border-color: #ef4444 !important;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #1A3A4A;
            color: white;
            text-align: left;
            padding: 8px;
        }

        .data-table tr:nth-child(even) {
            background-color: #DEBFCF;
        }

        .data-table tr:hover {
            background-color: #ddd;
        }

        .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        .required::after {
            content: " *";
            color: #ef4444;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .points-btn {
            font-weight: bold;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            display: inline-flex;
            align-items: center;
            margin-right: 0.5rem;
        }
        
        .points-btn.earned {
            background-color: #10b981;
            color: white;
        }
        
        .points-btn.pending {
            background-color: #f59e0b;
            color: white;
        }
        
        .progress-bar {
            width: 100%;
            height: 24px;
            background-color: #f3f3f3;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 10px;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            transition: width 0.5s ease;
        }
        
        .target-input {
            width: 100px;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
        }
        
        .summary-card {
            background-color: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 12px;
        }
        
        .summary-card h3 {
            color: #1A3A4A;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 1.1rem;
            padding-bottom: 6px;
            border-bottom: 1px solid #f3f3f3;
        }

        .copyable {
            cursor: pointer;
            position: relative;
            user-select: all;
        }

        .copyable::after {
            content: "Copied!";
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }

        .copyable.copied::after {
            opacity: 1;
            animation: fadeAfterCopy 1.5s forwards;
        }

        @keyframes fadeAfterCopy {
            0% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; }
        }

        .action-column {
            min-width: 80px;
            white-space: nowrap;
            width: 80px;
        }

        .action-btn {
            margin-right: 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }
        
        .visualizations-header {
            background: #1A3A4A;
            color: white;
            padding: 8px 12px;
            font-weight: bold;
            border-radius: 4px;
            font-size: 0.95rem;
        }
        
        .visualization-container {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .chart-box {
            width: 24%;
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .chart-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            font-weight: bold;
            color: #1A3A4A;
            text-align: center;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }
        
        .pie-chart {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto;
            background: conic-gradient(
                #FF5349 0% 60%, 
                #2197b2 60% 90%, 
                #d8dee9 90% 100%
            );
            position: relative;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pl-proposition-chart {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto;
            background: conic-gradient(
                #FF5349 0% 33%, 
                #2197b2 33% 66%, 
                #d8dee9 66% 100%
            );
            position: relative;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cc-proposition-chart {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto;
            background: conic-gradient(
                #32CD32 0% 33%, 
                #FF8C00 33% 66%, 
                #9370DB 66% 100%
            );
            position: relative;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .acc-chart {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto;
            background: conic-gradient(
                #FEFE22 0% 40%, 
                #F96714 40% 75%, 
                #2197b2 75% 100%
            );
            position: relative;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .scheme-chart {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto;
            background: conic-gradient(
                #77DDE7 0% 45%, 
                #FF1DCE 45% 70%, 
                #B2EC5D 70% 90%, 
                #A2ADD0 90% 100%
            );
            position: relative;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .donut-hole {
            position: absolute;
            width: 72px;
            height: 72px;
            background: white;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.1);
        }

        .chart-percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            font-size: 14px;
            color: #1A3A4A;
            text-align: center;
            z-index: 10;
        }
        
        .chart-legend {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 4px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-right: 6px;
            margin-bottom: 6px;
            font-size: 10px;
            background-color: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            transition: transform 0.15s;
        }
        
        .legend-item:hover {
            transform: scale(1.05);
        }
        
        .legend-color {
            width: 10px;
            height: 10px;
            margin-right: 4px;
            border-radius: 2px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1050;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 50px auto;
            max-width: 900px;
            width: 90%;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 15px;
            overflow-y: auto;
            max-height: calc(80vh - 130px);
        }
        
        .modal-footer {
            padding: 15px;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .close-modal {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close-modal:hover {
            color: black;
        }
        
        .export-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }
        
        .export-table th {
            background: #1A3A4A;
            color: white;
            text-align: left;
            padding: 8px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .export-table tr:nth-child(even) {
            background-color: #DEBFCF;
        }
        
        .export-table tr:hover {
            background-color: #ddd;
        }
        
        .export-table td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        .amount-input {
            width: 100px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
            text-align: right;
        }

        .total-row {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        .total-row td {
            border-top: 2px solid #1A3A4A;
        }
        
        .profile-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .profile-input {
            flex: 1;
            min-width: 150px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .profile-select {
            flex: 1;
            min-width: 150px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
        }
        
        .profile-btn {
            padding: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .profile-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .btn-save {
            background: linear-gradient(135deg, #1A3A4A 0%, #3C063D 100%);
            color: white;
        }
        
        .btn-load {
            background-color: #1A3A4A;
            color: white;
        }
        
        .btn-delete {
            background-color: #FF5349;
            color: white;
        }

        .banking-container {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .banking-select {
            flex: 1;
            min-width: 200px;
        }

        .adcb-checkbox-container {
            display: flex;
            align-items: center;
            gap: 5px;
            min-width: 120px;
            justify-content: flex-end;
        }

        .status-container {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .status-select {
            flex: 1;
            min-width: 200px;
        }

        .deduction-checkbox-container {
            display: flex;
            align-items: center;
            gap: 5px;
            min-width: 80px;
            justify-content: flex-end;
        }

        .points-container {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .points-input {
            flex: 1;
            min-width: 200px;
        }

        .text-primary {
            color: #1A3A4A !important;
        }

        .input-with-paste {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-with-paste input {
            width: 100%;
            padding-right: 45px;
        }

        .paste-icon {
            position: absolute;
            right: 10px;
            color: #1A3A4A;
            cursor: pointer;
            font-size: 16px;
            z-index: 10;
            padding: 5px;
            transition: all 0.2s;
        }

        .paste-icon:hover {
            color: #0f2936;
            transform: scale(1.1);
        }

        .mobile-prefix {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px 0 0 4px;
            font-weight: bold;
            color: #333;
            border-right: none;
            font-size: 16px;
        }

        .mobile-input-container {
            display: flex;
            align-items: stretch;
            flex: 1;
            position: relative;
        }

        .mobile-input-container input {
            border-radius: 0 4px 4px 0 !important;
            border-left: none;
            flex: 1;
            font-size: 16px !important;
            padding-right: 45px;
        }

        .mobile-paste-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #1A3A4A;
            cursor: pointer;
            font-size: 16px;
            z-index: 10;
            padding: 5px;
            transition: all 0.2s;
        }

        .mobile-paste-icon:hover {
            color: #0f2936;
            transform: translateY(-50%) scale(1.1);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .summary-progress-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 2px;
            margin-bottom: 2px;
        }

        .hidden-column {
            display: none;
        }

        .funding-target-container {
            display: grid;
            grid-template-columns: 30fr 70fr;
            gap: 10px;
            margin-bottom: 12px;
        }

        .account-funding-card {
            background-color: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .account-funding-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .account-funding-title {
            color: #1A3A4A;
            font-weight: bold;
            font-size: 1rem;
        }

        .account-funding-total {
            color: #ff8c00;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .account-funding-items {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 0.8rem;
        }

        .account-funding-item {
            color: #333;
        }

        .funding-count {
            color: #ff8c00;
            font-weight: bold;
        }

        .funding-points {
            color: #666;
        }

        .target-card {
            background-color: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .target-card h3 {
            color: #1A3A4A;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 1rem;
            padding-bottom: 6px;
            border-bottom: 1px solid #f3f3f3;
        }

        .sort-dropdown {
            position: relative;
            display: inline-block;
        }

        .sort-btn {
            background: linear-gradient(135deg, #1A3A4A 0%, #3C063D 100%);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .sort-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .sort-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 180px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            border-radius: 8px;
            z-index: 1000;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .sort-dropdown-content.show {
            display: block;
        }

        .sort-option {
            color: #374151;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #f3f4f6;
        }

        .sort-option:last-child {
            border-bottom: none;
        }

        .sort-option:hover {
            background-color: #f9fafb;
        }

        .sort-option.active {
            background-color: #1A3A4A;
            color: white;
        }

        .filter-dropdown {
            position: relative;
            display: inline-block;
        }

        .filter-btn {
            background: linear-gradient(135deg, #1A3A4A 0%, #3C063D 100%);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .filter-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            border-radius: 8px;
            z-index: 1000;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .filter-dropdown-content.show {
            display: block;
        }

        .filter-option {
            color: #374151;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #f3f4f6;
        }

        .filter-option:last-child {
            border-bottom: none;
        }

        .filter-option:hover {
            background-color: #f9fafb;
        }

        .filter-option.active {
            background-color: #1A3A4A;
            color: white;
        }

        .autocomplete-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .autocomplete-suggestion {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .autocomplete-suggestion:hover,
        .autocomplete-suggestion.active {
            background-color: #f0f0f0;
        }

        .autocomplete-suggestion:last-child {
            border-bottom: none;
        }

        .styled-input {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            width: 100%;
            min-height: 48px;
            box-sizing: border-box;
        }

        .styled-input:focus {
            outline: none;
            border-color: #1A3A4A;
            box-shadow: 0 0 0 3px rgba(26, 58, 74, 0.1);
            background: #ffffff;
        }

        .styled-input:hover {
            border-color: #6c757d;
        }

        .styled-select {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 45px;
            width: 100%;
            min-height: 48px;
            box-sizing: border-box;
        }

        .styled-select:focus {
            outline: none;
            border-color: #1A3A4A;
            box-shadow: 0 0 0 3px rgba(26, 58, 74, 0.1);
            background: #ffffff;
        }

        .styled-select:hover {
            border-color: #6c757d;
        }

        .styled-radio-group {
            display: grid;
            gap: 8px;
            margin-top: 8px;
        }

        .styled-radio-group.proposition-grid {
            grid-template-columns: repeat(3, 1fr);
        }

        .styled-radio-group.scheme-grid {
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        }

        .styled-radio-group.activation-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .styled-radio-group.products-grid {
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        }

        .styled-radio-item {
            display: flex;
            align-items: center;
            position: relative;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            border: 2px solid #e9ecef;
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            transition: all 0.3s ease;
            justify-content: center;
            text-align: center;
            min-height: 40px;
        }

        .styled-radio-item:hover {
            border-color: #6c757d;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .styled-radio-item input[type="radio"] {
            opacity: 0;
            position: absolute;
            width: 0;
            height: 0;
        }

        .styled-radio-item input[type="radio"]:checked + .radio-label {
            color: white;
        }

        .styled-radio-item input[type="radio"]:checked {
            background: none;
        }

        .styled-radio-item:has(input[type="radio"]:checked) {
            background: linear-gradient(135deg, #1A3A4A 0%, #3C063D 100%);
            border-color: #1A3A4A;
            color: white;
        }

        .radio-label {
            font-weight: 500;
            transition: color 0.3s ease;
            pointer-events: none;
            font-size: 14px;
        }

        .styled-checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
            margin-top: 8px;
        }

        .styled-checkbox-item {
            display: flex;
            align-items: center;
            position: relative;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            border: 2px solid #e9ecef;
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            transition: all 0.3s ease;
            justify-content: center;
            text-align: center;
            min-height: 40px;
        }

        .styled-checkbox-item:hover {
            border-color: #6c757d;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .styled-checkbox-item input[type="checkbox"] {
            opacity: 0;
            position: absolute;
            width: 0;
            height: 0;
        }

        .styled-checkbox-item input[type="checkbox"]:checked + .checkbox-label {
            color: white;
        }

        .styled-checkbox-item:has(input[type="checkbox"]:checked) {
            background: linear-gradient(135deg, #1A3A4A 0%, #3C063D 100%);
            border-color: #1A3A4A;
            color: white;
        }

        .styled-checkbox-item:has(input[type="checkbox"]:disabled) {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f1f3f4;
            border-color: #d1d5db;
        }

        .checkbox-label {
            font-weight: 500;
            transition: color 0.3s ease;
            pointer-events: none;
            font-size: 14px;
        }

        .styled-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
            font-size: 14px;
            letter-spacing: 0.025em;
        }

        .form-section {
            background: #ffffff;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
        }

        .form-row {
            margin-bottom: 20px;
        }

        .checkbox-group-wrapper {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .radio-group-wrapper {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .activation-section {
            display: none;
        }

        .activation-section.show {
            display: block;
        }

        /* Fix 1: Universal Search Styles */
        .search-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-icon-btn {
            background: linear-gradient(135deg, #1A3A4A 0%, #3C063D 100%);
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .search-icon-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .search-textbox {
            display: none;
            width: 300px;
            padding: 8px 12px;
            border: 2px solid #1A3A4A;
            border-radius: 4px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .search-textbox.active {
            display: block;
        }

        .search-textbox:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 58, 74, 0.1);
        }

        /* Fix 2: Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 200px;
            height: 40px;
            background: linear-gradient(135deg, #1A3A4A 0%, #3C063D 100%);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 96px;
            height: 34px;
            background: white;
            border-radius: 17px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            color: #1A3A4A;
        }

        .toggle-switch.find-mode .toggle-slider {
            transform: translateX(96px);
        }

        .toggle-labels {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            color: white;
            font-size: 12px;
            font-weight: bold;
            pointer-events: none;
        }

        .toggle-labels .label-left {
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .toggle-labels .label-right {
            opacity: 0.5;
            transition: opacity 0.3s ease;
        }

        .toggle-switch.find-mode .toggle-labels .label-left {
            opacity: 0.5;
        }

        .toggle-switch.find-mode .toggle-labels .label-right {
            opacity: 1;
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-box {
                width: 100%;
            }            
            .profile-container {
                flex-direction: column;
                align-items: stretch;
            }       
            .profile-input,
            .profile-select {
                min-width: 0;
                width: 100%;
            }         
            .profile-btn {
                width: 100%;
                justify-content: center;
            }            
            .banking-container,
            .status-container {
                flex-direction: column;
                align-items: stretch;
                gap: 5px;
            }
            
            .banking-select,
            .status-select {
                min-width: 0;
                width: 100%;
            }
            
            .adcb-checkbox-container,
            .deduction-checkbox-container {
                min-width: 0;
                justify-content: flex-start;
            }

            .summary-progress-grid {
                grid-template-columns: 1fr;
            }

            .funding-target-container {
                grid-template-columns: 1fr;
            }

            .account-funding-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            .account-funding-items {
                flex-direction: column;
                gap: 3px;
            }

            .styled-radio-group.proposition-grid {
                grid-template-columns: 1fr;
            }

            .styled-radio-group.scheme-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .styled-radio-group.activation-grid {
                grid-template-columns: 1fr;
            }

            .styled-checkbox-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            /* Mobile responsive for search and toggle */
            .search-textbox {
                width: 250px;
            }

            .toggle-switch {
                width: 180px;
            }

            .toggle-slider {
                width: 86px;
            }

            .toggle-switch.find-mode .toggle-slider {
                transform: translateX(86px);
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-tahoma">
<div class="container mx-auto px-2 py-2 max-w-full">
    <!-- Section Navigation Buttons with Search -->
    <div class="mb-3 flex justify-center gap-2 flex-wrap items-center">
        <button id="showSummaryBtn" class="custom-btn text-white py-2 px-4 rounded-md flex items-center text-sm">
            <i class="fas fa-chart-pie mr-2"></i> Summary
        </button>
        <button id="showEntryBtn" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-md flex items-center text-sm">
            <i class="fas fa-file-alt mr-2"></i> Form
        </button>
        <button id="showViewBtn" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-md flex items-center text-sm">
            <i class="fas fa-table mr-2"></i> View
        </button>
        <a href="https://docs.google.com/spreadsheets/d/1VfEPU_2EvNqB6g2ldAzD05fvwFigL1yN3L0wLOwZP4o/edit?gid=0#gid=0" target="_blank" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-md flex items-center text-sm">
            <i class="fas fa-file-excel mr-2"></i> Sheet
        </a>
        <button id="showKPIBtn" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-md flex items-center text-sm">
            <i class="fas fa-chart-line mr-2"></i> KPI
        </button>
        
        <!-- Fix 1: Universal Search -->
        <div class="search-container ml-4">
            <button id="searchIconBtn" class="search-icon-btn">
                <i class="fas fa-search"></i>
                <span>Search</span>
            </button>
            <input type="text" id="universalSearch" class="search-textbox" placeholder="Search by CID, Name, or Mobile...">
        </div>
    </div>
    
    <!-- Section Content Containers -->
    <!-- Summary Section -->
    <div id="summarySection" class="section active">
        <div class="bg-white p-3 rounded-lg shadow-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-primary">Summary Dashboard</h2>
            </div>
            
            <!-- Points Summary Card -->
            <div class="summary-card mb-2">
                <h3 class="mb-1">Points</h3>
                <div class="grid grid-cols-3 gap-2">
                    <div>
                        <p class="font-medium text-gray-600 text-sm">Earned Points:</p>
                        <p class="text-lg font-bold text-green-600" id="summaryEarnedPoints">0</p>
                    </div>
                    <div>
                        <p class="font-medium text-gray-600 text-sm">Pending Points:</p>
                        <p class="text-lg font-bold text-amber-600" id="summaryPendingPoints">0</p>
                    </div>
                    <div>
                        <p class="font-medium text-gray-600 text-sm">Total Points:</p>
                        <p class="text-lg font-bold text-blue-600" id="summaryTotalPoints">0</p>
                    </div>
                </div>
            </div>
            
            <!-- Progress Cards -->
            <div class="summary-progress-grid mb-2">
                <!-- In Progress Card -->
                <div class="summary-card mb-0">
                    <h3 class="mb-1">In Progress</h3>
                    <div class="space-y-1">
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">Credit Cards:</p>
                            <p class="text-base font-bold text-purple-600" id="summaryInProgressCC">0</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">Personal Loans:</p>
                            <p class="text-base font-bold text-purple-600" id="summaryInProgressPL">AED 0</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">MDSA:</p>
                            <p class="text-base font-bold text-purple-600" id="summaryInProgressMDSA">0</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">Privilege:</p>
                            <p class="text-base font-bold text-purple-600" id="summaryInProgressPrivilege">0</p>
                        </div>
                    </div>
                </div>
                
                <!-- Completed Card -->
                <div class="summary-card mb-0">
                    <h3 class="mb-1">Completed</h3>
                    <div class="space-y-1">
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">Credit Cards:</p>
                            <p class="text-base font-bold text-green-600" id="summaryCompletedCC">0</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">Personal Loans:</p>
                            <p class="text-base font-bold text-green-600" id="summaryCompletedPL">AED 0</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">MDSA:</p>
                            <p class="text-base font-bold text-green-600" id="summaryCompletedMDSA">0</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">Privilege:</p>
                            <p class="text-base font-bold text-green-600" id="summaryCompletedPrivilege">0</p>
                        </div>
                    </div>
                </div>

                <!-- Total Submissions Card -->
                <div class="summary-card mb-0">
                    <h3 class="mb-1">Total Submissions</h3>
                    <div class="space-y-1">
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">Credit Cards:</p>
                            <p class="text-base font-bold text-blue-600" id="summaryTotalCC">15</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">Personal Loans:</p>
                            <p class="text-base font-bold text-blue-600" id="summaryTotalPL">AED 170,000</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">Accounts:</p>
                            <p class="text-base font-bold text-blue-600" id="summaryTotalAccounts">0</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Account Funding and Target in one line (30% - 70%) -->
            <div class="funding-target-container">
                <!-- Account Funding Card (30%) -->
                <div class="account-funding-card">
                    <div class="account-funding-header">
                        <span class="account-funding-title">Account Funding</span>
                        <span class="account-funding-total" id="fundingTotal">14 (3050 pts)</span>
                    </div>
                    <div class="account-funding-items">
                        <div class="account-funding-item">
                            MDSA: <span class="funding-count" id="fundingMDSACount">6</span> <span class="funding-points" id="fundingMDSAPoints">(1050 pts)</span>
                        </div>
                        <div class="account-funding-item">
                            Aspire: <span class="funding-count" id="fundingAspireCount">6</span> <span class="funding-points" id="fundingAspirePoints">(900 pts)</span>
                        </div>
                        <div class="account-funding-item">
                            Privilege: <span class="funding-count" id="fundingPrivilegeCount">2</span> <span class="funding-points" id="fundingPrivilegePoints">(1100 pts)</span>
                        </div>
                    </div>
                </div>
                
                <!-- Target Card (70%) -->
                <div class="target-card">
                    <h3 class="mb-1">Target</h3>
                    <div class="space-y-2">
                        <div>
                            <div class="flex items-center justify-between mb-0">
                                <p class="font-medium text-gray-600 text-sm">Credit Cards:</p>
                                <div class="flex items-center gap-1">
                                    <span id="remainingCC" class="text-xs font-bold text-blue-600">12</span>
                                    <input type="number" id="targetCC" class="target-input text-xs py-0 px-1 w-16" value="20" min="0">
                                </div>
                            </div>
                            <div class="progress-bar h-4 mt-1">
                                <div class="progress-fill bg-blue-500" id="progressCC" style="width: 40%">40%</div>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-0">
                                <p class="font-medium text-gray-600 text-sm">Personal Loans:</p>
                                <div class="flex items-center gap-1">
                                    <span id="remainingPL" class="text-xs font-bold text-blue-600">500,000</span>
                                    <input type="number" id="targetPL" class="target-input text-xs py-0 px-1 w-16" value="500000" min="0">
                                </div>
                            </div>
                            <div class="progress-bar h-4 mt-1">
                                <div class="progress-fill bg-green-500" id="progressPL" style="width: 0%">0%</div>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-0">
                                <p class="font-medium text-gray-600 text-sm">Accounts:</p>
                                <div class="flex items-center gap-1">
                                    <span id="remainingACC" class="text-xs font-bold text-blue-600">8</span>
                                    <input type="number" id="targetACC" class="target-input text-xs py-0 px-1 w-16" value="10" min="0">
                                </div>
                            </div>
                            <div class="progress-bar h-4 mt-1">
                                <div class="progress-fill bg-purple-500" id="progressACC" style="width: 20%">20%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Visualizations Section -->
            <div class="border rounded-lg mb-2">
                <div class="visualizations-header">
                    Visualizations
                </div>
                
                <div class="visualization-container p-2">
                    <!-- Personal Loan Proposition Chart -->
                    <div class="chart-box">
                        <div class="chart-title">Personal Loan Proposition</div>
                        <div class="pl-proposition-chart">
                            <div class="chart-percentage" id="plChartPercentage">33%</div>
                            <div class="donut-hole"></div>
                        </div>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #FF5349;"></div>
                                <span>Conventional</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #2197b2;"></div>
                                <span>Islamic</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #d8dee9;"></div>
                                <span>Both</span>
                            </div>
                        </div>
                    </div>

                    <!-- Credit Card Proposition Chart -->
                    <div class="chart-box">
                        <div class="chart-title">Credit Card Proposition</div>
                        <div class="cc-proposition-chart">
                            <div class="chart-percentage" id="ccChartPercentage">33%</div>
                            <div class="donut-hole"></div>
                        </div>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #32CD32;"></div>
                                <span>Conventional</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #FF8C00;"></div>
                                <span>Islamic</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #9370DB;"></div>
                                <span>Both</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Account Types Chart -->
                    <div class="chart-box">
                        <div class="chart-title">Account Types</div>
                        <div class="acc-chart">
                            <div class="chart-percentage" id="accChartPercentage">40%</div>
                            <div class="donut-hole"></div>
                        </div>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #FEFE22;"></div>
                                <span>Aspire</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #F96714;"></div>
                                <span>Privilege</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #2197b2;"></div>
                                <span>MDSA</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Scheme Distribution Chart -->
                    <div class="chart-box">
                        <div class="chart-title">Scheme Distribution</div>
                        <div class="scheme-chart">
                            <div class="chart-percentage" id="schemeChartPercentage">45%</div>
                            <div class="donut-hole"></div>
                        </div>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #77DDE7;"></div>
                                <span>TML ALL</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #FF1DCE;"></div>
                                <span>TML CC</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #B2EC5D;"></div>
                                <span>TM SELECT</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #A2ADD0;"></div>
                                <span>NTML</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Entry Form Section -->
    <div id="entrySection" class="section">
        <div class="form-section">
            <h2 class="text-xl font-bold text-primary mb-6">Customer Data Entry</h2>
            
            <form id="entryForm" class="space-y-6">
                <div class="form-grid">
                    <!-- Left Column -->
                    <div class="space-y-6">
                        <!-- CID with Paste Icon -->
                        <div class="form-row">
                            <label for="cid" class="styled-label">CID (Optional)</label>
                            <div class="input-with-paste">
                                <input type="text" id="cid" name="cid" class="styled-input" pattern="[0-9]*" inputmode="numeric" tabindex="1">
                                <i class="fas fa-paste paste-icon" onclick="pasteToField('cid')" title="Paste"></i>
                            </div>
                        </div>
                        
                        <!-- App ID with Paste Icon -->
                        <div class="form-row">
                            <label for="appId" class="styled-label">App ID</label>
                            <div class="input-with-paste">
                                <input type="text" id="appId" name="appId" class="styled-input" tabindex="2">
                                <i class="fas fa-paste paste-icon" onclick="pasteToField('appId')" title="Paste"></i>
                            </div>
                        </div>
                        
                        <!-- Salary -->
                        <div class="form-row">
                            <label for="salary" class="styled-label required">Salary</label>
                            <input type="number" id="salary" name="salary" class="styled-input" required tabindex="3">
                        </div>
                        
                        <!-- Customer Name with Paste Icon -->
                        <div class="form-row">
                            <label for="customerName" class="styled-label required">Customer Name</label>
                            <div class="input-with-paste">
                                <input type="text" id="customerName" name="customerName" class="styled-input" required style="text-transform: uppercase;" tabindex="4">
                                <i class="fas fa-paste paste-icon" onclick="pasteToField('customerName')" title="Paste"></i>
                            </div>
                            <p id="nameError" class="text-red-500 text-sm hidden mt-1">Customer name must be unique</p>
                        </div>
                        
                        <!-- Mobile with Paste Icon -->
                        <div class="form-row">
                            <label for="mobile" class="styled-label required">Mobile</label>
                            <div class="input-with-paste">
                                <div class="mobile-input-container">
                                    <div class="mobile-prefix">971</div>
                                    <input type="text" id="mobile" name="mobile" class="styled-input" required pattern="[0-9]*" inputmode="numeric" placeholder="Enter 9 digits" tabindex="5">
                                    <i class="fas fa-paste mobile-paste-icon" onclick="pasteToField('mobile')" title="Paste"></i>
                                </div>
                            </div>
                            <p id="mobileError" class="text-red-500 text-sm hidden mt-1">Mobile number must be unique</p>
                        </div>
                        
                        <!-- Company Name with Paste Icon and Autocomplete -->
                        <div class="form-row">
                            <label for="companyName" class="styled-label">Company Name</label>
                            <div class="autocomplete-container">
                                <input type="text" id="companyName" name="companyName" class="styled-input pr-12" style="text-transform: uppercase;" tabindex="6">
                                <i class="fas fa-paste paste-icon" onclick="pasteToField('companyName')" title="Paste"></i>
                                <div id="companySuggestions" class="autocomplete-suggestions"></div>
                            </div>
                        </div>
                        
                        <!-- Proposition -->
                        <div class="form-row">
                            <label class="styled-label required">Proposition</label>
                            <div class="radio-group-wrapper">
                                <div class="styled-radio-group proposition-grid">
                                    <label class="styled-radio-item">
                                        <input type="radio" name="proposition" value="Conventional" checked>
                                        <span class="radio-label">Conventional</span>
                                    </label>
                                    <label class="styled-radio-item">
                                        <input type="radio" name="proposition" value="Islamic">
                                        <span class="radio-label">Islamic</span>
                                    </label>
                                    <label class="styled-radio-item">
                                        <input type="radio" name="proposition" value="Both">
                                        <span class="radio-label">Both</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Date -->
                        <div class="form-row">
                            <label for="date" class="styled-label required">Date</label>
                            <input type="date" id="date" name="date" pattern="\d{2}/\d{2}/\d{4}" class="styled-input" required>
                        </div>
                    </div>
                    
                    <!-- Right Column -->
                    <div class="space-y-6">
                        <!-- Products -->
                        <div class="form-row">
                            <label class="styled-label required">Products</label>
                            <div class="checkbox-group-wrapper">
                                <div class="styled-checkbox-grid products-grid">
                                    <label class="styled-checkbox-item">
                                        <input type="checkbox" name="products" value="ACC" id="productACC">
                                        <span class="checkbox-label">ACC</span>
                                    </label>
                                    <label class="styled-checkbox-item">
                                        <input type="checkbox" name="products" value="2nd ACC" id="product2ndACC" disabled>
                                        <span class="checkbox-label">2nd ACC</span>
                                    </label>
                                    <label class="styled-checkbox-item">
                                        <input type="checkbox" name="products" value="STL" id="productSTL" disabled>
                                        <span class="checkbox-label">STL</span>
                                    </label>
                                    <label class="styled-checkbox-item">
                                        <input type="checkbox" name="products" value="CC" id="productCC">
                                        <span class="checkbox-label">CC</span>
                                    </label>
                                    <label class="styled-checkbox-item">
                                        <input type="checkbox" name="products" value="2ndCC" id="product2ndCC">
                                        <span class="checkbox-label">2nd CC</span>
                                    </label>
                                    <label class="styled-checkbox-item">
                                        <input type="checkbox" name="products" value="BT/CCL" id="productBTCCL">
                                        <span class="checkbox-label">BT/CCL</span>
                                    </label>
                                    <label class="styled-checkbox-item">
                                        <input type="checkbox" name="products" value="PL" id="productPL">
                                        <span class="checkbox-label">PL</span>
                                    </label>
                                    <label class="styled-checkbox-item">
                                        <input type="checkbox" name="products" value="Other" id="productOther">
                                        <span class="checkbox-label">Other</span>
                                    </label>
                                </div>
                            </div>
                            <p id="productsError" class="text-red-500 text-sm hidden mt-1">Please select at least one product</p>
                        </div>
                        
                        <!-- Product Options Container -->
                        <div id="productOptionsContainer" class="space-y-4">
                            <!-- Product-specific dropdown sections will be added here dynamically -->
                        </div>
                        
                        <!-- Loan Amount (Only shown for PL) -->
                        <div id="loanAmountSection" class="form-row hidden">
                            <label for="loanAmount" class="styled-label">Loan Amount</label>
                            <input type="number" id="loanAmount" name="loanAmount" class="styled-input">
                        </div>
                        
                        <!-- Other Points (Only shown for Other product) -->
                        <div id="otherPointsSection" class="form-row hidden">
                            <label for="otherPoints" class="styled-label">Other Points (Miscellaneous)</label>
                            <input type="number" id="otherPoints" name="otherPoints" class="styled-input" placeholder="Enter other points">
                        </div>
                        
                        <!-- Banking with ADCB checkbox -->
                        <div class="form-row">
                            <label class="styled-label">Banking</label>
                            <div class="banking-container mt-2">
                                <select id="banking" name="banking" class="banking-select styled-select" tabindex="7">
                                    <option value="SELECT">SELECT</option>
                                    <option value="ADCB">ADCB</option>
                                    <option value="ENBD">ENBD</option>
                                    <option value="EIB">EIB</option>
                                    <option value="FAB">FAB</option>
                                    <option value="DIB">DIB</option>
                                    <option value="MASHREQ">MASHREQ</option>
                                    <option value="ADIB">ADIB</option>
                                    <option value="RAK">RAK</option>
                                    <option value="CBD">CBD</option>
                                    <option value="HSBC">HSBC</option>
                                    <option value="CITI">CITI</option>
                                    <option value="Other">Other</option>
                                </select>
                                <div class="adcb-checkbox-container">
                                    <label class="styled-checkbox-item" style="padding: 8px 12px; min-height: auto;">
                                        <input type="checkbox" id="adcbOverride" name="adcbOverride">
                                        <span class="checkbox-label text-sm">ADCB</span>
                                    </label>
                                </div>
                            </div>
                            <div id="otherBankingSection" class="mt-2 hidden">
                                <input type="text" id="otherBanking" name="otherBanking" placeholder="Specify bank" class="styled-input">
                            </div>
                        </div>
                        
                        <!-- Scheme -->
                        <div class="form-row">
                            <label class="styled-label required">Scheme</label>
                            <div class="radio-group-wrapper">
                                <div class="styled-radio-group scheme-grid">
                                    <label class="styled-radio-item">
                                        <input type="radio" name="scheme" value="TML ALL" checked>
                                        <span class="radio-label">TML ALL</span>
                                    </label>
                                    <label class="styled-radio-item">
                                        <input type="radio" name="scheme" value="TML CC">
                                        <span class="radio-label">TML CC</span>
                                    </label>
                                    <label class="styled-radio-item">
                                        <input type="radio" name="scheme" value="TM SELECT">
                                        <span class="radio-label">TM SELECT</span>
                                    </label>
                                    <label class="styled-radio-item">
                                        <input type="radio" name="scheme" value="NTML">
                                        <span class="radio-label">NTML</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Status with 50% Deduction checkbox -->
                        <div class="form-row">
                            <label for="status" class="styled-label required">Status</label>
                            <div class="status-container mt-2">
                                <select id="status" name="status" class="status-select styled-select" required tabindex="8">
                                    <option value="">Select Status</option>
                                    <option value="Draft">Draft</option>
                                    <option value="Under Review">Under Review</option>
                                    <option value="Completed">Completed</option>
                                    <option value="ACC Completed, Under Review">ACC Completed, Under Review</option>
                                    <option value="HR CPV">HR CPV</option>
                                    <option value="Compliance">Compliance</option>
                                    <option value="Rejected">Rejected</option>
                                    <option value="Other">Other</option>
                                </select>
                                <div class="deduction-checkbox-container">
                                    <label class="styled-checkbox-item" style="padding: 8px 12px; min-height: auto;">
                                        <input type="checkbox" id="ccDeductionOverride" name="ccDeductionOverride">
                                        <span class="checkbox-label text-sm">50%</span>
                                    </label>
                                </div>
                            </div>
                            <div id="otherStatusSection" class="mt-2 hidden">
                                <input type="text" id="otherStatus" name="otherStatus" placeholder="Specify status" class="styled-input">
                            </div>
                        </div>
                        
                        <!-- Activation -->
                        <div class="form-row activation-section" id="activationSection">
                            <label class="styled-label required">Activation</label>
                            <div class="radio-group-wrapper">
                                <div class="styled-radio-group activation-grid">
                                    <label class="styled-radio-item">
                                        <input type="radio" name="activation" value="Non Activated" checked>
                                        <span class="radio-label">Non Activated</span>
                                    </label>
                                    <label class="styled-radio-item">
                                        <input type="radio" name="activation" value="Activated">
                                        <span class="radio-label">Activated</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Points (System Generated) -->
                        <div class="form-row">
                            <label for="points" class="styled-label">Points (System Generated)</label>
                            <div class="points-container mt-2">
                                <input type="text" id="points" name="points" class="points-input styled-input bg-gray-100" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Form Action Buttons -->
                <div class="flex justify-center gap-3 mt-8 flex-wrap">
                    <button type="submit" id="submitBtn" class="custom-btn text-white py-3 px-8 rounded-md flex items-center" tabindex="9">
                        <i class="fas fa-save mr-2"></i> Save Data
                    </button>
                    <button type="button" id="updateBtn" class="custom-btn bg-blue-600 text-white py-3 px-8 rounded-md flex items-center hidden">
                        <i class="fas fa-edit mr-2"></i> Update Data
                    </button>
                    <button type="button" id="deleteBtn" class="bg-red-600 text-white py-3 px-8 rounded-md flex items-center hover:bg-red-700 hidden">
                        <i class="fas fa-trash-alt mr-2"></i> Delete Data
                    </button>
                    <button type="button" id="resetBtn" class="bg-gray-600 text-white py-3 px-8 rounded-md flex items-center hover:bg-gray-700">
                        <i class="fas fa-redo-alt mr-2"></i> Reset Form
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- View Data Section -->
    <div id="viewSection" class="section">
        <div class="bg-white p-4 rounded-lg shadow-md">
            <!-- Fix 2: Toggle Switch for View All / Find Records -->
            <div class="flex flex-wrap justify-between items-center mb-4">
                <div class="toggle-switch" id="viewToggleSwitch">
                    <div class="toggle-slider">View All</div>
                    <div class="toggle-labels">
                        <span class="label-left">View All</span>
                        <span class="label-right">Find Records</span>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2 mt-2 sm:mt-0">
                    <button id="earnPointsBtn" class="points-btn earned">
                        <i class="fas fa-check-circle mr-2"></i><span id="earnedPointsTotal">0</span></button>
                    <button id="pendingPointsBtn" class="points-btn pending">
                        <i class="fas fa-hourglass-half mr-2"></i> <span id="pendingPointsTotal">0</span></button>
                    <button id="expandBtn" class="bg-gray-600 text-white py-2 px-3 rounded-md hover:bg-gray-700" title="Expand/Collapse Columns">
                        <i class="fas fa-expand-alt"></i></button>
                    <!-- Product Sort Dropdown -->
                    <div class="sort-dropdown">
                        <button class="sort-btn" id="sortDropdownBtn">
                            <i class="fas fa-sort"></i>
                            <span>Sort</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="sort-dropdown-content" id="sortDropdownContent">
                            <div class="sort-option active" data-sort="all">All Products</div>
                            <div class="sort-option" data-sort="acc">ACC</div>
                            <div class="sort-option" data-sort="cc">CC</div>
                            <div class="sort-option" data-sort="pl">PL</div>
                            <div class="sort-option" data-sort="btccl">BT/CCL</div>
                            <div class="sort-option" data-sort="other">Other</div>
                        </div>
                    </div>
                    <!-- Filter Dropdown -->
                    <div class="filter-dropdown">
                        <button class="filter-btn" id="filterDropdownBtn">
                            <i class="fas fa-filter"></i>
                            <span>Filter</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="filter-dropdown-content" id="filterDropdownContent">
                            <!-- Filter options will be populated dynamically -->
                        </div>
                    </div>
                    <button id="exportDataBtn" class="custom-btn text-white py-2 px-4 rounded-md flex items-center">
                        <i class="fas fa-file-export mr-2"></i></button>
                    <button id="refreshDataBtn" class="custom-btn text-white py-2 px-4 rounded-md flex items-center">
                        <i class="fas fa-sync-alt mr-2"></i></button>
                    <button id="showAllRecordsBtn" class="custom-btn text-white py-2 px-6 rounded-md">
                        <i class="fas fa-list mr-2"></i></button>
                </div>
            </div>
            
            <!-- View All Records Table -->
            <div id="viewAllContainer">
                <div class="overflow-x-auto">
                    <table id="dataTable" class="data-table">
                        <thead>
                            <tr>
                                <th class="cid-column hidden-column">CID</th>
                                <th class="appid-column hidden-column">App ID</th>
                                <th>Customer Name</th>
                                <th>Mobile</th>
                                <th>Products</th>
                                <th>Status</th>
                                <th>Points</th>
                                <th class="action-column hidden-column w-20">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Find Records Container -->
            <div id="findRecordsContainer" style="display: none;">
                <div class="overflow-x-auto">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="search-cid-column hidden-column">CID</th>
                                <th class="search-appid-column hidden-column">App ID</th>
                                <th>Customer Name</th>
                                <th>Mobile</th>
                                <th>Products</th>
                                <th>Status</th>
                                <th>Points</th>
                                <th class="search-action-column hidden-column w-20">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="searchResultsBody">
                            <!-- Search results will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <div id="masterShowMoreContainer" class="mt-4 text-center hidden">
                    <button id="showMoreMasterBtn" class="custom-btn text-white py-2 px-6 rounded-md">
                        <i class="fas fa-plus mr-2"></i> Show More
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Indicator -->
<div id="successIndicator" class="success-indicator hidden">
    <span id="successMessage">Operation successful!</span>
</div>

<!-- Loading Indicator -->
<div id="loadingIndicator" class="loading-indicator hidden">
    <div class="spinner"></div>
</div>

<!-- Export Modal -->
<div id="exportModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="text-lg font-bold text-primary">Export Data</h2>
            <span class="close-modal" id="closeExportModal">&times;</span>
        </div>
        <div class="modal-body">
            <!-- Referral Profile Section -->
            <div class="profile-container">
                <input type="text" id="profileName" class="profile-input" placeholder="Profile Name">
                <button id="saveProfileBtn" class="profile-btn btn-save">
                    <i class="fas fa-save mr-1"></i> Save
                </button>
                <select id="profileSelect" class="profile-select">
                    <option value="">Select a profile</option>
                </select>
                <button id="loadProfileBtn" class="profile-btn btn-load">
                    <i class="fas fa-folder-open mr-1"></i> Load
                </button>
                <button id="deleteProfileBtn" class="profile-btn btn-delete">
                    <i class="fas fa-trash-alt mr-1"></i> Delete
                </button>
            </div>
            
            <!-- Export Table -->
            <div class="mb-3">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center">
                        <input type="checkbox" id="selectAllRows" class="mr-2">
                        <label for="selectAllRows" class="text-gray-700 font-medium">Select All</label>
                    </div>
                    <div>
                        <span class="text-sm text-gray-600" id="selectedRowsCount">0 rows selected</span>
                    </div>
                </div>
                <div class="max-h-[400px] overflow-y-auto border border-gray-200 rounded">
                    <table class="export-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" id="selectAllHeader"></th>
                                <th>CID</th>
                                <th>Date</th>
                                <th>Customer Name</th>
                                <th>Product</th>
                                <th>Status</th>
                                <th id="amountHeader">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="exportTableBody">
                            <!-- Export data will be populated here -->
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="6" class="text-right font-bold">Total:</td>
                                <td id="totalAmount" class="font-bold">0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button id="cancelExportBtn" class="bg-gray-500 text-white py-2 px-4 rounded hover:bg-gray-600">
                Cancel
            </button>
            <button id="confirmExportBtn" class="custom-btn text-white py-2 px-4 rounded">
                <i class="fas fa-file-pdf mr-2"></i> Export PDF
            </button>
        </div>
    </div>
</div>

<!-- KPI Modal -->
<div id="kpiModal" class="modal">
    <div class="modal-content" style="max-width: 95%; max-height: 95%; margin: 20px auto;">
        <div class="modal-header">
            <h2 class="text-lg font-bold text-primary">Key Performance Indicator</h2>
            <span class="close-modal" id="closeKPIModal">&times;</span>
        </div>
        <div class="modal-body">
            <iframe id="kpiIframe" src="kpi.html" style="width: 100%; height: 70vh; border: none; border-radius: 8px;"></iframe>
        </div>
    </div>
</div>

<script>
    // Initialize jsPDF
    window.jsPDF = window.jspdf.jsPDF;

    // Google Apps Script Web App URL
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwBKFBLV1ayE1-RIsdbr11-dZ0yGcFxnwkyoOJXnQrH-vbtSH1sjTCQzBlJTdyufOeOXA/exec';

    // Global variables
    let allRecordsData = [];
    let allMasterData = [];
    let masterDataOffset = 0;
    let isShowingAllRecords = false;
    const maxInitialRecords = 10;
    const masterPageSize = 20;
    let longPressTimer = null;
    let isLongPressing = false;
    let currentSelections = { ACC: '', ACC2: '', CC: '', CCOption2: '', PL: '' };
    let editingData = null;
    let editingProductString = "";
    let editingFromMaster = false;
    let isExpanded = false;
    let appInitialized = false;
    let currentFilter = 'all';
    let currentSort = 'all';
    let companyNames = [];
    let statusOptions = [];
    let selectedCCOptions = new Set();
    let isFindMode = false; // Fix 2: Track current mode

    // ==========================================
    // PASTE FUNCTIONALITY
    // ==========================================

    async function pasteToField(fieldId) {
        try {
            const text = await navigator.clipboard.readText();
            const field = document.getElementById(fieldId);
            
            if (!field) return;
            
            let processedText = text.trim();
            
            // Process based on field type
            switch(fieldId) {
                case 'cid':
                    // Only allow numbers
                    processedText = processedText.replace(/\D/g, '');
                    break;
                    
                case 'appId':
                    // Allow text but no spaces
                    processedText = processedText.replace(/\s/g, '');
                    break;
                    
                case 'customerName':
                case 'companyName':
                    // Convert to uppercase
                    processedText = processedText.toUpperCase();
                    break;
                    
                case 'mobile':
                    // Remove non-digits and handle prefixes
                    processedText = processedText.replace(/\D/g, '');
                    
                    // Remove leading zeros
                    if (processedText.startsWith('0')) {
                        processedText = processedText.substring(1);
                    }
                    if (processedText.startsWith('971')) {
                        processedText = processedText.substring(3);
                    }
                    
                    // Ensure it's 9 digits max
                    if (processedText.length > 9) {
                        processedText = processedText.substring(0, 9);
                    }
                    break;
            }
            
            field.value = processedText;
            
            // Trigger change event for validation
            const event = new Event('input', { bubbles: true });
            field.dispatchEvent(event);
            
            // Show feedback
            showSuccess(`Pasted to ${fieldId.replace(/([A-Z])/g, ' $1').toLowerCase()}`);
            
        } catch (err) {
            console.error('Failed to read clipboard contents: ', err);
            showSuccess('Failed to paste. Please try copying the text again.');
        }
    }

    // ==========================================
    // Fix 1: UNIVERSAL SEARCH FUNCTIONALITY
    // ==========================================

    function setupUniversalSearch() {
        const searchIconBtn = document.getElementById('searchIconBtn');
        const searchTextbox = document.getElementById('universalSearch');
        const navigationButtons = document.querySelectorAll('.mb-3 .flex button, .mb-3 .flex a');
        
        let isSearchMode = false;

        searchIconBtn.addEventListener('click', function() {
            isSearchMode = !isSearchMode;
            
            if (isSearchMode) {
                // Show search textbox and hide other buttons
                searchTextbox.classList.add('active');
                searchTextbox.focus();
                
                navigationButtons.forEach(btn => {
                    if (btn !== searchIconBtn && !btn.closest('.search-container')) {
                        btn.style.display = 'none';
                    }
                });
                
                searchIconBtn.innerHTML = '<i class="fas fa-times"></i><span>Close</span>';
            } else {
                // Hide search textbox and show other buttons
                searchTextbox.classList.remove('active');
                searchTextbox.value = '';
                
                navigationButtons.forEach(btn => {
                    btn.style.display = '';
                });
                
                searchIconBtn.innerHTML = '<i class="fas fa-search"></i><span>Search</span>';
                
                // Clear search results
                clearUniversalSearch();
            }
        });

        // Search functionality
        searchTextbox.addEventListener('input', function() {
            const searchTerm = this.value.trim();
            
            if (searchTerm.length >= 2) {
                performUniversalSearch(searchTerm);
            } else if (searchTerm.length === 0) {
                clearUniversalSearch();
            }
        });

        // Enter key to search
        searchTextbox.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const searchTerm = this.value.trim();
                if (searchTerm.length >= 1) {
                    performUniversalSearch(searchTerm);
                }
            }
        });
    }

    async function performUniversalSearch(searchTerm) {
        showLoading();
        try {
            // Search both Data and Master sheets
            const [dataResponse, masterResponse] = await Promise.all([
                fetch(`${scriptURL}?action=getAll`),
                fetch(`${scriptURL}?action=searchMaster&cid=${encodeURIComponent(searchTerm)}&name=${encodeURIComponent(searchTerm)}&mobile=${encodeURIComponent(searchTerm)}`)
            ]);

            const dataResult = await dataResponse.json();
            const masterResult = await masterResponse.json();

            let combinedResults = [];

            // Filter Data sheet results
            if (dataResult.success && dataResult.data) {
                const filteredData = dataResult.data.filter(record => {
                    const cid = (record.CID || '').toString().toLowerCase();
                    const name = (record['Customer Name'] || '').toLowerCase();
                    const mobile = (record.Mobile || '').toString().toLowerCase();
                    const searchLower = searchTerm.toLowerCase();
                    
                    return cid.includes(searchLower) || 
                           name.includes(searchLower) || 
                           mobile.includes(searchLower);
                });
                
                combinedResults = [...filteredData];
            }

            // Add Master sheet results
            if (masterResult.success && masterResult.data) {
                const filteredMaster = masterResult.data.filter(record => {
                    // Avoid duplicates based on CID
                    const cid = record.CID;
                    return !combinedResults.some(existing => existing.CID === cid);
                });
                
                combinedResults = [...combinedResults, ...filteredMaster];
            }

            // Display results
            if (isFindMode) {
                displayDataInTable(combinedResults, 'searchResultsBody', true, false, 'mixed');
            } else {
                displayDataInTable(combinedResults, 'dataTableBody', false, false, 'mixed');
            }

            showSuccess(`Found ${combinedResults.length} matching records`);

        } catch (error) {
            console.error('Error in universal search:', error);
            showSuccess('Error performing search');
        } finally {
            hideLoading();
        }
    }

    function clearUniversalSearch() {
        // Restore original data view
        if (isFindMode) {
            document.getElementById('searchResultsBody').innerHTML = '';
            fetchAllMasterData(); // Load default find records data
        } else {
            fetchAllData(); // Load default view all data
        }
    }

    // ==========================================
    // Fix 2: VIEW TOGGLE FUNCTIONALITY
    // ==========================================

    function setupViewToggle() {
        const toggleSwitch = document.getElementById('viewToggleSwitch');
        const viewAllContainer = document.getElementById('viewAllContainer');
        const findRecordsContainer = document.getElementById('findRecordsContainer');

        toggleSwitch.addEventListener('click', function() {
            isFindMode = !isFindMode;
            
            if (isFindMode) {
                // Switch to Find Records mode
                toggleSwitch.classList.add('find-mode');
                toggleSwitch.querySelector('.toggle-slider').textContent = 'Find Records';
                
                viewAllContainer.style.display = 'none';
                findRecordsContainer.style.display = 'block';
                
                // Load find records data (Master sheet by default)
                fetchAllMasterData();
                
            } else {
                // Switch to View All mode
                toggleSwitch.classList.remove('find-mode');
                toggleSwitch.querySelector('.toggle-slider').textContent = 'View All';
                
                findRecordsContainer.style.display = 'none';
                viewAllContainer.style.display = 'block';
                
                // Load view all data (Data sheet)
                fetchAllData();
            }
        });
    }

    // ==========================================
    // INPUT VALIDATION AND AUTOCOMPLETE
    // ==========================================

    function setupCompanyAutocomplete() {
        const companyNameInput = document.getElementById('companyName');
        const suggestionsDiv = document.getElementById('companySuggestions');
        
        let selectedIndex = -1;
        
        companyNameInput.addEventListener('input', function() {
            const value = this.value.toUpperCase();
            selectedIndex = -1;
            
            if (value.length < 2) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            const filtered = companyNames.filter(company => 
                company.toUpperCase().includes(value)
            ).slice(0, 10);
            
            if (filtered.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            suggestionsDiv.innerHTML = '';
            filtered.forEach((company, index) => {
                const div = document.createElement('div');
                div.className = 'autocomplete-suggestion';
                div.textContent = company;
                div.addEventListener('click', function() {
                    companyNameInput.value = company;
                    suggestionsDiv.style.display = 'none';
                });
                suggestionsDiv.appendChild(div);
            });
            
            suggestionsDiv.style.display = 'block';
        });
        
        companyNameInput.addEventListener('keydown', function(e) {
            const suggestions = suggestionsDiv.querySelectorAll('.autocomplete-suggestion');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, suggestions.length - 1);
                updateSelection(suggestions);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateSelection(suggestions);
            } else if (e.key === 'Enter' && selectedIndex >= 0) {
                e.preventDefault();
                companyNameInput.value = suggestions[selectedIndex].textContent;
                suggestionsDiv.style.display = 'none';
            } else if (e.key === 'Escape') {
                suggestionsDiv.style.display = 'none';
                selectedIndex = -1;
            }
        });
        
        function updateSelection(suggestions) {
            suggestions.forEach((suggestion, index) => {
                suggestion.classList.toggle('active', index === selectedIndex);
            });
        }
        
        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!companyNameInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                suggestionsDiv.style.display = 'none';
            }
        });
    }

    async function fetchCompanyNames() {
        try {
            const uniqueCompanies = new Set();
            
            // Fetch from Data sheet
            const dataResponse = await fetch(`${scriptURL}?action=getAll`);
            const dataResult = await dataResponse.json();
            
            if (dataResult.success && dataResult.data) {
                dataResult.data
                    .map(record => record['Company Name'])
                    .filter(name => name && name.trim() !== '')
                    .forEach(name => uniqueCompanies.add(name.toUpperCase()));
            }
            
            // Fetch from Master sheet
            const masterResponse = await fetch(`${scriptURL}?action=getMasterCompanies`);
            const masterResult = await masterResponse.json();
            
            if (masterResult.success && masterResult.data) {
                masterResult.data
                    .map(record => record['Company Name'])
                    .filter(name => name && name.trim() !== '')
                    .forEach(name => uniqueCompanies.add(name.toUpperCase()));
            }
            
            companyNames = Array.from(uniqueCompanies).sort();
            
        } catch (error) {
            console.error('Error fetching company names:', error);
        }
    }

    // Fetch status options from Google Sheets column M
    async function fetchStatusOptions() {
        try {
            const response = await fetch(`${scriptURL}?action=getAll`);
            const data = await response.json();
            
            if (data.success && data.data) {
                // Extract unique status values from the data
                const uniqueStatuses = [...new Set(
                    data.data
                        .map(record => record.Status)
                        .filter(status => status && status.trim() !== '')
                )].sort();
                
                statusOptions = uniqueStatuses;
                populateFilterDropdown();
            }
        } catch (error) {
            console.error('Error fetching status options:', error);
        }
    }

    // DOM initialization
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM Content Loaded - Initializing app...');
        
        // Set current date by default
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date').value = today;
        
        // CID - numbers only
        document.getElementById('cid').addEventListener('input', function(e) {
            this.value = this.value.replace(/\D/g, '');
        });
        
        // App ID - allow text but no spaces
        document.getElementById('appId').addEventListener('input', function(e) {
            this.value = this.value.replace(/\s/g, '');
        });
        
        // Customer Name - uppercase
        document.getElementById('customerName').addEventListener('input', function(e) {
            this.value = this.value.toUpperCase();
        });
        
        // Company Name - uppercase
        document.getElementById('companyName').addEventListener('input', function(e) {
            this.value = this.value.toUpperCase();
        });
        
        // Mobile - numbers only, handle prefixes
        document.getElementById('mobile').addEventListener('input', function(e) {
            let value = this.value.replace(/\D/g, '');
            
            // Remove leading zeros and 971 prefix if pasted
            if (value.startsWith('0')) {
                value = value.substring(1);
            }
            if (value.startsWith('971')) {
                value = value.substring(3);
            }
            
            // Limit to 9 digits
            if (value.length > 9) {
                value = value.substring(0, 9);
            }
            
            this.value = value;
        });
        
        // Initialize other functionality
        document.getElementById('product2ndCC').disabled = true;
        document.getElementById('product2ndACC').disabled = true;
        document.getElementById('productSTL').disabled = true;
        
        setupKeyboardNavigation();
        setupProductEventListeners();
        setupFilterDropdown();
        setupSortDropdown();
        setupCompanyAutocomplete();
        setupUniversalSearch(); // Fix 1
        setupViewToggle(); // Fix 2
        
        // Fetch company names and status options
        fetchCompanyNames();
        fetchStatusOptions();
        
        // Mark app as initialized with a delay to ensure everything is ready
        setTimeout(() => {
            appInitialized = true;
            console.log('App initialization complete');
        }, 100);
        
        showSection('summary');
        loadProfiles();
    });

    // Setup sort dropdown functionality
    function setupSortDropdown() {
        const sortBtn = document.getElementById('sortDropdownBtn');
        const sortContent = document.getElementById('sortDropdownContent');
        const sortOptions = document.querySelectorAll('.sort-option');

        sortBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            sortContent.classList.toggle('show');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!sortBtn.contains(e.target) && !sortContent.contains(e.target)) {
                sortContent.classList.remove('show');
            }
        });

        // Handle sort option clicks
        sortOptions.forEach(option => {
            option.addEventListener('click', function() {
                const sort = this.dataset.sort;
                
                // Update active state
                sortOptions.forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
                
                // Apply sort
                currentSort = sort;
                
                if (sort === 'all') {
                    // Revert to original state
                    if (isShowingAllRecords) {
                        displayDataInTable(allRecordsData, 'dataTableBody', false, false, 'data');
                    } else {
                        const displayData = allRecordsData.slice(-maxInitialRecords);
                        displayDataInTable(displayData, 'dataTableBody', false, false, 'data');
                    }
                } else {
                    // Show all records when sorting
                    displayDataInTable(allRecordsData, 'dataTableBody', false, false, 'data');
                    isShowingAllRecords = true;
                    document.getElementById('showAllRecordsBtn').innerHTML = '<i class="fas fa-list-alt mr-2"></i>';
                }
                
                applyProductSort(sort);
                
                // Close dropdown
                sortContent.classList.remove('show');
            });
        });
    }

    function applyProductSort(sort) {
        const tableBody = document.getElementById('dataTableBody');
        const rows = Array.from(tableBody.querySelectorAll('tr'));
        
        if (sort === 'all') {
            // Show all rows
            rows.forEach(row => {
                row.style.display = '';
            });
            return;
        }
        
        // Hide all rows first
        rows.forEach(row => {
            row.style.display = 'none';
        });
        
        // Show only matching rows
        rows.forEach(row => {
            const productCell = row.cells[4];
            if (!productCell) return;
            
            const productText = productCell.textContent.toLowerCase();
            
            if (productMatchesSort(productText, sort)) {
                row.style.display = '';
            }
        });
    }

    function productMatchesSort(productText, sort) {
        const accProducts = ['mdsa', 'aspire 5k-10k', 'aspire 10k-20k', 'privilege 20k-40k', 'privilege 40k & above'];
        const ccProducts = [
            'touchpoints gold visa', 'touchpoints titanium mc', 'essiential cashback mc', 'talabat mc',
            'lulu titanium mc', 'lulu platinum mc', 'touchpoints platinum mc', '365 cashback visa',
            'shukran platinum visa', 'etihad guest platinum visa', 'etihad guest signature visa',
            'etihad guest infinite visa', 'touchpoints infinite visa', 'traveller mc world elite',
            'betaqti mc world elite', 'emirati islamic infinite visa'
        ];
        const plProducts = ['pl asp-a&b', 'pl asp-c&below', 'pl prv-a&b', 'pl prv-c&below', 'top up'];
        const btcclProducts = ['bt/ccl'];
        const otherProducts = ['other'];
        
        switch(sort) {
            case 'acc':
                return accProducts.some(product => productText.includes(product));
            case 'cc':
                return ccProducts.some(product => productText.includes(product));
            case 'pl':
                return plProducts.some(product => productText.includes(product));
            case 'btccl':
                return btcclProducts.some(product => productText.includes(product));
            case 'other':
                return otherProducts.some(product => productText.includes(product));
            default:
                return true;
        }
    }

    // Setup filter dropdown with status options from data
    function setupFilterDropdown() {
        const filterBtn = document.getElementById('filterDropdownBtn');
        const filterContent = document.getElementById('filterDropdownContent');

        filterBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            filterContent.classList.toggle('show');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!filterBtn.contains(e.target) && !filterContent.contains(e.target)) {
                filterContent.classList.remove('show');
            }
        });
    }

    // Populate filter dropdown with status options
    function populateFilterDropdown() {
        const filterContent = document.getElementById('filterDropdownContent');
        filterContent.innerHTML = '';

        // Add "All Status" option
        const allOption = document.createElement('div');
        allOption.className = 'filter-option active';
        allOption.dataset.filter = 'all';
        allOption.textContent = 'All Status';
        filterContent.appendChild(allOption);

        // Add status options from data
        statusOptions.forEach(status => {
            const option = document.createElement('div');
            option.className = 'filter-option';
            option.dataset.filter = status;
            option.textContent = status;
            filterContent.appendChild(option);
        });

        // Add event listeners to new options
        const filterOptions = filterContent.querySelectorAll('.filter-option');
        filterOptions.forEach(option => {
            option.addEventListener('click', function() {
                const filter = this.dataset.filter;
                
                // Update active state
                filterOptions.forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
                
                // Apply filter
                currentFilter = filter;
                
                // Show all records when filtering and revert when "All Status" is selected
                if (filter === 'all') {
                    // Revert to original state
                    if (isShowingAllRecords) {
                        displayDataInTable(allRecordsData, 'dataTableBody', false, false, 'data');
                    } else {
                        const displayData = allRecordsData.slice(-maxInitialRecords);
                        displayDataInTable(displayData, 'dataTableBody', false, false, 'data');
                    }
                } else {
                    // Show all records when filtering
                    displayDataInTable(allRecordsData, 'dataTableBody', false, false, 'data');
                    isShowingAllRecords = true;
                    document.getElementById('showAllRecordsBtn').innerHTML = '<i class="fas fa-list-alt mr-2"></i>';
                }
                
                applyStatusFilter(filter);
                
                // Close dropdown
                filterContent.classList.remove('show');
            });
        });
    }

    // Apply status filter
    function applyStatusFilter(filter) {
        const tableBody = document.getElementById('dataTableBody');
        const rows = tableBody.querySelectorAll('tr');
        
        rows.forEach(row => {
            const statusCell = row.cells[5]; // Status column
            if (!statusCell) return;
            
            const statusText = statusCell.textContent.trim();
            let shouldShow = true;
            
            if (filter === 'all') {
                shouldShow = true;
            } else {
                shouldShow = statusText === filter;
            }
            
            row.style.display = shouldShow ? '' : 'none';
        });
    }

    // Enhanced product event listeners setup
    function setupProductEventListeners() {
        console.log('Setting up product event listeners...');
        
        // Product checkbox change events
        document.getElementById('productACC').addEventListener('change', function() {
            const product2ndACC = document.getElementById('product2ndACC');
            const productSTL = document.getElementById('productSTL');
            
            product2ndACC.disabled = !this.checked;
            productSTL.disabled = !this.checked;
            
            if (!this.checked) {
                product2ndACC.checked = false;
                productSTL.checked = false;
            }
            
            if (appInitialized) {
                updateProductOptions();
            }
            updateActivationVisibility();
        });

        // Enhanced 2nd ACC handling
        document.getElementById('product2ndACC').addEventListener('change', function() {
            console.log('2nd ACC checkbox changed:', this.checked);
            if (appInitialized) {
                setTimeout(() => {
                    updateProductOptions();
                }, 100);
            }
        });

        document.getElementById('productSTL').addEventListener('change', function() {
            calculateTotalPoints();
        });

        document.getElementById('productPL').addEventListener('change', function() {
            const loanAmountSection = document.getElementById('loanAmountSection');
            const loanAmountInput = document.getElementById('loanAmount');
            
            if (this.checked) {
                loanAmountSection.classList.remove('hidden');
            } else {
                loanAmountSection.classList.add('hidden');
                loanAmountInput.value = '';
            }
            
            if (appInitialized) {
                updateProductOptions();
            }
        });

        document.getElementById('productCC').addEventListener('change', function() {
            const product2ndCC = document.getElementById('product2ndCC');
            product2ndCC.disabled = !this.checked;
            
            if (!this.checked) {
                product2ndCC.checked = false;
            }
            
            if (appInitialized) {
                updateProductOptions();
            }
            updateActivationVisibility();
        });

        document.getElementById('product2ndCC').addEventListener('change', function() {
            if (appInitialized) {
                updateProductOptions();
            }
            updateActivationVisibility();
        });

        document.getElementById('productBTCCL').addEventListener('change', function() {
            calculateTotalPoints();
        });

        document.getElementById('productOther').addEventListener('change', function() {
            const otherPointsSection = document.getElementById('otherPointsSection');
            const otherPointsInput = document.getElementById('otherPoints');
            
            if (this.checked) {
                otherPointsSection.classList.remove('hidden');
            } else {
                otherPointsSection.classList.add('hidden');
                otherPointsInput.value = '';
            }
            calculateTotalPoints();
        });

        document.getElementById('otherPoints').addEventListener('input', function() {
            calculateTotalPoints();
        });

        document.querySelectorAll('input[name="proposition"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (appInitialized) {
                    updateProductOptions();
                }
            });
        });

        document.getElementById('salary').addEventListener('input', function() {
            if (appInitialized) {
                updateProductOptions();
            }
        });

        console.log('Product event listeners setup complete');
    }

    function updateActivationVisibility() {
        const activationSection = document.getElementById('activationSection');
        const productCC = document.getElementById('productCC');
        const product2ndCC = document.getElementById('product2ndCC');
        
        if (productCC.checked || product2ndCC.checked) {
            activationSection.classList.add('show');
        } else {
            activationSection.classList.remove('show');
        }
    }

    function setupKeyboardNavigation() {
        const formFields = [
            'cid', 'appId', 'salary', 'customerName', 'mobile', 
            'companyName', 'banking', 'status', 'submitBtn'
        ];
        
        formFields.forEach((fieldId, index) => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === 'Tab') {
                        e.preventDefault();
                        
                        if (fieldId === 'submitBtn') {
                            field.click();
                        } else {
                            const nextIndex = index + 1;
                            if (nextIndex < formFields.length) {
                                const nextField = document.getElementById(formFields[nextIndex]);
                                if (nextField) {
                                    nextField.focus();
                                }
                            }
                        }
                    }
                });
            }
        });
    }

    // ==========================================
    // THEME AND UI FUNCTIONALITY
    // ==========================================

    // Section navigation
    const showEntryBtn = document.getElementById('showEntryBtn');
    const showViewBtn = document.getElementById('showViewBtn');
    const showSummaryBtn = document.getElementById('showSummaryBtn');
    const showKPIBtn = document.getElementById('showKPIBtn');
    
    const entrySection = document.getElementById('entrySection');
    const viewSection = document.getElementById('viewSection');
    const summarySection = document.getElementById('summarySection');
    
    function showSection(section) {
        // Hide all sections
        entrySection.classList.remove('active');
        viewSection.classList.remove('active');
        summarySection.classList.remove('active');
        
        // Reset button styles
        showEntryBtn.classList.remove('custom-btn');
        showViewBtn.classList.remove('custom-btn');
        showSummaryBtn.classList.remove('custom-btn');
        showKPIBtn.classList.remove('custom-btn');
        
        showEntryBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
        showViewBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
        showSummaryBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
        showKPIBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
        
        // Show selected section and highlight button
        if (section === 'entry') {
            entrySection.classList.add('active');
            showEntryBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
            showEntryBtn.classList.add('custom-btn');
        } else if (section === 'view') {
            viewSection.classList.add('active');
            showViewBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
            showViewBtn.classList.add('custom-btn');
            // Initialize based on current mode
            if (isFindMode) {
                fetchAllMasterData();
            } else {
                fetchAllData();
            }
        } else if (section === 'summary') {
            summarySection.classList.add('active');
            showSummaryBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
            showSummaryBtn.classList.add('custom-btn');
            fetchAllDataForSummary();
        }
    }
    
    showEntryBtn.addEventListener('click', () => showSection('entry'));
    showViewBtn.addEventListener('click', () => showSection('view'));
    showSummaryBtn.addEventListener('click', () => showSection('summary'));

    // Expand button functionality
    document.getElementById('expandBtn').addEventListener('click', function() {
        isExpanded = !isExpanded;
        toggleColumnVisibility();
        
        // Update button icon
        const icon = this.querySelector('i');
        if (isExpanded) {
            icon.className = 'fas fa-compress-alt';
            this.title = 'Collapse Columns';
        } else {
            icon.className = 'fas fa-expand-alt';
            this.title = 'Expand Columns';
        }
    });

    function toggleColumnVisibility() {
        const hiddenColumns = [
            '.cid-column', '.appid-column', '.action-column',
            '.search-cid-column', '.search-appid-column', '.search-action-column'
        ];
        
        hiddenColumns.forEach(selector => {
            const elements = document.querySelectorAll(selector);
            elements.forEach(element => {
                if (isExpanded) {
                    element.classList.remove('hidden-column');
                } else {
                    element.classList.add('hidden-column');
                }
            });
        });
    }

    // KPI Modal functionality
    const kpiModal = document.getElementById('kpiModal');
    const closeKPIModal = document.getElementById('closeKPIModal');
    
    showKPIBtn.addEventListener('click', function() {
        kpiModal.style.display = 'block';
        showKPIBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
        showKPIBtn.classList.add('custom-btn');
    });
    
    closeKPIModal.addEventListener('click', function() {
        kpiModal.style.display = 'none';
        showKPIBtn.classList.remove('custom-btn');
        showKPIBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
    });
    
    window.addEventListener('click', function(event) {
        if (event.target === kpiModal) {
            kpiModal.style.display = 'none';
            showKPIBtn.classList.remove('custom-btn');
            showKPIBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
        }
    });

    // Show success indicator
    function showSuccess(message) {
        const indicator = document.getElementById('successIndicator');
        const messageEl = document.getElementById('successMessage');
        
        messageEl.textContent = message;
        indicator.classList.remove('hidden');
        
        setTimeout(() => {
            indicator.classList.add('hidden');
        }, 3000);
    }

    // Show loading indicator
    function showLoading() {
        document.getElementById('loadingIndicator').classList.remove('hidden');
    }

    // Hide loading indicator
    function hideLoading() {
        document.getElementById('loadingIndicator').classList.add('hidden');
    }

    // ==========================================
    // EXISTING FORM AND DATA FUNCTIONALITY
    // ==========================================
    
    // Get all form elements
    const entryForm = document.getElementById('entryForm');
    const cidInput = document.getElementById('cid');
    const appIdInput = document.getElementById('appId');
    const dateInput = document.getElementById('date');
    const salaryInput = document.getElementById('salary');
    const customerNameInput = document.getElementById('customerName');
    const mobileInput = document.getElementById('mobile');
    const bankingSelect = document.getElementById('banking');
    const otherBankingSection = document.getElementById('otherBankingSection');
    const otherBankingInput = document.getElementById('otherBanking');
    const adcbOverrideCheckbox = document.getElementById('adcbOverride');
    const ccDeductionOverrideCheckbox = document.getElementById('ccDeductionOverride');
    const companyNameInput = document.getElementById('companyName');
    const statusSelect = document.getElementById('status');
    const otherStatusSection = document.getElementById('otherStatusSection');
    const otherStatusInput = document.getElementById('otherStatus');
    const pointsInput = document.getElementById('points');
    const productACC = document.getElementById('productACC');
    const product2ndACC = document.getElementById('product2ndACC');
    const productSTL = document.getElementById('productSTL');
    const productCC = document.getElementById('productCC');
    const product2ndCC = document.getElementById('product2ndCC');
    const productBTCCL = document.getElementById('productBTCCL');
    const productPL = document.getElementById('productPL');
    const productOther = document.getElementById('productOther');
    const loanAmountSection = document.getElementById('loanAmountSection');
    const loanAmountInput = document.getElementById('loanAmount');
    const otherPointsSection = document.getElementById('otherPointsSection');
    const otherPointsInput = document.getElementById('otherPoints');
    const productOptionsContainer = document.getElementById('productOptionsContainer');

    // Reset button
    document.getElementById('resetBtn').addEventListener('click', function() {
        resetForm();
    });

    // Form reset function
    function resetForm() {
        entryForm.reset();
        productOptionsContainer.innerHTML = '';
        loanAmountSection.classList.add('hidden');
        otherPointsSection.classList.add('hidden');
        otherBankingSection.classList.add('hidden');
        otherStatusSection.classList.add('hidden');
        
        document.getElementById('nameError').classList.add('hidden');
        document.getElementById('mobileError').classList.add('hidden');
        document.getElementById('productsError').classList.add('hidden');
        document.getElementById('companySuggestions').style.display = 'none';

        document.getElementById('submitBtn').classList.remove('hidden');
        document.getElementById('updateBtn').classList.add('hidden');
        document.getElementById('deleteBtn').classList.add('hidden');

        pointsInput.value = '';
        
        productSTL.disabled = true;
        product2ndACC.disabled = true;
        product2ndCC.disabled = true;
        productOther.checked = false;
        
        cidInput.disabled = false;
        cidInput.readOnly = false;
        
        document.querySelectorAll('.error-field').forEach(field => {
            field.classList.remove('error-field');
        });
        
        currentSelections = { ACC: '', ACC2: '', CC: '', CCOption2: '', PL: '' };
        editingData = null;
        editingProductString = "";
        editingFromMaster = false;
        selectedCCOptions.clear();
        
        adcbOverrideCheckbox.checked = false;
        ccDeductionOverrideCheckbox.checked = false;
        
        // Reset date to current date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date').value = today;
        
        // Reset activation visibility
        updateActivationVisibility();
    }

    // Banking select change event
    bankingSelect.addEventListener('change', function() {
        if (this.value === 'Other') {
            otherBankingSection.classList.remove('hidden');
        } else {
            otherBankingSection.classList.add('hidden');
        }
        calculateTotalPoints();
    });

    adcbOverrideCheckbox.addEventListener('change', function() {
        calculateTotalPoints();
    });

    ccDeductionOverrideCheckbox.addEventListener('change', function() {
        calculateTotalPoints();
    });

    statusSelect.addEventListener('change', function() {
        if (this.value === 'Other') {
            otherStatusSection.classList.remove('hidden');
        } else {
            otherStatusSection.classList.add('hidden');
        }
        
        if (this.value === 'Rejected') {
            pointsInput.value = '0';
        } else {
            calculateTotalPoints();
        }
    });

    // Initialize product options when proposition or products change
    function updateProductOptions() {
        if (!appInitialized) {
            console.log('App not initialized yet, skipping product options update');
            return;
        }
        
        console.log('Updating product options...');
        
        // Save current dropdown selections before updating
        const accSelect = document.getElementById('ACCSelect');
        const acc2Select = document.getElementById('ACC2Select');
        const ccSelect = document.getElementById('CCSelect');
        const ccSelect2 = document.getElementById('CCSelect2');
        const plSelect = document.getElementById('PLSelect');
        
        if (accSelect) currentSelections.ACC = accSelect.value;
        if (acc2Select) currentSelections.ACC2 = acc2Select.value;
        if (ccSelect) currentSelections.CC = ccSelect.value;
        if (ccSelect2) currentSelections.CCOption2 = ccSelect2.value;
        if (plSelect) currentSelections.PL = plSelect.value;
        
        productOptionsContainer.innerHTML = '';
        
        if (editingData) {
            console.log('In editing mode, using initializeProductOptions');
            initializeProductOptions();
            return;
        }
        
        const proposition = document.querySelector('input[name="proposition"]:checked').value;
        const salary = parseFloat(salaryInput.value) || 0;
        
        if (productACC.checked) {
            const accOptions = getACCOptions(proposition, salary);
            if (accOptions.length > 0) {
                const accDiv = createProductOptionDiv('ACC', accOptions);
                productOptionsContainer.appendChild(accDiv);
                
                const newAccSelect = accDiv.querySelector('select');
                newAccSelect.addEventListener('change', function() {
                    calculateTotalPoints();
                });
                
                if (currentSelections.ACC && newAccSelect.querySelector(`option[value="${currentSelections.ACC}"]`)) {
                    newAccSelect.value = currentSelections.ACC;
                }
            }
            
            if (product2ndACC.checked) {
                console.log('Creating 2nd ACC dropdown');
                const accOptions = getACCOptions(proposition, salary);
                if (accOptions.length > 0) {
                    const acc2Div = createProductOptionDiv('ACC2', accOptions, '2nd ACC');
                    productOptionsContainer.appendChild(acc2Div);
                    
                    const newAcc2Select = acc2Div.querySelector('select');
                    newAcc2Select.addEventListener('change', function() {
                        calculateTotalPoints();
                    });
                    
                    setTimeout(() => {
                        if (currentSelections.ACC2 && newAcc2Select.querySelector(`option[value="${currentSelections.ACC2}"]`)) {
                            newAcc2Select.value = currentSelections.ACC2;
                            console.log('Restored 2nd ACC selection:', currentSelections.ACC2);
                        }
                    }, 50);
                }
            }
        }
        
        if (productCC.checked) {
            const ccOptions = getCCOptions(proposition);
            if (ccOptions.length > 0) {
                const ccDiv = createProductOptionDiv('CC', ccOptions);
                productOptionsContainer.appendChild(ccDiv);
                
                const newCcSelect = ccDiv.querySelector('select');
                newCcSelect.addEventListener('change', function() {
                    updateSelectedCCOptions();
                    calculateTotalPoints();
                });
                
                if (currentSelections.CC && newCcSelect.querySelector(`option[value="${currentSelections.CC}"]`)) {
                    newCcSelect.value = currentSelections.CC;
                }
            }
            
            if (product2ndCC.checked) {
                const ccOptions = getCCOptions(proposition);
                if (ccOptions.length > 0) {
                    const cc2Div = createProductOptionDiv('CC2', ccOptions, '2nd CC');
                    productOptionsContainer.appendChild(cc2Div);
                    
                    const newCc2Select = cc2Div.querySelector('select');
                    newCc2Select.addEventListener('change', function() {
                        updateSelectedCCOptions();
                        calculateTotalPoints();
                    });
                    
                    if (currentSelections.CCOption2 && newCc2Select.querySelector(`option[value="${currentSelections.CCOption2}"]`)) {
                        newCc2Select.value = currentSelections.CCOption2;
                    }
                }
            }
        }
        
        if (productPL.checked) {
            const plOptions = getPLOptions(proposition);
            if (plOptions.length > 0) {
                const plDiv = createProductOptionDiv('PL', plOptions);
                productOptionsContainer.appendChild(plDiv);
                
                const newPlSelect = plDiv.querySelector('select');
                newPlSelect.addEventListener('change', calculateTotalPoints);
                
                if (currentSelections.PL && newPlSelect.querySelector(`option[value="${currentSelections.PL}"]`)) {
                    newPlSelect.value = currentSelections.PL;
                }
                
                loanAmountInput.addEventListener('input', calculateTotalPoints);
            }
        }
        
        setTimeout(() => {
            updateSelectedCCOptions();
        }, 100);
        
        calculateTotalPoints();
    }

    function updateSelectedCCOptions() {
        selectedCCOptions.clear();
        
        const ccSelect = document.getElementById('CCSelect');
        const cc2Select = document.getElementById('CCSelect2');
        
        if (ccSelect && ccSelect.value) {
            selectedCCOptions.add(ccSelect.value);
        }
        
        if (cc2Select && cc2Select.value) {
            selectedCCOptions.add(cc2Select.value);
        }
        
        // Disable selected options in other dropdowns
        if (ccSelect) {
            updateCCDropdownOptions(ccSelect, 'CC');
        }
        
        if (cc2Select) {
            updateCCDropdownOptions(cc2Select, 'CC2');
        }
    }

    function updateCCDropdownOptions(selectElement, selectType) {
        const currentValue = selectElement.value;
        const options = selectElement.querySelectorAll('option');
        
        options.forEach(option => {
            if (option.value === '') return; // Skip the default option
            
            const isCurrentSelection = option.value === currentValue;
            const isSelectedElsewhere = selectedCCOptions.has(option.value) && !isCurrentSelection;
            
            option.disabled = isSelectedElsewhere;
            option.style.display = isSelectedElsewhere ? 'none' : 'block';
        });
    }

    // Enhanced function to initialize product options with specific 2nd ACC handling
    function initializeProductOptions() {
        if (!editingData) {
            console.log('No editing data available');
            return;
        }
        
        console.log('Initializing product options for editing data');
        console.log('Product string:', editingProductString);
        console.log('2nd ACC checked:', product2ndACC.checked);
        
        const proposition = document.querySelector('input[name="proposition"]:checked').value;
        const salary = parseFloat(salaryInput.value) || 0;
        
        // Clear existing product options
        productOptionsContainer.innerHTML = '';
        
        if (productACC.checked) {
            const accOptions = getACCOptions(proposition, salary);
            
            if (accOptions.length > 0) {
                const accDiv = createProductOptionDiv('ACC', accOptions);
                productOptionsContainer.appendChild(accDiv);
                
                const accSelect = document.getElementById('ACCSelect');
                if (accSelect) {
                    accSelect.addEventListener('change', function() {
                        calculateTotalPoints();
                    });
                    
                    // Set value from saved data
                    setTimeout(() => {
                        setAccDropdownFromString(accSelect, editingProductString, 0);
                    }, 10);
                }
            }
            
            if (product2ndACC.checked) {
                console.log('Initializing 2nd ACC dropdown for editing');
                const accOptions = getACCOptions(proposition, salary);
                
                if (accOptions.length > 0) {
                    setTimeout(() => {
                        const acc2Div = createProductOptionDiv('ACC2', accOptions, '2nd ACC');
                        productOptionsContainer.appendChild(acc2Div);
                        
                        const acc2Select = document.getElementById('ACC2Select');
                        if (acc2Select) {
                            acc2Select.addEventListener('change', function() {
                                calculateTotalPoints();
                            });
                            
                            setTimeout(() => {
                                setAccDropdownFromString(acc2Select, editingProductString, 1);
                                console.log('Set 2nd ACC dropdown value');
                            }, 100);
                        }
                    }, 200);
                }
            }
        }
        
        if (productCC.checked) {
            const ccOptions = getCCOptions(proposition);
            
            if (ccOptions.length > 0) {
                const ccDiv = createProductOptionDiv('CC', ccOptions);
                productOptionsContainer.appendChild(ccDiv);
                
                const ccSelect = document.getElementById('CCSelect');
                if (ccSelect) {
                    ccSelect.addEventListener('change', function() {
                        updateSelectedCCOptions();
                        calculateTotalPoints();
                    });
                    
                    setTimeout(() => {
                        setCcDropdownFromString(ccSelect, editingProductString, 0);
                    }, 10);
                }
            }
            
            if (product2ndCC.checked) {
                const ccOptions = getCCOptions(proposition);
                
                if (ccOptions.length > 0) {
                    const cc2Div = createProductOptionDiv('CC2', ccOptions, '2nd CC');
                    productOptionsContainer.appendChild(cc2Div);
                    
                    const cc2Select = document.getElementById('CCSelect2');
                    if (cc2Select) {
                        cc2Select.addEventListener('change', function() {
                            updateSelectedCCOptions();
                            calculateTotalPoints();
                        });
                        
                        setTimeout(() => {
                            setCcDropdownFromString(cc2Select, editingProductString, 1);
                        }, 10);
                    }
                }
            }
        }
        
        if (productPL.checked) {
            const plOptions = getPLOptions(proposition);
            
            if (plOptions.length > 0) {
                const plDiv = createProductOptionDiv('PL', plOptions);
                productOptionsContainer.appendChild(plDiv);
                
                const plSelect = document.getElementById('PLSelect');
                if (plSelect) {
                    plSelect.addEventListener('change', calculateTotalPoints);
                    
                    setTimeout(() => {
                        setPlDropdownFromString(plSelect, editingProductString);
                    }, 10);
                }
                
                loanAmountInput.addEventListener('input', calculateTotalPoints);
            }
        }
        
        // Calculate points after initialization with longer delay
        setTimeout(() => {
            updateSelectedCCOptions();
            calculateTotalPoints();
        }, 300);
    }
    
    // Helper functions to set dropdown values correctly based on saved product string
    function setAccDropdownFromString(accSelect, productString, accIndex = 0) {
        if (!accSelect || !productString) return;
        
        const products = productString.split(',').map(p => p.trim());
        const accProducts = products.filter(p => 
            p.includes('MDSA') || 
            p.includes('Aspire') ||
            p.includes('Privilege')
        );
        
        console.log('ACC Products found:', accProducts, 'Index:', accIndex);
        
        if (accProducts.length > accIndex) {
            const targetProduct = accProducts[accIndex];
            console.log('Setting ACC dropdown to:', targetProduct);
            
            for (let option of accSelect.options) {
                const optionValue = option.value;
                const optionText = option.text;
                
                console.log('Checking option:', optionValue, optionText);
                
                if (targetProduct === 'MDSA' && optionValue === 'MDSA') {
                    accSelect.value = optionValue;
                    console.log('Set MDSA');
                    return;
                } else if (targetProduct.includes('Aspire 5K-10K') && optionValue === 'Aspire5K-10K') {
                    accSelect.value = optionValue;
                    console.log('Set Aspire5K-10K');
                    return;
                } else if (targetProduct.includes('Aspire 10K-20K') && optionValue === 'Aspire10K-20K') {
                    accSelect.value = optionValue;
                    console.log('Set Aspire10K-20K');
                    return;
                } else if (targetProduct.includes('Privilege 20K-40K') && optionValue === 'Privilege20K-40K') {
                    accSelect.value = optionValue;
                    console.log('Set Privilege20K-40K');
                    return;
                } else if (targetProduct.includes('Privilege 40K') && optionValue === 'Privilege40K+') {
                    accSelect.value = optionValue;
                    console.log('Set Privilege40K+');
                    return;
                }
            }
        }
    }
    
    function setCcDropdownFromString(ccSelect, productString, ccIndex = 0) {
        if (!ccSelect || !productString) return;
        
        const products = productString.split(',').map(p => p.trim());
        const ccProducts = products.filter(p => 
            p.includes('Touchpoints') || 
            p.includes('Cashback') ||
            p.includes('Talabat') ||
            p.includes('Lulu') ||
            p.includes('Etihad') ||
            p.includes('Shukran') ||
            p.includes('All ') ||
            p.includes('Traveller') ||
            p.includes('Betaqti') ||
            p.includes('Emirati')
        );
        
        console.log('CC Products found:', ccProducts, 'Index:', ccIndex);
        
        if (ccProducts.length > ccIndex) {
            const targetProduct = ccProducts[ccIndex];
            console.log('Setting CC dropdown to:', targetProduct);
            
            for (let option of ccSelect.options) {
                const optionText = option.text.toLowerCase();
                const targetText = targetProduct.toLowerCase();
                
                console.log('Checking CC option:', option.value, optionText);
                
                if ((targetText.includes('touchpoints') && optionText.includes('touchpoints')) ||
                    (targetText.includes('cashback') && optionText.includes('cashback')) ||
                    (targetText.includes('talabat') && optionText.includes('talabat')) ||
                    (targetText.includes('lulu') && optionText.includes('lulu')) ||
                    (targetText.includes('etihad') && optionText.includes('etihad')) ||
                    (targetText.includes('shukran') && optionText.includes('shukran')) ||
                    (targetText.includes('traveller') && optionText.includes('traveller')) ||
                    (targetText.includes('betaqti') && optionText.includes('betaqti')) ||
                    (targetText.includes('emirati') && optionText.includes('emirati'))) {
                    
                    if ((targetText.includes('gold') && optionText.includes('gold')) ||
                        (targetText.includes('platinum') && optionText.includes('platinum')) ||
                        (targetText.includes('titanium') && optionText.includes('titanium')) ||
                        (targetText.includes('signature') && optionText.includes('signature')) ||
                        (targetText.includes('infinite') && optionText.includes('infinite')) ||
                        (targetText.includes('365') && optionText.includes('365')) ||
                        (!targetText.includes('gold') && !targetText.includes('platinum') && 
                         !targetText.includes('titanium') && !targetText.includes('signature') && 
                         !targetText.includes('infinite') && !targetText.includes('365'))) {
                        ccSelect.value = option.value;
                        console.log('Set CC to:', option.value);
                        return;
                    }
                }
            }
        }
    }
    
    function setPlDropdownFromString(plSelect, productString) {
        if (!plSelect || !productString) return;
        
        console.log('Setting PL dropdown from:', productString);
        
        if (productString.includes('PL Asp-A&B')) {
            selectOptionByValue(plSelect, 'PLAspAB');
        } else if (productString.includes('PL Prv-A&B')) {
            selectOptionByValue(plSelect, 'PLPrvAB');
        } else if (productString.includes('PL Asp-C&Below')) {
            selectOptionByValue(plSelect, 'PLAspCBelow');
        } else if (productString.includes('PL Prv-C&Below')) {
            selectOptionByValue(plSelect, 'PLPrvCBelow');
        } else if (productString.includes('TOP UP')) {
            selectOptionByValue(plSelect, 'TOPUP');
        }
    }
    
    function selectOptionByValue(selectElement, value) {
        if (!selectElement) return false;
        
        for (let option of selectElement.options) {
            if (option.value === value) {
                selectElement.value = value;
                console.log('Set option to:', value);
                return true;
            }
        }
        
        console.log('Option not found:', value);
        return false;
    }

    // Create a product option div with dropdown
    function createProductOptionDiv(productType, options, customLabel) {
        const div = document.createElement('div');
        const label = customLabel || productType + ' Option';
        const id = productType === 'CC2' ? 'CCSelect2' : 
                  productType === 'ACC2' ? 'ACC2Select' : 
                  `${productType}Select`;
        
        let optionsHtml = '<option value="">Select ' + label + '</option>';
        
        options.forEach(option => {
            const extraAttributes = [];
            
            if (option.points) {
                extraAttributes.push(`data-points="${option.points}"`);
            }
            
            if (option.paid !== undefined) {
                extraAttributes.push(`data-paid="${option.paid}"`);
            }
            
            if (option.disableSTL !== undefined) {
                extraAttributes.push(`data-disablestl="${option.disableSTL}"`);
            }
            
            if (option.minSalary !== undefined) {
                extraAttributes.push(`data-minsalary="${option.minSalary}"`);
            }
            
            if (option.maxSalary !== undefined) {
                extraAttributes.push(`data-maxsalary="${option.maxSalary}"`);
            }
            
            optionsHtml += `<option value="${option.value}" ${extraAttributes.join(' ')}>${option.text}</option>`;
        });
        
        div.innerHTML = `
            <label for="${id}" class="styled-label">${label}</label>
            <select id="${id}" class="styled-select" data-product="${productType}">
                ${optionsHtml}
            </select>
        `;
        return div;
    }

    // Get ACC options based on proposition and salary
    function getACCOptions(proposition, salary) {
        const options = [];
        
        options.push({ value: "Aspire5K-10K", text: "Aspire 5K-10K", points: 150, minSalary: 5000, maxSalary: 9999, disableSTL: false });
        options.push({ value: "Aspire10K-20K", text: "Aspire 10K-20K", points: 400, minSalary: 10000, maxSalary: 19999, disableSTL: false });
        options.push({ value: "Privilege20K-40K", text: "Privilege 20K-40K", points: 550, minSalary: 20000, maxSalary: 39999, disableSTL: false });
        options.push({ value: "Privilege40K+", text: "Privilege 40K & Above", points: 800, minSalary: 40000, maxSalary: Infinity, disableSTL: false });
        
        if (proposition === "Islamic" || proposition === "Both") {
            options.push({ 
                value: "MDSA", 
                text: "MDSA", 
                points: 110,
                minSalary: 3000,
                maxSalary: Infinity,
                disableSTL: false
            });
        }
        
        return options;
    }

    // Get CC options based on proposition with updated points and removed options
    function getCCOptions(proposition) {
        if (proposition === "Conventional") {
            return [
                { value: "TouchpointsGoldVisa", text: "Touchpoints Gold Visa", points: 300, paid: false },
                { value: "TouchpointsTitaniumMC", text: "Touchpoints Titanium MC", points: 200, paid: false },
                { value: "EssientialCashbackMC", text: "Essiential Cashback MC", points: 200, paid: false },
                { value: "TalabatMC", text: "Talabat MC", points: 150, paid: false },
                { value: "LuluTitaniumMC", text: "Lulu Titanium MC", points: 200, paid: false },
                { value: "LuluPlatinumMC", text: "Lulu Platinum MC", points: 200, paid: false },
                { value: "TouchpointsPlatinumMC", text: "Touchpoints Platinum MC", points: 400, paid: true },
                { value: "365CashbackVisa", text: "365 Cashback Visa", points: 500, paid: true },
                { value: "ShukranPlatinumVisa", text: "Shukran Platinum Visa", points: 300, paid: true },
                { value: "EtihadGuestPlatinumVisa", text: "Etihad Guest Platinum Visa", points: 500, paid: true },
                { value: "EtihadGuestSignatureVisa", text: "Etihad Guest Signature Visa", points: 500, paid: true },
                { value: "EtihadGuestInfiniteVisa", text: "Etihad Guest Infinite Visa", points: 750, paid: true },
                { value: "TouchpointsInfiniteVisa", text: "Touchpoints Infinite Visa", points: 800, paid: true },
                { value: "TravellerMCWorldElite", text: "Traveller MC World Elite", points: 800, paid: true },
                { value: "BetaqtiMCWorldElite", text: "Betaqti MC World Elite", points: 1000, paid: true }
            ];
        } else if (proposition === "Islamic") {
            return [
                { value: "TouchpointsGoldVisa", text: "Touchpoints Gold Visa", points: 300, paid: false },
                { value: "TalabatMC", text: "Talabat MC", points: 150, paid: false },
                { value: "TouchpointsPlatinumVisa", text: "Touchpoints Platinum Visa", points: 500, paid: true },
                { value: "365CashbackVisa", text: "365 Cashback Visa", points: 500, paid: true },
                { value: "ShukranPlatinumVisa", text: "Shukran Platinum Visa", points: 300, paid: true },
                { value: "EtihadGuestPlatinumVisa", text: "Etihad Guest Platinum Visa", points: 500, paid: true },
                { value: "EtihadGuestSignatureVisa", text: "Etihad Guest Signature Visa", points: 500, paid: true },
                { value: "TouchpointsInfiniteVisa", text: "Touchpoints Infinite Visa", points: 800, paid: true },
                { value: "EtihadGuestInfiniteVisa", text: "Etihad Guest Infinite Visa", points: 750, paid: true },
                { value: "EmiratiIslamicInfiniteVisa", text: "Emirati Islamic Infinite Visa", points: 750, paid: true }
            ];
        } else if (proposition === "Both") {
            const conventional = getCCOptions("Conventional");
            const islamic = getCCOptions("Islamic");
            const combinedOptions = [...conventional];
            
            islamic.forEach(islamicOption => {
                if (!conventional.some(convOption => convOption.value === islamicOption.value)) {
                    combinedOptions.push(islamicOption);
                }
            });
            
            return combinedOptions;
        }
        
        return [];
    }

    // Updated PL options with new names and TOP UP option
    function getPLOptions(proposition) {
        return [
            { value: "PLAspAB", text: "PL Asp-A&B", points: "0.50%" },
            { value: "PLPrvAB", text: "PL Prv-A&B", points: "0.50%" },
            { value: "PLAspCBelow", text: "PL Asp-C&Below", points: "0.25%" },
            { value: "PLPrvCBelow", text: "PL Prv-C&Below", points: "0.25%" },
            { value: "TOPUP", text: "TOP UP", points: "0%" }
        ];
    }

    // Updated calculate total points function to handle 50% deduction override
    function calculateTotalPoints() {
        if (statusSelect.value === 'Rejected') {
            pointsInput.value = '0';
            return;
        }
        
        let totalPoints = 0;
        const isAccCompletedUnderReview = statusSelect.value === 'ACC Completed, Under Review';
        
        // Handle ACC Completed, Under Review special case
        if (isAccCompletedUnderReview) {
            if (productACC.checked) {
                const accSelect = document.getElementById('ACCSelect');
                if (accSelect && accSelect.value) {
                    const selectedOption = accSelect.options[accSelect.selectedIndex];
                    const accPoints = parseInt(selectedOption.dataset.points) || 0;
                    totalPoints += accPoints;
                }
            }
            
            if (product2ndACC.checked) {
                const acc2Select = document.getElementById('ACC2Select');
                if (acc2Select && acc2Select.value) {
                    const selectedOption = acc2Select.options[acc2Select.selectedIndex];
                    const acc2Points = parseInt(selectedOption.dataset.points) || 0;
                    totalPoints += acc2Points;
                }
            }
            
            if (productCC.checked) {
                const ccSelect = document.getElementById('CCSelect');
                if (ccSelect && ccSelect.value) {
                    const selectedOption = ccSelect.options[ccSelect.selectedIndex];
                    let ccPoints = parseInt(selectedOption.dataset.points) || 0;
                    
                    if (!productACC.checked) {
                        // If 50% deduction is checked, ignore ADCB override and apply 50%
                        if (ccDeductionOverrideCheckbox.checked) {
                            ccPoints = Math.round(ccPoints * 0.5);
                        } else if (!adcbOverrideCheckbox.checked && bankingSelect.value !== 'ADCB') {
                            ccPoints = Math.round(ccPoints * 0.7);
                        }
                    } else {
                        // Apply 50% deduction even when ACC is checked if override is selected
                        if (ccDeductionOverrideCheckbox.checked) {
                            ccPoints = Math.round(ccPoints * 0.5);
                        }
                    }
                    
                    totalPoints += ccPoints;
                    
                    if (product2ndCC.checked) {
                        const cc2Select = document.getElementById('CCSelect2');
                        if (cc2Select && cc2Select.value) {
                            const selectedOption2 = cc2Select.options[cc2Select.selectedIndex];
                            const isPaid = selectedOption2.dataset.paid === "true";
                            
                            totalPoints += isPaid ? 250 : 80;
                        }
                    }
                }
            }
            
            if (productBTCCL.checked) {
                totalPoints += 100;
            }
            
            if (productOther.checked) {
                const otherPointsValue = parseFloat(otherPointsInput.value) || 0;
                totalPoints += otherPointsValue;
            }
            
            if (productPL.checked) {
                const plSelect = document.getElementById('PLSelect');
                const loanAmount = parseFloat(loanAmountInput.value) || 0;
                
                if (plSelect && plSelect.value && loanAmount > 0) {
                    const selectedOption = plSelect.options[plSelect.selectedIndex];
                    const pointsPercentage = selectedOption.dataset.points;
                    
                    if (pointsPercentage === "0%" || plSelect.value === "TOPUP") {
                        totalPoints += 0;
                    } else if (pointsPercentage === "0.50%") {
                        totalPoints += loanAmount * 0.005;
                    } else if (pointsPercentage === "0.25%") {
                        totalPoints += loanAmount * 0.0025;
                    }
                }
            }
            
            pointsInput.value = totalPoints.toFixed(2);
            return;
        }
        
        // Regular point calculation for all other statuses
        if (productACC.checked) {
            const accSelect = document.getElementById('ACCSelect');
            if (accSelect && accSelect.value) {
                const selectedOption = accSelect.options[accSelect.selectedIndex];
                const accPoints = parseInt(selectedOption.dataset.points) || 0;
                
                if (productSTL.checked && !productSTL.disabled) {
                    totalPoints += accPoints;
                }
            }
        }
        
        if (product2ndACC.checked) {
            const acc2Select = document.getElementById('ACC2Select');
            if (acc2Select && acc2Select.value) {
                const selectedOption = acc2Select.options[acc2Select.selectedIndex];
                const acc2Points = parseInt(selectedOption.dataset.points) || 0;
                
                if (productSTL.checked && !productSTL.disabled) {
                    totalPoints += acc2Points;
                }
            }
        }
        
        if (productCC.checked) {
            const ccSelect = document.getElementById('CCSelect');
            if (ccSelect && ccSelect.value) {
                const selectedOption = ccSelect.options[ccSelect.selectedIndex];
                let ccPoints = parseInt(selectedOption.dataset.points) || 0;
                
                if (!productACC.checked) {
                    // If 50% deduction is checked, ignore ADCB override and apply 50%
                    if (ccDeductionOverrideCheckbox.checked) {
                        ccPoints = Math.round(ccPoints * 0.5);
                    } else if (!adcbOverrideCheckbox.checked && bankingSelect.value !== 'ADCB') {
                        ccPoints = Math.round(ccPoints * 0.7);
                    }
                } else {
                    // Apply 50% deduction even when ACC is checked if override is selected
                    if (ccDeductionOverrideCheckbox.checked) {
                        ccPoints = Math.round(ccPoints * 0.5);
                    }
                }
                
                totalPoints += ccPoints;
                
                if (product2ndCC.checked) {
                    const cc2Select = document.getElementById('CCSelect2');
                    if (cc2Select && cc2Select.value) {
                        const selectedOption2 = cc2Select.options[cc2Select.selectedIndex];
                        const isPaid = selectedOption2.dataset.paid === "true";
                        
                        totalPoints += isPaid ? 250 : 80;
                    }
                }
            }
        }
        
        if (productBTCCL.checked) {
            totalPoints += 100;
        }
        
        if (productOther.checked) {
            const otherPointsValue = parseFloat(otherPointsInput.value) || 0;
            totalPoints += otherPointsValue;
        }
        
        if (productPL.checked) {
            const plSelect = document.getElementById('PLSelect');
            const loanAmount = parseFloat(loanAmountInput.value) || 0;
            
            if (plSelect && plSelect.value && loanAmount > 0) {
                const selectedOption = plSelect.options[plSelect.selectedIndex];
                const pointsPercentage = selectedOption.dataset.points;
                
                if (pointsPercentage === "0%" || plSelect.value === "TOPUP") {
                    totalPoints += 0;
                } else if (pointsPercentage === "0.50%") {
                    totalPoints += loanAmount * 0.005;
                } else if (pointsPercentage === "0.25%") {
                    totalPoints += loanAmount * 0.0025;
                }
            }
        }
        
        pointsInput.value = totalPoints.toFixed(2);
    }

    // ==========================================
    // GOOGLE SHEETS INTEGRATION
    // ==========================================

    // Fetch all data from Google Sheets Data sheet
    async function fetchAllData() {
        showLoading();
        try {
            const response = await fetch(`${scriptURL}?action=getAll`);
            const data = await response.json();
            
            if (data.success) {
                allRecordsData = data.data || [];
                
                isShowingAllRecords = false;
                const displayData = allRecordsData.slice(-maxInitialRecords);
                displayDataInTable(displayData, 'dataTableBody', false, false, 'data');
                calculatePointsTotals(allRecordsData);
                
                // Update status options for filter dropdown
                fetchStatusOptions();
            } else {
                showSuccess(`Error: ${data.error}`);
                document.getElementById('dataTableBody').innerHTML = '<tr><td colspan="8" class="text-center py-4">Error loading data from server</td></tr>';
            }
        } catch (error) {
            console.error('Error fetching data:', error);
            showSuccess('Error fetching data from server.');
            document.getElementById('dataTableBody').innerHTML = '<tr><td colspan="8" class="text-center py-4">Error connecting to server</td></tr>';
        } finally {
            hideLoading();
        }
    }

    document.getElementById('showAllRecordsBtn').addEventListener('click', function() {
        if (!isShowingAllRecords && allRecordsData.length > 0) {
            displayDataInTable(allRecordsData, 'dataTableBody', false, false, 'data');
            isShowingAllRecords = true;
            this.innerHTML = '<i class="fas fa-list-alt mr-2"></i>';
        } else {
            const displayData = allRecordsData.slice(-maxInitialRecords);
            displayDataInTable(displayData, 'dataTableBody', false, false, 'data');
            isShowingAllRecords = false;
            this.innerHTML = '<i class="fas fa-list mr-2"></i>';
        }
    });

    function calculatePointsTotals(data) {
        let earnedPoints = 0;
        let pendingPoints = 0;
        
        data.forEach(record => {
            const points = parseFloat(record.Points) || 0;
            if (record.Status === 'Completed') {
                earnedPoints += points;
            } else if (record.Status !== 'Rejected') {
                pendingPoints += points;
            }
        });
        
        document.getElementById('earnedPointsTotal').textContent = Math.round(earnedPoints);
        document.getElementById('pendingPointsTotal').textContent = Math.round(pendingPoints);
    }

    async function fetchAllDataForSummary() {
        showLoading();
        try {
            const response = await fetch(`${scriptURL}?action=getAll`);
            const data = await response.json();
            
            if (data.success) {
                populateSummaryData(data.data || []);
            } else {
                showSuccess(`Error: ${data.error}`);
            }
        } catch (error) {
            console.error('Error fetching data for summary:', error);
            showSuccess('Error fetching data from server.');
        } finally {
            hideLoading();
        }
    }

    function populateSummaryData(data) {
        if (!data || data.length === 0) {
            document.getElementById('summaryEarnedPoints').textContent = "0";
            document.getElementById('summaryPendingPoints').textContent = "0";
            document.getElementById('summaryTotalPoints').textContent = "0";
            
            document.getElementById('summaryInProgressCC').textContent = "0";
            document.getElementById('summaryInProgressPL').textContent = "AED 0";
            document.getElementById('summaryInProgressMDSA').textContent = "0";
            document.getElementById('summaryInProgressPrivilege').textContent = "0";
            
            document.getElementById('summaryCompletedCC').textContent = "0";
            document.getElementById('summaryCompletedPL').textContent = "AED 0";
            document.getElementById('summaryCompletedMDSA').textContent = "0";
            document.getElementById('summaryCompletedPrivilege').textContent = "0";
            
            document.getElementById('summaryTotalCC').textContent = "0";
            document.getElementById('summaryTotalPL').textContent = "AED 0";
            document.getElementById('summaryTotalAccounts').textContent = "0";
            
            document.getElementById('fundingTotal').textContent = "0 (0 pts)";
            document.getElementById('fundingMDSACount').textContent = "0";
            document.getElementById('fundingMDSAPoints').textContent = "(0 pts)";
            document.getElementById('fundingAspireCount').textContent = "0";
            document.getElementById('fundingAspirePoints').textContent = "(0 pts)";
            document.getElementById('fundingPrivilegeCount').textContent = "0";
            document.getElementById('fundingPrivilegePoints').textContent = "(0 pts)";
            return;
        }
        
        let earnedPoints = 0, pendingPoints = 0;
        let inProgressCC = 0, completedCC = 0;
        let inProgressLoanAmount = 0, completedLoanAmount = 0;
        let inProgressMDSA = 0, completedMDSA = 0;
        let inProgressPrivilege = 0, completedPrivilege = 0;
        let conventionalCount = 0, islamicCount = 0, bothCount = 0;
        let aspireCount = 0, privilegeCount = 0, mdsaCount = 0;
        let tmlAllCount = 0, tmlCCCount = 0, tmSelectCount = 0, ntmlCount = 0;
        
        // Separate Personal Loan and Credit Card proposition counts
        let plConventionalCount = 0, plIslamicCount = 0, plBothCount = 0;
        let ccConventionalCount = 0, ccIslamicCount = 0, ccBothCount = 0;
        let plTotalAmount = 0, ccTotalCount = 0;
        
        // Account Funding calculations
        let fundingMDSACount = 0, fundingMDSAPoints = 0;
        let fundingAspireCount = 0, fundingAspirePoints = 0;
        let fundingPrivilegeCount = 0, fundingPrivilegePoints = 0;
        
        data.forEach(record => {
            const points = parseFloat(record.Points) || 0;
            const isCompleted = record.Status === 'Completed';
            const isRejected = record.Status === 'Rejected';
            const isAccCompletedUnderReview = record.Status === 'ACC Completed, Under Review';
            const productString = record.Product || '';
            const proposition = record.Proposition || '';
            const scheme = record.Scheme || '';
            const loanAmount = parseFloat(record['Loan Amount']) || 0;
            
            if (isCompleted) {
                earnedPoints += points;
            } else if (!isRejected) {
                pendingPoints += points;
            }
            
            // Check if record has Personal Loan or Credit Card products
            const hasPL = productString.includes('PL Asp-A&B') || 
                         productString.includes('PL Asp-C&Below') || 
                         productString.includes('PL Prv-A&B') || 
                         productString.includes('PL Prv-C&Below') || 
                         productString.includes('TOP UP');
            
            const hasCC = productString.includes('Touchpoints') ||
                         productString.includes('Cashback') ||
                         productString.includes('Talabat') ||
                         productString.includes('Lulu') ||
                         productString.includes('Etihad') ||
                         productString.includes('Shukran') ||
                         productString.includes('All ') ||
                         productString.includes('Traveller') ||
                         productString.includes('Betaqti') ||
                         productString.includes('Emirati') ||
                         productString.includes('Visa') ||
                         productString.includes('MC');
            
            // Count proposition distribution for PL and CC separately
            if (hasPL && loanAmount > 0) {
                plTotalAmount += loanAmount;
                if (proposition === 'Conventional') {
                    plConventionalCount++;
                } else if (proposition === 'Islamic') {
                    plIslamicCount++;
                } else if (proposition === 'Both') {
                    plBothCount++;
                }
            }
            
            if (hasCC) {
                ccTotalCount++;
                if (proposition === 'Conventional') {
                    ccConventionalCount++;
                } else if (proposition === 'Islamic') {
                    ccIslamicCount++;
                } else if (proposition === 'Both') {
                    ccBothCount++;
                }
            }
            
            // Account Funding logic
            if (!isRejected && !productString.includes('STL')) {
                if (productString.includes('MDSA')) {
                    fundingMDSACount++;
                    fundingMDSAPoints += 110;
                } 
                
                if (productString.includes('Aspire 5K-10K') || productString.includes('Aspire 10K-20K')) {
                    fundingAspireCount++;
                    if (productString.includes('Aspire 5K-10K')) {
                        fundingAspirePoints += 150;
                    } else if (productString.includes('Aspire 10K-20K')) {
                        fundingAspirePoints += 400;
                    }
                }
                
                if (productString.includes('Privilege 20K-40K') || productString.includes('Privilege 40K')) {
                    fundingPrivilegeCount++;
                    if (productString.includes('Privilege 20K-40K')) {
                        fundingPrivilegePoints += 550;
                    } else if (productString.includes('Privilege 40K')) {
                        fundingPrivilegePoints += 800;
                    }
                }
            }
            
            let ccCount = 0;
            const ccOptions = getCCOptions('Both');
            const allCCNames = ccOptions.map(option => option.text);
            
            const isCreditCard = (product) => {
                return allCCNames.some(ccName => 
                    product.includes(ccName) || 
                    (product.includes('Visa') && !product.includes('BT/CCL')) ||
                    (product.includes('MC') && !product.includes('BT/CCL')) ||
                    (product === 'CC') || 
                    (product === '2ndCC')
                );
            };
            
            if (productString) {
                const products = productString.split(',').map(p => p.trim());
                
                products.forEach(product => {
                    if (isCreditCard(product)) {
                        ccCount++;
                    }
                });
            }

            const hasMDSA = productString.includes('MDSA');
            const hasPrivilege = productString.includes('Privilege');

            if (isAccCompletedUnderReview) {
                // For ACC products (MDSA/Privilege), count as completed
                if (hasMDSA) completedMDSA++;
                if (hasPrivilege) completedPrivilege++;
                
                // For other products (CC/PL), count as in progress
                if (hasCC) inProgressCC += ccCount;
                if (hasPL && loanAmount > 0) {
                    inProgressLoanAmount += loanAmount;
                }
            } else {
                // Regular logic for other statuses
                if (isCompleted) {
                    completedCC += ccCount;
                    if (loanAmount > 0) {
                        completedLoanAmount += loanAmount;
                    }
                    if (hasMDSA) completedMDSA++;
                    if (hasPrivilege) completedPrivilege++;
                } else if (!isRejected) {
                    inProgressCC += ccCount;
                    if (loanAmount > 0) {
                        inProgressLoanAmount += loanAmount;
                    }
                    if (hasMDSA) inProgressMDSA++;
                    if (hasPrivilege) inProgressPrivilege++;
                }
            }
            
            if (proposition === 'Conventional') {
                conventionalCount++;
            } else if (proposition === 'Islamic') {
                islamicCount++;
            } else if (proposition === 'Both') {
                bothCount++;
            }
            
            if (productString.includes('Aspire')) {
                aspireCount++;
            } else if (productString.includes('Privilege')) {
                privilegeCount++;
            } else if (productString.includes('MDSA')) {
                mdsaCount++;
            }
            
            if (isCompleted) {
                if (scheme === 'TML ALL') {
                    tmlAllCount++;
                } else if (scheme === 'TML CC') {
                    tmlCCCount++;
                } else if (scheme === 'TM SELECT') {
                    tmSelectCount++;
                } else if (scheme === 'NTML') {
                    ntmlCount++;
                }
            }
        });
        
        const totalPoints = earnedPoints + pendingPoints;
        const totalCC = inProgressCC + completedCC;
        const totalLoanAmount = inProgressLoanAmount + completedLoanAmount;
        const totalAccounts = aspireCount + privilegeCount + mdsaCount;
        
        function formatCurrency(amount) {
            return 'AED ' + amount.toLocaleString('en-US');
        }
        
        document.getElementById('summaryEarnedPoints').textContent = Math.round(earnedPoints);
        document.getElementById('summaryPendingPoints').textContent = Math.round(pendingPoints);
        document.getElementById('summaryTotalPoints').textContent = Math.round(totalPoints);
        
        document.getElementById('summaryInProgressCC').textContent = inProgressCC;
        document.getElementById('summaryInProgressPL').textContent = formatCurrency(inProgressLoanAmount);
        document.getElementById('summaryInProgressMDSA').textContent = inProgressMDSA;
        document.getElementById('summaryInProgressPrivilege').textContent = inProgressPrivilege;
        
        document.getElementById('summaryCompletedCC').textContent = completedCC;
        document.getElementById('summaryCompletedPL').textContent = formatCurrency(completedLoanAmount);
        document.getElementById('summaryCompletedMDSA').textContent = completedMDSA;
        document.getElementById('summaryCompletedPrivilege').textContent = completedPrivilege;
        
        document.getElementById('summaryTotalCC').textContent = totalCC > 0 ? totalCC : "0";
        document.getElementById('summaryTotalPL').textContent = formatCurrency(totalLoanAmount > 0 ? totalLoanAmount : 0);
        document.getElementById('summaryTotalAccounts').textContent = totalAccounts > 0 ? totalAccounts : "0";
        
        // Update Account Funding section
        const totalFundingCount = fundingMDSACount + fundingAspireCount + fundingPrivilegeCount;
        const totalFundingPoints = fundingMDSAPoints + fundingAspirePoints + fundingPrivilegePoints;
        
        document.getElementById('fundingTotal').textContent = `${totalFundingCount} (${totalFundingPoints} pts)`;
        document.getElementById('fundingMDSACount').textContent = `${fundingMDSACount}`;
        document.getElementById('fundingMDSAPoints').textContent = `(${fundingMDSAPoints} pts)`;
        document.getElementById('fundingAspireCount').textContent = `${fundingAspireCount}`;
        document.getElementById('fundingAspirePoints').textContent = `(${fundingAspirePoints} pts)`;
        document.getElementById('fundingPrivilegeCount').textContent = `${fundingPrivilegeCount}`;
        document.getElementById('fundingPrivilegePoints').textContent = `(${fundingPrivilegePoints} pts)`;
        
        updateTargetProgress('CC', completedCC);
        updateTargetProgress('PL', completedLoanAmount);
        updateTargetProgress('ACC', totalAccounts);
        
        updateVisualizations(conventionalCount, islamicCount, bothCount, aspireCount, privilegeCount, mdsaCount, tmlAllCount, tmlCCCount, tmSelectCount, ntmlCount, plConventionalCount, plIslamicCount, plBothCount, ccConventionalCount, ccIslamicCount, ccBothCount);
    }

    function updateVisualizations(conventional, islamic, both, aspire, privilege, mdsa, tmlAll, tmlCC, tmSelect, ntml, plConventional, plIslamic, plBoth, ccConventional, ccIslamic, ccBoth) {
        const totalProposition = conventional + islamic + both || 1;
        const totalAccounts = aspire + privilege + mdsa || 1;
        const totalSchemes = tmlAll + tmlCC + tmSelect + ntml || 1;
        
        // Calculate percentages for PL and CC propositions separately
        const totalPL = plConventional + plIslamic + plBoth || 1;
        const totalCC = ccConventional + ccIslamic + ccBoth || 1;
        
        const plConventionalPercent = Math.round((plConventional / totalPL) * 100);
        const plIslamicPercent = Math.round((plIslamic / totalPL) * 100);
        const plBothPercent = 100 - plConventionalPercent - plIslamicPercent;
        
        const ccConventionalPercent = Math.round((ccConventional / totalCC) * 100);
        const ccIslamicPercent = Math.round((ccIslamic / totalCC) * 100);
        const ccBothPercent = 100 - ccConventionalPercent - ccIslamicPercent;
        
        const aspirePercent = Math.round((aspire / totalAccounts) * 100);
        const privilegePercent = Math.round((privilege / totalAccounts) * 100);
        const mdsaPercent = 100 - aspirePercent - privilegePercent;
        
        const tmlAllPercent = Math.round((tmlAll / totalSchemes) * 100);
        const tmlCCPercent = Math.round((tmlCC / totalSchemes) * 100);
        const tmSelectPercent = Math.round((tmSelect / totalSchemes) * 100);
        const ntmlPercent = 100 - tmlAllPercent - tmlCCPercent - tmSelectPercent;
        
        // Update PL Proposition Chart
        document.querySelector('.pl-proposition-chart').style.background = `conic-gradient(
            #FF5349 0% ${plConventionalPercent}%, 
            #2197b2 ${plConventionalPercent}% ${plConventionalPercent + plIslamicPercent}%, 
            #d8dee9 ${plConventionalPercent + plIslamicPercent}% 100%
        )`;
        
        // Update CC Proposition Chart
        document.querySelector('.cc-proposition-chart').style.background = `conic-gradient(
            #32CD32 0% ${ccConventionalPercent}%, 
            #FF8C00 ${ccConventionalPercent}% ${ccConventionalPercent + ccIslamicPercent}%, 
            #9370DB ${ccConventionalPercent + ccIslamicPercent}% 100%
        )`;
        
        document.querySelector('.acc-chart').style.background = `conic-gradient(
            #FEFE22 0% ${aspirePercent}%, 
            #F96714 ${aspirePercent}% ${aspirePercent + privilegePercent}%, 
            #2197b2 ${aspirePercent + privilegePercent}% 100%
        )`;
        
        document.querySelector('.scheme-chart').style.background = `conic-gradient(
            #77DDE7 0% ${tmlAllPercent}%, 
            #FF1DCE ${tmlAllPercent}% ${tmlAllPercent + tmlCCPercent}%, 
            #B2EC5D ${tmlAllPercent + tmlCCPercent}% ${tmlAllPercent + tmlCCPercent + tmSelectPercent}%, 
            #A2ADD0 ${tmlAllPercent + tmlCCPercent + tmSelectPercent}% 100%
        )`;
        
        const plDominantPercent = Math.max(plConventionalPercent, plIslamicPercent, plBothPercent);
        const ccDominantPercent = Math.max(ccConventionalPercent, ccIslamicPercent, ccBothPercent);
        const accDominantPercent = Math.max(aspirePercent, privilegePercent, mdsaPercent);
        const schemeDominantPercent = Math.max(tmlAllPercent, tmlCCPercent, tmSelectPercent, ntmlPercent);
        
        document.getElementById('plChartPercentage').textContent = `${plDominantPercent}%`;
        document.getElementById('ccChartPercentage').textContent = `${ccDominantPercent}%`;
        document.getElementById('accChartPercentage').textContent = `${accDominantPercent}%`;
        document.getElementById('schemeChartPercentage').textContent = `${schemeDominantPercent}%`;
    }
    
    function updateTargetProgress(type, completed) {
        const targetInput = document.getElementById(`target${type}`);
        const remainingEl = document.getElementById(`remaining${type}`);
        const progressEl = document.getElementById(`progress${type}`);
        
        const target = parseInt(targetInput.value) || 0;
        const remaining = Math.max(0, target - completed);
        const percentage = target > 0 ? Math.round((completed / target) * 100) : 0;
        
        remainingEl.textContent = type === 'PL' ? remaining.toLocaleString('en-US') : remaining;
        progressEl.style.width = `${Math.min(100, percentage)}%`;
        progressEl.textContent = `${percentage}%`;
        
        targetInput.addEventListener('change', function() {
            updateTargetProgress(type, completed);
        });
    }
    
    // Enhanced product grouping for export
    function categorizeProductType(productString) {
        if (!productString) return "Unknown";
        
        // Check for updated PL products first
        if (productString.includes("PL Asp-A&B") || 
            productString.includes("PL Asp-C&Below") ||
            productString.includes("PL Prv-A&B") ||
            productString.includes("PL Prv-C&Below") ||
            productString.includes("TOP UP") ||
            productString.includes("PL")) {
            return "PL";
        }
        
        // Group ACC types together
        if (productString.includes("MDSA") || 
            productString.includes("Aspire") || 
            productString.includes("Privilege") ||
            productString.includes("ACC") ||
            productString.includes("2nd ACC")) {
            return "ACC";
        }
        
        // Group CC types together
        if (productString.includes("Touchpoints") || 
            productString.includes("Cashback") ||
            productString.includes("Talabat") ||
            productString.includes("Visa") ||
            productString.includes("MC") ||
            productString.includes("Guest") ||
            productString.includes("CC") ||
            productString.includes("2ndCC")) {
            return "CC";
        }
        
        if (productString.includes("BT/CCL")) return "BT/CCL";
        if (productString.includes("STL")) return "STL";
        
        return "Unknown";
    }

    // Fetch All functionality for Master Sheet
    async function fetchAllMasterData() {
        showLoading();
        try {
            const response = await fetch(`${scriptURL}?action=fetchAllMaster&offset=0&limit=20`);
            const data = await response.json();
            
            if (data.success) {
                allMasterData = data.data || [];
                masterDataOffset = 20;
                
                if (allMasterData.length === 0) {
                    document.getElementById('searchResultsBody').innerHTML = '<tr><td colspan="8" class="text-center py-4">No records found in Master sheet</td></tr>';
                    document.getElementById('masterShowMoreContainer').classList.add('hidden');
                    return;
                }
                
                displayDataInTable(allMasterData, 'searchResultsBody', false, true, 'master');
                
                const showMoreContainer = document.getElementById('masterShowMoreContainer');
                if (allMasterData.length === 20) {
                    showMoreContainer.classList.remove('hidden');
                } else {
                    showMoreContainer.classList.add('hidden');
                }
                
                showSuccess(`Fetched ${allMasterData.length} records from Master sheet`);
            } else {
                showSuccess(`Error: ${data.error}`);
                document.getElementById('searchResultsBody').innerHTML = '<tr><td colspan="8" class="text-center py-4">Error fetching Master sheet data</td></tr>';
            }
        } catch (error) {
            console.error('Error fetching Master sheet:', error);
            showSuccess('Error connecting to Master sheet');
            document.getElementById('searchResultsBody').innerHTML = '<tr><td colspan="8" class="text-center py-4">Error connecting to Master sheet</td></tr>';
        } finally {
            hideLoading();
        }
    }

    // Show more Master data
    async function showMoreMasterData() {
        showLoading();
        try {
            const response = await fetch(`${scriptURL}?action=fetchAllMaster&offset=${masterDataOffset}&limit=20`);
            const data = await response.json();
            
            if (data.success && data.data && data.data.length > 0) {
                allMasterData = [...allMasterData, ...data.data];
                masterDataOffset += 20;
                
                displayDataInTable(allMasterData, 'searchResultsBody', false, true, 'master');
                
                if (data.data.length < 20) {
                    document.getElementById('masterShowMoreContainer').classList.add('hidden');
                }
                
                showSuccess(`Loaded ${data.data.length} more records`);
            } else {
                document.getElementById('masterShowMoreContainer').classList.add('hidden');
                showSuccess('No more records to load');
            }
        } catch (error) {
            console.error('Error loading more Master data:', error);
            showSuccess('Error loading more data');
        } finally {
            hideLoading();
        }
    }

    document.getElementById('showMoreMasterBtn').addEventListener('click', showMoreMasterData);

    function copyToClipboard(text) {
        if (navigator.clipboard && window.isSecureContext) {
            return navigator.clipboard.writeText(text).then(() => {
                return true;
            }).catch(err => {
                console.error('Failed to copy text with Clipboard API: ', err);
                return fallbackCopyToClipboard(text);
            });
        } else {
            return fallbackCopyToClipboard(text);
        }
    }
    
    function fallbackCopyToClipboard(text) {
        const input = document.createElement('textarea');
        input.style.position = 'fixed';
        input.style.opacity = 0;
        input.style.left = '-999999px';
        input.value = text;
        document.body.appendChild(input);
        input.select();
        input.setSelectionRange(0, 99999);
        
        try {
            const successful = document.execCommand('copy');
            return successful;
        } catch (err) {
            console.error('Failed to copy text: ', err);
            return false;
        } finally {
            document.body.removeChild(input);
        }
    }

    // Modified displayDataInTable function
    function displayDataInTable(data, targetTableId, isMasterSearch = false, isMasterFetch = false, sheetType = 'data') {
        const tableBody = document.getElementById(targetTableId);
        tableBody.innerHTML = '';
        
        if (data.length === 0) {
            const colSpan = 8;
            tableBody.innerHTML = `<tr><td colspan="${colSpan}" class="text-center py-4">No records found</td></tr>`;
            return;
        }
        
        data.forEach(row => {
            const tr = document.createElement('tr');
            const mobileNumber = row.Mobile || '';
            const cidValue = row.CID || '';
            const appIdValue = row['App ID'] || '';
            const customerNameValue = row['Customer Name'] || '';
            
            let displayMobile = mobileNumber;
            let callMobile = mobileNumber;
            
            if (mobileNumber) {
                if (mobileNumber.toString().startsWith('971')) {
                    displayMobile = mobileNumber.toString();
                    callMobile = mobileNumber.toString();
                } else {
                    displayMobile = mobileNumber.toString();
                    callMobile = '971' + mobileNumber.toString();
                }
            }
            
            let actionsHtml = '';
            if (!isMasterSearch) {
                actionsHtml = `
                    <td class="action-column ${!isExpanded ? 'hidden-column' : ''}">
                        <a href="tel:+${callMobile}" class="action-btn bg-green-600 text-white p-1 rounded inline-block" title="Call ${row['Customer Name']}" role="button">
                            <i class="fas fa-phone"></i>
                        </a>
                        <button class="delete-btn action-btn bg-red-600 text-white p-1 rounded" data-cid="${row.CID}" data-sheet="${sheetType}" title="Delete">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
            } else if (isMasterFetch) {
                actionsHtml = `
                    <td class="action-column ${!isExpanded ? 'hidden-column' : ''}">
                        <a href="tel:+${callMobile}" class="action-btn bg-green-600 text-white p-1 rounded inline-block" title="Call ${row['Customer Name']}" role="button">
                            <i class="fas fa-phone"></i>
                        </a>
                        <button class="delete-btn action-btn bg-red-600 text-white p-1 rounded" data-cid="${row.CID}" data-sheet="${sheetType}" title="Delete">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
            } else {
                actionsHtml = `
                    <td class="action-column ${!isExpanded ? 'hidden-column' : ''}">
                        <a href="tel:+${callMobile}" class="action-btn bg-green-600 text-white p-1 rounded inline-block" title="Call ${row['Customer Name']}" role="button">
                            <i class="fas fa-phone"></i>
                        </a>
                    </td>
                `;
            }
            
            const cidClass = targetTableId === 'dataTableBody' ? 'cid-column' : 'search-cid-column';
            const appIdClass = targetTableId === 'dataTableBody' ? 'appid-column' : 'search-appid-column';
            
            tr.innerHTML = `
                <td class="${cidClass} ${!isExpanded ? 'hidden-column' : ''} copyable" data-value="${cidValue}">${cidValue}</td>
                <td class="${appIdClass} ${!isExpanded ? 'hidden-column' : ''} copyable" data-value="${appIdValue}">${appIdValue}</td>
                <td class="copyable" data-value="${customerNameValue}">${customerNameValue}</td>
                <td class="copyable" data-value="${displayMobile}">${displayMobile}</td>
                <td>${row.Product || ''}</td>
                <td>${row.Status || ''}</td>
                <td data-cid="${cidValue}" data-sheet="${sheetType}" style="cursor: pointer; color: #1A3A4A; font-weight: bold;">${row.Points || ''}</td>
                ${actionsHtml}
            `;
            
            const pointsCell = tr.cells[6];
            if (pointsCell) {
                pointsCell.addEventListener('click', (e) => {
                    e.stopPropagation();
                    editingFromMaster = (sheetType === 'master');
                    editRecord(cidValue);
                });
            }
            
            tableBody.appendChild(tr);
        });
        
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const cid = this.getAttribute('data-cid');
                const sheet = this.getAttribute('data-sheet');
                showConfirmDialog('Are you sure you want to delete this record?', () => {
                    deleteRecord(cid, sheet);
                });
            });
        });
        
        document.querySelectorAll('.copyable').forEach(element => {
            element.addEventListener('click', function(e) {
                e.stopPropagation();
                const value = this.getAttribute('data-value');
                if (copyToClipboard(value)) {
                    this.classList.add('copied');
                    setTimeout(() => {
                        this.classList.remove('copied');
                    }, 1500);
                }
            });
        });

        // Apply current filter
        applyStatusFilter(currentFilter);
    }

    // Custom confirm dialog
    function showConfirmDialog(message, onConfirm) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                <div class="flex justify-end space-x-3">
                    <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">Cancel</button>
                    <button class="confirm-btn px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded">Confirm</button>
                </div>
            </div>
        `;
        
        const cancelBtn = modal.querySelector('.cancel-btn');
        const confirmBtn = modal.querySelector('.confirm-btn');
        
        cancelBtn.addEventListener('click', () => {
            document.body.removeChild(modal);
        });
        
        confirmBtn.addEventListener('click', () => {
            document.body.removeChild(modal);
            onConfirm();
        });
        
        document.body.appendChild(modal);
    }

    async function submitFormData(formData) {
        showLoading();
        
        try {
            const response = await fetch(scriptURL, {
                method: 'POST',
                body: formData
            });
            
            const responseText = await response.text();
            
            let data;
            try {
                data = JSON.parse(responseText);
            } catch (parseError) {
                console.error("Error parsing response:", parseError);
                showSuccess('Error: Could not parse server response');
                hideLoading();
                return;
            }
            
            if (data.success) {
                showSuccess('Data submitted successfully!');
                resetForm();
                showSection('entry');
            } else {
                showSuccess(`Error: ${data.error}`);
            }
        } catch (error) {
            console.error('Error submitting form:', error);
            showSuccess('Error submitting data: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    async function updateRecord(formData) {
        showLoading();
        try {
            if (editingFromMaster) {
                formData.append('action', 'updateMaster');
            } else {
                formData.append('action', 'update');
            }
            
            const response = await fetch(scriptURL, {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            if (data.success) {
                showSuccess('Record updated successfully!');
                resetForm();
                showSection('view');
            } else {
                showSuccess(`Error: ${data.error}`);
            }
        } catch (error) {
            console.error('Error updating record:', error);
            showSuccess('Error updating record');
        } finally {
            hideLoading();
        }
    }

    async function deleteRecord(cid, sourceSheet = null) {
        showLoading();
        try {
            let action = 'delete';
            if (sourceSheet === 'master') {
                action = 'deleteMaster';
            }
            
            const response = await fetch(`${scriptURL}?action=${action}&cid=${cid}`, {
                method: 'GET'
            });
            
            const data = await response.json();
            if (data.success) {
                showSuccess('Record deleted successfully!');
                resetForm();
                if (document.getElementById('entrySection').classList.contains('active')) {
                    showSection('entry');
                } else {
                    fetchAllData();
                    fetchAllDataForSummary();
                }
            } else {
                showSuccess(`Error: ${data.error}`);
            }
        } catch (error) {
            console.error('Error deleting record:', error);
            showSuccess('Error deleting record');
        } finally {
            hideLoading();
        }
    }

    async function editRecord(cid) {
        showLoading();
        try {
            let localRecord = allRecordsData.find(r => r.CID === cid);
            let fromMaster = false;
            
            if (!localRecord) {
                localRecord = allMasterData.find(r => r.CID === cid);
                fromMaster = true;
            }
            
            if (localRecord) {
                editingData = localRecord;
                editingProductString = localRecord.Product || "";
                editingFromMaster = fromMaster;
                
                populateForm(localRecord);
                
                showSection('entry');
                
                document.getElementById('submitBtn').classList.add('hidden');
                document.getElementById('updateBtn').classList.remove('hidden');
                document.getElementById('deleteBtn').classList.remove('hidden');
                
                hideLoading();
                return;
            }
            
            const response = await fetch(`${scriptURL}?action=getById&cid=${cid}`);
            const data = await response.json();
            
            if (data.success && data.data) {
                editingData = data.data;
                editingProductString = data.data.Product || "";
                
                currentSelections = {
                    ACC: '',
                    ACC2: '',
                    CC: '',
                    CCOption2: '',
                    PL: ''
                };
                
                if (data.data.accOption) currentSelections.ACC = data.data.accOption;
                if (data.data.accOption2) currentSelections.ACC2 = data.data.accOption2;
                if (data.data.ccOption) currentSelections.CC = data.data.ccOption;
                if (data.data.ccOption2) currentSelections.CCOption2 = data.data.ccOption2;
                if (data.data.plOption) currentSelections.PL = data.data.plOption;
                
                populateForm(data.data);
                
                showSection('entry');
                
                document.getElementById('submitBtn').classList.add('hidden');
                document.getElementById('updateBtn').classList.remove('hidden');
                document.getElementById('deleteBtn').classList.remove('hidden');
            } else {
                showSuccess(`Error: ${data.error || 'Record not found'}`);
            }
        } catch (error) {
            console.error('Error fetching record:', error);
            showSuccess('Error fetching record data');
        } finally {
            hideLoading();
        }
    }

    function parseProductString(productString) {
        if (!productString) return [];
        
        return productString.split(',').map(p => p.trim());
    }

    function productStringContains(productString, product) {
        const products = parseProductString(productString);
        
        if (product === 'PL') {
            return products.some(p => 
                p.includes('PL Asp-A&B') || 
                p.includes('PL Asp-C&Below') || 
                p.includes('PL Prv-A&B') || 
                p.includes('PL Prv-C&Below') || 
                p.includes('TOP UP') ||
                p === 'PL'
            );
        }
        
        return products.some(p => p === product || p.includes(product));
    }

    function formatDateForInput(dateString) {
        if (!dateString) return '';
        
        const date = new Date(dateString);
        if (isNaN(date.getTime())) {
            return dateString;
        }
        
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        
        return `${year}-${month}-${day}`;
    }

    // Enhanced form population function
    function populateForm(data) {
        console.log('Populating form with data:', data);
        
        entryForm.reset();
        productOptionsContainer.innerHTML = '';
        loanAmountSection.classList.add('hidden');
        otherPointsSection.classList.add('hidden');
        otherBankingSection.classList.add('hidden');
        otherStatusSection.classList.add('hidden');
        document.getElementById('companySuggestions').style.display = 'none';
        
        document.getElementById('nameError').classList.add('hidden');
        document.getElementById('mobileError').classList.add('hidden');
        document.getElementById('productsError').classList.add('hidden');

        document.querySelectorAll('.error-field').forEach(field => {
            field.classList.remove('error-field');
        });
        
        editingData = data;
        editingProductString = data.Product || "";
        selectedCCOptions.clear();
        
        console.log('Setting editing product string:', editingProductString);
        
        cidInput.value = data.CID || '';
        cidInput.disabled = false;
        cidInput.readOnly = false;
        appIdInput.value = data['App ID'] || '';
        
        if (data.Date) {
            dateInput.value = formatDateForInput(data.Date);
        }
        
        salaryInput.value = data.Salary || '';
        customerNameInput.value = data['Customer Name'] || '';
        
        let mobileValue = data.Mobile || '';
        if (mobileValue.toString().startsWith('971')) {
            mobileValue = mobileValue.toString().substring(3);
        }
        mobileValue = mobileValue.toString().replace(/\s+/g, '');
        mobileInput.value = mobileValue;
        
        companyNameInput.value = data['Company Name'] || '';
        
        const productString = data.Product || '';
        const products = parseProductString(productString);
        
        console.log('Populating form with product string:', productString);
        console.log('Parsed products:', products);
        
        if (data.accOption) currentSelections.ACC = data.accOption;
        if (data.accOption2) currentSelections.ACC2 = data.accOption2;
        if (data.ccOption) currentSelections.CC = data.ccOption;
        if (data.ccOption2) currentSelections.CCOption2 = data.ccOption2;
        if (data.plOption) currentSelections.PL = data.plOption;
        
        productACC.checked = productStringContains(productString, 'MDSA') || 
                            productStringContains(productString, 'Aspire') ||
                            productStringContains(productString, 'Privilege') ||
                            productString.includes('ACC');
                            
        product2ndACC.checked = productString.includes('2nd ACC') || 
                               products.some(p => p.trim() === '2nd ACC') ||
                               products.filter(p => 
                                   p.includes('MDSA') || 
                                   p.includes('Aspire') || 
                                   p.includes('Privilege')
                               ).length > 1;
        
        if (productACC.checked) {
            product2ndACC.disabled = false;
            productSTL.disabled = false;
        }
        
        productSTL.checked = productStringContains(productString, 'STL');
        
        productCC.checked = productStringContains(productString, 'Touchpoints') ||
                           productStringContains(productString, 'Cashback') ||
                           productStringContains(productString, 'Talabat') ||
                           productStringContains(productString, 'Lulu') ||
                           productStringContains(productString, 'Etihad') ||
                           productStringContains(productString, 'Shukran') ||
                           productStringContains(productString, 'All ') ||
                           productStringContains(productString, 'Traveller') ||
                           productStringContains(productString, 'Betaqti') ||
                           productStringContains(productString, 'Emirati') ||
                           productString.includes('CC');
        
        product2ndCC.checked = productStringContains(productString, '2ndCC') ||
                               (products.length > 1 && 
                                (productStringContains(productString, 'Touchpoints') ||
                                 productStringContains(productString, 'Talabat')));
        
        if (productCC.checked) {
            product2ndCC.disabled = false;
        }
        
        productBTCCL.checked = productStringContains(productString, 'BT/CCL');
        
        productPL.checked = productStringContains(productString, 'PL Asp-A&B') ||
                           productStringContains(productString, 'PL Asp-C&Below') ||
                           productStringContains(productString, 'PL Prv-A&B') ||
                           productStringContains(productString, 'PL Prv-C&Below') ||
                           productStringContains(productString, 'TOP UP') ||
                           productStringContains(productString, 'PL');
                           
        productOther.checked = productStringContains(productString, 'Other');
        
        if (productPL.checked) {
            loanAmountSection.classList.remove('hidden');
            loanAmountInput.value = data['Loan Amount'] || '';
        }
        
        if (productOther.checked) {
            otherPointsSection.classList.remove('hidden');
            let otherAmount = data['Other Points'] || data['Other Amount'] || data['Miscellaneous Points'] || '';
            if (!otherAmount && data.Points && productOther.checked && !productPL.checked && !productCC.checked && !productACC.checked) {
                otherAmount = data.Points;
            }
            otherPointsInput.value = otherAmount;
        }
        
        const propositionRadios = document.getElementsByName('proposition');
        for (let radio of propositionRadios) {
            if (radio.value === data.Proposition) {
                radio.checked = true;
                break;
            }
        }
        
        const schemeRadios = document.getElementsByName('scheme');
        for (let radio of schemeRadios) {
            if (radio.value === data.Scheme) {
                radio.checked = true;
                break;
            }
        }
        
        const activationRadios = document.getElementsByName('activation');
        for (let radio of activationRadios) {
            if (radio.value === data.Activation) {
                radio.checked = true;
                break;
            }
        }
        
        if (data.Banking) {
            if (['SELECT', 'ADCB', 'ENBD', 'EIB', 'FAB', 'DIB', 'MASHREQ', 'ADIB', 'RAK', 'CBD', 'HSBC', 'CITI'].includes(data.Banking)) {
                bankingSelect.value = data.Banking;
            } else {
                bankingSelect.value = 'Other';
                otherBankingSection.classList.remove('hidden');
                otherBankingInput.value = data.Banking;
            }
        }
        
        adcbOverrideCheckbox.checked = data.adcbOverride === 'true' || data.adcbOverride === true;
        ccDeductionOverrideCheckbox.checked = data.ccDeductionOverride === 'true' || data.ccDeductionOverride === true;
        
        if (data.Status) {
            if (['Draft', 'Under Review', 'Completed', 'ACC Completed, Under Review', 'HR CPV', 'Compliance', 'Rejected'].includes(data.Status)) {
                statusSelect.value = data.Status;
            } else {
                statusSelect.value = 'Other';
                otherStatusSection.classList.remove('hidden');
                otherStatusInput.value = data.Status;
            }
        }
        
        pointsInput.value = data.Points || '';
        
        // Update activation visibility
        updateActivationVisibility();
        
        console.log('Before calling initializeProductOptions');
        
        setTimeout(() => {
            if (appInitialized) {
                console.log('App initialized, calling initializeProductOptions');
                initializeProductOptions();
                
                if (statusSelect.value === 'Rejected') {
                    pointsInput.value = '0';
                }
            } else {
                console.log('App not initialized yet, will retry...');
                setTimeout(() => {
                    if (appInitialized) {
                        initializeProductOptions();
                        if (statusSelect.value === 'Rejected') {
                            pointsInput.value = '0';
                        }
                    } else {
                        setTimeout(() => {
                            initializeProductOptions();
                            if (statusSelect.value === 'Rejected') {
                                pointsInput.value = '0';
                            }
                        }, 1500);
                    }
                }, 1000);
            }
        }, 500);
    }

    async function checkUniqueness(cid, customerName, mobile) {
        try {
            const response = await fetch(`${scriptURL}?action=checkUnique&cid=${cid}&name=${encodeURIComponent(customerName)}&mobile=${mobile}`);
            return await response.json();
        } catch (error) {
            console.error('Error checking uniqueness:', error);
            showSuccess('Error checking uniqueness');
            return { 
                success: false, 
                data: { cidExists: false, nameExists: false, mobileExists: false },
                error: error.message
            };
        }
    }

    async function validateForm() {
        let isValid = true;
        
        document.getElementById('nameError').classList.add('hidden');
        document.getElementById('mobileError').classList.add('hidden');
        document.getElementById('productsError').classList.add('hidden');
        
        cidInput.classList.remove('error-field');
        
        if (!dateInput.value) {
            dateInput.classList.add('error-field');
            isValid = false;
        } else {
            dateInput.classList.remove('error-field');
        }
        
        if (!salaryInput.value.trim()) {
            salaryInput.classList.add('error-field');
            isValid = false;
        } else {
            salaryInput.classList.remove('error-field');
        }
        
        if (!customerNameInput.value.trim()) {
            customerNameInput.classList.add('error-field');
            isValid = false;
        } else {
            customerNameInput.classList.remove('error-field');
        }
        
        if (!mobileInput.value.trim()) {
            mobileInput.classList.add('error-field');
            isValid = false;
        } else {
            mobileInput.classList.remove('error-field');
        }
        
        if (statusSelect.value === '') {
            statusSelect.classList.add('error-field');
            isValid = false;
        } else {
            statusSelect.classList.remove('error-field');
        }
        
        const productSelected = productACC.checked || product2ndACC.checked || productSTL.checked || productCC.checked || 
                               product2ndCC.checked || productBTCCL.checked || productPL.checked || productOther.checked;
        
        if (!productSelected) {
            document.getElementById('productsError').classList.remove('hidden');
            isValid = false;
        }
        
        if (document.getElementById('updateBtn').classList.contains('hidden')) {
            if (isValid && (customerNameInput.value.trim() || mobileInput.value.trim())) {
                showLoading();
                const uniquenessCheck = await checkUniqueness(
                    '',
                    customerNameInput.value.trim(),
                    '971' + mobileInput.value.trim()
                );
                hideLoading();
                
                if (uniquenessCheck.success && uniquenessCheck.data) {
                    if (uniquenessCheck.data.nameExists) {
                        document.getElementById('nameError').classList.remove('hidden');
                        customerNameInput.classList.add('error-field');
                        isValid = false;
                    }
                    
                    if (uniquenessCheck.data.mobileExists) {
                        document.getElementById('mobileError').classList.remove('hidden');
                        mobileInput.classList.add('error-field');
                        isValid = false;
                    }
                } else if (!uniquenessCheck.success) {
                    console.log('Warning: Could not check uniqueness');
                }
            }
        }
        
        return isValid;
    }

    function collectFormData() {
        const formData = new FormData();
        
        const cidValue = cidInput.value.trim();
        formData.append('cid', cidValue);
        formData.append('appId', appIdInput.value);
        
        const proposition = document.querySelector('input[name="proposition"]:checked').value;
        formData.append('proposition', proposition);
        
        formData.append('date', dateInput.value);
        formData.append('salary', salaryInput.value);
        formData.append('customerName', customerNameInput.value);
        
        const mobileValue = mobileInput.value.trim().replace(/\s+/g, '');
        const fullMobile = mobileValue.startsWith('971') ? mobileValue : '971' + mobileValue;
        formData.append('mobile', fullMobile);
        
        let bankingValue = bankingSelect.value;
        if (bankingValue === 'Other') {
            bankingValue = otherBankingInput.value || 'Other';
        }
        formData.append('banking', bankingValue);
        
        formData.append('adcbOverride', adcbOverrideCheckbox.checked);
        formData.append('ccDeductionOverride', ccDeductionOverrideCheckbox.checked);
        formData.append('companyName', companyNameInput.value);
        
        const scheme = document.querySelector('input[name="scheme"]:checked').value;
        formData.append('scheme', scheme);
        
        let statusValue = statusSelect.value;
        if (statusValue === 'Other') {
            statusValue = otherStatusInput.value || 'Other';
        }
        formData.append('status', statusValue);
        
        const activation = document.querySelector('input[name="activation"]:checked').value;
        formData.append('activation', activation);
        
        formData.append('points', statusValue === 'Rejected' ? '0' : pointsInput.value);
        
        const selectedProductOptions = [];
        
        if (productACC.checked) {
            const accSelect = document.getElementById('ACCSelect');
            if (accSelect && accSelect.value) {
                const selectedOption = accSelect.options[accSelect.selectedIndex];
                selectedProductOptions.push(selectedOption.text.split(' (')[0]);
                formData.append('accOption', accSelect.value);
            } else {
                selectedProductOptions.push('ACC');
            }
            
            if (productSTL.checked) {
                selectedProductOptions.push('STL');
            }
        }
        
        if (product2ndACC.checked) {
            const acc2Select = document.getElementById('ACC2Select');
            if (acc2Select && acc2Select.value) {
                const selectedOption = acc2Select.options[acc2Select.selectedIndex];
                selectedProductOptions.push(selectedOption.text.split(' (')[0]);
                formData.append('accOption2', acc2Select.value);
            } else {
                selectedProductOptions.push('2nd ACC');
            }
        }
        
        if (productCC.checked) {
            const ccSelect = document.getElementById('CCSelect');
            if (ccSelect && ccSelect.value) {
                const selectedOption = ccSelect.options[ccSelect.selectedIndex];
                selectedProductOptions.push(selectedOption.text);
                formData.append('ccOption', ccSelect.value);
            } else {
                selectedProductOptions.push('CC');
            }
            
            if (product2ndCC.checked) {
                const cc2Select = document.getElementById('CCSelect2');
                if (cc2Select && cc2Select.value) {
                    const selectedOption = cc2Select.options[cc2Select.selectedIndex];
                    selectedProductOptions.push(selectedOption.text);
                    formData.append('ccOption2', cc2Select.value);
                } else {
                    selectedProductOptions.push('2ndCC');
                }
            }
        }
        
        if (productBTCCL.checked) {
            selectedProductOptions.push('BT/CCL');
        }
        
        if (productOther.checked) {
            selectedProductOptions.push('Other');
            formData.append('otherPoints', otherPointsInput.value);
        }
        
        if (productPL.checked) {
            const plSelect = document.getElementById('PLSelect');
            if (plSelect && plSelect.value) {
                const selectedOption = plSelect.options[plSelect.selectedIndex];
                selectedProductOptions.push(selectedOption.text);
                formData.append('plOption', plSelect.value);
            } else {
                selectedProductOptions.push('PL');
            }
            formData.append('loanAmount', loanAmountInput.value);
        }
        
        const productList = selectedProductOptions.join(', ');
        formData.append('productList', productList);
        
        return formData;
    }

    // ==========================================
    // EXPORT FUNCTIONALITY
    // ==========================================
    
    const exportModal = document.getElementById('exportModal');
    const closeExportModalBtn = document.getElementById('closeExportModal');
    const cancelExportBtn = document.getElementById('cancelExportBtn');
    const exportDataBtn = document.getElementById('exportDataBtn');
    const confirmExportBtn = document.getElementById('confirmExportBtn');
    const selectAllRows = document.getElementById('selectAllRows');
    const selectAllHeader = document.getElementById('selectAllHeader');
    const exportTableBody = document.getElementById('exportTableBody');
    const selectedRowsCount = document.getElementById('selectedRowsCount');
    const totalAmountEl = document.getElementById('totalAmount');
    
    const profileNameInput = document.getElementById('profileName');
    const profileSelect = document.getElementById('profileSelect');
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    const loadProfileBtn = document.getElementById('loadProfileBtn');
    const deleteProfileBtn = document.getElementById('deleteProfileBtn');
    
    exportDataBtn.addEventListener('click', function() {
        populateExportTable();
        exportModal.style.display = 'block';
    });
    
    function closeExportModal() {
        exportModal.style.display = 'none';
    }
    
    closeExportModalBtn.addEventListener('click', closeExportModal);
    cancelExportBtn.addEventListener('click', closeExportModal);
    
    window.addEventListener('click', function(event) {
        if (event.target === exportModal) {
            closeExportModal();
        }
    });
    
    function populateExportTable() {
        exportTableBody.innerHTML = '';
        
        if (allRecordsData.length === 0) {
            exportTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No records found</td></tr>';
            selectAllRows.disabled = true;
            selectAllHeader.disabled = true;
            return;
        }
        
        selectAllRows.disabled = false;
        selectAllHeader.disabled = false;
        
        allRecordsData.forEach((record, index) => {
            const tr = document.createElement('tr');
            tr.setAttribute('data-cid', record.CID || '');
            
            let date = '';
            if (record.Date) {
                const dateObj = new Date(record.Date);
                if (!isNaN(dateObj.getTime())) {
                    date = `${String(dateObj.getDate()).padStart(2, '0')}/${String(dateObj.getMonth() + 1).padStart(2, '0')}/${dateObj.getFullYear()}`;
                }
            }
            
            const productType = categorizeProductType(record.Product);
            
            let productDisplay = productType;
            if (productType === "PL" && record['Loan Amount']) {
                productDisplay = `${productType} (AED ${parseInt(record['Loan Amount']).toLocaleString()})`;
            }
            
            let savedAmount = '';
            
            if (record.exportAmount) {
                savedAmount = record.exportAmount;
            }
            
            tr.innerHTML = `
                <td><input type="checkbox" class="row-checkbox" data-cid="${record.CID || ''}"></td>
                <td>${record.CID || ''}</td>
                <td>${date}</td>
                <td>${record['Customer Name'] || ''}</td>
                <td>${productDisplay}</td>
                <td>${record.Status || ''}</td>
                <td><input type="number" class="amount-input" value="${savedAmount}" placeholder="Enter amount"></td>
            `;
            
            exportTableBody.appendChild(tr);
        });
        
        document.querySelectorAll('.amount-input').forEach(input => {
            input.addEventListener('input', calculateTotalAmount);
        });
        
        updateSelectedRowsCount();
        
        selectAllRows.checked = true;
        selectAllHeader.checked = true;
        document.querySelectorAll('#exportTableBody .row-checkbox').forEach(checkbox => {
            checkbox.checked = true;
        });
        updateSelectedRowsCount();
        
        calculateTotalAmount();
    }
    
    function calculateTotalAmount() {
        let total = 0;
        const checkedRows = document.querySelectorAll('#exportTableBody .row-checkbox:checked');
        
        checkedRows.forEach(checkbox => {
            const row = checkbox.closest('tr');
            const amountInput = row.querySelector('.amount-input');
            const amount = parseFloat(amountInput.value) || 0;
            total += amount;
        });
        
        totalAmountEl.textContent = total.toLocaleString('en-US');
    }
    
    function updateSelectedRowsCount() {
        const checkedRows = document.querySelectorAll('#exportTableBody .row-checkbox:checked').length;
        selectedRowsCount.textContent = `${checkedRows} rows selected`;
        
        calculateTotalAmount();
    }
    
    selectAllHeader.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('#exportTableBody .row-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        
        selectAllRows.checked = this.checked;
        updateSelectedRowsCount();
    });
    
    selectAllRows.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('#exportTableBody .row-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        
        selectAllHeader.checked = this.checked;
        updateSelectedRowsCount();
    });
    
    exportTableBody.addEventListener('change', function(e) {
        if (e.target.classList.contains('row-checkbox')) {
            const allCheckboxes = document.querySelectorAll('#exportTableBody .row-checkbox');
            const checkedCheckboxes = document.querySelectorAll('#exportTableBody .row-checkbox:checked');
            
            selectAllRows.checked = allCheckboxes.length === checkedCheckboxes.length && allCheckboxes.length > 0;
            selectAllHeader.checked = allCheckboxes.length === checkedCheckboxes.length && allCheckboxes.length > 0;
            
            updateSelectedRowsCount();
        }
    });
    
    confirmExportBtn.addEventListener('click', function() {
        const checkedRows = document.querySelectorAll('#exportTableBody .row-checkbox:checked');
        
        if (checkedRows.length === 0) {
            showSuccess("Please select at least one record to export");
            return;
        }
        
        let hasAmounts = false;
        checkedRows.forEach(checkbox => {
            const row = checkbox.closest('tr');
            const amountInput = row.querySelector('.amount-input');
            if (amountInput && amountInput.value && amountInput.value.trim() !== '') {
                hasAmounts = true;
            }
        });
        
        let selectedData = [];
        checkedRows.forEach(checkbox => {
            const row = checkbox.closest('tr');
            if (row) {
                const cells = row.querySelectorAll('td');
                const amountInput = row.querySelector('.amount-input');
                const amount = amountInput ? amountInput.value : '';
                
                if (cells.length >= 7) {
                    const rowData = {
                        CID: cells[1].textContent,
                        Date: cells[2].textContent,
                        'Customer Name': cells[3].textContent,
                        Product: cells[4].textContent,
                        Status: cells[5].textContent
                    };
                    
                    if (hasAmounts) {
                        rowData.Amount = amount;
                    }
                    
                    selectedData.push(rowData);
                    
                    const cid = checkbox.getAttribute('data-cid');
                    const record = allRecordsData.find(r => r.CID === cid);
                    if (record) {
                        record.exportAmount = amount;
                    }
                }
            }
        });
        
        let totalAmount = 0;
        if (hasAmounts) {
            totalAmount = selectedData.reduce((total, record) => {
                return total + (parseFloat(record.Amount) || 0);
            }, 0);
        }
        
        createPDF(selectedData, totalAmount, hasAmounts);
        
        closeExportModal();
        
        showSuccess(`Exported ${selectedData.length} records as PDF successfully`);
    });
    
    function createPDF(data, totalAmount, includeAmount) {
        try {
            const doc = new jsPDF('landscape');
            
            const pageWidth = 297;
            const pageHeight = 210;
            const margin = 10;
            const usableWidth = pageWidth - (margin * 2);
            
            doc.setFontSize(16);
            doc.setTextColor(26, 58, 74);
            doc.text('Sales Report', margin, 20);
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            const now = new Date();
            const dateStr = `${String(now.getDate()).padStart(2, '0')}/${String(now.getMonth() + 1).padStart(2, '0')}/${now.getFullYear()}`;
            doc.text(`Generated on: ${dateStr}`, margin, 28);
            
            const columnPercentages = {
                no: 3,
                cid: 10,
                date: 10,
                customerName: 30,
                product: 25,
                status: 15,
                amount: 7
            };
            
            const columnWidths = {
                no: (usableWidth * columnPercentages.no) / 100,
                cid: (usableWidth * columnPercentages.cid) / 100,
                date: (usableWidth * columnPercentages.date) / 100,
                customerName: (usableWidth * columnPercentages.customerName) / 100,
                product: (usableWidth * columnPercentages.product) / 100,
                status: (usableWidth * columnPercentages.status) / 100,
                amount: includeAmount ? (usableWidth * columnPercentages.amount) / 100 : 0
            };
            
            const columns = [
                { header: 'No', dataKey: 'no', width: columnWidths.no },
                { header: 'CID', dataKey: 'cid', width: columnWidths.cid },
                { header: 'Date', dataKey: 'date', width: columnWidths.date },
                { header: 'Customer Name', dataKey: 'customerName', width: columnWidths.customerName },
                { header: 'Product', dataKey: 'product', width: columnWidths.product },
                { header: 'Status', dataKey: 'status', width: columnWidths.status }
            ];
            
            if (includeAmount) {
                columns.push({ header: 'Amount', dataKey: 'amount', width: columnWidths.amount });
            }
            
            const tableData = data.map((row, index) => {
                const rowData = {
                    no: (index + 1).toString(),
                    cid: row.CID || '',
                    date: row.Date || '',
                    customerName: row['Customer Name'] || '',
                    product: row.Product || '',
                    status: row.Status || ''
                };
                
                if (includeAmount) {
                    const amountValue = parseFloat(row.Amount) || 0;
                    rowData.amount = amountValue.toLocaleString('en-US');
                }
                
                return rowData;
            });
            
            if (includeAmount) {
                const totalRow = {
                    no: '',
                    cid: '',
                    date: '',
                    customerName: '',
                    product: '',
                    status: 'Total:',
                    amount: totalAmount.toLocaleString('en-US')
                };
                tableData.push(totalRow);
            }
            
            doc.autoTable({
                columns: columns,
                body: tableData,
                startY: 35,
                theme: 'grid',
                styles: {
                    fontSize: 8,
                    cellPadding: 2,
                    overflow: 'linebreak',
                    halign: 'left',
                    valign: 'middle'
                },
                headStyles: {
                    fillColor: [26, 58, 74],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    halign: 'center',
                    fontSize: 8
                },
                alternateRowStyles: {
                    fillColor: [222, 191, 207]
                },
                columnStyles: {
                    0: { halign: 'center', width: columnWidths.no },
                    1: { halign: 'center', width: columnWidths.cid },
                    2: { halign: 'center', width: columnWidths.date },
                    3: { halign: 'left', width: columnWidths.customerName },
                    4: { halign: 'left', width: columnWidths.product },
                    5: { halign: 'center', width: columnWidths.status },
                    6: { halign: 'right', width: columnWidths.amount }
                },
                didParseCell: function(data) {
                    if (data.column.dataKey === 'customerName' || data.column.dataKey === 'product') {
                        data.cell.styles.overflow = 'linebreak';
                        data.cell.styles.cellWidth = 'wrap';
                    }
                    
                    if (includeAmount && data.row.index === tableData.length - 1) {
                        data.cell.styles.fillColor = [240, 240, 240];
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.lineColor = [255, 255, 255];
                        data.cell.styles.lineWidth = 0;
                        
                        if (data.column.index >= 0 && data.column.index <= 4) {
                            data.cell.text = [''];
                        }
                        
                        if (data.column.index === 5) {
                            data.cell.styles.halign = 'right';
                        }
                    }
                },
                didDrawPage: function(data) {
                    const pageCount = doc.internal.getNumberOfPages();
                    const currentPage = doc.internal.getCurrentPageInfo().pageNumber;
                    
                    doc.setFontSize(8);
                    doc.setTextColor(26, 58, 74);
                    doc.text(`Page ${currentPage} of ${pageCount}`, pageWidth/2, pageHeight - 5, { align: 'center' });
                },
                margin: { top: 35, left: margin, right: margin, bottom: 15 },
                tableWidth: usableWidth
            });
            
            doc.save('customer_data_report.pdf');
        } catch (error) {
            console.error("Error generating PDF:", error);
            showSuccess("Error generating PDF: " + error.message + "\n\nPlease check console for details.");
            
            downloadJSON(data);
        }
    }
    
    function downloadJSON(data) {
        try {
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'customer_data_report.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess("PDF generation failed. Data downloaded as JSON instead.");
        } catch (e) {
            console.error("Even JSON fallback failed:", e);
            showSuccess("All PDF export methods failed. Please try again or contact support.");
        }
    }
    
    // ==========================================
    // PROFILE MANAGEMENT
    // ==========================================
    
    saveProfileBtn.addEventListener('click', function() {
        const profileName = profileNameInput.value.trim();
        
        if (!profileName) {
            showSuccess('Please enter a profile name');
            return;
        }
        
        const selectedRecords = [];
        const checkedRows = document.querySelectorAll('#exportTableBody .row-checkbox:checked');
        
        checkedRows.forEach(checkbox => {
            const cid = checkbox.dataset.cid;
            const row = checkbox.closest('tr');
            const amountInput = row.querySelector('.amount-input');
            const amount = amountInput.value;
            
            selectedRecords.push({
                cid: cid,
                amount: amount
            });
        });
        
        if (selectedRecords.length === 0) {
            showSuccess('Please select at least one record to save in profile');
            return;
        }
        
        saveProfile(profileName, selectedRecords);
        loadProfiles();
        showSuccess(`Profile "${profileName}" saved with ${selectedRecords.length} records`);
        profileNameInput.value = '';
    });
    
    loadProfileBtn.addEventListener('click', function() {
        const profileName = profileSelect.value;
        
        if (!profileName) {
            showSuccess('Please select a profile');
            return;
        }
        
        const selectedRecords = loadProfile(profileName);
        
        if (!selectedRecords || selectedRecords.length === 0) {
            showSuccess('Profile is empty or could not be loaded');
            return;
        }
        
        const rowCheckboxes = document.querySelectorAll('#exportTableBody .row-checkbox');
        
        rowCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        
        rowCheckboxes.forEach(checkbox => {
            const cid = checkbox.dataset.cid;
            const recordData = selectedRecords.find(record => record.cid === cid);
            
            if (recordData) {
                checkbox.checked = true;
                
                if (recordData.amount) {
                    const row = checkbox.closest('tr');
                    const amountInput = row.querySelector('.amount-input');
                    if (amountInput) {
                        amountInput.value = recordData.amount;
                    }
                }
            }
        });
        
        const allCheckboxes = document.querySelectorAll('#exportTableBody .row-checkbox');
        const checkedCheckboxes = document.querySelectorAll('#exportTableBody .row-checkbox:checked');
        
        selectAllRows.checked = allCheckboxes.length === checkedCheckboxes.length && allCheckboxes.length > 0;
        selectAllHeader.checked = allCheckboxes.length === checkedCheckboxes.length && allCheckboxes.length > 0;
        
        updateSelectedRowsCount();
        calculateTotalAmount();
        
        showSuccess(`Profile "${profileName}" loaded with ${selectedRecords.length} records`);
    });
    
    deleteProfileBtn.addEventListener('click', function() {
        const profileName = profileSelect.value;
        
        if (!profileName) {
            showSuccess('Please select a profile to delete');
            return;
        }
        
        deleteProfile(profileName);
        loadProfiles();
        showSuccess(`Profile "${profileName}" deleted`);
    });
    
    function saveProfile(name, selectedRecords) {
        const profiles = JSON.parse(localStorage.getItem('exportProfiles')) || {};
        profiles[name] = selectedRecords;
        localStorage.setItem('exportProfiles', JSON.stringify(profiles));
    }
    
    function loadProfile(name) {
        const profiles = JSON.parse(localStorage.getItem('exportProfiles')) || {};
        return profiles[name] || [];
    }
    
    function deleteProfile(name) {
        const profiles = JSON.parse(localStorage.getItem('exportProfiles')) || {};
        
        if (profiles[name]) {
            delete profiles[name];
            localStorage.setItem('exportProfiles', JSON.stringify(profiles));
        }
    }
    
    function loadProfiles() {
        const profiles = JSON.parse(localStorage.getItem('exportProfiles')) || {};
        
        while (profileSelect.options.length > 1) {
            profileSelect.remove(1);
        }
        
        for (const profileName in profiles) {
            const option = document.createElement('option');
            option.value = profileName;
            option.textContent = `${profileName} (${profiles[profileName].length} records)`;
            profileSelect.appendChild(option);
        }
    }

    // ==========================================
    // EVENT LISTENERS
    // ==========================================

    entryForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (await validateForm()) {
            const formData = collectFormData();
            formData.append('action', 'add');
            await submitFormData(formData);
        }
    });

    document.getElementById('updateBtn').addEventListener('click', async function() {
        if (await validateForm()) {
            const formData = collectFormData();
            await updateRecord(formData);
        }
    });

    document.getElementById('deleteBtn').addEventListener('click', function() {
        const cid = cidInput.value;
        if (cid) {
            showConfirmDialog('Are you sure you want to delete this record?', () => {
                deleteRecord(cid, editingFromMaster ? 'master' : 'data');
            });
        }
    });

    document.getElementById('refreshDataBtn').addEventListener('click', function() {
        fetchAllData();
        fetchAllDataForSummary();
    });
</script>
</body>
</html>
