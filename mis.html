<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management Information System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tahoma:wght@400;700&display=swap');
        body { font-family: 'Tahoma', Geneva, sans-serif; margin: 0; padding: 0; width: 100vw; height: 100vh; overflow-x: hidden; }
        .custom-btn { background: linear-gradient(135deg, #1A3A4A 0%, #3C063D 100%); transition: all 0.3s; }
        .custom-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .success-indicator { background: linear-gradient(135deg, #FFD1D1 0%, #59E3FF 100%); color: #333; padding: 8px 12px; border-radius: 4px; position: fixed; top: 20px; right: 20px; animation: fadeOut 2s forwards; animation-delay: 1s; z-index: 100; font-weight: 500; }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .loading-indicator { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #1A3A4A; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-field { border-color: #ef4444 !important; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background: #1A3A4A; color: white; text-align: left; padding: 8px; }
        .data-table tr:nth-child(even) { background-color: #DEBFCF; }
        .data-table tr:hover { background-color: #ddd; }
        .data-table td { border: 1px solid #ddd; padding: 8px; }
        .required::after { content: " *"; color: #ef4444; }
        .section { display: none; }
        .section.active { display: block; }
        .points-btn { font-weight: bold; padding: 0.5rem 1rem; border-radius: 0.375rem; display: inline-flex; align-items: center; margin-right: 0.5rem; }
        .points-btn.earned { background-color: #10b981; color: white; }
        .points-btn.pending { background-color: #f59e0b; color: white; }
        .progress-bar { width: 100%; height: 24px; background-color: #f3f3f3; border-radius: 12px; overflow: hidden; margin-bottom: 10px; position: relative; }
        .progress-fill { height: 100%; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; transition: width 0.5s ease; }
        .target-input { width: 100px; padding: 6px; border: 1px solid #ccc; border-radius: 4px; text-align: center; }
        .summary-card { background-color: white; border-radius: 8px; padding: 12px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); margin-bottom: 12px; }
        .summary-card h3 { color: #1A3A4A; margin-bottom: 8px; font-weight: bold; font-size: 1.1rem; padding-bottom: 6px; border-bottom: 1px solid #f3f3f3; }
        .copyable { cursor: pointer; position: relative; user-select: all; }
        .copyable::after { content: "Copied!"; position: absolute; top: -20px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 2px 6px; border-radius: 3px; font-size: 12px; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        .copyable.copied::after { opacity: 1; animation: fadeAfterCopy 1.5s forwards; }
        @keyframes fadeAfterCopy { 0% { opacity: 1; } 70% { opacity: 1; } 100% { opacity: 0; } }
        .action-column { min-width: 80px; white-space: nowrap; width: 80px; }
        .action-btn { margin-right: 6px; display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; }
        .visualizations-header { background: #1A3A4A; color: white; padding: 8px 12px; font-weight: bold; border-radius: 4px; font-size: 0.95rem; }
        .visualization-container { display: flex; justify-content: space-between; margin-top: 10px; flex-wrap: wrap; gap: 8px; }
        .chart-box { width: 24%; background: white; border-radius: 8px; padding: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 10px; transition: transform 0.2s, box-shadow 0.2s; }
        .chart-box:hover { transform: translateY(-2px); box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
        .chart-title { font-weight: bold; color: #1A3A4A; text-align: center; margin-bottom: 10px; font-size: 0.95rem; }
        .pie-chart, .pl-proposition-chart, .cc-proposition-chart, .acc-chart, .scheme-chart { width: 120px; height: 120px; border-radius: 50%; margin: 0 auto; position: relative; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .donut-hole { position: absolute; width: 72px; height: 72px; background: white; border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: inset 0 1px 4px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; font-weight: bold; color: #1A3A4A; font-size: 12px; }
        .chart-legend { margin-top: 10px; display: flex; flex-wrap: wrap; justify-content: center; gap: 4px; }
        .legend-item { display: flex; align-items: center; margin-right: 6px; margin-bottom: 6px; font-size: 10px; background-color: #f8f9fa; padding: 2px 6px; border-radius: 3px; transition: transform 0.15s; }
        .legend-item:hover { transform: scale(1.05); }
        .legend-color { width: 10px; height: 10px; margin-right: 4px; border-radius: 2px; }
        .modal { display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 50px auto; max-width: 900px; width: 90%; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; max-height: 80vh; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 15px; overflow-y: auto; max-height: calc(80vh - 130px); }
        .modal-footer { padding: 15px; border-top: 1px solid #e9ecef; display: flex; justify-content: flex-end; gap: 10px; }
        .close-modal { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-modal:hover { color: black; }
        .export-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        .export-table th { background: #1A3A4A; color: white; text-align: left; padding: 8px; position: sticky; top: 0; z-index: 10; }
        .export-table tr:nth-child(even) { background-color: #DEBFCF; }
        .export-table tr:hover { background-color: #ddd; }
        .export-table td { border: 1px solid #ddd; padding: 8px; }
        .amount-input { width: 100px; border: 1px solid #ddd; border-radius: 4px; padding: 5px; text-align: right; }
        .total-row { background-color: #f8f9fa; font-weight: bold; }
        .total-row td { border-top: 2px solid #1A3A4A; }
        .profile-container { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        .profile-input { flex: 1; min-width: 150px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; }
        .profile-select { flex: 1; min-width: 150px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; background-color: white; }
        .profile-btn { padding: 8px; display: inline-flex; align-items: center; justify-content: center; border-radius: 4px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; }
        .profile-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-save { background: linear-gradient(135deg, #1A3A4A 0%, #3C063D 100%); color: white; }
        .btn-load { background-color: #1A3A4A; color: white; }
        .btn-delete { background-color: #FF5349; color: white; }
        .text-primary { color: #1A3A4A !important; }
        .input-with-paste { position: relative; display: flex; align-items: center; }
        .input-with-paste input { width: 100%; padding-right: 45px; }
        .paste-icon { position: absolute; right: 10px; color: #1A3A4A; cursor: pointer; font-size: 16px; z-index: 10; padding: 5px; transition: all 0.2s; }
        .paste-icon:hover { color: #0f2936; transform: scale(1.1); }
        .mobile-prefix { display: flex; align-items: center; background: #f8f9fa; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px 0 0 4px; font-weight: bold; color: #333; border-right: none; font-size: 16px; }
        .mobile-input-container { display: flex; align-items: stretch; flex: 1; position: relative; }
        .mobile-input-container input { border-radius: 0 4px 4px 0 !important; border-left: none; flex: 1; font-size: 16px !important; padding-right: 45px; }
        .mobile-paste-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #1A3A4A; cursor: pointer; font-size: 16px; z-index: 10; padding: 5px; transition: all 0.2s; }
        .mobile-paste-icon:hover { color: #0f2936; transform: translateY(-50%) scale(1.1); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .summary-progress-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2px; margin-bottom: 2px; }
        .hidden-column { display: none; }
        .funding-target-container { display: grid; grid-template-columns: 30fr 70fr; gap: 10px; margin-bottom: 12px; }
        .account-funding-card, .target-card { background-color: white; border-radius: 8px; padding: 12px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }
        .account-funding-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; flex-wrap: wrap; }
        .account-funding-title { color: #1A3A4A; font-weight: bold; font-size: 1rem; }
        .account-funding-total { color: #ff8c00; font-weight: bold; font-size: 0.9rem; }
        .account-funding-items { display: flex; flex-direction: column; gap: 4px; font-size: 0.8rem; }
        .account-funding-item { color: #333; }
        .funding-count { color: #ff8c00; font-weight: bold; }
        .funding-points { color: #666; }
        .target-card h3 { color: #1A3A4A; margin-bottom: 8px; font-weight: bold; font-size: 1rem; padding-bottom: 6px; border-bottom: 1px solid #f3f3f3; }
        .sort-dropdown, .filter-dropdown { position: relative; display: inline-block; }
        .sort-btn, .filter-btn { background: linear-gradient(135deg, #1A3A4A 0%, #3C063D 100%); color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 14px; transition: all 0.3s; }
        .sort-btn:hover, .filter-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .sort-dropdown-content, .filter-dropdown-content { display: none; position: absolute; right: 0; background-color: white; min-width: 180px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); border-radius: 8px; z-index: 1000; border: 1px solid #e5e7eb; overflow: hidden; }
        .sort-dropdown-content.show, .filter-dropdown-content.show { display: block; }
        .sort-option, .filter-option { color: #374151; padding: 12px 16px; text-decoration: none; display: block; cursor: pointer; transition: background-color 0.2s; border-bottom: 1px solid #f3f4f6; }
        .sort-option:last-child, .filter-option:last-child { border-bottom: none; }
        .sort-option:hover, .filter-option:hover { background-color: #f9fafb; }
        .sort-option.active, .filter-option.active { background-color: #1A3A4A; color: white; }
        .autocomplete-container { position: relative; display: flex; align-items: center; }
        .autocomplete-suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; }
        .autocomplete-suggestion { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .autocomplete-suggestion:hover, .autocomplete-suggestion.active { background-color: #f0f0f0; }
        .autocomplete-suggestion:last-child { border-bottom: none; }
        .styled-input { background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%); border: 2px solid #e9ecef; border-radius: 8px; padding: 12px 16px; font-size: 16px; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.05); width: 100%; }
        .styled-input:focus { outline: none; border-color: #1A3A4A; box-shadow: 0 0 0 3px rgba(26, 58, 74, 0.1); background: #ffffff; }
        .styled-input:hover { border-color: #6c757d; }
        .styled-select { background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%); border: 2px solid #e9ecef; border-radius: 8px; padding: 12px 16px; font-size: 16px; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 12px center; background-size: 16px; padding-right: 45px; width: 100%; }
        .styled-select:focus { outline: none; border-color: #1A3A4A; box-shadow: 0 0 0 3px rgba(26, 58, 74, 0.1); background: #ffffff; }
        .styled-select:hover { border-color: #6c757d; }
        .styled-radio-group { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .styled-radio-item { display: flex; align-items: center; position: relative; cursor: pointer; padding: 6px 12px; border-radius: 6px; border: 2px solid #e9ecef; background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%); transition: all 0.3s ease; min-width: 80px; justify-content: center; font-size: 14px; }
        .styled-radio-item:hover { border-color: #6c757d; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .styled-radio-item input[type="radio"] { opacity: 0; position: absolute; width: 0; height: 0; }
        .styled-radio-item input[type="radio"]:checked + .radio-label { color: white; }
        .styled-radio-item:has(input[type="radio"]:checked) { background: linear-gradient(135deg, #1A3A4A 0%, #3C063D 100%); border-color: #1A3A4A; color: white; }
        .radio-label { font-weight: 500; transition: color 0.3s ease; pointer-events: none; }
        .styled-checkbox-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 8px; }
        .styled-checkbox-item { display: flex; align-items: center; position: relative; cursor: pointer; padding: 8px 12px; border-radius: 6px; border: 2px solid #e9ecef; background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%); transition: all 0.3s ease; font-size: 14px; }
        .styled-checkbox-item:hover { border-color: #6c757d; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .styled-checkbox-item input[type="checkbox"] { opacity: 0; position: absolute; width: 0; height: 0; }
        .styled-checkbox-item input[type="checkbox"]:checked + .checkbox-label { color: white; }
        .styled-checkbox-item:has(input[type="checkbox"]:checked) { background: linear-gradient(135deg, #1A3A4A 0%, #3C063D 100%); border-color: #1A3A4A; color: white; }
        .styled-checkbox-item:has(input[type="checkbox"]:disabled) { opacity: 0.5; cursor: not-allowed; background: #f1f3f4; border-color: #d1d5db; }
        .checkbox-label { font-weight: 500; transition: color 0.3s ease; pointer-events: none; }
        .styled-label { display: block; font-weight: 600; color: #374151; margin-bottom: 6px; font-size: 14px; letter-spacing: 0.025em; }
        .form-section { background: #ffffff; padding: 24px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); border: 1px solid #e5e7eb; }
        .form-row { margin-bottom: 20px; }
        .checkbox-group-wrapper, .radio-group-wrapper { background: #f8f9fa; padding: 16px; border-radius: 8px; border: 1px solid #e9ecef; }
        .proposition-radio-group { display: flex; gap: 8px; margin-top: 8px; }
        .scheme-radio-group { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 8px; }
        .activation-radio-group { display: flex; gap: 8px; margin-top: 8px; }
        .main-search-container { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
        .main-search-input { flex: 1; max-width: 400px; }
        #activationSection { display: none; }
        .view-mode-toggle { background: linear-gradient(135deg, #1A3A4A 0%, #3C063D 100%); color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 14px; transition: all 0.3s; margin-bottom: 16px; }
        .view-mode-toggle:hover { opacity: 0.9; transform: translateY(-1px); }
        .find-records-controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .chart-box { width: 100%; }
            .summary-progress-grid { grid-template-columns: 1fr; }
            .funding-target-container { grid-template-columns: 1fr; }
            .account-funding-header { flex-direction: column; align-items: flex-start; gap: 5px; }
            .account-funding-items { flex-direction: column; gap: 3px; }
            .styled-radio-group { flex-direction: column; gap: 8px; }
            .styled-radio-item { min-width: auto; justify-content: flex-start; }
            .styled-checkbox-grid { grid-template-columns: repeat(2, 1fr); }
            .proposition-radio-group { flex-direction: column; gap: 8px; }
            .scheme-radio-group { grid-template-columns: 1fr; }
            .activation-radio-group { flex-direction: column; gap: 8px; }
            .main-search-container { flex-direction: column; align-items: stretch; }
            .main-search-input { max-width: none; }
        }
    </style>
</head>
<body class="bg-gray-50 font-tahoma">
<div class="container mx-auto px-2 py-2 max-w-full">
    <div class="mb-3 flex justify-center gap-2 flex-wrap">
        <button id="showSummaryBtn" class="custom-btn text-white py-2 px-4 rounded-md flex items-center text-sm">
            <i class="fas fa-chart-pie mr-2"></i> Summary
        </button>
        <button id="showEntryBtn" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-md flex items-center text-sm">
            <i class="fas fa-file-alt mr-2"></i> Form
        </button>
        <button id="showViewBtn" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-md flex items-center text-sm">
            <i class="fas fa-table mr-2"></i> View
        </button>
        <a href="https://docs.google.com/spreadsheets/d/1VfEPU_2EvNqB6g2ldAzD05fvwFigL1yN3L0wLOwZP4o/edit?gid=0#gid=0" target="_blank" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-md flex items-center text-sm">
            <i class="fas fa-file-excel mr-2"></i> Sheet
        </a>
        <button id="showKPIBtn" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-md flex items-center text-sm">
            <i class="fas fa-chart-line mr-2"></i> KPI
        </button>
    </div>
    
    <div id="summarySection" class="section active">
        <div class="bg-white p-3 rounded-lg shadow-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-primary">Summary Dashboard</h2>
                <button id="copySummaryBtn" class="bg-gray-600 text-white p-2 rounded-md hover:bg-gray-700 no-print">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
            
            <div class="summary-card mb-2">
                <h3 class="mb-1">Points</h3>
                <div class="grid grid-cols-3 gap-2">
                    <div>
                        <p class="font-medium text-gray-600 text-sm">Earned Points:</p>
                        <p class="text-lg font-bold text-green-600" id="summaryEarnedPoints">0</p>
                    </div>
                    <div>
                        <p class="font-medium text-gray-600 text-sm">Pending Points:</p>
                        <p class="text-lg font-bold text-amber-600" id="summaryPendingPoints">0</p>
                    </div>
                    <div>
                        <p class="font-medium text-gray-600 text-sm">Total Points:</p>
                        <p class="text-lg font-bold text-blue-600" id="summaryTotalPoints">0</p>
                    </div>
                </div>
            </div>
            
            <div class="summary-progress-grid mb-2">
                <div class="summary-card mb-0">
                    <h3 class="mb-1">In Progress</h3>
                    <div class="space-y-1">
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">Credit Cards:</p>
                            <p class="text-base font-bold text-purple-600" id="summaryInProgressCC">0</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">Personal Loans:</p>
                            <p class="text-base font-bold text-purple-600" id="summaryInProgressPL">AED 0</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">MDSA:</p>
                            <p class="text-base font-bold text-purple-600" id="summaryInProgressMDSA">0</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">Privilege:</p>
                            <p class="text-base font-bold text-purple-600" id="summaryInProgressPrivilege">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="summary-card mb-0">
                    <h3 class="mb-1">Completed</h3>
                    <div class="space-y-1">
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">Credit Cards:</p>
                            <p class="text-base font-bold text-green-600" id="summaryCompletedCC">0</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">Personal Loans:</p>
                            <p class="text-base font-bold text-green-600" id="summaryCompletedPL">AED 0</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">MDSA:</p>
                            <p class="text-base font-bold text-green-600" id="summaryCompletedMDSA">0</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">Privilege:</p>
                            <p class="text-base font-bold text-green-600" id="summaryCompletedPrivilege">0</p>
                        </div>
                    </div>
                </div>

                <div class="summary-card mb-0">
                    <h3 class="mb-1">Total Submissions</h3>
                    <div class="space-y-1">
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">Credit Cards:</p>
                            <p class="text-base font-bold text-blue-600" id="summaryTotalCC">15</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">Personal Loans:</p>
                            <p class="text-base font-bold text-blue-600" id="summaryTotalPL">AED 170,000</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">Accounts:</p>
                            <p class="text-base font-bold text-blue-600" id="summaryTotalAccounts">0</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="funding-target-container">
                <div class="account-funding-card">
                    <div class="account-funding-header">
                        <span class="account-funding-title">Account Funding</span>
                        <span class="account-funding-total" id="fundingTotal">14 (3050 pts)</span>
                    </div>
                    <div class="account-funding-items">
                        <div class="account-funding-item">
                            MDSA: <span class="funding-count" id="fundingMDSACount">6</span> <span class="funding-points" id="fundingMDSAPoints">(1050 pts)</span>
                        </div>
                        <div class="account-funding-item">
                            Aspire: <span class="funding-count" id="fundingAspireCount">6</span> <span class="funding-points" id="fundingAspirePoints">(900 pts)</span>
                        </div>
                        <div class="account-funding-item">
                            Privilege: <span class="funding-count" id="fundingPrivilegeCount">2</span> <span class="funding-points" id="fundingPrivilegePoints">(1100 pts)</span>
                        </div>
                    </div>
                </div>
                
                <div class="target-card">
                    <h3 class="mb-1">Target</h3>
                    <div class="space-y-2">
                        <div>
                            <div class="flex items-center justify-between mb-0">
                                <p class="font-medium text-gray-600 text-sm">Credit Cards:</p>
                                <div class="flex items-center gap-1">
                                    <span id="remainingCC" class="text-xs font-bold text-blue-600">12</span>
                                    <input type="number" id="targetCC" class="target-input text-xs py-0 px-1 w-16" value="20" min="0">
                                </div>
                            </div>
                            <div class="progress-bar h-4 mt-1">
                                <div class="progress-fill bg-blue-500" id="progressCC" style="width: 40%">40%</div>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-0">
                                <p class="font-medium text-gray-600 text-sm">Personal Loans:</p>
                                <div class="flex items-center gap-1">
                                    <span id="remainingPL" class="text-xs font-bold text-blue-600">500,000</span>
                                    <input type="number" id="targetPL" class="target-input text-xs py-0 px-1 w-16" value="500000" min="0">
                                </div>
                            </div>
                            <div class="progress-bar h-4 mt-1">
                                <div class="progress-fill bg-green-500" id="progressPL" style="width: 0%">0%</div>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-0">
                                <p class="font-medium text-gray-600 text-sm">Accounts:</p>
                                <div class="flex items-center gap-1">
                                    <span id="remainingACC" class="text-xs font-bold text-blue-600">8</span>
                                    <input type="number" id="targetACC" class="target-input text-xs py-0 px-1 w-16" value="10" min="0">
                                </div>
                            </div>
                            <div class="progress-bar h-4 mt-1">
                                <div class="progress-fill bg-purple-500" id="progressACC" style="width: 20%">20%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="border rounded-lg mb-2">
                <div class="visualizations-header">Visualizations</div>
                <div class="visualization-container p-2">
                    <div class="chart-box">
                        <div class="chart-title">Personal Loan Proposition</div>
                        <div class="pl-proposition-chart">
                            <div class="donut-hole" id="plPercentageText">0%</div>
                        </div>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #FF5349;"></div>
                                <span>Conventional (<span id="plConventionalPercent">0%</span>)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #2197b2;"></div>
                                <span>Islamic (<span id="plIslamicPercent">0%</span>)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #d8dee9;"></div>
                                <span>Both (<span id="plBothPercent">0%</span>)</span>
                            </div>
                        </div>
                    </div>

                    <div class="chart-box">
                        <div class="chart-title">Credit Card Proposition</div>
                        <div class="cc-proposition-chart">
                            <div class="donut-hole" id="ccPercentageText">0%</div>
                        </div>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #32CD32;"></div>
                                <span>Conventional (<span id="ccConventionalPercent">0%</span>)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #FF8C00;"></div>
                                <span>Islamic (<span id="ccIslamicPercent">0%</span>)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #9370DB;"></div>
                                <span>Both (<span id="ccBothPercent">0%</span>)</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-box">
                        <div class="chart-title">Account Types</div>
                        <div class="acc-chart">
                            <div class="donut-hole" id="accPercentageText">0%</div>
                        </div>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #FEFE22;"></div>
                                <span>Aspire (<span id="aspirePercent">0%</span>)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #F96714;"></div>
                                <span>Privilege (<span id="privilegePercent">0%</span>)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #2197b2;"></div>
                                <span>MDSA (<span id="mdsaPercent">0%</span>)</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-box">
                        <div class="chart-title">Scheme Distribution</div>
                        <div class="scheme-chart">
                            <div class="donut-hole" id="schemePercentageText">0%</div>
                        </div>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #77DDE7;"></div>
                                <span>TML ALL (<span id="tmlAllPercent">0%</span>)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #FF1DCE;"></div>
                                <span>TML CC (<span id="tmlCCPercent">0%</span>)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #B2EC5D;"></div>
                                <span>TM SELECT (<span id="tmSelectPercent">0%</span>)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #A2ADD0;"></div>
                                <span>NTML (<span id="ntmlPercent">0%</span>)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="entrySection" class="section">
        <div class="form-section">
            <h2 class="text-xl font-bold text-primary mb-6">Customer Data Entry</h2>
            
            <form id="entryForm" class="space-y-6">
                <div class="form-grid">
                    <div class="space-y-6">
                        <div class="form-row">
                            <label for="cid" class="styled-label">CID (Optional)</label>
                            <div class="input-with-paste">
                                <input type="text" id="cid" name="cid" class="styled-input" pattern="[0-9]*" inputmode="numeric" tabindex="1">
                                <i class="fas fa-paste paste-icon" onclick="pasteToField('cid')" title="Paste"></i>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <label for="appId" class="styled-label">App ID</label>
                            <div class="input-with-paste">
                                <input type="text" id="appId" name="appId" class="styled-input" tabindex="2">
                                <i class="fas fa-paste paste-icon" onclick="pasteToField('appId')" title="Paste"></i>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <label for="salary" class="styled-label required">Salary</label>
                            <input type="number" id="salary" name="salary" class="styled-input" required tabindex="3">
                        </div>
                        
                        <div class="form-row">
                            <label for="customerName" class="styled-label required">Customer Name</label>
                            <div class="input-with-paste">
                                <input type="text" id="customerName" name="customerName" class="styled-input" required style="text-transform: uppercase;" tabindex="4">
                                <i class="fas fa-paste paste-icon" onclick="pasteToField('customerName')" title="Paste"></i>
                            </div>
                            <p id="nameError" class="text-red-500 text-sm hidden mt-1">Customer name must be unique</p>
                        </div>
                        
                        <div class="form-row">
                            <label for="mobile" class="styled-label required">Mobile</label>
                            <div class="input-with-paste">
                                <div class="mobile-input-container">
                                    <div class="mobile-prefix">971</div>
                                    <input type="text" id="mobile" name="mobile" class="styled-input" required pattern="[0-9]*" inputmode="numeric" placeholder="Enter 9 digits" tabindex="5">
                                    <i class="fas fa-paste mobile-paste-icon" onclick="pasteToField('mobile')" title="Paste"></i>
                                </div>
                            </div>
                            <p id="mobileError" class="text-red-500 text-sm hidden mt-1">Mobile number must be unique</p>
                        </div>
                        
                        <div class="form-row">
                            <label for="companyName" class="styled-label">Company Name</label>
                            <div class="autocomplete-container">
                                <input type="text" id="companyName" name="companyName" class="styled-input pr-12" style="text-transform: uppercase;" tabindex="6">
                                <i class="fas fa-paste paste-icon" onclick="pasteToField('companyName')" title="Paste"></i>
                                <div id="companySuggestions" class="autocomplete-suggestions"></div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <label class="styled-label required">Proposition</label>
                            <div class="radio-group-wrapper">
                                <div class="proposition-radio-group">
                                    <label class="styled-radio-item">
                                        <input type="radio" name="proposition" value="Conventional" checked>
                                        <span class="radio-label">Conventional</span>
                                    </label>
                                    <label class="styled-radio-item">
                                        <input type="radio" name="proposition" value="Islamic">
                                        <span class="radio-label">Islamic</span>
                                    </label>
                                    <label class="styled-radio-item">
                                        <input type="radio" name="proposition" value="Both">
                                        <span class="radio-label">Both</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <label for="date" class="styled-label required">Date</label>
                            <input type="date" id="date" name="date" class="styled-input" required>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="form-row">
                            <label class="styled-label required">Products</label>
                            <div class="checkbox-group-wrapper">
                                <div class="styled-checkbox-grid">
                                    <label class="styled-checkbox-item">
                                        <input type="checkbox" name="products" value="ACC" id="productACC">
                                        <span class="checkbox-label">ACC</span>
                                    </label>
                                    <label class="styled-checkbox-item">
                                        <input type="checkbox" name="products" value="2nd ACC" id="product2ndACC" disabled>
                                        <span class="checkbox-label">2nd ACC</span>
                                    </label>
                                    <label class="styled-checkbox-item">
                                        <input type="checkbox" name="products" value="STL" id="productSTL" disabled>
                                        <span class="checkbox-label">STL</span>
                                    </label>
                                    <label class="styled-checkbox-item">
                                        <input type="checkbox" name="products" value="CC" id="productCC">
                                        <span class="checkbox-label">CC</span>
                                    </label>
                                    <label class="styled-checkbox-item">
                                        <input type="checkbox" name="products" value="2ndCC" id="product2ndCC">
                                        <span class="checkbox-label">2nd CC</span>
                                    </label>
                                    <label class="styled-checkbox-item">
                                        <input type="checkbox" name="products" value="BT/CCL" id="productBTCCL">
                                        <span class="checkbox-label">BT/CCL</span>
                                    </label>
                                    <label class="styled-checkbox-item">
                                        <input type="checkbox" name="products" value="PL" id="productPL">
                                        <span class="checkbox-label">PL</span>
                                    </label>
                                    <label class="styled-checkbox-item">
                                        <input type="checkbox" name="products" value="Other" id="productOther">
                                        <span class="checkbox-label">Other</span>
                                    </label>
                                </div>
                            </div>
                            <p id="productsError" class="text-red-500 text-sm hidden mt-1">Please select at least one product</p>
                        </div>
                        
                        <div id="productOptionsContainer" class="space-y-4"></div>
                        
                        <div id="loanAmountSection" class="form-row hidden">
                            <label for="loanAmount" class="styled-label">Loan Amount</label>
                            <input type="number" id="loanAmount" name="loanAmount" class="styled-input">
                        </div>
                        
                        <div id="otherPointsSection" class="form-row hidden">
                            <label for="otherPoints" class="styled-label">Other Points (Miscellaneous)</label>
                            <input type="number" id="otherPoints" name="otherPoints" class="styled-input" placeholder="Enter other points">
                        </div>
                        
                        <div class="form-row">
                            <label class="styled-label">Banking</label>
                            <div class="flex gap-2 items-center">
                                <select id="banking" name="banking" class="styled-select flex-1" tabindex="7">
                                    <option value="SELECT">SELECT</option>
                                    <option value="ADCB">ADCB</option>
                                    <option value="ENBD">ENBD</option>
                                    <option value="EIB">EIB</option>
                                    <option value="FAB">FAB</option>
                                    <option value="DIB">DIB</option>
                                    <option value="MASHREQ">MASHREQ</option>
                                    <option value="ADIB">ADIB</option>
                                    <option value="RAK">RAK</option>
                                    <option value="CBD">CBD</option>
                                    <option value="HSBC">HSBC</option>
                                    <option value="CITI">CITI</option>
                                    <option value="Other">Other</option>
                                </select>
                                <label class="styled-checkbox-item" style="padding: 8px 12px; min-height: auto;">
                                    <input type="checkbox" id="adcbOverride" name="adcbOverride">
                                    <span class="checkbox-label text-sm">ADCB</span>
                                </label>
                            </div>
                            <div id="otherBankingSection" class="mt-2 hidden">
                                <input type="text" id="otherBanking" name="otherBanking" placeholder="Specify bank" class="styled-input">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <label class="styled-label required">Scheme</label>
                            <div class="radio-group-wrapper">
                                <div class="scheme-radio-group">
                                    <label class="styled-radio-item">
                                        <input type="radio" name="scheme" value="TML ALL" checked>
                                        <span class="radio-label">TML ALL</span>
                                    </label>
                                    <label class="styled-radio-item">
                                        <input type="radio" name="scheme" value="TML CC">
                                        <span class="radio-label">TML CC</span>
                                    </label>
                                    <label class="styled-radio-item">
                                        <input type="radio" name="scheme" value="TM SELECT">
                                        <span class="radio-label">TM SELECT</span>
                                    </label>
                                    <label class="styled-radio-item">
                                        <input type="radio" name="scheme" value="NTML">
                                        <span class="radio-label">NTML</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <label for="status" class="styled-label required">Status</label>
                            <div class="flex gap-2 items-center">
                                <select id="status" name="status" class="styled-select flex-1" required tabindex="8">
                                    <option value="">Select Status</option>
                                    <option value="Draft">Draft</option>
                                    <option value="Under Review">Under Review</option>
                                    <option value="Completed">Completed</option>
                                    <option value="ACC Completed, Under Review">ACC Completed, Under Review</option>
                                    <option value="HR CPV">HR CPV</option>
                                    <option value="Compliance">Compliance</option>
                                    <option value="Rejected">Rejected</option>
                                    <option value="Other">Other</option>
                                </select>
                                <label class="styled-checkbox-item" style="padding: 8px 12px; min-height: auto;">
                                    <input type="checkbox" id="ccDeductionOverride" name="ccDeductionOverride">
                                    <span class="checkbox-label text-sm">50%</span>
                                </label>
                            </div>
                            <div id="otherStatusSection" class="mt-2 hidden">
                                <input type="text" id="otherStatus" name="otherStatus" placeholder="Specify status" class="styled-input">
                            </div>
                        </div>
                        
                        <div id="activationSection" class="form-row">
                            <label class="styled-label required">Activation</label>
                            <div class="radio-group-wrapper">
                                <div class="activation-radio-group">
                                    <label class="styled-radio-item">
                                        <input type="radio" name="activation" value="Non Activated" checked>
                                        <span class="radio-label">Non Activated</span>
                                    </label>
                                    <label class="styled-radio-item">
                                        <input type="radio" name="activation" value="Activated">
                                        <span class="radio-label">Activated</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <label for="points" class="styled-label">Points (System Generated)</label>
                            <input type="text" id="points" name="points" class="styled-input bg-gray-100" readonly>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-center gap-3 mt-8 flex-wrap">
                    <button type="submit" id="submitBtn" class="custom-btn text-white py-3 px-8 rounded-md flex items-center" tabindex="9">
                        <i class="fas fa-save mr-2"></i> Save Data
                    </button>
                    <button type="button" id="updateBtn" class="custom-btn bg-blue-600 text-white py-3 px-8 rounded-md flex items-center hidden">
                        <i class="fas fa-edit mr-2"></i> Update Data
                    </button>
                    <button type="button" id="deleteBtn" class="bg-red-600 text-white py-3 px-8 rounded-md flex items-center hover:bg-red-700 hidden">
                        <i class="fas fa-trash-alt mr-2"></i> Delete Data
                    </button>
                    <button type="button" id="resetBtn" class="bg-gray-600 text-white py-3 px-8 rounded-md flex items-center hover:bg-gray-700">
                        <i class="fas fa-redo-alt mr-2"></i> Reset Form
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="viewSection" class="section">
        <div class="bg-white p-4 rounded-lg shadow-md">
            <button id="viewModeToggle" class="view-mode-toggle">
                <i class="fas fa-table mr-2"></i>
                <span id="viewModeText">View All Records</span>
                <i class="fas fa-exchange-alt ml-2"></i>
            </button>
            
            <div id="findRecordsControls" class="find-records-controls" style="display: none;">
                <button id="fetchAllBtn" class="custom-btn text-white py-2 px-6 rounded-md flex items-center">
                    <i class="fas fa-download mr-2"></i> Fetch All
                </button>
                <button id="searchBtn" class="custom-btn text-white py-2 px-6 rounded-md flex items-center">
                    <i class="fas fa-search mr-2"></i> Search Master
                </button>
                <button id="clearSearchBtn" class="bg-gray-600 text-white py-2 px-6 rounded-md flex items-center hover:bg-gray-700">
                    <i class="fas fa-times mr-2"></i> Clear
                </button>
            </div>
            
            <div class="flex flex-wrap justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-primary" id="viewSectionTitle">View All Records</h2>
                <div class="flex flex-wrap gap-2 mt-2 sm:mt-0">
                    <button id="earnPointsBtn" class="points-btn earned">
                        <i class="fas fa-check-circle mr-2"></i><span id="earnedPointsTotal">0</span>
                    </button>
                    <button id="pendingPointsBtn" class="points-btn pending">
                        <i class="fas fa-hourglass-half mr-2"></i> <span id="pendingPointsTotal">0</span>
                    </button>
                    <button id="exportDataBtn" class="custom-btn text-white py-2 px-4 rounded-md flex items-center">
                        <i class="fas fa-file-export mr-2"></i>
                    </button>
                    <button id="refreshDataBtn" class="custom-btn text-white py-2 px-4 rounded-md flex items-center">
                        <i class="fas fa-sync-alt mr-2"></i>
                    </button>
                    <button id="showAllRecordsBtn" class="custom-btn text-white py-2 px-6 rounded-md">
                        <i class="fas fa-list mr-2"></i>
                    </button>
                </div>
            </div>
            
            <div class="main-search-container">
                <button id="searchToggleBtn" class="bg-gray-600 text-white py-2 px-3 rounded-md hover:bg-gray-700" title="Search Records">
                    <i class="fas fa-search"></i>
                </button>
                <input type="text" id="globalSearch" class="main-search-input styled-input hidden" placeholder="Search by CID, Name, or Mobile...">
                <button id="expandBtn" class="bg-gray-600 text-white py-2 px-3 rounded-md hover:bg-gray-700" title="Expand/Collapse Columns">
                    <i class="fas fa-expand-alt"></i>
                </button>
                <div class="sort-dropdown">
                    <button class="sort-btn" id="sortDropdownBtn">
                        <i class="fas fa-sort"></i>
                        <span>Sort</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="sort-dropdown-content" id="sortDropdownContent">
                        <div class="sort-option active" data-sort="all">All Products</div>
                        <div class="sort-option" data-sort="acc">ACC</div>
                        <div class="sort-option" data-sort="cc">CC</div>
                        <div class="sort-option" data-sort="pl">PL</div>
                        <div class="sort-option" data-sort="btccl">BT/CCL</div>
                        <div class="sort-option" data-sort="other">Other</div>
                    </div>
                </div>
                <div class="filter-dropdown">
                    <button class="filter-btn" id="filterDropdownBtn">
                        <i class="fas fa-filter"></i>
                        <span>Filter</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="filter-dropdown-content" id="filterDropdownContent"></div>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table id="dataTable" class="data-table">
                    <thead>
                        <tr>
                            <th class="cid-column hidden-column">CID</th>
                            <th class="appid-column hidden-column">App ID</th>
                            <th>Customer Name</th>
                            <th>Mobile</th>
                            <th>Products</th>
                            <th>Status</th>
                            <th>Points</th>
                            <th class="action-column hidden-column w-20">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody"></tbody>
                </table>
            </div>
            
            <div id="masterShowMoreContainer" class="mt-4 text-center hidden">
                <button id="showMoreMasterBtn" class="custom-btn text-white py-2 px-6 rounded-md">
                    <i class="fas fa-plus mr-2"></i> Show More
                </button>
            </div>
        </div>
    </div>
</div>

<div id="successIndicator" class="success-indicator hidden">
    <span id="successMessage">Operation successful!</span>
</div>

<div id="loadingIndicator" class="loading-indicator hidden">
    <div class="spinner"></div>
</div>

<div id="exportModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="text-lg font-bold text-primary">Export Data</h2>
            <span class="close-modal" id="closeExportModal">&times;</span>
        </div>
        <div class="modal-body">
            <div class="profile-container">
                <input type="text" id="profileName" class="profile-input" placeholder="Profile Name">
                <button id="saveProfileBtn" class="profile-btn btn-save">
                    <i class="fas fa-save mr-1"></i> Save
                </button>
                <select id="profileSelect" class="profile-select">
                    <option value="">Select a profile</option>
                </select>
                <button id="loadProfileBtn" class="profile-btn btn-load">
                    <i class="fas fa-folder-open mr-1"></i> Load
                </button>
                <button id="deleteProfileBtn" class="profile-btn btn-delete">
                    <i class="fas fa-trash-alt mr-1"></i> Delete
                </button>
            </div>
            
            <div class="mb-3">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center">
                        <input type="checkbox" id="selectAllRows" class="mr-2">
                        <label for="selectAllRows" class="text-gray-700 font-medium">Select All</label>
                    </div>
                    <div>
                        <span class="text-sm text-gray-600" id="selectedRowsCount">0 rows selected</span>
                    </div>
                </div>
                <div class="max-h-[400px] overflow-y-auto border border-gray-200 rounded">
                    <table class="export-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" id="selectAllHeader"></th>
                                <th>CID</th>
                                <th>Date</th>
                                <th>Customer Name</th>
                                <th>Product</th>
                                <th>Status</th>
                                <th id="amountHeader">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="exportTableBody"></tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="6" class="text-right font-bold">Total:</td>
                                <td id="totalAmount" class="font-bold">0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button id="cancelExportBtn" class="bg-gray-500 text-white py-2 px-4 rounded hover:bg-gray-600">
                Cancel
            </button>
            <button id="confirmExportBtn" class="custom-btn text-white py-2 px-4 rounded">
                <i class="fas fa-file-pdf mr-2"></i> Export PDF
            </button>
        </div>
    </div>
</div>

<div id="kpiModal" class="modal">
    <div class="modal-content" style="max-width: 95%; max-height: 95%; margin: 20px auto;">
        <div class="modal-header">
            <h2 class="text-lg font-bold text-primary">Key Performance Indicator</h2>
            <span class="close-modal" id="closeKPIModal">&times;</span>
        </div>
        <div class="modal-body">
            <iframe id="kpiIframe" src="kpi.html" style="width: 100%; height: 70vh; border: none; border-radius: 8px;"></iframe>
        </div>
    </div>
</div>

<script>
    window.jsPDF = window.jspdf.jsPDF;
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwBKFBLV1ayE1-RIsdbr11-dZ0yGcFxnwkyoOJXnQrH-vbtSH1sjTCQzBlJTdyufOeOXA/exec';

    let allRecordsData = [], allMasterData = [], masterDataOffset = 0, isShowingAllRecords = false;
    const maxInitialRecords = 10, masterPageSize = 20;
    let currentSelections = { ACC: '', ACC2: '', CC: '', CCOption2: '', PL: '' };
    let editingData = null, editingProductString = "", editingFromMaster = false;
    let isExpanded = false, appInitialized = false, currentFilter = 'all', currentSort = 'all';
    let companyNames = [], statusOptions = [], isInFindRecordsMode = false;

    async function pasteToField(fieldId) {
        try {
            const text = await navigator.clipboard.readText();
            const field = document.getElementById(fieldId);
            if (!field) return;
            
            let processedText = text.trim();
            switch(fieldId) {
                case 'cid': processedText = processedText.replace(/\D/g, ''); break;
                case 'appId': processedText = processedText.replace(/\s/g, ''); break;
                case 'customerName': case 'companyName': processedText = processedText.toUpperCase(); break;
                case 'mobile':
                    processedText = processedText.replace(/\D/g, '');
                    if (processedText.startsWith('0')) processedText = processedText.substring(1);
                    if (processedText.startsWith('971')) processedText = processedText.substring(3);
                    if (processedText.length > 9) processedText = processedText.substring(0, 9);
                    break;
            }
            
            field.value = processedText;
            field.dispatchEvent(new Event('input', { bubbles: true }));
            showSuccess(`Pasted to ${fieldId.replace(/([A-Z])/g, ' $1').toLowerCase()}`);
        } catch (err) {
            showSuccess('Failed to paste. Please try copying the text again.');
        }
    }

    function setupCompanyAutocomplete() {
        const companyNameInput = document.getElementById('companyName');
        const suggestionsDiv = document.getElementById('companySuggestions');
        let selectedIndex = -1;
        
        companyNameInput.addEventListener('input', function() {
            const value = this.value.toUpperCase();
            selectedIndex = -1;
            
            if (value.length < 2) { suggestionsDiv.style.display = 'none'; return; }
            
            const filtered = companyNames.filter(company => company.toUpperCase().includes(value)).slice(0, 10);
            if (filtered.length === 0) { suggestionsDiv.style.display = 'none'; return; }
            
            suggestionsDiv.innerHTML = '';
            filtered.forEach((company, index) => {
                const div = document.createElement('div');
                div.className = 'autocomplete-suggestion';
                div.textContent = company;
                div.addEventListener('click', function() {
                    companyNameInput.value = company;
                    suggestionsDiv.style.display = 'none';
                });
                suggestionsDiv.appendChild(div);
            });
            
            suggestionsDiv.style.display = 'block';
        });
        
        companyNameInput.addEventListener('keydown', function(e) {
            const suggestions = suggestionsDiv.querySelectorAll('.autocomplete-suggestion');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, suggestions.length - 1);
                updateSelection(suggestions);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateSelection(suggestions);
            } else if (e.key === 'Enter' && selectedIndex >= 0) {
                e.preventDefault();
                companyNameInput.value = suggestions[selectedIndex].textContent;
                suggestionsDiv.style.display = 'none';
            } else if (e.key === 'Escape') {
                suggestionsDiv.style.display = 'none';
                selectedIndex = -1;
            }
        });
        
        function updateSelection(suggestions) {
            suggestions.forEach((suggestion, index) => {
                suggestion.classList.toggle('active', index === selectedIndex);
            });
        }
        
        document.addEventListener('click', function(e) {
            if (!companyNameInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                suggestionsDiv.style.display = 'none';
            }
        });
    }

    async function fetchCompanyNames() {
        try {
            const [dataResponse, masterResponse] = await Promise.all([
                fetch(`${scriptURL}?action=getAll`),
                fetch(`${scriptURL}?action=fetchAllMaster&offset=0&limit=1000`)
            ]);
            
            const [dataResult, masterResult] = await Promise.all([
                dataResponse.json(),
                masterResponse.json()
            ]);
            
            const companies = new Set();
            
            if (dataResult.success && dataResult.data) {
                dataResult.data.forEach(record => {
                    if (record['Company Name'] && record['Company Name'].trim()) {
                        companies.add(record['Company Name'].toUpperCase());
                    }
                });
            }
            
            if (masterResult.success && masterResult.data) {
                masterResult.data.forEach(record => {
                    if (record['Company Name'] && record['Company Name'].trim()) {
                        companies.add(record['Company Name'].toUpperCase());
                    }
                });
            }
            
            companyNames = Array.from(companies).sort();
        } catch (error) {
            console.error('Error fetching company names:', error);
        }
    }

    async function fetchStatusOptions() {
        try {
            const response = await fetch(`${scriptURL}?action=getAll`);
            const data = await response.json();
            
            if (data.success && data.data) {
                const uniqueStatuses = [...new Set(
                    data.data.map(record => record.Status).filter(status => status && status.trim() !== '')
                )].sort();
                
                statusOptions = uniqueStatuses;
                populateFilterDropdown();
            }
        } catch (error) {
            console.error('Error fetching status options:', error);
        }
    }

    async function fetchAllMasterData() {
        showLoading();
        try {
            masterDataOffset = 0;
            allMasterData = [];
            
            const response = await fetch(`${scriptURL}?action=fetchAllMaster&offset=${masterDataOffset}&limit=${masterPageSize}`);
            const data = await response.json();
            
            if (data.success) {
                allMasterData = data.data || [];
                masterDataOffset += masterPageSize;
                
                displayDataInTable(allMasterData, 'dataTableBody', true, true, 'master');
                
                const masterShowMoreContainer = document.getElementById('masterShowMoreContainer');
                if (allMasterData.length === masterPageSize) {
                    masterShowMoreContainer.classList.remove('hidden');
                } else {
                    masterShowMoreContainer.classList.add('hidden');
                }
                
                showSuccess(`Fetched ${allMasterData.length} records from Master sheet`);
            } else {
                showSuccess(`Error: ${data.error}`);
                document.getElementById('dataTableBody').innerHTML = '<tr><td colspan="8" class="text-center py-4">Error loading data from Master sheet</td></tr>';
            }
        } catch (error) {
            console.error('Error fetching master data:', error);
            showSuccess('Error fetching data from Master sheet.');
            document.getElementById('dataTableBody').innerHTML = '<tr><td colspan="8" class="text-center py-4">Error connecting to server</td></tr>';
        } finally {
            hideLoading();
        }
    }

    async function loadMoreMasterData() {
        showLoading();
        try {
            const response = await fetch(`${scriptURL}?action=fetchAllMaster&offset=${masterDataOffset}&limit=${masterPageSize}`);
            const data = await response.json();
            
            if (data.success && data.data && data.data.length > 0) {
                const newData = data.data;
                allMasterData = [...allMasterData, ...newData];
                masterDataOffset += masterPageSize;
                
                displayDataInTable(allMasterData, 'dataTableBody', true, true, 'master');
                
                const masterShowMoreContainer = document.getElementById('masterShowMoreContainer');
                if (newData.length < masterPageSize) {
                    masterShowMoreContainer.classList.add('hidden');
                }
                
                showSuccess(`Loaded ${newData.length} more records. Total: ${allMasterData.length}`);
            } else {
                document.getElementById('masterShowMoreContainer').classList.add('hidden');
                showSuccess('No more records to load');
            }
        } catch (error) {
            console.error('Error loading more master data:', error);
            showSuccess('Error loading more data');
        } finally {
            hideLoading();
        }
    }

    async function searchMasterData() {
        showLoading();
        try {
            const response = await fetch(`${scriptURL}?action=searchAllMaster`);
            const data = await response.json();
            
            if (data.success) {
                allMasterData = data.data || [];
                displayDataInTable(allMasterData, 'dataTableBody', true, false, 'master');
                document.getElementById('masterShowMoreContainer').classList.add('hidden');
                showSuccess(`Found ${allMasterData.length} records in Master sheet`);
            } else {
                showSuccess(`Error: ${data.error}`);
                document.getElementById('dataTableBody').innerHTML = '<tr><td colspan="8" class="text-center py-4">Error searching Master sheet</td></tr>';
            }
        } catch (error) {
            console.error('Error searching master data:', error);
            showSuccess('Error searching Master sheet.');
            document.getElementById('dataTableBody').innerHTML = '<tr><td colspan="8" class="text-center py-4">Error connecting to server</td></tr>';
        } finally {
            hideLoading();
        }
    }

    function clearMasterSearch() {
        document.getElementById('dataTableBody').innerHTML = '';
        document.getElementById('masterShowMoreContainer').classList.add('hidden');
        allMasterData = [];
        masterDataOffset = 0;
        showSuccess('Search cleared');
    }

    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date').value = today;
        
        ['cid', 'appId', 'customerName', 'companyName', 'mobile'].forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('input', function(e) {
                    switch(fieldId) {
                        case 'cid': this.value = this.value.replace(/\D/g, ''); break;
                        case 'appId': this.value = this.value.replace(/\s/g, ''); break;
                        case 'customerName': case 'companyName': this.value = this.value.toUpperCase(); break;
                        case 'mobile':
                            let value = this.value.replace(/\D/g, '');
                            if (value.startsWith('0')) value = value.substring(1);
                            if (value.startsWith('971')) value = value.substring(3);
                            if (value.length > 9) value = value.substring(0, 9);
                            this.value = value;
                            break;
                    }
                });
            }
        });
        
        document.getElementById('product2ndCC').disabled = true;
        document.getElementById('product2ndACC').disabled = true;
        document.getElementById('productSTL').disabled = true;
        
        setupProductEventListeners();
        setupFilterDropdown();
        setupSortDropdown();
        setupCompanyAutocomplete();
        setupGlobalSearch();
        setupViewModeToggle();
        setupMasterDataButtons();
        
        fetchCompanyNames();
        fetchStatusOptions();
        
        setTimeout(() => { appInitialized = true; }, 100);
        
        showSection('summary');
        loadProfiles();
    });

    function setupMasterDataButtons() {
        document.getElementById('fetchAllBtn').addEventListener('click', fetchAllMasterData);
        document.getElementById('searchBtn').addEventListener('click', searchMasterData);
        document.getElementById('clearSearchBtn').addEventListener('click', clearMasterSearch);
        document.getElementById('showMoreMasterBtn').addEventListener('click', loadMoreMasterData);
    }

    function setupGlobalSearch() {
        const globalSearchInput = document.getElementById('globalSearch');
        const searchToggleBtn = document.getElementById('searchToggleBtn');
        let searchTimeout;
        
        searchToggleBtn.addEventListener('click', function() {
            const isSearchVisible = !globalSearchInput.classList.contains('hidden');
            
            if (!isSearchVisible) {
                globalSearchInput.classList.remove('hidden');
                globalSearchInput.focus();
                searchToggleBtn.innerHTML = '<i class="fas fa-times"></i>';
                hideOtherButtons();
            } else {
                globalSearchInput.classList.add('hidden');
                globalSearchInput.value = '';
                searchToggleBtn.innerHTML = '<i class="fas fa-search"></i>';
                document.getElementById('dataTableBody').innerHTML = '';
                showOtherButtons();
            }
        });
        
        function hideOtherButtons() {
            ['earnPointsBtn', 'pendingPointsBtn', 'exportDataBtn', 'refreshDataBtn', 'showAllRecordsBtn', 'expandBtn', 'sortDropdownBtn', 'filterDropdownBtn'].forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.style.display = 'none';
            });
        }
        
        function showOtherButtons() {
            ['earnPointsBtn', 'pendingPointsBtn', 'exportDataBtn', 'refreshDataBtn', 'showAllRecordsBtn', 'expandBtn', 'sortDropdownBtn', 'filterDropdownBtn'].forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.style.display = '';
            });
        }
        
        globalSearchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const searchTerm = this.value.trim();
            
            if (searchTerm.length === 0) {
                document.getElementById('dataTableBody').innerHTML = '';
                return;
            }
            
            if (searchTerm.length >= 2) {
                searchTimeout = setTimeout(() => {
                    performGlobalSearch(searchTerm);
                }, 300);
            }
        });
        
        globalSearchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performGlobalSearch(this.value.trim());
            }
        });
    }

    function setupViewModeToggle() {
        const viewModeToggle = document.getElementById('viewModeToggle');
        const viewModeText = document.getElementById('viewModeText');
        const findRecordsControls = document.getElementById('findRecordsControls');
        const viewSectionTitle = document.getElementById('viewSectionTitle');
        const masterShowMoreContainer = document.getElementById('masterShowMoreContainer');
        
        viewModeToggle.addEventListener('click', function() {
            isInFindRecordsMode = !isInFindRecordsMode;
            
            if (isInFindRecordsMode) {
                viewModeText.innerHTML = 'Find Records';
                findRecordsControls.style.display = 'flex';
                viewSectionTitle.textContent = 'Find Records';
            } else {
                viewModeText.innerHTML = 'View All Records';
                findRecordsControls.style.display = 'none';
                viewSectionTitle.textContent = 'View All Records';
                masterShowMoreContainer.classList.add('hidden');
                
                document.getElementById('dataTableBody').innerHTML = '';
                fetchAllData();
            }
        });
    }

    async function performGlobalSearch(searchTerm) {
        if (!searchTerm) return;
        
        showLoading();
        try {
            const [dataResponse, masterResponse] = await Promise.all([
                fetch(`${scriptURL}?action=searchData&term=${encodeURIComponent(searchTerm)}`),
                fetch(`${scriptURL}?action=searchMaster&cid=${encodeURIComponent(searchTerm)}&name=${encodeURIComponent(searchTerm)}&mobile=${encodeURIComponent(searchTerm)}`)
            ]);
            
            const [dataResult, masterResult] = await Promise.all([
                dataResponse.json(),
                masterResponse.json()
            ]);
            
            let combinedResults = [];
            
            if (dataResult.success && dataResult.data) {
                combinedResults = [...dataResult.data];
            }
            
            if (masterResult.success && masterResult.data) {
                masterResult.data.forEach(masterRecord => {
                    const existsInData = combinedResults.some(dataRecord => dataRecord.CID === masterRecord.CID);
                    if (!existsInData) {
                        combinedResults.push(masterRecord);
                    }
                });
            }
            
            displayDataInTable(combinedResults, 'dataTableBody', false, false, 'combined');
            
            if (combinedResults.length === 0) {
                document.getElementById('dataTableBody').innerHTML = '<tr><td colspan="8" class="text-center py-4">No matching records found</td></tr>';
            }
        } catch (error) {
            console.error('Error performing global search:', error);
            showSuccess('Error searching records');
            document.getElementById('dataTableBody').innerHTML = '<tr><td colspan="8" class="text-center py-4">Error searching records</td></tr>';
        } finally {
            hideLoading();
        }
    }

    function setupSortDropdown() {
        const sortBtn = document.getElementById('sortDropdownBtn');
        const sortContent = document.getElementById('sortDropdownContent');
        const sortOptions = document.querySelectorAll('.sort-option');

        sortBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            sortContent.classList.toggle('show');
        });

        document.addEventListener('click', function(e) {
            if (!sortBtn.contains(e.target) && !sortContent.contains(e.target)) {
                sortContent.classList.remove('show');
            }
        });

        sortOptions.forEach(option => {
            option.addEventListener('click', function() {
                const sort = this.dataset.sort;
                
                sortOptions.forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
                
                currentSort = sort;
                applyProductSort(sort);
                
                sortContent.classList.remove('show');
            });
        });
    }

    function applyProductSort(sort) {
        const tableBody = document.getElementById('dataTableBody');
        const rows = Array.from(tableBody.querySelectorAll('tr'));
        
        if (sort === 'all') {
            if (!isShowingAllRecords && allRecordsData.length > 0) {
                displayDataInTable(allRecordsData, 'dataTableBody', false, false, 'data');
                isShowingAllRecords = true;
                document.getElementById('showAllRecordsBtn').innerHTML = '<i class="fas fa-list-alt mr-2"></i>';
            }
            return;
        }
        
        if (!isShowingAllRecords && allRecordsData.length > 0) {
            displayDataInTable(allRecordsData, 'dataTableBody', false, false, 'data');
            isShowingAllRecords = true;
            document.getElementById('showAllRecordsBtn').innerHTML = '<i class="fas fa-list-alt mr-2"></i>';
        }
        
        rows.forEach(row => {
            const productCell = row.cells[4];
            if (!productCell) return;
            
            const productText = productCell.textContent.toLowerCase();
            row.style.display = productMatchesSort(productText, sort) ? '' : 'none';
        });
    }

    function productMatchesSort(productText, sort) {
        const accProducts = ['mdsa', 'aspire 5k-10k', 'aspire 10k-20k', 'privilege 20k-40k', 'privilege 40k & above'];
        const ccProducts = ['touchpoints gold visa', 'touchpoints titanium mc', 'essiential cashback mc', 'talabat mc', 'lulu titanium mc', 'lulu platinum mc', 'touchpoints platinum mc', '365 cashback visa', 'shukran platinum visa', 'etihad guest platinum visa', 'etihad guest signature visa', 'etihad guest infinite visa', 'touchpoints infinite visa', 'traveller mc world elite', 'betaqti mc world elite', 'emirati islamic infinite visa'];
        const plProducts = ['pl asp-a&b', 'pl asp-c&below', 'pl prv-a&b', 'pl prv-c&below', 'top up'];
        const btcclProducts = ['bt/ccl'];
        const otherProducts = ['other'];
        
        switch(sort) {
            case 'acc': return accProducts.some(product => productText.includes(product));
            case 'cc': return ccProducts.some(product => productText.includes(product));
            case 'pl': return plProducts.some(product => productText.includes(product));
            case 'btccl': return btcclProducts.some(product => productText.includes(product));
            case 'other': return otherProducts.some(product => productText.includes(product));
            default: return true;
        }
    }

    function setupFilterDropdown() {
        const filterBtn = document.getElementById('filterDropdownBtn');
        const filterContent = document.getElementById('filterDropdownContent');

        filterBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            filterContent.classList.toggle('show');
        });

        document.addEventListener('click', function(e) {
            if (!filterBtn.contains(e.target) && !filterContent.contains(e.target)) {
                filterContent.classList.remove('show');
            }
        });
    }

    function populateFilterDropdown() {
        const filterContent = document.getElementById('filterDropdownContent');
        filterContent.innerHTML = '';

        const allOption = document.createElement('div');
        allOption.className = 'filter-option active';
        allOption.dataset.filter = 'all';
        allOption.textContent = 'All Status';
        filterContent.appendChild(allOption);

        statusOptions.forEach(status => {
            const option = document.createElement('div');
            option.className = 'filter-option';
            option.dataset.filter = status;
            option.textContent = status;
            filterContent.appendChild(option);
        });

        const filterOptions = filterContent.querySelectorAll('.filter-option');
        filterOptions.forEach(option => {
            option.addEventListener('click', function() {
                const filter = this.dataset.filter;
                
                filterOptions.forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
                
                currentFilter = filter;
                
                if (filter === 'all') {
                    if (isShowingAllRecords) {
                        displayDataInTable(allRecordsData, 'dataTableBody', false, false, 'data');
                    } else {
                        const displayData = allRecordsData.slice(-maxInitialRecords);
                        displayDataInTable(displayData, 'dataTableBody', false, false, 'data');
                    }
                } else {
                    displayDataInTable(allRecordsData, 'dataTableBody', false, false, 'data');
                    isShowingAllRecords = true;
                    document.getElementById('showAllRecordsBtn').innerHTML = '<i class="fas fa-list-alt mr-2"></i>';
                }
                
                applyStatusFilter(filter);
                filterContent.classList.remove('show');
            });
        });
    }

    function applyStatusFilter(filter) {
        const tableBody = document.getElementById('dataTableBody');
        const rows = tableBody.querySelectorAll('tr');
        
        rows.forEach(row => {
            const statusCell = row.cells[5];
            if (!statusCell) return;
            
            const statusText = statusCell.textContent.trim();
            const shouldShow = filter === 'all' || statusText === filter;
            row.style.display = shouldShow ? '' : 'none';
        });
    }

    function setupProductEventListeners() {
        document.getElementById('productACC').addEventListener('change', function() {
            const product2ndACC = document.getElementById('product2ndACC');
            const productSTL = document.getElementById('productSTL');
            
            product2ndACC.disabled = !this.checked;
            productSTL.disabled = !this.checked;
            
            if (!this.checked) {
                product2ndACC.checked = false;
                productSTL.checked = false;
            }
            
            if (appInitialized) updateProductOptions();
        });

        document.getElementById('product2ndACC').addEventListener('change', function() {
            if (appInitialized) setTimeout(() => updateProductOptions(), 100);
        });

        document.getElementById('productSTL').addEventListener('change', function() {
            calculateTotalPoints();
        });

        document.getElementById('productPL').addEventListener('change', function() {
            const loanAmountSection = document.getElementById('loanAmountSection');
            const loanAmountInput = document.getElementById('loanAmount');
            
            if (this.checked) {
                loanAmountSection.classList.remove('hidden');
            } else {
                loanAmountSection.classList.add('hidden');
                loanAmountInput.value = '';
            }
            
            if (appInitialized) updateProductOptions();
        });

        document.getElementById('productCC').addEventListener('change', function() {
            const product2ndCC = document.getElementById('product2ndCC');
            product2ndCC.disabled = !this.checked;
            
            if (!this.checked) product2ndCC.checked = false;
            
            updateActivationVisibility();
            if (appInitialized) updateProductOptions();
        });

        document.getElementById('product2ndCC').addEventListener('change', function() {
            updateActivationVisibility();
            if (appInitialized) updateProductOptions();
        });

        ['productBTCCL', 'productOther'].forEach(id => {
            document.getElementById(id).addEventListener('change', function() {
                if (id === 'productOther') {
                    const otherPointsSection = document.getElementById('otherPointsSection');
                    const otherPointsInput = document.getElementById('otherPoints');
                    
                    if (this.checked) {
                        otherPointsSection.classList.remove('hidden');
                    } else {
                        otherPointsSection.classList.add('hidden');
                        otherPointsInput.value = '';
                    }
                }
                calculateTotalPoints();
            });
        });

        document.getElementById('otherPoints').addEventListener('input', calculateTotalPoints);

        document.querySelectorAll('input[name="proposition"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (appInitialized) updateProductOptions();
            });
        });

        document.getElementById('salary').addEventListener('input', function() {
            if (appInitialized) updateProductOptions();
        });
    }

    function updateActivationVisibility() {
        const ccChecked = document.getElementById('productCC').checked;
        const cc2Checked = document.getElementById('product2ndCC').checked;
        const activationSection = document.getElementById('activationSection');
        
        if (ccChecked || cc2Checked) {
            activationSection.style.display = 'block';
        } else {
            activationSection.style.display = 'none';
        }
    }

    function showSection(section) {
        ['entrySection', 'viewSection', 'summarySection'].forEach(id => {
            document.getElementById(id).classList.remove('active');
        });
        
        ['showEntryBtn', 'showViewBtn', 'showSummaryBtn', 'showKPIBtn'].forEach(id => {
            const btn = document.getElementById(id);
            btn.classList.remove('custom-btn');
            btn.classList.add('bg-gray-500', 'hover:bg-gray-600');
        });
        
        if (section === 'entry') {
            document.getElementById('entrySection').classList.add('active');
            const btn = document.getElementById('showEntryBtn');
            btn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
            btn.classList.add('custom-btn');
        } else if (section === 'view') {
            document.getElementById('viewSection').classList.add('active');
            const btn = document.getElementById('showViewBtn');
            btn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
            btn.classList.add('custom-btn');
            fetchAllData();
        } else if (section === 'summary') {
            document.getElementById('summarySection').classList.add('active');
            const btn = document.getElementById('showSummaryBtn');
            btn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
            btn.classList.add('custom-btn');
            fetchAllDataForSummary();
        }
    }
    
    document.getElementById('showEntryBtn').addEventListener('click', () => showSection('entry'));
    document.getElementById('showViewBtn').addEventListener('click', () => showSection('view'));
    document.getElementById('showSummaryBtn').addEventListener('click', () => showSection('summary'));

    document.getElementById('expandBtn').addEventListener('click', function() {
        isExpanded = !isExpanded;
        toggleColumnVisibility();
        
        const icon = this.querySelector('i');
        if (isExpanded) {
            icon.className = 'fas fa-compress-alt';
            this.title = 'Collapse Columns';
        } else {
            icon.className = 'fas fa-expand-alt';
            this.title = 'Expand Columns';
        }
    });

    function toggleColumnVisibility() {
        const hiddenColumns = ['.cid-column', '.appid-column', '.action-column'];
        
        hiddenColumns.forEach(selector => {
            const elements = document.querySelectorAll(selector);
            elements.forEach(element => {
                if (isExpanded) {
                    element.classList.remove('hidden-column');
                } else {
                    element.classList.add('hidden-column');
                }
            });
        });
    }

    const kpiModal = document.getElementById('kpiModal');
    const closeKPIModal = document.getElementById('closeKPIModal');
    
    document.getElementById('showKPIBtn').addEventListener('click', function() {
        kpiModal.style.display = 'block';
        this.classList.remove('bg-gray-500', 'hover:bg-gray-600');
        this.classList.add('custom-btn');
    });
    
    closeKPIModal.addEventListener('click', function() {
        kpiModal.style.display = 'none';
        document.getElementById('showKPIBtn').classList.remove('custom-btn');
        document.getElementById('showKPIBtn').classList.add('bg-gray-500', 'hover:bg-gray-600');
    });
    
    window.addEventListener('click', function(event) {
        if (event.target === kpiModal) {
            kpiModal.style.display = 'none';
            document.getElementById('showKPIBtn').classList.remove('custom-btn');
            document.getElementById('showKPIBtn').classList.add('bg-gray-500', 'hover:bg-gray-600');
        }
    });

    function showSuccess(message) {
        const indicator = document.getElementById('successIndicator');
        const messageEl = document.getElementById('successMessage');
        
        messageEl.textContent = message;
        indicator.classList.remove('hidden');
        
        setTimeout(() => indicator.classList.add('hidden'), 3000);
    }

    function showLoading() { document.getElementById('loadingIndicator').classList.remove('hidden'); }
    function hideLoading() { document.getElementById('loadingIndicator').classList.add('hidden'); }

    const entryForm = document.getElementById('entryForm');
    const cidInput = document.getElementById('cid');
    const appIdInput = document.getElementById('appId');
    const dateInput = document.getElementById('date');
    const salaryInput = document.getElementById('salary');
    const customerNameInput = document.getElementById('customerName');
    const mobileInput = document.getElementById('mobile');
    const bankingSelect = document.getElementById('banking');
    const otherBankingSection = document.getElementById('otherBankingSection');
    const otherBankingInput = document.getElementById('otherBanking');
    const adcbOverrideCheckbox = document.getElementById('adcbOverride');
    const ccDeductionOverrideCheckbox = document.getElementById('ccDeductionOverride');
    const companyNameInput = document.getElementById('companyName');
    const statusSelect = document.getElementById('status');
    const otherStatusSection = document.getElementById('otherStatusSection');
    const otherStatusInput = document.getElementById('otherStatus');
    const pointsInput = document.getElementById('points');
    const productACC = document.getElementById('productACC');
    const product2ndACC = document.getElementById('product2ndACC');
    const productSTL = document.getElementById('productSTL');
    const productCC = document.getElementById('productCC');
    const product2ndCC = document.getElementById('product2ndCC');
    const productBTCCL = document.getElementById('productBTCCL');
    const productPL = document.getElementById('productPL');
    const productOther = document.getElementById('productOther');
    const loanAmountSection = document.getElementById('loanAmountSection');
    const loanAmountInput = document.getElementById('loanAmount');
    const otherPointsSection = document.getElementById('otherPointsSection');
    const otherPointsInput = document.getElementById('otherPoints');
    const productOptionsContainer = document.getElementById('productOptionsContainer');

    document.getElementById('resetBtn').addEventListener('click', function() {
        resetForm();
    });

    function resetForm() {
        entryForm.reset();
        productOptionsContainer.innerHTML = '';
        [loanAmountSection, otherPointsSection, otherBankingSection, otherStatusSection].forEach(section => section.classList.add('hidden'));
        
        ['nameError', 'mobileError', 'productsError'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById('companySuggestions').style.display = 'none';

        ['submitBtn', 'updateBtn', 'deleteBtn'].forEach((id, index) => {
            const btn = document.getElementById(id);
            if (index === 0) btn.classList.remove('hidden');
            else btn.classList.add('hidden');
        });

        pointsInput.value = '';
        
        [productSTL, product2ndACC, product2ndCC].forEach(product => product.disabled = true);
        productOther.checked = false;
        
        cidInput.disabled = false;
        cidInput.readOnly = false;
        
        document.querySelectorAll('.error-field').forEach(field => field.classList.remove('error-field'));
        
        currentSelections = { ACC: '', ACC2: '', CC: '', CCOption2: '', PL: '' };
        editingData = null;
        editingProductString = "";
        editingFromMaster = false;
        
        [adcbOverrideCheckbox, ccDeductionOverrideCheckbox].forEach(checkbox => checkbox.checked = false);
        
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date').value = today;
        
        updateActivationVisibility();
    }

    bankingSelect.addEventListener('change', function() {
        if (this.value === 'Other') {
            otherBankingSection.classList.remove('hidden');
        } else {
            otherBankingSection.classList.add('hidden');
        }
        calculateTotalPoints();
    });

    [adcbOverrideCheckbox, ccDeductionOverrideCheckbox].forEach(checkbox => {
        checkbox.addEventListener('change', calculateTotalPoints);
    });

    statusSelect.addEventListener('change', function() {
        if (this.value === 'Other') {
            otherStatusSection.classList.remove('hidden');
        } else {
            otherStatusSection.classList.add('hidden');
        }
        
        if (this.value === 'Rejected') {
            pointsInput.value = '0';
        } else {
            calculateTotalPoints();
        }
    });

    function updateProductOptions() {
        if (!appInitialized) return;
        
        const accSelect = document.getElementById('ACCSelect');
        const acc2Select = document.getElementById('ACC2Select');
        const ccSelect = document.getElementById('CCSelect');
        const ccSelect2 = document.getElementById('CCSelect2');
        const plSelect = document.getElementById('PLSelect');
        
        if (accSelect) currentSelections.ACC = accSelect.value;
        if (acc2Select) currentSelections.ACC2 = acc2Select.value;
        if (ccSelect) currentSelections.CC = ccSelect.value;
        if (ccSelect2) currentSelections.CCOption2 = ccSelect2.value;
        if (plSelect) currentSelections.PL = plSelect.value;
        
        productOptionsContainer.innerHTML = '';
        
        if (editingData) {
            initializeProductOptions();
            return;
        }
        
        const proposition = document.querySelector('input[name="proposition"]:checked').value;
        const salary = parseFloat(salaryInput.value) || 0;
        
        if (productACC.checked) {
            const accOptions = getACCOptions(proposition, salary);
            if (accOptions.length > 0) {
                const accDiv = createProductOptionDiv('ACC', accOptions);
                productOptionsContainer.appendChild(accDiv);
                
                const newAccSelect = accDiv.querySelector('select');
                newAccSelect.addEventListener('change', calculateTotalPoints);
                
                if (currentSelections.ACC && newAccSelect.querySelector(`option[value="${currentSelections.ACC}"]`)) {
                    newAccSelect.value = currentSelections.ACC;
                }
            }
            
            if (product2ndACC.checked) {
                const accOptions = getACCOptions(proposition, salary);
                if (accOptions.length > 0) {
                    const acc2Div = createProductOptionDiv('ACC2', accOptions, '2nd ACC');
                    productOptionsContainer.appendChild(acc2Div);
                    
                    const newAcc2Select = acc2Div.querySelector('select');
                    newAcc2Select.addEventListener('change', calculateTotalPoints);
                    
                    setTimeout(() => {
                        if (currentSelections.ACC2 && newAcc2Select.querySelector(`option[value="${currentSelections.ACC2}"]`)) {
                            newAcc2Select.value = currentSelections.ACC2;
                        }
                    }, 50);
                }
            }
        }
        
        if (productCC.checked) {
            const ccOptions = getCCOptions(proposition);
            if (ccOptions.length > 0) {
                const ccDiv = createProductOptionDiv('CC', ccOptions);
                productOptionsContainer.appendChild(ccDiv);
                
                const newCcSelect = ccDiv.querySelector('select');
                newCcSelect.addEventListener('change', function() {
                    calculateTotalPoints();
                    updateCCDropdownOptions();
                });
                
                if (currentSelections.CC && newCcSelect.querySelector(`option[value="${currentSelections.CC}"]`)) {
                    newCcSelect.value = currentSelections.CC;
                }
            }
            
            if (product2ndCC.checked) {
                const ccOptions = getCCOptions(proposition);
                if (ccOptions.length > 0) {
                    const cc2Div = createProductOptionDiv('CC2', ccOptions, '2nd CC');
                    productOptionsContainer.appendChild(cc2Div);
                    
                    const newCc2Select = cc2Div.querySelector('select');
                    newCc2Select.addEventListener('change', function() {
                        calculateTotalPoints();
                        updateCCDropdownOptions();
                    });
                    
                    if (currentSelections.CCOption2 && newCc2Select.querySelector(`option[value="${currentSelections.CCOption2}"]`)) {
                        newCc2Select.value = currentSelections.CCOption2;
                    }
                }
            }
        }
        
        if (productPL.checked) {
            const plOptions = getPLOptions(proposition);
            if (plOptions.length > 0) {
                const plDiv = createProductOptionDiv('PL', plOptions);
                productOptionsContainer.appendChild(plDiv);
                
                const newPlSelect = plDiv.querySelector('select');
                newPlSelect.addEventListener('change', calculateTotalPoints);
                
                if (currentSelections.PL && newPlSelect.querySelector(`option[value="${currentSelections.PL}"]`)) {
                    newPlSelect.value = currentSelections.PL;
                }
                
                loanAmountInput.addEventListener('input', calculateTotalPoints);
            }
        }
        
        updateCCDropdownOptions();
        calculateTotalPoints();
    }

    function updateCCDropdownOptions() {
        const ccSelect = document.getElementById('CCSelect');
        const cc2Select = document.getElementById('CCSelect2');
        
        if (!ccSelect || !cc2Select) return;
        
        const ccValue = ccSelect.value;
        const cc2Value = cc2Select.value;
        
        Array.from(ccSelect.options).forEach(option => {
            option.disabled = option.value === cc2Value;
        });
        
        Array.from(cc2Select.options).forEach(option => {
            option.disabled = option.value === ccValue;
        });
    }

    function initializeProductOptions() {
        if (!editingData) return;
        
        const proposition = document.querySelector('input[name="proposition"]:checked').value;
        const salary = parseFloat(salaryInput.value) || 0;
        
        productOptionsContainer.innerHTML = '';
        
        if (productACC.checked) {
            const accOptions = getACCOptions(proposition, salary);
            
            if (accOptions.length > 0) {
                const accDiv = createProductOptionDiv('ACC', accOptions);
                productOptionsContainer.appendChild(accDiv);
                
                const accSelect = document.getElementById('ACCSelect');
                if (accSelect) {
                    accSelect.addEventListener('change', calculateTotalPoints);
                    setTimeout(() => setAccDropdownFromString(accSelect, editingProductString, 0), 10);
                }
            }
            
            if (product2ndACC.checked) {
                const accOptions = getACCOptions(proposition, salary);
                
                if (accOptions.length > 0) {
                    setTimeout(() => {
                        const acc2Div = createProductOptionDiv('ACC2', accOptions, '2nd ACC');
                        productOptionsContainer.appendChild(acc2Div);
                        
                        const acc2Select = document.getElementById('ACC2Select');
                        if (acc2Select) {
                            acc2Select.addEventListener('change', calculateTotalPoints);
                            setTimeout(() => setAccDropdownFromString(acc2Select, editingProductString, 1), 100);
                        }
                    }, 200);
                }
            }
        }
        
        if (productCC.checked) {
            const ccOptions = getCCOptions(proposition);
            
            if (ccOptions.length > 0) {
                const ccDiv = createProductOptionDiv('CC', ccOptions);
                productOptionsContainer.appendChild(ccDiv);
                
                const ccSelect = document.getElementById('CCSelect');
                if (ccSelect) {
                    ccSelect.addEventListener('change', function() {
                        calculateTotalPoints();
                        updateCCDropdownOptions();
                    });
                    setTimeout(() => setCcDropdownFromString(ccSelect, editingProductString, 0), 10);
                }
            }
            
            if (product2ndCC.checked) {
                const ccOptions = getCCOptions(proposition);
                
                if (ccOptions.length > 0) {
                    const cc2Div = createProductOptionDiv('CC2', ccOptions, '2nd CC');
                    productOptionsContainer.appendChild(cc2Div);
                    
                    const cc2Select = document.getElementById('CCSelect2');
                    if (cc2Select) {
                        cc2Select.addEventListener('change', function() {
                            calculateTotalPoints();
                            updateCCDropdownOptions();
                        });
                        setTimeout(() => setCcDropdownFromString(cc2Select, editingProductString, 1), 10);
                    }
                }
            }
        }
        
        if (productPL.checked) {
            const plOptions = getPLOptions(proposition);
            
            if (plOptions.length > 0) {
                const plDiv = createProductOptionDiv('PL', plOptions);
                productOptionsContainer.appendChild(plDiv);
                
                const plSelect = document.getElementById('PLSelect');
                if (plSelect) {
                    plSelect.addEventListener('change', calculateTotalPoints);
                    setTimeout(() => setPlDropdownFromString(plSelect, editingProductString), 10);
                }
                
                loanAmountInput.addEventListener('input', calculateTotalPoints);
            }
        }
        
        setTimeout(() => {
            updateCCDropdownOptions();
            calculateTotalPoints();
        }, 300);
    }
    
    function setAccDropdownFromString(accSelect, productString, accIndex = 0) {
        if (!accSelect || !productString) return;
        
        const products = productString.split(',').map(p => p.trim());
        const accProducts = products.filter(p => p.includes('MDSA') || p.includes('Aspire') || p.includes('Privilege'));
        
        if (accProducts.length > accIndex) {
            const targetProduct = accProducts[accIndex];
            
            for (let option of accSelect.options) {
                const optionValue = option.value;
                
                if (targetProduct === 'MDSA' && optionValue === 'MDSA') {
                    accSelect.value = optionValue;
                    return;
                } else if (targetProduct.includes('Aspire 5K-10K') && optionValue === 'Aspire5K-10K') {
                    accSelect.value = optionValue;
                    return;
                } else if (targetProduct.includes('Aspire 10K-20K') && optionValue === 'Aspire10K-20K') {
                    accSelect.value = optionValue;
                    return;
                } else if (targetProduct.includes('Privilege 20K-40K') && optionValue === 'Privilege20K-40K') {
                    accSelect.value = optionValue;
                    return;
                } else if (targetProduct.includes('Privilege 40K') && optionValue === 'Privilege40K+') {
                    accSelect.value = optionValue;
                    return;
                }
            }
        }
    }
    
    function setCcDropdownFromString(ccSelect, productString, ccIndex = 0) {
        if (!ccSelect || !productString) return;
        
        const products = productString.split(',').map(p => p.trim());
        const ccProducts = products.filter(p => 
            p.includes('Touchpoints') || p.includes('Cashback') || p.includes('Talabat') ||
            p.includes('Lulu') || p.includes('Etihad') || p.includes('Shukran') ||
            p.includes('All ') || p.includes('Traveller') || p.includes('Betaqti') ||
            p.includes('Emirati')
        );
        
        if (ccProducts.length > ccIndex) {
            const targetProduct = ccProducts[ccIndex];
            
            for (let option of ccSelect.options) {
                const optionText = option.text.toLowerCase();
                const targetText = targetProduct.toLowerCase();
                
                if ((targetText.includes('touchpoints') && optionText.includes('touchpoints')) ||
                    (targetText.includes('cashback') && optionText.includes('cashback')) ||
                    (targetText.includes('talabat') && optionText.includes('talabat')) ||
                    (targetText.includes('lulu') && optionText.includes('lulu')) ||
                    (targetText.includes('etihad') && optionText.includes('etihad')) ||
                    (targetText.includes('shukran') && optionText.includes('shukran')) ||
                    (targetText.includes('traveller') && optionText.includes('traveller')) ||
                    (targetText.includes('betaqti') && optionText.includes('betaqti')) ||
                    (targetText.includes('emirati') && optionText.includes('emirati'))) {
                    
                    if ((targetText.includes('gold') && optionText.includes('gold')) ||
                        (targetText.includes('platinum') && optionText.includes('platinum')) ||
                        (targetText.includes('titanium') && optionText.includes('titanium')) ||
                        (targetText.includes('signature') && optionText.includes('signature')) ||
                        (targetText.includes('infinite') && optionText.includes('infinite')) ||
                        (targetText.includes('365') && optionText.includes('365')) ||
                        (!targetText.includes('gold') && !targetText.includes('platinum') && 
                         !targetText.includes('titanium') && !targetText.includes('signature') && 
                         !targetText.includes('infinite') && !targetText.includes('365'))) {
                        ccSelect.value = option.value;
                        return;
                    }
                }
            }
        }
    }
    
    function setPlDropdownFromString(plSelect, productString) {
        if (!plSelect || !productString) return;
        
        if (productString.includes('PL Asp-A&B')) {
            selectOptionByValue(plSelect, 'PLAspAB');
        } else if (productString.includes('PL Prv-A&B')) {
            selectOptionByValue(plSelect, 'PLPrvAB');
        } else if (productString.includes('PL Asp-C&Below')) {
            selectOptionByValue(plSelect, 'PLAspCBelow');
        } else if (productString.includes('PL Prv-C&Below')) {
            selectOptionByValue(plSelect, 'PLPrvCBelow');
        } else if (productString.includes('TOP UP')) {
            selectOptionByValue(plSelect, 'TOPUP');
        }
    }
    
    function selectOptionByValue(selectElement, value) {
        if (!selectElement) return false;
        
        for (let option of selectElement.options) {
            if (option.value === value) {
                selectElement.value = value;
                return true;
            }
        }
        
        return false;
    }

    function createProductOptionDiv(productType, options, customLabel) {
        const div = document.createElement('div');
        const label = customLabel || productType + ' Option';
        const id = productType === 'CC2' ? 'CCSelect2' : 
                  productType === 'ACC2' ? 'ACC2Select' : 
                  `${productType}Select`;
        
        let optionsHtml = '<option value="">Select ' + label + '</option>';
        
        options.forEach(option => {
            const extraAttributes = [];
            
            if (option.points) extraAttributes.push(`data-points="${option.points}"`);
            if (option.paid !== undefined) extraAttributes.push(`data-paid="${option.paid}"`);
            if (option.disableSTL !== undefined) extraAttributes.push(`data-disablestl="${option.disableSTL}"`);
            if (option.minSalary !== undefined) extraAttributes.push(`data-minsalary="${option.minSalary}"`);
            if (option.maxSalary !== undefined) extraAttributes.push(`data-maxsalary="${option.maxSalary}"`);
            
            optionsHtml += `<option value="${option.value}" ${extraAttributes.join(' ')}>${option.text}</option>`;
        });
        
        div.innerHTML = `
            <label for="${id}" class="styled-label">${label}</label>
            <select id="${id}" class="styled-select" data-product="${productType}">
                ${optionsHtml}
            </select>
        `;
        return div;
    }

    function getACCOptions(proposition, salary) {
        const options = [];
        
        options.push({ value: "Aspire5K-10K", text: "Aspire 5K-10K", points: 150, minSalary: 5000, maxSalary: 9999, disableSTL: false });
        options.push({ value: "Aspire10K-20K", text: "Aspire 10K-20K", points: 400, minSalary: 10000, maxSalary: 19999, disableSTL: false });
        options.push({ value: "Privilege20K-40K", text: "Privilege 20K-40K", points: 550, minSalary: 20000, maxSalary: 39999, disableSTL: false });
        options.push({ value: "Privilege40K+", text: "Privilege 40K & Above", points: 800, minSalary: 40000, maxSalary: Infinity, disableSTL: false });
        
        if (proposition === "Islamic" || proposition === "Both") {
            options.push({ 
                value: "MDSA", 
                text: "MDSA", 
                points: 110,
                minSalary: 3000,
                maxSalary: Infinity,
                disableSTL: false
            });
        }
        
        return options;
    }

    function getCCOptions(proposition) {
        if (proposition === "Conventional") {
            return [
                { value: "TouchpointsGoldVisa", text: "Touchpoints Gold Visa", points: 300, paid: false },
                { value: "TouchpointsTitaniumMC", text: "Touchpoints Titanium MC", points: 200, paid: false },
                { value: "EssientialCashbackMC", text: "Essiential Cashback MC", points: 200, paid: false },
                { value: "TalabatMC", text: "Talabat MC", points: 150, paid: false },
                { value: "LuluTitaniumMC", text: "Lulu Titanium MC", points: 200, paid: false },
                { value: "LuluPlatinumMC", text: "Lulu Platinum MC", points: 200, paid: false },
                { value: "TouchpointsPlatinumMC", text: "Touchpoints Platinum MC", points: 400, paid: true },
                { value: "365CashbackVisa", text: "365 Cashback Visa", points: 500, paid: true },
                { value: "ShukranPlatinumVisa", text: "Shukran Platinum Visa", points: 300, paid: true },
                { value: "EtihadGuestPlatinumVisa", text: "Etihad Guest Platinum Visa", points: 500, paid: true },
                { value: "EtihadGuestSignatureVisa", text: "Etihad Guest Signature Visa", points: 500, paid: true },
                { value: "EtihadGuestInfiniteVisa", text: "Etihad Guest Infinite Visa", points: 750, paid: true },
                { value: "TouchpointsInfiniteVisa", text: "Touchpoints Infinite Visa", points: 800, paid: true },
                { value: "TravellerMCWorldElite", text: "Traveller MC World Elite", points: 800, paid: true },
                { value: "BetaqtiMCWorldElite", text: "Betaqti MC World Elite", points: 1000, paid: true }
            ];
        } else if (proposition === "Islamic") {
            return [
                { value: "TouchpointsGoldVisa", text: "Touchpoints Gold Visa", points: 300, paid: false },
                { value: "TalabatMC", text: "Talabat MC", points: 150, paid: false },
                { value: "TouchpointsPlatinumVisa", text: "Touchpoints Platinum Visa", points: 500, paid: true },
                { value: "365CashbackVisa", text: "365 Cashback Visa", points: 500, paid: true },
                { value: "ShukranPlatinumVisa", text: "Shukran Platinum Visa", points: 300, paid: true },
                { value: "EtihadGuestPlatinumVisa", text: "Etihad Guest Platinum Visa", points: 500, paid: true },
                { value: "EtihadGuestSignatureVisa", text: "Etihad Guest Signature Visa", points: 500, paid: true },
                { value: "TouchpointsInfiniteVisa", text: "Touchpoints Infinite Visa", points: 800, paid: true },
                { value: "EtihadGuestInfiniteVisa", text: "Etihad Guest Infinite Visa", points: 750, paid: true },
                { value: "EmiratiIslamicInfiniteVisa", text: "Emirati Islamic Infinite Visa", points: 750, paid: true }
            ];
        } else if (proposition === "Both") {
            const conventional = getCCOptions("Conventional");
            const islamic = getCCOptions("Islamic");
            const combinedOptions = [...conventional];
            
            islamic.forEach(islamicOption => {
                if (!conventional.some(convOption => convOption.value === islamicOption.value)) {
                    combinedOptions.push(islamicOption);
                }
            });
            
            return combinedOptions;
        }
        
        return [];
    }

    function getPLOptions(proposition) {
        return [
            { value: "PLAspAB", text: "PL Asp-A&B", points: "0.50%" },
            { value: "PLPrvAB", text: "PL Prv-A&B", points: "0.50%" },
            { value: "PLAspCBelow", text: "PL Asp-C&Below", points: "0.25%" },
            { value: "PLPrvCBelow", text: "PL Prv-C&Below", points: "0.25%" },
            { value: "TOPUP", text: "TOP UP", points: "0%" }
        ];
    }

    function calculateTotalPoints() {
        if (statusSelect.value === 'Rejected') {
            pointsInput.value = '0';
            return;
        }
        
        let totalPoints = 0;
        const isAccCompletedUnderReview = statusSelect.value === 'ACC Completed, Under Review';
        
        if (isAccCompletedUnderReview) {
            if (productACC.checked) {
                const accSelect = document.getElementById('ACCSelect');
                if (accSelect && accSelect.value) {
                    const selectedOption = accSelect.options[accSelect.selectedIndex];
                    const accPoints = parseInt(selectedOption.dataset.points) || 0;
                    totalPoints += accPoints;
                }
            }
            
            if (product2ndACC.checked) {
                const acc2Select = document.getElementById('ACC2Select');
                if (acc2Select && acc2Select.value) {
                    const selectedOption = acc2Select.options[acc2Select.selectedIndex];
                    const acc2Points = parseInt(selectedOption.dataset.points) || 0;
                    totalPoints += acc2Points;
                }
            }
            
            if (productCC.checked) {
                const ccSelect = document.getElementById('CCSelect');
                if (ccSelect && ccSelect.value) {
                    const selectedOption = ccSelect.options[ccSelect.selectedIndex];
                    let ccPoints = parseInt(selectedOption.dataset.points) || 0;
                    
                    if (!productACC.checked) {
                        if (ccDeductionOverrideCheckbox.checked) {
                            ccPoints = Math.round(ccPoints * 0.5);
                        } else if (!adcbOverrideCheckbox.checked && bankingSelect.value !== 'ADCB') {
                            ccPoints = Math.round(ccPoints * 0.7);
                        }
                    } else {
                        if (ccDeductionOverrideCheckbox.checked) {
                            ccPoints = Math.round(ccPoints * 0.5);
                        }
                    }
                    
                    totalPoints += ccPoints;
                    
                    if (product2ndCC.checked) {
                        const cc2Select = document.getElementById('CCSelect2');
                        if (cc2Select && cc2Select.value) {
                            const selectedOption2 = cc2Select.options[cc2Select.selectedIndex];
                            const isPaid = selectedOption2.dataset.paid === "true";
                            
                            totalPoints += isPaid ? 250 : 80;
                        }
                    }
                }
            }
            
            if (productBTCCL.checked) totalPoints += 100;
            
            if (productOther.checked) {
                const otherPointsValue = parseFloat(otherPointsInput.value) || 0;
                totalPoints += otherPointsValue;
            }
            
            if (productPL.checked) {
                const plSelect = document.getElementById('PLSelect');
                const loanAmount = parseFloat(loanAmountInput.value) || 0;
                
                if (plSelect && plSelect.value && loanAmount > 0) {
                    const selectedOption = plSelect.options[plSelect.selectedIndex];
                    const pointsPercentage = selectedOption.dataset.points;
                    
                    if (pointsPercentage === "0%" || plSelect.value === "TOPUP") {
                        totalPoints += 0;
                    } else if (pointsPercentage === "0.50%") {
                        totalPoints += loanAmount * 0.005;
                    } else if (pointsPercentage === "0.25%") {
                        totalPoints += loanAmount * 0.0025;
                    }
                }
            }
            
            pointsInput.value = totalPoints.toFixed(2);
            return;
        }
        
        if (productACC.checked) {
            const accSelect = document.getElementById('ACCSelect');
            if (accSelect && accSelect.value) {
                const selectedOption = accSelect.options[accSelect.selectedIndex];
                const accPoints = parseInt(selectedOption.dataset.points) || 0;
                
                if (productSTL.checked && !productSTL.disabled) {
                    totalPoints += accPoints;
                }
            }
        }
        
        if (product2ndACC.checked) {
            const acc2Select = document.getElementById('ACC2Select');
            if (acc2Select && acc2Select.value) {
                const selectedOption = acc2Select.options[acc2Select.selectedIndex];
                const acc2Points = parseInt(selectedOption.dataset.points) || 0;
                
                if (productSTL.checked && !productSTL.disabled) {
                    totalPoints += acc2Points;
                }
            }
        }
        
        if (productCC.checked) {
            const ccSelect = document.getElementById('CCSelect');
            if (ccSelect && ccSelect.value) {
                const selectedOption = ccSelect.options[ccSelect.selectedIndex];
                let ccPoints = parseInt(selectedOption.dataset.points) || 0;
                
                if (!productACC.checked) {
                    if (ccDeductionOverrideCheckbox.checked) {
                        ccPoints = Math.round(ccPoints * 0.5);
                    } else if (!adcbOverrideCheckbox.checked && bankingSelect.value !== 'ADCB') {
                        ccPoints = Math.round(ccPoints * 0.7);
                    }
                } else {
                    if (ccDeductionOverrideCheckbox.checked) {
                        ccPoints = Math.round(ccPoints * 0.5);
                    }
                }
                
                totalPoints += ccPoints;
                
                if (product2ndCC.checked) {
                    const cc2Select = document.getElementById('CCSelect2');
                    if (cc2Select && cc2Select.value) {
                        const selectedOption2 = cc2Select.options[cc2Select.selectedIndex];
                        const isPaid = selectedOption2.dataset.paid === "true";
                        
                        totalPoints += isPaid ? 250 : 80;
                    }
                }
            }
        }
        
        if (productBTCCL.checked) totalPoints += 100;
        
        if (productOther.checked) {
            const otherPointsValue = parseFloat(otherPointsInput.value) || 0;
            totalPoints += otherPointsValue;
        }
        
        if (productPL.checked) {
            const plSelect = document.getElementById('PLSelect');
            const loanAmount = parseFloat(loanAmountInput.value) || 0;
            
            if (plSelect && plSelect.value && loanAmount > 0) {
                const selectedOption = plSelect.options[plSelect.selectedIndex];
                const pointsPercentage = selectedOption.dataset.points;
                
                if (pointsPercentage === "0%" || plSelect.value === "TOPUP") {
                    totalPoints += 0;
                } else if (pointsPercentage === "0.50%") {
                    totalPoints += loanAmount * 0.005;
                } else if (pointsPercentage === "0.25%") {
                    totalPoints += loanAmount * 0.0025;
                }
            }
        }
        
        pointsInput.value = totalPoints.toFixed(2);
    }

    async function fetchAllData() {
        showLoading();
        try {
            const response = await fetch(`${scriptURL}?action=getAll`);
            const data = await response.json();
            
            if (data.success) {
                allRecordsData = data.data || [];
                
                isShowingAllRecords = false;
                const displayData = allRecordsData.slice(-maxInitialRecords);
                displayDataInTable(displayData, 'dataTableBody', false, false, 'data');
                calculatePointsTotals(allRecordsData);
                
                fetchStatusOptions();
            } else {
                showSuccess(`Error: ${data.error}`);
                document.getElementById('dataTableBody').innerHTML = '<tr><td colspan="8" class="text-center py-4">Error loading data from server</td></tr>';
            }
        } catch (error) {
            console.error('Error fetching data:', error);
            showSuccess('Error fetching data from server.');
            document.getElementById('dataTableBody').innerHTML = '<tr><td colspan="8" class="text-center py-4">Error connecting to server</td></tr>';
        } finally {
            hideLoading();
        }
    }

    document.getElementById('showAllRecordsBtn').addEventListener('click', function() {
        if (!isShowingAllRecords && allRecordsData.length > 0) {
            displayDataInTable(allRecordsData, 'dataTableBody', false, false, 'data');
            isShowingAllRecords = true;
            this.innerHTML = '<i class="fas fa-list-alt mr-2"></i>';
        } else {
            const displayData = allRecordsData.slice(-maxInitialRecords);
            displayDataInTable(displayData, 'dataTableBody', false, false, 'data');
            isShowingAllRecords = false;
            this.innerHTML = '<i class="fas fa-list mr-2"></i>';
        }
    });

    function calculatePointsTotals(data) {
        let earnedPoints = 0, pendingPoints = 0;
        
        data.forEach(record => {
            const points = parseFloat(record.Points) || 0;
            if (record.Status === 'Completed') {
                earnedPoints += points;
            } else if (record.Status !== 'Rejected') {
                pendingPoints += points;
            }
        });
        
        document.getElementById('earnedPointsTotal').textContent = Math.round(earnedPoints);
        document.getElementById('pendingPointsTotal').textContent = Math.round(pendingPoints);
    }

    async function fetchAllDataForSummary() {
        showLoading();
        try {
            const response = await fetch(`${scriptURL}?action=getAll`);
            const data = await response.json();
            
            if (data.success) {
                populateSummaryData(data.data || []);
            } else {
                showSuccess(`Error: ${data.error}`);
            }
        } catch (error) {
            console.error('Error fetching data for summary:', error);
            showSuccess('Error fetching data from server.');
        } finally {
            hideLoading();
        }
    }

    function populateSummaryData(data) {
        if (!data || data.length === 0) {
            ['summaryEarnedPoints', 'summaryPendingPoints', 'summaryTotalPoints', 'summaryInProgressCC', 'summaryInProgressPL', 'summaryInProgressMDSA', 'summaryInProgressPrivilege', 'summaryCompletedCC', 'summaryCompletedPL', 'summaryCompletedMDSA', 'summaryCompletedPrivilege', 'summaryTotalCC', 'summaryTotalAccounts', 'fundingTotal', 'fundingMDSACount', 'fundingMDSAPoints', 'fundingAspireCount', 'fundingAspirePoints', 'fundingPrivilegeCount', 'fundingPrivilegePoints'].forEach((id, index) => {
                const element = document.getElementById(id);
                if (element) {
                    if (id.includes('PL')) element.textContent = "AED 0";
                    else if (id.includes('fundingTotal')) element.textContent = "0 (0 pts)";
                    else if (id.includes('Points')) element.textContent = "(0 pts)";
                    else element.textContent = "0";
                }
            });
            document.getElementById('summaryTotalPL').textContent = "AED 0";
            return;
        }
        
        let earnedPoints = 0, pendingPoints = 0;
        let inProgressCC = 0, completedCC = 0;
        let inProgressLoanAmount = 0, completedLoanAmount = 0;
        let inProgressMDSA = 0, completedMDSA = 0;
        let inProgressPrivilege = 0, completedPrivilege = 0;
        let conventionalCount = 0, islamicCount = 0, bothCount = 0;
        let aspireCount = 0, privilegeCount = 0, mdsaCount = 0;
        let tmlAllCount = 0, tmlCCCount = 0, tmSelectCount = 0, ntmlCount = 0;
        
        let plConventionalCount = 0, plIslamicCount = 0, plBothCount = 0;
        let ccConventionalCount = 0, ccIslamicCount = 0, ccBothCount = 0;
        let plTotalAmount = 0, ccTotalCount = 0;
        
        let fundingMDSACount = 0, fundingMDSAPoints = 0;
        let fundingAspireCount = 0, fundingAspirePoints = 0;
        let fundingPrivilegeCount = 0, fundingPrivilegePoints = 0;
        
        data.forEach(record => {
            const points = parseFloat(record.Points) || 0;
            const isCompleted = record.Status === 'Completed';
            const isAccCompletedUnderReview = record.Status === 'ACC Completed, Under Review';
            const isRejected = record.Status === 'Rejected';
            const productString = record.Product || '';
            const proposition = record.Proposition || '';
            const scheme = record.Scheme || '';
            const loanAmount = parseFloat(record['Loan Amount']) || 0;
            
            if (isCompleted) {
                earnedPoints += points;
            } else if (!isRejected) {
                pendingPoints += points;
            }
            
            const hasPL = productString.includes('PL Asp-A&B') || 
                         productString.includes('PL Asp-C&Below') || 
                         productString.includes('PL Prv-A&B') || 
                         productString.includes('PL Prv-C&Below') || 
                         productString.includes('TOP UP');
            
            const hasCC = productString.includes('Touchpoints') ||
                         productString.includes('Cashback') ||
                         productString.includes('Talabat') ||
                         productString.includes('Lulu') ||
                         productString.includes('Etihad') ||
                         productString.includes('Shukran') ||
                         productString.includes('Traveller') ||
                         productString.includes('Betaqti') ||
                         productString.includes('Emirati') ||
                         productString.includes('Visa') ||
                         productString.includes('MC');
            
            if (hasPL && loanAmount > 0) {
                plTotalAmount += loanAmount;
                if (proposition === 'Conventional') plConventionalCount++;
                else if (proposition === 'Islamic') plIslamicCount++;
                else if (proposition === 'Both') plBothCount++;
            }
            
            if (hasCC) {
                ccTotalCount++;
                if (proposition === 'Conventional') ccConventionalCount++;
                else if (proposition === 'Islamic') ccIslamicCount++;
                else if (proposition === 'Both') ccBothCount++;
            }
            
            if (!isRejected && !productString.includes('STL')) {
                if (productString.includes('MDSA')) {
                    fundingMDSACount++;
                    fundingMDSAPoints += 110;
                } 
                
                if (productString.includes('Aspire 5K-10K') || productString.includes('Aspire 10K-20K')) {
                    fundingAspireCount++;
                    if (productString.includes('Aspire 5K-10K')) fundingAspirePoints += 150;
                    else if (productString.includes('Aspire 10K-20K')) fundingAspirePoints += 400;
                }
                
                if (productString.includes('Privilege 20K-40K') || productString.includes('Privilege 40K')) {
                    fundingPrivilegeCount++;
                    if (productString.includes('Privilege 20K-40K')) fundingPrivilegePoints += 550;
                    else if (productString.includes('Privilege 40K')) fundingPrivilegePoints += 800;
                }
            }
            
            let ccCount = 0;
            const ccOptions = getCCOptions('Both');
            const allCCNames = ccOptions.map(option => option.text);
            
            const isCreditCard = (product) => {
                return allCCNames.some(ccName => 
                    product.includes(ccName) || 
                    (product.includes('Visa') && !product.includes('BT/CCL')) ||
                    (product.includes('MC') && !product.includes('BT/CCL')) ||
                    (product === 'CC') || 
                    (product === '2ndCC')
                );
            };
            
            if (productString) {
                const products = productString.split(',').map(p => p.trim());
                products.forEach(product => {
                    if (isCreditCard(product)) ccCount++;
                });
            }

            const hasMDSA = productString.includes('MDSA');
            const hasPrivilege = productString.includes('Privilege');

            if (isAccCompletedUnderReview) {
                if (hasMDSA) completedMDSA++;
                if (hasPrivilege) completedPrivilege++;
                
                if (hasCC) inProgressCC += ccCount;
                if (hasPL && loanAmount > 0) inProgressLoanAmount += loanAmount;
            } else if (isCompleted) {
                completedCC += ccCount;
                if (loanAmount > 0) completedLoanAmount += loanAmount;
                if (hasMDSA) completedMDSA++;
                if (hasPrivilege) completedPrivilege++;
            } else if (!isRejected) {
                inProgressCC += ccCount;
                if (loanAmount > 0) inProgressLoanAmount += loanAmount;
                if (hasMDSA) inProgressMDSA++;
                if (hasPrivilege) inProgressPrivilege++;
            }
            
            if (proposition === 'Conventional') conventionalCount++;
            else if (proposition === 'Islamic') islamicCount++;
            else if (proposition === 'Both') bothCount++;
            
            if (productString.includes('Aspire')) aspireCount++;
            else if (productString.includes('Privilege')) privilegeCount++;
            else if (productString.includes('MDSA')) mdsaCount++;
            
            if (isCompleted) {
                if (scheme === 'TML ALL') tmlAllCount++;
                else if (scheme === 'TML CC') tmlCCCount++;
                else if (scheme === 'TM SELECT') tmSelectCount++;
                else if (scheme === 'NTML') ntmlCount++;
            }
        });
        
        const totalPoints = earnedPoints + pendingPoints;
        const totalCC = inProgressCC + completedCC;
        const totalLoanAmount = inProgressLoanAmount + completedLoanAmount;
        const totalAccounts = aspireCount + privilegeCount + mdsaCount;
        
        function formatCurrency(amount) {
            return 'AED ' + amount.toLocaleString('en-US');
        }
        
        document.getElementById('summaryEarnedPoints').textContent = Math.round(earnedPoints);
        document.getElementById('summaryPendingPoints').textContent = Math.round(pendingPoints);
        document.getElementById('summaryTotalPoints').textContent = Math.round(totalPoints);
        
        document.getElementById('summaryInProgressCC').textContent = inProgressCC;
        document.getElementById('summaryInProgressPL').textContent = formatCurrency(inProgressLoanAmount);
        document.getElementById('summaryInProgressMDSA').textContent = inProgressMDSA;
        document.getElementById('summaryInProgressPrivilege').textContent = inProgressPrivilege;
        
        document.getElementById('summaryCompletedCC').textContent = completedCC;
        document.getElementById('summaryCompletedPL').textContent = formatCurrency(completedLoanAmount);
        document.getElementById('summaryCompletedMDSA').textContent = completedMDSA;
        document.getElementById('summaryCompletedPrivilege').textContent = completedPrivilege;
        
        document.getElementById('summaryTotalCC').textContent = totalCC > 0 ? totalCC : "0";
        document.getElementById('summaryTotalPL').textContent = formatCurrency(totalLoanAmount > 0 ? totalLoanAmount : 0);
        document.getElementById('summaryTotalAccounts').textContent = totalAccounts > 0 ? totalAccounts : "0";
        
        const totalFundingCount = fundingMDSACount + fundingAspireCount + fundingPrivilegeCount;
        const totalFundingPoints = fundingMDSAPoints + fundingAspirePoints + fundingPrivilegePoints;
        
        document.getElementById('fundingTotal').textContent = `${totalFundingCount} (${totalFundingPoints} pts)`;
        document.getElementById('fundingMDSACount').textContent = `${fundingMDSACount}`;
        document.getElementById('fundingMDSAPoints').textContent = `(${fundingMDSAPoints} pts)`;
        document.getElementById('fundingAspireCount').textContent = `${fundingAspireCount}`;
        document.getElementById('fundingAspirePoints').textContent = `(${fundingAspirePoints} pts)`;
        document.getElementById('fundingPrivilegeCount').textContent = `${fundingPrivilegeCount}`;
        document.getElementById('fundingPrivilegePoints').textContent = `(${fundingPrivilegePoints} pts)`;
        
        updateTargetProgress('CC', completedCC);
        updateTargetProgress('PL', completedLoanAmount);
        updateTargetProgress('ACC', totalAccounts);
        
        updateVisualizations(conventionalCount, islamicCount, bothCount, aspireCount, privilegeCount, mdsaCount, tmlAllCount, tmlCCCount, tmSelectCount, ntmlCount, plConventionalCount, plIslamicCount, plBothCount, ccConventionalCount, ccIslamicCount, ccBothCount);
    }

    function updateVisualizations(conventional, islamic, both, aspire, privilege, mdsa, tmlAll, tmlCC, tmSelect, ntml, plConventional, plIslamic, plBoth, ccConventional, ccIslamic, ccBoth) {
        const totalAccounts = aspire + privilege + mdsa || 1;
        const totalSchemes = tmlAll + tmlCC + tmSelect + ntml || 1;
        
        const totalPL = plConventional + plIslamic + plBoth || 1;
        const totalCC = ccConventional + ccIslamic + ccBoth || 1;
        
        const plConventionalPercent = Math.round((plConventional / totalPL) * 100);
        const plIslamicPercent = Math.round((plIslamic / totalPL) * 100);
        const plBothPercent = 100 - plConventionalPercent - plIslamicPercent;
        
        const ccConventionalPercent = Math.round((ccConventional / totalCC) * 100);
        const ccIslamicPercent = Math.round((ccIslamic / totalCC) * 100);
        const ccBothPercent = 100 - ccConventionalPercent - ccIslamicPercent;
        
        const aspirePercent = Math.round((aspire / totalAccounts) * 100);
        const privilegePercent = Math.round((privilege / totalAccounts) * 100);
        const mdsaPercent = 100 - aspirePercent - privilegePercent;
        
        const tmlAllPercent = Math.round((tmlAll / totalSchemes) * 100);
        const tmlCCPercent = Math.round((tmlCC / totalSchemes) * 100);
        const tmSelectPercent = Math.round((tmSelect / totalSchemes) * 100);
        const ntmlPercent = 100 - tmlAllPercent - tmlCCPercent - tmSelectPercent;
        
        document.getElementById('plConventionalPercent').textContent = `${plConventionalPercent}%`;
        document.getElementById('plIslamicPercent').textContent = `${plIslamicPercent}%`;
        document.getElementById('plBothPercent').textContent = `${plBothPercent}%`;
        
        document.getElementById('ccConventionalPercent').textContent = `${ccConventionalPercent}%`;
        document.getElementById('ccIslamicPercent').textContent = `${ccIslamicPercent}%`;
        document.getElementById('ccBothPercent').textContent = `${ccBothPercent}%`;
        
        document.getElementById('aspirePercent').textContent = `${aspirePercent}%`;
        document.getElementById('privilegePercent').textContent = `${privilegePercent}%`;
        document.getElementById('mdsaPercent').textContent = `${mdsaPercent}%`;
        
        document.getElementById('tmlAllPercent').textContent = `${tmlAllPercent}%`;
        document.getElementById('tmlCCPercent').textContent = `${tmlCCPercent}%`;
        document.getElementById('tmSelectPercent').textContent = `${tmSelectPercent}%`;
        document.getElementById('ntmlPercent').textContent = `${ntmlPercent}%`;
        
        updatePieChart('pl-proposition-chart', [
            { value: plConventionalPercent, color: '#FF5349' },
            { value: plIslamicPercent, color: '#2197b2' },
            { value: plBothPercent, color: '#d8dee9' }
        ]);
        
        updatePieChart('cc-proposition-chart', [
            { value: ccConventionalPercent, color: '#32CD32' },
            { value: ccIslamicPercent, color: '#FF8C00' },
            { value: ccBothPercent, color: '#9370DB' }
        ]);
        
        updatePieChart('acc-chart', [
            { value: aspirePercent, color: '#FEFE22' },
            { value: privilegePercent, color: '#F96714' },
            { value: mdsaPercent, color: '#2197b2' }
        ]);
        
        updatePieChart('scheme-chart', [
            { value: tmlAllPercent, color: '#77DDE7' },
            { value: tmlCCPercent, color: '#FF1DCE' },
            { value: tmSelectPercent, color: '#B2EC5D' },
            { value: ntmlPercent, color: '#A2ADD0' }
        ]);
        
        document.getElementById('plPercentageText').textContent = `${totalPL}`;
        document.getElementById('ccPercentageText').textContent = `${totalCC}`;
        document.getElementById('accPercentageText').textContent = `${totalAccounts}`;
        document.getElementById('schemePercentageText').textContent = `${totalSchemes}`;
    }

    function updatePieChart(chartClass, segments) {
        const chart = document.querySelector(`.${chartClass}`);
        if (!chart) return;
        
        let cumulativePercent = 0;
        let gradients = [];
        
        segments.forEach(segment => {
            const segmentPercent = segment.value;
            if (segmentPercent > 0) {
                gradients.push(`${segment.color} ${cumulativePercent}% ${cumulativePercent + segmentPercent}%`);
                cumulativePercent += segmentPercent;
            }
        });
        
        if (gradients.length > 0) {
            chart.style.background = `conic-gradient(${gradients.join(', ')})`;
        } else {
            chart.style.background = '#f0f0f0';
        }
    }

    function updateTargetProgress(type, current) {
        const targetInput = document.getElementById(`target${type}`);
        const progressBar = document.getElementById(`progress${type}`);
        const remainingSpan = document.getElementById(`remaining${type}`);
        
        if (!targetInput || !progressBar || !remainingSpan) return;
        
        const target = parseFloat(targetInput.value) || 0;
        let remaining, progress;
        
        if (type === 'PL') {
            remaining = Math.max(0, target - current);
            progress = target > 0 ? (current / target) * 100 : 0;
            remainingSpan.textContent = remaining.toLocaleString('en-US');
        } else {
            remaining = Math.max(0, target - current);
            progress = target > 0 ? (current / target) * 100 : 0;
            remainingSpan.textContent = remaining;
        }
        
        progress = Math.min(100, progress);
        progressBar.style.width = `${progress}%`;
        progressBar.textContent = `${Math.round(progress)}%`;
        
        if (progress >= 100) {
            progressBar.className = 'progress-fill bg-green-500';
        } else if (progress >= 75) {
            progressBar.className = 'progress-fill bg-yellow-500';
        } else if (type === 'CC') {
            progressBar.className = 'progress-fill bg-blue-500';
        } else if (type === 'PL') {
            progressBar.className = 'progress-fill bg-green-500';
        } else {
            progressBar.className = 'progress-fill bg-purple-500';
        }
    }

    ['targetCC', 'targetPL', 'targetACC'].forEach(id => {
        document.getElementById(id).addEventListener('input', function() {
            const type = id.replace('target', '');
            const currentVal = type === 'CC' ? parseInt(document.getElementById('summaryTotalCC').textContent) || 0 :
                              type === 'PL' ? parseFloat(document.getElementById('summaryTotalPL').textContent.replace(/[^\d.-]/g, '')) || 0 :
                              parseInt(document.getElementById('summaryTotalAccounts').textContent) || 0;
            updateTargetProgress(type, currentVal);
        });
    });

    document.getElementById('copySummaryBtn').addEventListener('click', function() {
        window.print();
    });

    function displayDataInTable(data, tableBodyId, showEditButtons = false, isPaginated = false, source = 'data') {
        const tableBody = document.getElementById(tableBodyId);
        if (!tableBody) return;
        
        tableBody.innerHTML = '';
        
        if (!data || data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4">No data available</td></tr>';
            return;
        }
        
        data.forEach((record, index) => {
            const row = document.createElement('tr');
            
            const cidCell = document.createElement('td');
            cidCell.className = 'cid-column hidden-column';
            cidCell.textContent = record.CID || '';
            row.appendChild(cidCell);
            
            const appIdCell = document.createElement('td');
            appIdCell.className = 'appid-column hidden-column';
            appIdCell.textContent = record['App ID'] || '';
            row.appendChild(appIdCell);
            
            const nameCell = document.createElement('td');
            nameCell.textContent = record['Customer Name'] || '';
            row.appendChild(nameCell);
            
            const mobileCell = document.createElement('td');
            const mobile = record.Mobile || '';
            mobileCell.textContent = mobile ? `971${mobile}` : '';
            row.appendChild(mobileCell);
            
            const productCell = document.createElement('td');
            productCell.textContent = record.Product || '';
            row.appendChild(productCell);
            
            const statusCell = document.createElement('td');
            statusCell.textContent = record.Status || '';
            row.appendChild(statusCell);
            
            const pointsCell = document.createElement('td');
            pointsCell.textContent = record.Points || '0';
            row.appendChild(pointsCell);
            
            const actionCell = document.createElement('td');
            actionCell.className = 'action-column hidden-column';
            if (showEditButtons && source === 'data') {
                actionCell.innerHTML = `
                    <button class="action-btn bg-blue-500 text-white rounded hover:bg-blue-600" onclick="editRecord(${index}, false)" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                `;
            } else if (showEditButtons && source === 'master') {
                actionCell.innerHTML = `
                    <button class="action-btn bg-green-500 text-white rounded hover:bg-green-600" onclick="editRecord(${index}, true)" title="Copy to Form">
                        <i class="fas fa-copy"></i>
                    </button>
                `;
            }
            row.appendChild(actionCell);
            
            tableBody.appendChild(row);
        });
    }

    function loadProfiles() {
        // Placeholder for profile loading functionality
    }
</script>
</body>
</html>
