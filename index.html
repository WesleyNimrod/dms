<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management Information System</title>
    <link rel="icon" href="web.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5492A8',
                        secondary: '#38386E',
                        heading: '#13405E',
                        lightblue: '#caf0f8',
                        lightgreen: '#d8f3dc',
                        lightyellow: '#ffedd8',
                        lightred: '#ffccd5',
                        lightgray: '#f3f4f6'
                    },
                    fontFamily: {
                        tahoma: ['Tahoma', 'Geneva', 'sans-serif']
                    }
                }
            },
            darkMode: 'class'
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tahoma:wght@400;700&display=swap');
        
        body {
            font-family: 'Tahoma', Geneva, sans-serif;
        }
        
        @keyframes redFlash {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .dbr-warning-flash {
            animation: redFlash 1s ease-in-out 3;
            border: 2px solid rgba(239, 68, 68, 0.7) !important;
            background-color: rgba(239, 68, 68, 0.05) !important;
        }
        
        .dark .dbr-warning-flash {
            border: 2px solid rgba(248, 113, 113, 0.7) !important;
            background-color: rgba(248, 113, 113, 0.1) !important;
        }
        
        .dbr-high {
            color: #ef4444 !important;
            font-weight: bold;
            background-color: rgba(239, 68, 68, 0.1) !important;
            border-color: #ef4444 !important;
        }

        .dark .dbr-high {
            color: #f87171 !important;
            background-color: rgba(248, 113, 113, 0.1) !important;
            border-color: #f87171 !important;
        }
        
        .card-settled {
            opacity: 0.6;
            background-color: #f3f4f6 !important;
            border: 1px dashed #9ca3af !important;
        }
        
        .dark .card-settled {
            background-color: #374151 !important;
            border: 1px dashed #6b7280 !important;
        }
        
        .loan-settled {
            opacity: 0.6;
            background-color: #f3f4f6 !important;
            border: 1px dashed #9ca3af !important;
        }
        
        .dark .loan-settled {
            background-color: #374151 !important;
            border: 1px dashed #6b7280 !important;
        }
        
        .outstanding-warning {
            background-color: rgba(239, 68, 68, 0.1) !important;
            border-color: #ef4444 !important;
            color: #ef4444 !important;
        }
        
        .dark .outstanding-warning {
            background-color: rgba(248, 113, 113, 0.1) !important;
            border-color: #f87171 !important;
            color: #f87171 !important;
        }
        
        .cc-suggestion-text {
            color: #10b981 !important;
        }
        
        .dark .cc-suggestion-text {
            color: #34d399 !important;
        }
        
        .settlement-suggestion-text {
            color: #ef4444 !important;
            font-weight: bold;
        }
        
        .dark .settlement-suggestion-text {
            color: #f87171 !important;
            font-weight: bold;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            width: 900px;
        }
        
        .dark .modal-content {
            background: #1f2937;
            color: white;
        }
        
        .full-modal {
            width: 95%;
            height: 95%;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #38386E !important;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        
        .success-indicator {
            background: linear-gradient(135deg, #66d9e8 0%, #63e6be 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            position: fixed;
            top: 20px;
            right: 20px;
            animation: fadeOut 2s forwards;
            animation-delay: 1s;
            z-index: 100;
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .emi-table th {
            background-color: #5492A8;
            color: white;
            text-align: center;
            padding: 4px;
            border: 1px solid #ddd;
        }
        
        .emi-table td {
            text-align: right;
            padding: 2px 4px;
            border: 1px solid #ddd;
        }
        
        .emi-table td:first-child {
            text-align: center;
        }
        
        .dark .emi-table th {
            background-color: #374151;
        }
        
        .dark .emi-table td {
            border-color: #4b5563;
        }
        
        .layout-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 60px);
            width: 100%;
            overflow: hidden;
        }
        
        .horizontal-tabs {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px 20px;
            border-radius: 12px;
            margin-bottom: 10px;
            overflow-x: auto;
            min-height: 60px;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .tab-btn {
            position: relative;
            transition: all 0.3s;
            padding: 12px 16px;
            margin: 0 2px;
            border-radius: 8px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 50px;
            cursor: pointer;
            border: none;
            background: transparent;
        }
        
        .tab-btn i {
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tab-btn.active {
            color: white;
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .content-container {
            flex: 1;
            height: 100%;
            overflow-y: auto;
            padding: 20px;
            border-radius: 12px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .gradient-primary {
            background: linear-gradient(135deg, #5492A8 0%, #38386E 100%);
        }
        
        .gradient-card {
            background: linear-gradient(to bottom, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0) 100%);
        }
        
        .dark .gradient-card {
            background: linear-gradient(to bottom, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0) 100%);
        }
        
        input, select, textarea {
            transition: all 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #5492A8;
            box-shadow: 0 0 0 2px rgba(84, 146, 168, 0.2);
        }
        
        .custom-btn {
            background: linear-gradient(135deg, #5492A8 0%, #38386E 100%);
            transition: all 0.3s;
        }
        
        .custom-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .compact-form .grid-cols-3 {
            gap: 0.5rem;
        }
        
        .compact-form input, 
        .compact-form select, 
        .compact-form textarea {
            padding: 0.375rem 0.5rem;
        }
        
        iframe {
            width: 100%;
            height: 80vh;
            border: none;
        }
        
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        
        .auth-container {
            background: rgba(255, 255, 255, 0.85);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            padding: 30px;
            width: 400px;
            max-width: 90%;
        }
        
        .dark .auth-container {
            background: rgba(31, 41, 55, 0.85);
            border: 1px solid rgba(75, 85, 99, 0.18);
        }
        
        .theme-toggle-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 8px 0;
            margin-right: 15px;
        }
        
        @media (max-width: 768px) {
            .horizontal-tabs {
                flex-wrap: wrap;
                justify-content: flex-start;
            }
            
            .tab-btn {
                min-width: 45px;
                padding: 10px 12px;
            }
            
            .tab-btn i {
                font-size: 1.2rem;
            }
        }
        
        .header-controls {
            background-color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .dark .header-controls {
            background-color: #1f2937;
        }
        
        .quick-emi-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 60;
            width: 350px;
            max-width: 90%;
        }
        
        .dark .quick-emi-modal {
            background: #1f2937;
            color: white;
        }
        
        .quick-emi-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 59;
        }
        
        .guest-mode .tab-btn.restricted {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #5492A8 0%, #38386E 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        .loading-text {
            color: white;
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            animation: pulse 1.5s ease-in-out infinite alternate;
            margin-bottom: 30px;
        }

        @keyframes pulse {
            from { opacity: 0.7; }
            to { opacity: 1; }
        }

        .loading-dots {
            display: flex;
            gap: 8px;
            margin-top: 20px;
        }

        .loading-dot {
            width: 12px;
            height: 12px;
            background-color: white;
            border-radius: 50%;
            animation: bounce 1.4s ease-in-out infinite both;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        .loading-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            } 40% {
                transform: scale(1);
            }
        }
        
        .dbr-toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 24px;
            margin-left: 10px;
        }
        
        .dbr-toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .dbr-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .dbr-toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .dbr-toggle-slider {
            background-color: #5492A8;
        }
        
        input:checked + .dbr-toggle-slider:before {
            transform: translateX(36px);
        }
        
        .dbr-toggle-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            margin-top: 2px;
            color: #666;
        }
        
        .dark .dbr-toggle-labels {
            color: #999;
        }

        .whatsapp-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .paste-btn {
            position: absolute;
            right: 8px;
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: color 0.3s;
        }

        .paste-btn:hover {
            color: #374151;
        }

        .dark .paste-btn {
            color: #9ca3af;
        }

        .dark .paste-btn:hover {
            color: #d1d5db;
        }

        .closure-fee-calculate-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 8px;
            transition: all 0.3s;
        }

        .closure-fee-calculate-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-200 font-tahoma">
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-text">Management Information System</div>
        <div class="loading-dots">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
        </div>
    </div>

    <div class="auth-modal" id="authModal">
        <div class="auth-container">
            <h2 class="text-xl font-bold text-heading dark:text-white mb-4 text-center">Select Access Mode</h2>
            
            <div class="mb-4">
                <div class="flex gap-3 mb-3">
                    <button id="adminModeBtn" class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 text-white py-2 px-4 rounded-md hover:opacity-90">
                        <i class="fas fa-user-shield mr-2"></i>Admin Mode
                    </button>
                    <button id="guestModeBtn" class="flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white py-2 px-4 rounded-md hover:opacity-90">
                        <i class="fas fa-user mr-2"></i>Guest Mode
                    </button>
                </div>
            </div>
            
            <div id="adminPasswordSection" class="hidden">
                <div class="mb-4">
                    <label class="block text-gray-700 dark:text-gray-300 mb-2">Admin Password</label>
                    <input type="password" id="passwordInput" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white" placeholder="Enter admin password">
                    <p id="passwordError" class="text-red-500 text-sm mt-1 hidden">Invalid password!</p>
                </div>
                <div class="flex items-center mb-4">
                    <input type="checkbox" id="rememberMe" class="mr-2">
                    <label for="rememberMe" class="text-gray-700 dark:text-gray-300">Keep me signed in for 3 days</label>
                </div>
                <button id="submitPassword" class="custom-btn text-white py-2 px-4 rounded-md w-full">Login as Admin</button>
            </div>
            
            <div id="guestModeSection" class="hidden">
                <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg border border-blue-200 dark:border-blue-800 mb-4">
                    <p class="text-blue-800 dark:text-blue-300 text-sm">
                        <i class="fas fa-info-circle mr-2"></i>
                        Guest Mode provides access to Main, Advance, and Rate Grid tabs with limited functionality.
                    </p>
                </div>
                <button id="enterGuestMode" class="custom-btn text-white py-2 px-4 rounded-md w-full">Enter as Guest</button>
            </div>
        </div>
    </div>
    
    <div id="quickEmiOverlay" class="quick-emi-overlay hidden"></div>
    <div id="quickEmiModal" class="quick-emi-modal hidden">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-heading dark:text-white">Quick EMI Calculator</h3>
            <button id="closeQuickEmi" class="text-gray-500 hover:text-red-500 text-xl">&times;</button>
        </div>
        
        <div class="space-y-3">
            <div>
                <label class="block text-gray-700 dark:text-gray-300 text-sm mb-1">Loan Amount (AED)</label>
                <input type="number" id="quickLoanAmount" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white dark:border-gray-600" placeholder="Enter loan amount">
            </div>
            
            <div>
                <label class="block text-gray-700 dark:text-gray-300 text-sm mb-1">Tenure (Months)</label>
                <input type="number" id="quickTenure" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white dark:border-gray-600" placeholder="Enter tenure" value="48">
            </div>
            
            <div>
                <label class="block text-gray-700 dark:text-gray-300 text-sm mb-1">Interest Rate (%)</label>
                <input type="number" id="quickRate" step="0.01" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white dark:border-gray-600" placeholder="Enter rate" value="10">
            </div>
            
            <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-lg">
                <label class="block text-gray-700 dark:text-gray-300 text-sm mb-1">Monthly EMI</label>
                <div id="quickEmiResult" class="text-2xl font-bold text-primary dark:text-blue-400">AED 0</div>
            </div>
        </div>
    </div>
    
    <div class="w-full h-full" id="printableArea">
        <div class="layout-container">
            <div class="horizontal-tabs gradient-primary" id="horizontalTabs">
                <div class="theme-toggle-container">
                    <label class="toggle-switch">
                        <input type="checkbox" id="themeToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <button class="tab-btn active text-white font-medium" data-tab="main" title="Main">
                    <i class="fas fa-home"></i>
                </button>
                <button class="tab-btn text-white/80 font-medium" data-tab="mis" title="MIS">
                    <i class="fas fa-book"></i>
                </button>
                <button class="tab-btn text-white/80 font-medium" data-tab="datasheet" title="Follow-Up">
                    <i class="fas fa-chart-line"></i>
                </button>
                <button class="tab-btn text-white/80 font-medium" data-tab="calling" title="Calling">
                    <i class="fas fa-phone"></i>
                </button>
                <button class="tab-btn text-white/80 font-medium" data-tab="pldata" title="PL Data">
                    <i class="fas fa-database"></i>
                </button>
                <button class="tab-btn text-white/80 font-medium" data-tab="advcalc" title="Advance">
                    <i class="fas fa-calculator"></i>
                </button>
                <button class="tab-btn text-white/80 font-medium" data-tab="rategrid" title="Rate Grid">
                    <i class="fas fa-table"></i>
                </button>
                <button class="tab-btn text-white/80 font-medium" data-tab="finance" title="Finance">
                    <i class="fas fa-hand-holding-usd"></i>
                </button>
                <button class="tab-btn text-white/80 font-medium" data-tab="brochures" title="Brochures">
                    <i class="fas fa-file-pdf"></i>
                </button>
                <button class="tab-btn text-white/80 font-medium" data-tab="tracking" title="Tracking">
                    <i class="fas fa-file-pdf"></i>
                </button>
            </div>
            
            <div class="content-container bg-white dark:bg-gray-800 shadow-md" id="contentContainer">
                <div id="headerControls" class="header-controls">
                    <div class="flex flex-wrap items-center justify-center gap-2 w-full">
                        <input type="text" id="customerName" placeholder="Customer Name" class="border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white dark:border-gray-600 max-w-[160px]">
                        <select id="savedProfiles" class="border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white dark:border-gray-600 max-w-[160px]">
                            <option value="">Select a profile</option>
                        </select>
                        <button id="retrieveProfileBtn" class="custom-btn text-white p-2 rounded-md flex items-center justify-center" title="Retrieve Profile">
                            <i class="fas fa-download"></i>
                        </button>
                        <button id="deleteProfileBtn" class="bg-gradient-to-r from-red-500 to-red-600 text-white p-2 rounded-md hover:opacity-90 flex items-center justify-center" title="Delete Profile">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        
                        <button id="findOptimalLoanBtn" class="custom-btn text-white p-2 rounded-md flex items-center justify-center" title="Find Optimal Loan">
                            <i class="fas fa-search-dollar"></i>
                        </button>
                        <button id="resetBtn" class="custom-btn text-white p-2 rounded-md flex items-center justify-center" title="Reset">
                            <i class="fas fa-redo-alt"></i>
                        </button>
                        <button id="saveProfileBtn" class="custom-btn text-white p-2 rounded-md flex items-center justify-center" title="Save Profile">
                            <i class="fas fa-save"></i>
                        </button>
                        
                        <div class="whatsapp-input-container max-w-[160px]">
                            <input type="tel" id="whatsappNumber" placeholder="WhatsApp number" class="border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white dark:border-gray-600 w-full pr-10">
                            <button id="pasteBtn" class="paste-btn" title="Paste">
                                <i class="fas fa-paste text-sm"></i>
                            </button>
                        </div>
                        <button id="sendWhatsAppBtn" class="bg-gradient-to-r from-green-600 to-green-700 text-white p-2 rounded-md hover:opacity-90" title="Send WhatsApp">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                        <button id="quickEmiBtn" class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-2 rounded-md hover:opacity-90" title="Quick EMI Calculator">
                            <i class="fas fa-calculator"></i>
                        </button>
                        <button id="shareLoanBtn" class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-2 rounded-md hover:opacity-90" title="Share Loan Information">
                            <i class="fas fa-share-alt"></i>
                        </button>
                        <button id="generateEmiChartBtn" class="bg-gradient-to-r from-teal-500 to-teal-600 text-white p-2 rounded-md hover:opacity-90" title="Generate EMI Chart">
                            <i class="fas fa-chart-bar"></i>
                        </button>
                        <button id="loanComparisonBtn" class="bg-gradient-to-r from-indigo-500 to-indigo-600 text-white p-2 rounded-md hover:opacity-90" title="Loan Comparison">
                            <i class="fas fa-balance-scale"></i>
                        </button>
                    </div>
                </div>
                
                <div id="tab-main" class="tab-content active">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        
                        <div id="dbrCalculator" class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md border-l-4 border-primary compact-form">
                            <h2 class="text-xl font-bold text-heading dark:text-white mb-4">DBR CALCULATOR</h2>
                            
                            <div class="space-y-2">
                                <div class="grid grid-cols-3 gap-2 items-center">
                                    <label class="text-gray-700 dark:text-gray-300 font-medium">Salary (AED):</label>
                                    <input type="text" id="salary" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white dark:border-gray-600" pattern="[0-9]*">
                                </div>
                                
                                <div id="addbacks-container">
                                    <div class="grid grid-cols-3 gap-2 items-center addback-entry">
                                        <label class="text-gray-700 dark:text-gray-300 font-medium">Add-back:</label>
                                        <div class="col-span-2">
                                            <select class="addback-type border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white dark:border-gray-600 w-full">
                                                <option value="">Select Add-back Type</option>
                                                <option value="hra">HRA</option>
                                                <option value="airfare">Airfare Allowance</option>
                                                <option value="overtime">Over-time</option>
                                                <option value="servicecharge">Service Charge</option>
                                                <option value="incentives">Incentives</option>
                                                <option value="telephone">Telephone Allowance</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="dynamic-addback-fields"></div>
                                
                                <div class="flex justify-start gap-2 mb-2">
                                    <button id="addMoreAddbackBtn" class="custom-btn text-white p-1.5 rounded-md text-sm">+ Add More</button>
                                    <button id="removeAddbackBtn" class="custom-btn text-white p-1.5 rounded-md text-sm disabled:opacity-50" disabled>- Remove</button>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-2 items-center">
                                    <label class="text-gray-700 dark:text-gray-300 font-medium">Gross Salary:</label>
                                    <input type="text" id="grossSalary" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white dark:border-gray-600" readonly>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-2 items-center">
                                    <label class="text-gray-700 dark:text-gray-300 font-medium">Allowed Liability:</label>
                                    <input type="text" id="allowedLiability" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white dark:border-gray-600" readonly>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-2 items-center">
                                    <label class="text-gray-700 dark:text-gray-300 font-medium">DBR %:</label>
                                    <div class="col-span-2 flex items-center">
                                        <input type="text" id="dbrPercentage" class="flex-1 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white dark:border-gray-600" readonly>
                                        <div class="ml-2">
                                            <label class="dbr-toggle-switch">
                                                <input type="checkbox" id="dbrToggle">
                                                <span class="dbr-toggle-slider"></span>
                                            </label>
                                            <div class="dbr-toggle-labels">
                                                <span>49%</span>
                                                <span>49.99%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex gap-2">
                                    <button id="addLoansBtn" class="custom-btn text-white p-2 rounded-md flex-1">+ Loans</button>
                                    <button id="removeLoansBtn" class="custom-btn text-white p-2 rounded-md flex-1 disabled:opacity-50" disabled>- Remove Loans</button>
                                </div>
                                
                                <div id="existingLoansContainer" class="mt-2 space-y-2 hidden"></div>

                                <div id="creditCardsContainer">
                                    <div class="credit-card-entry mb-2">
                                        <div class="flex justify-between items-center mb-1">
                                            <div class="flex items-center gap-1 w-full">
                                                <label class="text-gray-700 dark:text-gray-300 font-medium flex-1">Credit Card 1:</label>
                                                <input type="text" placeholder="Settle Amount" class="credit-card-settle-amount border rounded-md p-1 text-xs dark:bg-gray-800 dark:text-white dark:border-gray-600 w-20" pattern="[0-9]*\.?[0-9]*">
                                                <button class="settle-card-btn custom-btn text-white px-2 py-1 rounded text-xs w-14 text-center">Settle</button>
                                            </div>
                                        </div>
                                        <div class="flex gap-2 items-center">
                                            <select class="card-bank-select border rounded-md p-2 text-sm dark:bg-gray-800 dark:text-white dark:border-gray-600" style="width: 25%;">
                                                <option value="ADCB">ADCB</option>
                                                <option value="ENBD">ENBD</option>
                                                <option value="EIB">EIB</option>
                                                <option value="FAB">FAB</option>
                                                <option value="ADIB">ADIB</option>
                                                <option value="CBD">CBD</option>
                                                <option value="HSBC">HSBC</option>
                                                <option value="CITI">CITI</option>
                                                <option value="SCB">SCB</option>
                                                <option value="MASHREQ">MASHREQ</option>
                                                <option value="DIB">DIB</option>
                                                <option value="RAK">RAK</option>
                                                <option value="OTHER">OTHER</option>
                                            </select>
                                            <input type="text" placeholder="Credit Limit" class="credit-card-amount border rounded-md p-2 text-sm dark:bg-gray-800 dark:text-white dark:border-gray-600" style="width: 25%;" pattern="[0-9]*">
                                            <input type="text" placeholder="New Limit" class="credit-card-new-limit border rounded-md p-2 text-sm dark:bg-gray-800 dark:text-white dark:border-gray-600" style="width: 25%;" pattern="[0-9]*">
                                            <input type="text" placeholder="Outstanding" class="credit-card-outstanding border rounded-md p-2 text-sm dark:bg-gray-800 dark:text-white dark:border-gray-600" style="width: 25%;" pattern="[0-9]*">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex gap-2">
                                    <button id="addCreditCardBtn" class="custom-btn text-white p-1.5 rounded-md text-sm">+ Add Card</button>
                                    <button id="removeCreditCardBtn" class="custom-btn text-white p-1.5 rounded-md text-sm disabled:opacity-50" disabled>- Remove Card</button>
                                </div>
                                
                                <div id="ccSuggestionContainer" class="border border-primary p-2 rounded-lg mt-2 hidden">
                                    <h3 id="suggestionTitle" class="text-base font-bold text-heading mb-1">CREDIT CARD SUGGESTION</h3>
                                    <p id="ccSuggestionText" class="text-gray-700 dark:text-gray-300 text-sm"></p>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-2 items-center">
                                    <label class="text-gray-700 dark:text-gray-300 font-medium">Total CC Limit:</label>
                                    <input type="text" id="totalCCLimit" class="col-span-1 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white dark:border-gray-600" readonly>
                                    <input type="text" id="dbrCC" class="col-span-1 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white dark:border-gray-600" readonly>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-2 items-center">
                                    <label class="text-gray-700 dark:text-gray-300 font-medium">Total Liabilities:</label>
                                    <input type="text" id="totalLiabilities" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white dark:border-gray-600" readonly>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-2 items-center">
                                    <label class="text-gray-700 dark:text-gray-300 font-medium">Available Liability:</label>
                                    <input type="text" id="availableLiability" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white dark:border-gray-600" readonly>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-2 items-center">
                                    <label class="text-gray-700 dark:text-gray-300 font-medium">New Total Liabilities:</label>
                                    <input type="text" id="newTotalLiabilities" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white dark:border-gray-600" readonly>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-2 items-center">
                                    <label class="text-gray-700 dark:text-gray-300 font-medium">Special Note:</label>
                                    <textarea id="specialNote" class="col-span-2 w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white dark:border-gray-600" rows="2"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div id="emiCalculator" class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md border-l-4 border-primary compact-form">
                            <h2 class="text-xl font-bold text-heading dark:text-white mb-4">EMI CALCULATOR</h2>
                            
                            <div class="space-y-2">
                                <div class="grid grid-cols-3 gap-2 items-center">
                                    <label class="text-gray-700 dark:text-gray-300 font-medium">Loan Type:</label>
                                    <select id="loanType" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white dark:border-gray-600">
                                        <option value="fresh-0-30">Fresh (0-30 days)</option>
                                        <option value="fresh-30-60">Fresh (30-60 days)</option>
                                        <option value="topup-0-30">Top-up (0-30 days)</option>
                                        <option value="topup-30-60">Top-up (30-60 days)</option>
                                        <option value="takeover-60-90">Take over (60-90 days)</option>
                                    </select>
                                </div>
                                
                                <div id="closureFeeContainer" class="grid grid-cols-3 gap-2 items-center hidden">
                                    <label class="text-gray-700 dark:text-gray-300 font-medium">Closure Fee (AED):</label>
                                    <div class="col-span-2 flex items-center">
                                        <input type="text" id="closureFee" class="flex-1 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white dark:border-gray-600" placeholder="Enter closure fee" pattern="[0-9]*\.?[0-9]*">
                                        <button id="calculateClosureFeeBtn" class="closure-fee-calculate-btn">Calculate</button>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-2 items-center">
                                    <label class="text-gray-700 dark:text-gray-300 font-medium">Disbursal Date:</label>
                                    <input type="date" id="disbursalDate" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white dark:border-gray-600">
                                </div>
                                
                                <div class="grid grid-cols-3 gap-2 items-center">
                                    <label class="text-gray-700 dark:text-gray-300 font-medium">First Payment Date:</label>
                                    <input type="date" id="firstPaymentDate" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white dark:border-gray-600">
                                    <p id="dateError" class="col-span-3 text-red-600 dark:text-red-400 text-sm hidden">Error: Invalid Payment Date</p>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-2 items-center">
                                    <label class="text-gray-700 dark:text-gray-300 font-medium">Payment Date:</label>
                                    <input type="text" id="paymentDate" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white dark:border-gray-600" readonly>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-2 items-center">
                                    <label class="text-gray-700 dark:text-gray-300 font-medium">Multiples Of Salary:</label>
                                    <input type="text" id="multiplesOfSalary" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white dark:border-gray-600" value="20" maxlength="2" pattern="[0-9]{1,2}">
                                </div>
                                
                                <div class="grid grid-cols-3 gap-2 items-center">
                                    <label class="text-gray-700 dark:text-gray-300 font-medium">Max Eligibility (AED):</label>
                                    <input type="text" id="maxLoanEligibility" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white dark:border-gray-600" readonly>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-2 items-center">
                                    <label class="text-gray-700 dark:text-gray-300 font-medium">Tenure:</label>
                                    <input type="text" id="tenureMonths" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white dark:border-gray-600" value="48" maxlength="2" pattern="[0-9]{1,2}">
                                </div>
                                
                                <div class="grid grid-cols-3 gap-2 items-center">
                                    <label class="text-gray-700 dark:text-gray-300 font-medium">Loan Amount (AED):</label>
                                    <div class="col-span-2 flex gap-2">
                                        <input type="text" id="loanAmount" class="border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white dark:border-gray-600 flex-grow" pattern="[0-9]*">
                                        <input type="text" id="loanMultiples" class="border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white dark:border-gray-600 w-15 text-center" readonly>
                                    </div>
                                    <p id="loanAmountError" class="col-span-3 text-red-600 dark:text-red-400 text-sm hidden">Error: Loan Amount Will Exceed DBR Limit!</p>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-2 items-center">
                                    <label class="text-gray-700 dark:text-gray-300 font-medium">Rate %:</label>
                                    <input type="text" id="reducingRate" class="col-span-1 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white dark:border-gray-600" value="10" pattern="[0-9]{1,2}(\.[0-9]{1,2})?">
                                    <input type="text" id="flatRate" class="col-span-1 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white dark:border-gray-600" readonly>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-2 items-center">
                                    <label class="text-gray-700 dark:text-gray-300 font-medium">EMI (AED):</label>
                                    <input type="text" id="emi" class="col-span-1 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white dark:border-gray-600" readonly>
                                    <input type="text" id="preferredEMI" class="col-span-1 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white dark:border-gray-600" placeholder="Preferred EMI" pattern="[0-9]*\.?[0-9]*">
                                </div>
                                
                                <div class="grid grid-cols-3 gap-2 items-center">
                                    <label class="text-gray-700 dark:text-gray-300 font-medium" id="totalPaymentLabel">Total Payment (AED):</label>
                                    <input type="text" id="totalPayment" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white dark:border-gray-600" readonly>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-2 items-center">
                                    <label class="text-gray-700 dark:text-gray-300 font-medium">Total Interest (AED):</label>
                                    <input type="text" id="totalInterest" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white dark:border-gray-600" readonly>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-2 items-center">
                                    <label class="text-gray-700 dark:text-gray-300 font-medium">Processing Fees + VAT (AED):</label>
                                    <input type="text" id="processingFees" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white dark:border-gray-600" readonly>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-2 items-center">
                                    <label class="text-gray-700 dark:text-gray-300 font-medium">Total Outstanding:</label>
                                    <input type="text" id="totalOutstanding" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white dark:border-gray-600" readonly>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-2 items-center">
                                    <label class="text-gray-700 dark:text-gray-300 font-medium">Cash In Hand - NetPay (AED):</label>
                                    <div class="col-span-2 flex items-center gap-2">
                                        <input type="text" id="cashInHand" class="flex-1 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white dark:border-gray-600" readonly>
                                        <div class="flex items-center gap-1">
                                            <input type="checkbox" id="netAmountCheckbox" class="rounded" checked>
                                            <label for="netAmountCheckbox" class="text-gray-700 dark:text-gray-300 text-sm">Net Amount</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="emiChartSection" class="mt-4 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md border-l-4 border-primary hidden">
                        <h2 class="text-xl font-bold text-heading dark:text-white mb-4">EMI PAYMENT SCHEDULE</h2>
                        <div class="relative" style="height: 350px;">
                            <canvas id="emiChart"></canvas>
                        </div>
                        <div class="mt-4 overflow-x-auto">
                            <table class="w-full border-collapse text-sm">
                                <thead>
                                    <tr class="bg-primary text-white">
                                        <th class="border border-gray-300 p-2">Month</th>
                                        <th class="border border-gray-300 p-2">EMI (AED)</th>
                                        <th class="border border-gray-300 p-2">Principal (AED)</th>
                                        <th class="border border-gray-300 p-2">Interest (AED)</th>
                                        <th class="border border-gray-300 p-2">Balance (AED)</th>
                                    </tr>
                                </thead>
                                <tbody id="emiScheduleBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div id="tab-mis" class="tab-content">
                    <iframe src="mis.html" title="MIS Information" id="misIframe"></iframe>
                </div>
                
                <div id="tab-datasheet" class="tab-content">
                    <iframe src="https://script.google.com/macros/s/AKfycbyt6zvvO5POe2jMnyaR2bJOPu09L2f2Rr3Aeh72_APIR1C-6JVzSDOZvGfi4ZOZbQL0/exec" frameborder="0" width="100%" height="600px"></iframe>
                </div>
                
                <div id="tab-calling" class="tab-content">
                    <iframe src="Calling.html" title="Calling" id="callingIframe"></iframe>
                </div>
                
                <div id="tab-pldata" class="tab-content">
                    <iframe src="pl.html" title="PL Data" id="plDataIframe"></iframe>
                </div>
                
                <div id="tab-advcalc" class="tab-content">
                    <iframe src="advcalc.html" title="Advanced Calculator" id="advcalcIframe"></iframe>
                </div>
                
                <div id="tab-rategrid" class="tab-content">
                    <iframe src="rategrid.html" title="Rate Grid" id="rategridIframe"></iframe>
                </div>
                
                <div id="tab-finance" class="tab-content">
                    <iframe src="finance.html" title="Finance" id="financeIframe"></iframe>
                </div>
                
                <div id="tab-brochures" class="tab-content">
                    <iframe src="pdf.html" title="Brochures" id="brochuresIframe"></iframe>
                </div>
                
                <div id="tab-tracking" class="tab-content">
                    <iframe src="trk.html" title="Tracking" id="trackingIframe"></iframe>
                </div>
            </div>
        </div>
    </div>
    
    <div id="successIndicator" class="success-indicator hidden">
        <span id="successMessage">Operation successful!</span>
    </div>
    
    <div id="closureFeeModal" class="modal hidden">
        <div class="modal-content full-modal">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-heading dark:text-white">Closure Fee Calculator</h2>
                <button class="close-modal text-gray-700 dark:text-gray-300 hover:text-red-500 dark:hover:text-red-400 text-2xl">&times;</button>
            </div>
            <iframe src="ecf.html" title="Closure Fee Calculator" id="closureFeeIframe" style="width: 100%; height: calc(100% - 60px); border: none;"></iframe>
        </div>
    </div>
    
    <div id="shareModal" class="modal hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-heading dark:text-white">Loan Information</h2>
                <button class="close-modal text-gray-700 dark:text-gray-300 hover:text-red-500 dark:hover:text-red-400 text-2xl">&times;</button>
            </div>
            
            <div class="button-container mb-4 flex gap-2">
                <button id="exportPdfBtn" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:opacity-90 text-white font-bold py-2 px-4 rounded">
                    <i class="fas fa-file-pdf mr-2"></i>Export PDF
                </button>
                <button id="printPageBtn" class="bg-gradient-to-r from-green-500 to-green-600 hover:opacity-90 text-white font-bold py-2 px-4 rounded">
                    <i class="fas fa-print mr-2"></i>Print Page
                </button>
            </div>
            
            <div class="loan-info-container">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="border rounded-lg overflow-hidden">
                        <table class="w-full">
                            <tr class="border-b">
                                <td class="font-bold p-2 bg-gray-50 dark:bg-gray-700 w-1/2">Loan Nature/FPD:</td>
                                <td id="shareLoanType" class="p-2"></td>
                            </tr>
                            <tr class="border-b">
                                <td class="font-bold p-2 bg-gray-50 dark:bg-gray-700">Tenure:</td>
                                <td id="shareTenure" class="p-2"></td>
                            </tr>
                            <tr class="border-b">
                                <td class="font-bold p-2 bg-gray-50 dark:bg-gray-700">Requested Amount (AED):</td>
                                <td id="shareLoanAmount" class="p-2"></td>
                            </tr>
                            <tr class="border-b">
                                <td class="font-bold p-2 bg-gray-50 dark:bg-gray-700">Reducing Rate:</td>
                                <td id="shareReducingRate" class="p-2"></td>
                            </tr>
                            <tr class="border-b">
                                <td class="font-bold p-2 bg-gray-50 dark:bg-gray-700">Flat Rate:</td>
                                <td id="shareFlatRate" class="p-2"></td>
                            </tr>
                            <tr class="border-b">
                                <td class="font-bold p-2 bg-gray-50 dark:bg-gray-700">Max Eligibility (AED):</td>
                                <td id="shareMaxLoanEligibility" class="p-2"></td>
                            </tr>
                            <tr>
                                <td class="font-bold p-2 bg-gray-50 dark:bg-gray-700">Payment Date:</td>
                                <td id="sharePaymentDate" class="p-2"></td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="border rounded-lg overflow-hidden">
                        <table class="w-full">
                            <tr class="border-b">
                                <td class="font-bold p-2 bg-gray-50 dark:bg-gray-700 w-1/2">EMI (AED):</td>
                                <td id="shareEmi" class="p-2"></td>
                            </tr>
                            <tr class="border-b">
                                <td class="font-bold p-2 bg-gray-50 dark:bg-gray-700" id="shareTotalPaymentLabel">Total Payment (AED):</td>
                                <td id="shareTotalPayment" class="p-2"></td>
                            </tr>
                            <tr class="border-b">
                                <td class="font-bold p-2 bg-gray-50 dark:bg-gray-700">Total Interest/Profit (AED):</td>
                                <td id="shareTotalInterest" class="p-2"></td>
                            </tr>
                            <tr class="border-b">
                                <td class="font-bold p-2 bg-gray-50 dark:bg-gray-700">Processing Fees + VAT (AED):</td>
                                <td id="shareProcessingFees" class="p-2"></td>
                            </tr>
                            <tr class="border-b">
                                <td class="font-bold p-2 bg-gray-50 dark:bg-gray-700">Total Outstanding (AED):</td>
                                <td id="shareTotalOutstanding" class="p-2"></td>
                            </tr>
                            <tr>
                                <td class="font-bold p-2 bg-gray-50 dark:bg-gray-700">Cash in Hand(AED):</td>
                                <td id="shareCashInHand" class="p-2"></td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <h3 class="text-xl font-bold text-heading dark:text-white mb-3">EMI Payment Schedule</h3>
                <div class="overflow-x-auto border rounded-lg">
                    <table class="w-full emi-table">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>EMI (AED)</th>
                                <th>Principal (AED)</th>
                                <th>Interest (AED)</th>
                                <th>Balance (AED)</th>
                            </tr>
                        </thead>
                        <tbody id="shareEmiSchedule">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div id="emiChartModal" class="modal hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-heading dark:text-white">EMI Payment Schedule</h2>
                <button class="close-modal text-gray-700 dark:text-gray-300 hover:text-red-500 dark:hover:text-red-400 text-2xl">&times;</button>
            </div>
            
            <div class="relative mb-4" style="height: 400px;">
                <canvas id="emiChartStandalone"></canvas>
            </div>
            <div class="mt-4 overflow-x-auto">
                <table class="w-full border-collapse text-sm">
                    <thead>
                        <tr class="bg-primary text-white">
                            <th class="border border-gray-300 p-2">Month</th>
                            <th class="border border-gray-300 p-2">EMI (AED)</th>
                            <th class="border border-gray-300 p-2">Principal (AED)</th>
                            <th class="border border-gray-300 p-2">Interest (AED)</th>
                            <th class="border border-gray-300 p-2">Balance (AED)</th>
                        </tr>
                    </thead>
                    <tbody id="emiScheduleBodyStandalone">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="loanComparisonModal" class="modal hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-heading dark:text-white">LOAN COMPARISON</h2>
                <button class="close-modal text-gray-700 dark:text-gray-300 hover:text-red-500 dark:hover:text-red-400 text-2xl">&times;</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-3">
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Bank Name:</label>
                        <input type="text" id="bank1NameModal" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white dark:border-gray-600">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Loan Amount (AED):</label>
                        <input type="number" id="bank1LoanAmountModal" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white dark:border-gray-600">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Tenure (Months):</label>
                        <input type="number" id="bank1TenureModal" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white dark:border-gray-600">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Reducing Rate (%):</label>
                        <input type="number" id="bank1RateModal" step="0.01" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white dark:border-gray-600">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">EMI (AED):</label>
                        <input type="text" id="bank1EMIModal" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white dark:border-gray-600" readonly>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Total Interest (AED):</label>
                        <input type="text" id="bank1TotalInterestModal" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white dark:border-gray-600" readonly>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Bank Name:</label>
                        <input type="text" id="bank2NameModal" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white dark:border-gray-600">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Loan Amount (AED):</label>
                        <input type="number" id="bank2LoanAmountModal" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white dark:border-gray-600">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Tenure (Months):</label>
                        <input type="number" id="bank2TenureModal" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white dark:border-gray-600">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Reducing Rate (%):</label>
                        <input type="number" id="bank2RateModal" step="0.01" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white dark:border-gray-600">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">EMI (AED):</label>
                        <input type="text" id="bank2EMIModal" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white dark:border-gray-600" readonly>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Total Interest (AED):</label>
                        <input type="text" id="bank2TotalInterestModal" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white dark:border-gray-600" readonly>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                <h3 class="text-xl font-semibold text-heading dark:text-white mb-2">COMPARISON RESULT</h3>
                <p id="comparisonResult" class="text-gray-700 dark:text-gray-300">Enter Details For Both Banks To Compare.</p>
            </div>
        </div>
    </div>
    
    <script>
        window.addEventListener('load', function() {
            setTimeout(function() {
                const loadingScreen = document.getElementById('loadingScreen');
                loadingScreen.style.opacity = '0';
                setTimeout(function() {
                    loadingScreen.style.display = 'none';
                }, 500);
            }, 375);
        });

        let isAdminMode = false;
        let isGuestMode = false;
        let settledCards = new Map();
        let settledLoans = new Set();
        let originalOutstandingValues = new Map();
        let dbrThreshold = 49.00;
        
        document.addEventListener('DOMContentLoaded', function() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            const headerControls = document.getElementById('headerControls');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active');
                        btn.classList.add('text-white/80');
                        btn.classList.remove('text-white');
                    });
                    
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    this.classList.add('active');
                    this.classList.remove('text-white/80');
                    this.classList.add('text-white');
                    
                    const targetContent = document.getElementById(`tab-${targetTab}`);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                    
                    if (targetTab === 'main') {
                        headerControls.style.display = 'block';
                    } else {
                        headerControls.style.display = 'none';
                    }
                });
            });
        });
        
        const authModal = document.getElementById('authModal');
        const adminModeBtn = document.getElementById('adminModeBtn');
        const guestModeBtn = document.getElementById('guestModeBtn');
        const adminPasswordSection = document.getElementById('adminPasswordSection');
        const guestModeSection = document.getElementById('guestModeSection');
        const passwordInput = document.getElementById('passwordInput');
        const rememberMeCheckbox = document.getElementById('rememberMe');
        const submitPasswordBtn = document.getElementById('submitPassword');
        const enterGuestModeBtn = document.getElementById('enterGuestMode');
        const passwordError = document.getElementById('passwordError');
        
        function checkAuthentication() {
            const authExpiry = localStorage.getItem('authExpiry');
            const authMode = localStorage.getItem('authMode');
            
            if (authExpiry && new Date(authExpiry) > new Date() && authMode === 'flut20') {
                isAdminMode = true;
                authModal.classList.add('hidden');
                setupAdminMode();
            } else {
                localStorage.removeItem('authExpiry');
                localStorage.removeItem('authMode');
                authModal.classList.add('hidden');
                setupAdminMode();
            }
        }
        
        function setupAdminMode() {
            isAdminMode = true;
            isGuestMode = false;
            document.body.classList.remove('guest-mode');
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('restricted');
            });
        }
        
        function setupGuestMode() {
            isGuestMode = true;
            isAdminMode = false;
            document.body.classList.add('guest-mode');
            
            const allowedTabs = ['main', 'advcalc', 'rategrid'];
            document.querySelectorAll('.tab-btn').forEach(btn => {
                const tabName = btn.getAttribute('data-tab');
                if (!allowedTabs.includes(tabName)) {
                    btn.classList.add('restricted');
                }
            });
            
            const adminElements = document.querySelectorAll('#saveProfileBtn, #retrieveProfileBtn, #deleteProfileBtn');
            adminElements.forEach(el => {
                if (el) el.style.display = 'none';
            });
        }
        
        adminModeBtn.addEventListener('click', function() {
            adminPasswordSection.classList.remove('hidden');
            guestModeSection.classList.add('hidden');
            passwordInput.focus();
        });
        
        guestModeBtn.addEventListener('click', function() {
            guestModeSection.classList.remove('hidden');
            adminPasswordSection.classList.add('hidden');
        });
        
        submitPasswordBtn.addEventListener('click', function() {
            const password = passwordInput.value;
            
            if (password === 'flut20') {
                passwordError.classList.add('hidden');
                
                if (rememberMeCheckbox.checked) {
                    const expiryDate = new Date();
                    expiryDate.setDate(expiryDate.getDate() + 3);
                    localStorage.setItem('authExpiry', expiryDate.toISOString());
                    localStorage.setItem('authMode', 'admin');
                }
                
                authModal.classList.add('hidden');
                setupAdminMode();
            } else {
                passwordError.classList.remove('hidden');
                passwordInput.focus();
            }
        });
        
        enterGuestModeBtn.addEventListener('click', function() {
            authModal.classList.add('hidden');
            setupGuestMode();
        });
        
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitPasswordBtn.click();
            }
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
        });
        
        const themeToggle = document.getElementById('themeToggle');
        
        document.documentElement.classList.remove('dark');
        themeToggle.checked = false;
        
        function updateIframesDarkMode(isDark) {
            const iframes = document.querySelectorAll('iframe');
            iframes.forEach(iframe => {
                try {
                    if (iframe.contentWindow && iframe.contentWindow.document) {
                        if (isDark) {
                            iframe.contentWindow.document.documentElement.classList.add('dark');
                        } else {
                            iframe.contentWindow.document.documentElement.classList.remove('dark');
                        }
                    }
                } catch (e) {
                    console.log("Cannot directly access iframe content due to same-origin policy");
                }
                
                const currentSrc = iframe.src;
                if (currentSrc && !currentSrc.includes('script.google.com')) {
                    iframe.src = '';
                    setTimeout(() => {
                        iframe.src = currentSrc + (currentSrc.includes('?') ? '&' : '?') + 'theme=' + (isDark ? 'dark' : 'light') + '&t=' + Date.now();
                    }, 100);
                }
            });
        }
        
        themeToggle.addEventListener('change', function() {
            if (this.checked) {
                document.documentElement.classList.add('dark');
                updateIframesDarkMode(true);
            } else {
                document.documentElement.classList.remove('dark');
                updateIframesDarkMode(false);
            }
        });
        
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        function showSuccess(message) {
            const indicator = document.getElementById('successIndicator');
            const messageEl = document.getElementById('successMessage');
            
            messageEl.textContent = message;
            indicator.classList.remove('hidden');
            
            setTimeout(() => {
                indicator.classList.add('hidden');
            }, 3000);
        }
        
        const quickEmiBtn = document.getElementById('quickEmiBtn');
        const quickEmiModal = document.getElementById('quickEmiModal');
        const quickEmiOverlay = document.getElementById('quickEmiOverlay');
        const closeQuickEmi = document.getElementById('closeQuickEmi');
        const quickLoanAmount = document.getElementById('quickLoanAmount');
        const quickTenure = document.getElementById('quickTenure');
        const quickRate = document.getElementById('quickRate');
        const quickEmiResult = document.getElementById('quickEmiResult');
        
        function calculateQuickEMI() {
            const principal = parseFloat(quickLoanAmount.value) || 0;
            const rate = parseFloat(quickRate.value) || 0;
            const tenure = parseInt(quickTenure.value) || 0;
            
            if (principal > 0 && rate > 0 && tenure > 0) {
                const monthlyRate = rate / 12 / 100;
                const emi = principal * monthlyRate * Math.pow(1 + monthlyRate, tenure) / (Math.pow(1 + monthlyRate, tenure) - 1);
                quickEmiResult.textContent = `AED ${formatNumber(emi.toFixed(2))}`;
            } else {
                quickEmiResult.textContent = 'AED 0';
            }
        }
        
        quickEmiBtn.addEventListener('click', function() {
            quickEmiModal.classList.remove('hidden');
            quickEmiOverlay.classList.remove('hidden');
            quickLoanAmount.focus();
        });
        
        function closeQuickEmiModal() {
            quickEmiModal.classList.add('hidden');
            quickEmiOverlay.classList.add('hidden');
        }
        
        closeQuickEmi.addEventListener('click', closeQuickEmiModal);
        quickEmiOverlay.addEventListener('click', closeQuickEmiModal);
        
        [quickLoanAmount, quickTenure, quickRate].forEach(input => {
            input.addEventListener('input', calculateQuickEMI);
        });
        
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal') || e.target.classList.contains('close-modal')) {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.add('hidden');
                });
            }
        });
        
        function getOrdinalSuffix(day) {
            if (day >= 11 && day <= 13) {
                return day + 'th';
            }
            switch (day % 10) {
                case 1: return day + 'st';
                case 2: return day + 'nd';
                case 3: return day + 'rd';
                default: return day + 'th';
            }
        }
        
        function updatePaymentDate() {
            const firstPaymentDate = document.getElementById('firstPaymentDate').value;
            const paymentDateInput = document.getElementById('paymentDate');
            
            if (firstPaymentDate) {
                const date = new Date(firstPaymentDate);
                const day = date.getDate();
                paymentDateInput.value = getOrdinalSuffix(day);
            } else {
                paymentDateInput.value = '';
            }
        }
        
        function updateTotalPaymentLabel() {
            const loanType = document.getElementById('loanType').value;
            const totalPaymentLabel = document.getElementById('totalPaymentLabel');
            const totalPaymentInput = document.getElementById('totalPayment');
            const closureFee = parseFloat(document.getElementById('closureFee').value) || 0;
            
            if ((loanType === 'topup-0-30' || loanType === 'topup-30-60') && closureFee > 0) {
                totalPaymentLabel.textContent = 'Closure Fee (AED):';
                totalPaymentInput.value = formatNumber(closureFee.toFixed(2));
            } else {
                totalPaymentLabel.textContent = 'Total Payment (AED):';
                const loanAmount = parseFloat(document.getElementById('loanAmount').value) || 0;
                const tenureMonths = parseInt(document.getElementById('tenureMonths').value) || 0;
                const emi = parseFloat(document.getElementById('emi').value.replace(/,/g, '')) || 0;
                
                if (loanAmount > 0 && tenureMonths > 0 && emi > 0) {
                    const totalPayment = emi * tenureMonths;
                    totalPaymentInput.value = formatNumber(totalPayment.toFixed(2));
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const salaryInput = document.getElementById('salary');
            const grossSalaryInput = document.getElementById('grossSalary');
            const allowedLiabilityInput = document.getElementById('allowedLiability');
            const dbrPercentageInput = document.getElementById('dbrPercentage');
            const dbrToggle = document.getElementById('dbrToggle');
            const addLoansBtn = document.getElementById('addLoansBtn');
            const removeLoansBtn = document.getElementById('removeLoansBtn');
            const existingLoansContainer = document.getElementById('existingLoansContainer');
            const addCreditCardBtn = document.getElementById('addCreditCardBtn');
            const removeCreditCardBtn = document.getElementById('removeCreditCardBtn');
            const creditCardsContainer = document.getElementById('creditCardsContainer');
            const totalCCLimitInput = document.getElementById('totalCCLimit');
            const dbrCCInput = document.getElementById('dbrCC');
            const totalOutstandingInput = document.getElementById('totalOutstanding');
            const totalLiabilitiesInput = document.getElementById('totalLiabilities');
            const availableLiabilityInput = document.getElementById('availableLiability');
            const newTotalLiabilitiesInput = document.getElementById('newTotalLiabilities');
            const specialNote = document.getElementById('specialNote');
            const ccSuggestionContainer = document.getElementById('ccSuggestionContainer');
            const ccSuggestionText = document.getElementById('ccSuggestionText');
            const suggestionTitle = document.getElementById('suggestionTitle');
            const dbrCalculatorSection = document.getElementById('dbrCalculator');
            
            const customerNameInput = document.getElementById('customerName');
            const savedProfilesSelect = document.getElementById('savedProfiles');
            const retrieveProfileBtn = document.getElementById('retrieveProfileBtn');
            const deleteProfileBtn = document.getElementById('deleteProfileBtn');
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            const loanTypeSelect = document.getElementById('loanType');
            const closureFeeContainer = document.getElementById('closureFeeContainer');
            const closureFeeInput = document.getElementById('closureFee');
            const calculateClosureFeeBtn = document.getElementById('calculateClosureFeeBtn');
            const closureFeeModal = document.getElementById('closureFeeModal');
            const multiplesOfSalaryInput = document.getElementById('multiplesOfSalary');
            const maxLoanEligibilityInput = document.getElementById('maxLoanEligibility');
            const tenureMonthsInput = document.getElementById('tenureMonths');
            const loanAmountInput = document.getElementById('loanAmount');
            const loanMultiplesInput = document.getElementById('loanMultiples');
            const loanAmountError = document.getElementById('loanAmountError');
            const reducingRateInput = document.getElementById('reducingRate');
            const flatRateInput = document.getElementById('flatRate');
            const emiInput = document.getElementById('emi');
            const preferredEMIInput = document.getElementById('preferredEMI');
            const totalPaymentInput = document.getElementById('totalPayment');
            const totalInterestInput = document.getElementById('totalInterest');
            const processingFeesInput = document.getElementById('processingFees');
            const cashInHandInput = document.getElementById('cashInHand');
            const netAmountCheckbox = document.getElementById('netAmountCheckbox');
            const findOptimalLoanBtn = document.getElementById('findOptimalLoanBtn');
            const resetBtn = document.getElementById('resetBtn');
            const disbursalDateInput = document.getElementById('disbursalDate');
            const firstPaymentDateInput = document.getElementById('firstPaymentDate');
            const paymentDateInput = document.getElementById('paymentDate');
            const dateErrorMsg = document.getElementById('dateError');
            const emiCalculatorSection = document.getElementById('emiCalculator');
            
            const emiChartSection = document.getElementById('emiChartSection');
            const sendWhatsAppBtn = document.getElementById('sendWhatsAppBtn');
            const whatsappNumberInput = document.getElementById('whatsappNumber');
            const pasteBtn = document.getElementById('pasteBtn');
            const addbacksContainer = document.getElementById('addbacks-container');
            const dynamicAddbackFields = document.querySelector('.dynamic-addback-fields');
            const addMoreAddbackBtn = document.getElementById('addMoreAddbackBtn');
            const removeAddbackBtn = document.getElementById('removeAddbackBtn');
            
            const shareLoanBtn = document.getElementById('shareLoanBtn');
            const generateEmiChartBtn = document.getElementById('generateEmiChartBtn');
            const loanComparisonBtn = document.getElementById('loanComparisonBtn');
            const shareModal = document.getElementById('shareModal');
            const emiChartModal = document.getElementById('emiChartModal');
            const loanComparisonModal = document.getElementById('loanComparisonModal');
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            const printPageBtn = document.getElementById('printPageBtn');
            
            const bank1NameModal = document.getElementById('bank1NameModal');
            const bank1LoanAmountModal = document.getElementById('bank1LoanAmountModal');
            const bank1TenureModal = document.getElementById('bank1TenureModal');
            const bank1RateModal = document.getElementById('bank1RateModal');
            const bank1EMIModal = document.getElementById('bank1EMIModal');
            const bank1TotalInterestModal = document.getElementById('bank1TotalInterestModal');
            const bank2NameModal = document.getElementById('bank2NameModal');
            const bank2LoanAmountModal = document.getElementById('bank2LoanAmountModal');
            const bank2TenureModal = document.getElementById('bank2TenureModal');
            const bank2RateModal = document.getElementById('bank2RateModal');
            const bank2EMIModal = document.getElementById('bank2EMIModal');
            const bank2TotalInterestModal = document.getElementById('bank2TotalInterestModal');
            const comparisonResult = document.getElementById('comparisonResult');
            
            let emiChart = null;
            let emiChartStandalone = null;
            let existingLoanCount = 0;
            
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            disbursalDateInput.value = formattedDate;
            
            const nextMonth = new Date(today);
            nextMonth.setMonth(nextMonth.getMonth() + 1);
            firstPaymentDateInput.value = nextMonth.toISOString().split('T')[0];
            
            updatePaymentDate();
            
            let addbackCount = 1;
            let addbackData = {};
            
            dbrToggle.checked = false;
            
            dbrToggle.addEventListener('change', function() {
                if (this.checked) {
                    dbrThreshold = 49.99;
                } else {
                    dbrThreshold = 49.00;
                }
                updateDBRCalculator();
            });
            
            loanTypeSelect.addEventListener('change', function() {
                const loanType = this.value;
                if (loanType === 'topup-0-30' || loanType === 'topup-30-60') {
                    closureFeeContainer.classList.remove('hidden');
                } else {
                    closureFeeContainer.classList.add('hidden');
                    closureFeeInput.value = '';
                }
                
                adjustFirstPaymentDate();
                validatePaymentDate();
                updatePaymentDate();
                updateEMICalculator();
                updateTotalPaymentLabel();
            });
            
            closureFeeInput.addEventListener('input', function() {
                updateCashInHand();
                updateTotalPaymentLabel();
            });
            
            calculateClosureFeeBtn.addEventListener('click', function() {
                closureFeeModal.classList.remove('hidden');
            });
            
            firstPaymentDateInput.addEventListener('change', function() {
                updatePaymentDate();
                validatePaymentDate();
                updateEMICalculator();
            });
            
            whatsappNumberInput.addEventListener('input', function(e) {
                this.value = this.value.replace(/\s/g, '');
                
                if (this.value.startsWith('+971') || this.value.startsWith('0')) {
                    this.value = this.value.replace(/^(\+971|0)/, '');
                }
            });
            
            whatsappNumberInput.addEventListener('paste', function(e) {
                e.preventDefault();
                let paste = (e.clipboardData || window.clipboardData).getData('text');
                
                paste = paste.replace(/\s/g, '');
                paste = paste.replace(/^(\+971|0)/, '');
                
                this.value = paste;
            });
            
            pasteBtn.addEventListener('click', async function() {
                try {
                    const text = await navigator.clipboard.readText();
                    let cleanText = text.replace(/\s/g, '');
                    cleanText = cleanText.replace(/^(\+971|0)/, '');
                    whatsappNumberInput.value = cleanText;
                } catch (err) {
                    console.error('Failed to read clipboard contents: ', err);
                    showSuccess('Please allow clipboard access or paste manually');
                }
            });
            
            salaryInput.addEventListener('input', function(e) {
                this.value = this.value.replace(/[^0-9]/g, '');
                updateGrossSalary();
            });
            
            multiplesOfSalaryInput.addEventListener('input', function(e) {
                this.value = this.value.replace(/[^0-9]/g, '').slice(0, 2);
                updateEMICalculator();
            });
            
            tenureMonthsInput.addEventListener('input', function(e) {
                this.value = this.value.replace(/[^0-9]/g, '').slice(0, 2);
                updateEMICalculator();
                updateTotalPaymentLabel();
            });
            
            loanAmountInput.addEventListener('input', function(e) {
                this.value = this.value.replace(/[^0-9]/g, '');
                checkLoanAmountWithDBR();
                updateEMICalculator();
                updateLoanMultiples();
                updateCashInHand();
                updateTotalPaymentLabel();
            });
            
            reducingRateInput.addEventListener('input', function(e) {
                const value = this.value;
                const regex = /^[0-9]{0,2}(\.[0-9]{0,2})?$/;
                if (!regex.test(value)) {
                    this.value = this.value.slice(0, -1);
                }
                updateEMICalculator();
                updateTotalPaymentLabel();
            });
            
            closureFeeInput.addEventListener('input', function(e) {
                this.value = this.value.replace(/[^0-9.]/g, '');
                const parts = this.value.split('.');
                if (parts.length > 2) {
                    this.value = parts[0] + '.' + parts[1];
                }
                updateCashInHand();
                updateTotalPaymentLabel();
            });
            
            preferredEMIInput.addEventListener('input', function(e) {
                this.value = this.value.replace(/[^0-9.]/g, '');
                const parts = this.value.split('.');
                if (parts.length > 2) {
                    this.value = parts[0] + '.' + parts[1];
                }
                calculateLoanAmountFromPreferredEMI();
            });
            
            function calculateLoanAmountFromPreferredEMI() {
                const preferredEMI = parseFloat(preferredEMIInput.value) || 0;
                const reducingRate = parseFloat(reducingRateInput.value) || 0;
                const tenureMonths = parseInt(tenureMonthsInput.value) || 0;
                const loanType = loanTypeSelect.value;
                
                if (preferredEMI > 0 && reducingRate > 0 && tenureMonths > 0) {
                    const grossSalary = parseFloat(grossSalaryInput.value.replace(/,/g, '')) || 0;
                    if (grossSalary <= 0) return;
                    
                    let totalExistingLoansInstallments = 0;
                    document.querySelectorAll('.existing-loan-entry').forEach((entry, index) => {
                        if (!settledLoans.has(index)) {
                            const installmentInput = entry.querySelector('.loan-installment');
                            totalExistingLoansInstallments += parseFloat(installmentInput.value) || 0;
                        }
                    });
                    
                    let totalCCLimit = 0;
                    document.querySelectorAll('.credit-card-entry').forEach((entry, index) => {
                        if (!settledCards.has(index)) {
                            const limitInput = entry.querySelector('.credit-card-amount');
                            const newLimitInput = entry.querySelector('.credit-card-new-limit');
                            
                            const originalLimit = parseFloat(limitInput.value) || 0;
                            const newLimitValue = newLimitInput.value;
                            const newLimit = newLimitValue !== '' ? parseFloat(newLimitValue) : null;
                            
                            const effectiveLimit = newLimit !== null ? newLimit : originalLimit;
                            totalCCLimit += effectiveLimit;
                        }
                    });
                    
                    const dbrRate = 0.05;
                    const dbrCC = totalCCLimit * dbrRate;
                    const currentLiabilities = totalExistingLoansInstallments + dbrCC;
                    const allowedLiability = grossSalary * (dbrThreshold / 100);
                    const maxEMI = allowedLiability - currentLiabilities;
                    
                    if (preferredEMI > maxEMI) {
                        showSuccess(`Preferred EMI exceeds available liability. Maximum EMI: AED ${formatNumber(maxEMI.toFixed(2))}`);
                        return;
                    }
                    
                    const monthlyRate = reducingRate / 12 / 100;
                    let loanAmount = 0;
                    
                    if (loanType === 'fresh-0-30' || loanType === 'topup-0-30') {
                        loanAmount = preferredEMI / (monthlyRate * Math.pow(1 + monthlyRate, tenureMonths) / (Math.pow(1 + monthlyRate, tenureMonths) - 1));
                    } else if (loanType === 'fresh-30-60' || loanType === 'topup-30-60') {
                        const adjustedEMI = preferredEMI / (1 + monthlyRate);
                        loanAmount = adjustedEMI / (monthlyRate * Math.pow(1 + monthlyRate, tenureMonths) / (Math.pow(1 + monthlyRate, tenureMonths) - 1));
                    } else if (loanType === 'takeover-60-90') {
                        const adjustedEMI = preferredEMI / (1 + 2 * monthlyRate);
                        loanAmount = adjustedEMI / (monthlyRate * Math.pow(1 + monthlyRate, tenureMonths) / (Math.pow(1 + monthlyRate, tenureMonths) - 1));
                    }
                    
                    if (loanAmount > 0) {
                        loanAmountInput.value = Math.floor(loanAmount).toString();
                        updateEMICalculator();
                    }
                }
            }
            
            function adjustFirstPaymentDate() {
                const disbursalDate = new Date(disbursalDateInput.value);
                if (!disbursalDate) return;
                
                const loanType = loanTypeSelect.value;
                const [minDays, maxDays] = getDayRangeFromLoanType(loanType);
                
                const optimalDates = [5, 10, 15, 19, 24];
                let bestDate = null;
                let bestDaysBetween = null;
                
                for (const day of optimalDates) {
                    let testDate = new Date(disbursalDate);
                    testDate.setMonth(testDate.getMonth() + 1);
                    testDate.setDate(day);
                    
                    if (testDate <= disbursalDate) {
                        testDate.setMonth(testDate.getMonth() + 1);
                    }
                    
                    const daysBetween = Math.floor((testDate - disbursalDate) / (1000 * 60 * 60 * 24));
                    
                    if (daysBetween >= minDays && daysBetween <= maxDays) {
                        if (!bestDate || Math.abs(daysBetween - (minDays + maxDays) / 2) < Math.abs(bestDaysBetween - (minDays + maxDays) / 2)) {
                            bestDate = testDate;
                            bestDaysBetween = daysBetween;
                        }
                    }
                }
                
                if (bestDate) {
                    firstPaymentDateInput.value = bestDate.toISOString().split('T')[0];
                } else {
                    const midDays = Math.floor((minDays + maxDays) / 2);
                    const newPaymentDate = new Date(disbursalDate);
                    newPaymentDate.setDate(disbursalDate.getDate() + midDays);
                    firstPaymentDateInput.value = newPaymentDate.toISOString().split('T')[0];
                }
                
                updatePaymentDate();
            }
            
            document.querySelectorAll('.credit-card-amount, .credit-card-new-limit, .credit-card-outstanding').forEach(input => {
                input.addEventListener('input', function(e) {
                    this.value = this.value.replace(/[^0-9]/g, '');
                });
            });
            
            document.querySelectorAll('.credit-card-settle-amount').forEach(input => {
                input.addEventListener('input', function(e) {
                    this.value = this.value.replace(/[^0-9.]/g, '');
                    const parts = this.value.split('.');
                    if (parts.length > 2) {
                        this.value = parts[0] + '.' + parts[1];
                    }
                });
            });
            
            netAmountCheckbox.addEventListener('change', updateCashInHand);
            
            function updateCashInHand() {
                const loanAmount = parseFloat(loanAmountInput.value) || 0;
                const totalOutstanding = parseFloat(totalOutstandingInput.value.replace(/,/g, '')) || 0;
                const processingFees = parseFloat(processingFeesInput.value.replace(/,/g, '')) || 0;
                const closureFee = parseFloat(closureFeeInput.value) || 0;
                
                let cashInHand = loanAmount - totalOutstanding;
                
                if (netAmountCheckbox.checked) {
                    cashInHand -= processingFees;
                }
                
                cashInHand -= closureFee;
                
                cashInHandInput.value = formatNumber(cashInHand.toFixed(2));
            }
            
            function validateOutstandingVsLimit(cardEntry) {
                const bankSelect = cardEntry.querySelector('.card-bank-select');
                const creditLimitInput = cardEntry.querySelector('.credit-card-amount');
                const newLimitInput = cardEntry.querySelector('.credit-card-new-limit');
                const outstandingInput = cardEntry.querySelector('.credit-card-outstanding');
                
                const creditLimit = parseFloat(creditLimitInput.value) || 0;
                const newLimit = parseFloat(newLimitInput.value) || 0;
                const outstanding = parseFloat(outstandingInput.value) || 0;
                
                const effectiveLimit = newLimit > 0 ? newLimit : creditLimit;
                
                if (effectiveLimit > 0 && outstanding > effectiveLimit) {
                    outstandingInput.classList.add('outstanding-warning');
                } else {
                    outstandingInput.classList.remove('outstanding-warning');
                }
            }
            
            function validateADCBNewLimit(cardEntry) {
                const bankSelect = cardEntry.querySelector('.card-bank-select');
                const newLimitInput = cardEntry.querySelector('.credit-card-new-limit');
                
                if (bankSelect.value === 'ADCB') {
                    const newLimit = parseFloat(newLimitInput.value) || 0;
                    
                    if (newLimit > 0 && newLimit < 3000) {
                        newLimitInput.classList.add('outstanding-warning');
                    } else {
                        newLimitInput.classList.remove('outstanding-warning');
                    }
                } else {
                    newLimitInput.classList.remove('outstanding-warning');
                }
            }
            
            function handleSettleAmountChange(cardEntry) {
                const bankSelect = cardEntry.querySelector('.card-bank-select');
                const outstandingInput = cardEntry.querySelector('.credit-card-outstanding');
                const settleAmountInput = cardEntry.querySelector('.credit-card-settle-amount');
                const cardIndex = Array.from(document.querySelectorAll('.credit-card-entry')).indexOf(cardEntry);
                
                if (bankSelect.value === 'ADCB' && !settleAmountInput.classList.contains('hidden')) {
                    const settleAmount = parseFloat(settleAmountInput.value) || 0;
                    
                    if (!originalOutstandingValues.has(cardIndex)) {
                        const currentOutstanding = parseFloat(outstandingInput.value) || 0;
                        originalOutstandingValues.set(cardIndex, currentOutstanding);
                    }
                    
                    const originalOutstanding = originalOutstandingValues.get(cardIndex);
                    
                    if (settleAmount > 0) {
                        const newOutstanding = Math.max(0, originalOutstanding - settleAmount);
                        outstandingInput.value = newOutstanding.toFixed(2);
                    } else {
                        outstandingInput.value = originalOutstanding.toFixed(2);
                    }
                }
                
                validateOutstandingVsLimit(cardEntry);
                updateDBRCalculator();
            }
            
            function handleBankSelection(cardEntry) {
                const bankSelect = cardEntry.querySelector('.card-bank-select');
                const settleAmountInput = cardEntry.querySelector('.credit-card-settle-amount');
                const newLimitInput = cardEntry.querySelector('.credit-card-new-limit');
                const outstandingInput = cardEntry.querySelector('.credit-card-outstanding');
                const cardIndex = Array.from(document.querySelectorAll('.credit-card-entry')).indexOf(cardEntry);
                
                if (bankSelect.value === 'ADCB') {
                    settleAmountInput.classList.remove('hidden');
                    validateADCBNewLimit(cardEntry);
                } else {
                    settleAmountInput.classList.add('hidden');
                    settleAmountInput.value = '';
                    
                    if (originalOutstandingValues.has(cardIndex)) {
                        originalOutstandingValues.delete(cardIndex);
                    }
                }
                
                if (bankSelect.value !== 'ADCB') {
                    newLimitInput.classList.remove('outstanding-warning');
                }
                
                validateOutstandingVsLimit(cardEntry);
                updateDBRCalculator();
            }
            
            const initialCardEntry = document.querySelector('.credit-card-entry');
            const initialBankSelect = initialCardEntry.querySelector('.card-bank-select');
            const initialCreditLimitInput = initialCardEntry.querySelector('.credit-card-amount');
            const initialNewLimitInput = initialCardEntry.querySelector('.credit-card-new-limit');
            const initialOutstandingInput = initialCardEntry.querySelector('.credit-card-outstanding');
            const initialSettleAmountInput = initialCardEntry.querySelector('.credit-card-settle-amount');
            
            handleBankSelection(initialCardEntry);
            
            initialBankSelect.addEventListener('change', function() {
                handleBankSelection(initialCardEntry);
            });
            
            initialCreditLimitInput.addEventListener('input', function() {
                validateOutstandingVsLimit(initialCardEntry);
                updateDBRCalculator();
            });
            
            initialNewLimitInput.addEventListener('input', function() {
                validateADCBNewLimit(initialCardEntry);
                validateOutstandingVsLimit(initialCardEntry);
                updateDBRCalculator();
            });
            
            initialOutstandingInput.addEventListener('input', function() {
                const cardIndex = Array.from(document.querySelectorAll('.credit-card-entry')).indexOf(initialCardEntry);
                const bankSelect = initialCardEntry.querySelector('.card-bank-select');
                
                if (bankSelect.value !== 'ADCB' || !originalOutstandingValues.has(cardIndex)) {
                    const currentValue = parseFloat(this.value) || 0;
                    originalOutstandingValues.set(cardIndex, currentValue);
                }
                
                validateOutstandingVsLimit(initialCardEntry);
                updateDBRCalculator();
            });
            
            initialSettleAmountInput.addEventListener('blur', function() {
                handleSettleAmountChange(initialCardEntry);
            });
            
            addLoansBtn.addEventListener('click', function() {
                existingLoansContainer.classList.remove('hidden');
                addExistingLoan();
                removeLoansBtn.disabled = false;
            });
            
            removeLoansBtn.addEventListener('click', function() {
                const loanEntries = document.querySelectorAll('.existing-loan-entry');
                if (loanEntries.length > 0) {
                    const lastEntry = loanEntries[loanEntries.length - 1];
                    const lastEntryIndex = Array.from(document.querySelectorAll('.existing-loan-entry')).indexOf(lastEntry);
                    
                    if (settledLoans.has(lastEntryIndex)) {
                        settledLoans.delete(lastEntryIndex);
                    }
                    
                    lastEntry.remove();
                    existingLoanCount--;
                    
                    if (existingLoanCount === 0) {
                        existingLoansContainer.classList.add('hidden');
                        removeLoansBtn.disabled = true;
                    }
                    
                    updateDBRCalculator();
                }
            });
            
            function addExistingLoan() {
                existingLoanCount++;
                const loanDiv = document.createElement('div');
                loanDiv.classList.add('existing-loan-entry', 'mb-2');
                
                loanDiv.innerHTML = `
                    <div class="flex gap-2 items-center w-full">
                        <select class="loan-bank border rounded-md p-2 text-sm dark:bg-gray-800 dark:text-white dark:border-gray-600" style="width: 25%;">
                            <option value="ADCB">ADCB</option>
                            <option value="ENBD">ENBD</option>
                            <option value="EIB">EIB</option>
                            <option value="FAB">FAB</option>
                            <option value="ADIB">ADIB</option>
                            <option value="CBD">CBD</option>
                            <option value="HSBC">HSBC</option>
                            <option value="CITI">CITI</option>
                            <option value="SCB">SCB</option>
                            <option value="MASHREQ">MASHREQ</option>
                            <option value="DIB">DIB</option>
                            <option value="RAK">RAK</option>
                            <option value="OTHER">OTHER</option>
                        </select>
                        <select class="loan-type border rounded-md p-2 text-sm dark:bg-gray-800 dark:text-white dark:border-gray-600" style="width: 35%;">
                            <option value="Personal Loan">Personal Loan</option>
                            <option value="Auto Loan">Auto Loan</option>
                            <option value="Mortgage Loan">Mortgage Loan</option>
                        </select>
                        <input type="number" placeholder="Installment" class="loan-installment border rounded-md p-2 text-sm dark:bg-gray-800 dark:text-white dark:border-gray-600" style="width: 15%;">
                        <input type="number" placeholder="Outstanding" class="loan-outstanding border rounded-md p-2 text-sm dark:bg-gray-800 dark:text-white dark:border-gray-600" style="width: 15%;">
                        <button class="settle-loan-btn custom-btn text-white px-3 py-2 rounded text-sm whitespace-nowrap" style="width: 10%;">Settle</button>
                    </div>
                `;
                
                existingLoansContainer.appendChild(loanDiv);
                
                const newLoanInstallment = loanDiv.querySelector('.loan-installment');
                newLoanInstallment.addEventListener('input', updateDBRCalculator);
                
                const newLoanOutstanding = loanDiv.querySelector('.loan-outstanding');
                newLoanOutstanding.addEventListener('input', updateDBRCalculator);
                
                const settleLoanBtn = loanDiv.querySelector('.settle-loan-btn');
                settleLoanBtn.addEventListener('click', function() {
                    const loanEntry = this.closest('.existing-loan-entry');
                    const loanIndex = Array.from(document.querySelectorAll('.existing-loan-entry')).indexOf(loanEntry);
                    
                    if (settledLoans.has(loanIndex)) {
                        settledLoans.delete(loanIndex);
                        loanEntry.classList.remove('loan-settled');
                        this.textContent = 'Settle';
                        this.classList.add('custom-btn');
                        this.classList.remove('bg-gradient-to-r', 'from-red-500', 'to-red-600');
                    } else {
                        settledLoans.add(loanIndex);
                        loanEntry.classList.add('loan-settled');
                        this.textContent = 'Unsettle';
                        this.classList.remove('custom-btn');
                        this.classList.add('bg-gradient-to-r', 'from-red-500', 'to-red-600');
                    }
                    
                    updateDBRCalculator();
                });
            }
            
            loadSavedProfiles();
            loadTemporaryState();
            
            window.addEventListener('beforeunload', saveTemporaryState);
            
            saveProfileBtn.addEventListener('click', saveCustomerProfile);
            retrieveProfileBtn.addEventListener('click', retrieveCustomerProfile);
            deleteProfileBtn.addEventListener('click', deleteCustomerProfile);
            
            function saveCustomerProfile() {
                const customerName = customerNameInput.value.trim();
                if (!customerName) {
                    showSuccess('Please enter a customer name before saving');
                    return;
                }
                
                const profileData = {
                    customerName: customerName,
                    whatsappNumber: whatsappNumberInput.value,
                    salary: salaryInput.value,
                    loanType: loanTypeSelect.value,
                    closureFee: closureFeeInput.value,
                    disbursalDate: disbursalDateInput.value,
                    firstPaymentDate: firstPaymentDateInput.value,
                    multiplesOfSalary: multiplesOfSalaryInput.value,
                    tenureMonths: tenureMonthsInput.value,
                    loanAmount: loanAmountInput.value,
                    reducingRate: reducingRateInput.value,
                    preferredEMI: preferredEMIInput.value,
                    specialNote: specialNote.value,
                    netAmountChecked: netAmountCheckbox.checked,
                    dbrThreshold: dbrThreshold,
                    
                    creditCards: Array.from(document.querySelectorAll('.credit-card-entry')).map((entry, index) => {
                        return {
                            bank: entry.querySelector('.card-bank-select').value,
                            limit: entry.querySelector('.credit-card-amount').value,
                            newLimit: entry.querySelector('.credit-card-new-limit').value,
                            outstanding: entry.querySelector('.credit-card-outstanding').value,
                            settled: settledCards.has(index),
                            originalOutstanding: originalOutstandingValues.get(index) || entry.querySelector('.credit-card-outstanding').value,
                            settleAmount: entry.querySelector('.credit-card-settle-amount').value
                        };
                    }),
                    
                    existingLoans: Array.from(document.querySelectorAll('.existing-loan-entry')).map((entry, index) => {
                        return {
                            bank: entry.querySelector('.loan-bank').value,
                            type: entry.querySelector('.loan-type').value,
                            installment: entry.querySelector('.loan-installment').value,
                            outstanding: entry.querySelector('.loan-outstanding').value,
                            settled: settledLoans.has(index)
                        };
                    }),
                    
                    addbackData: addbackData
                };
                
                try {
                    const existingProfiles = JSON.parse(localStorage.getItem('customerProfiles')) || {};
                    existingProfiles[customerName] = profileData;
                    localStorage.setItem('customerProfiles', JSON.stringify(existingProfiles));
                    showSuccess('Profile saved successfully!');
                    
                    loadSavedProfiles();
                    
                    const options = savedProfilesSelect.options;
                    for (let i = 0; i < options.length; i++) {
                        if (options[i].textContent.includes(customerName)) {
                            savedProfilesSelect.value = options[i].value;
                            break;
                        }
                    }
                    
                    localStorage.setItem('lastUsedProfile', customerName);
                    
                } catch (error) {
                    console.error('Error saving profile:', error);
                    showSuccess('Error saving profile. Please try again.');
                }
            }
            
            function loadSavedProfiles() {
                while (savedProfilesSelect.options.length > 1) {
                    savedProfilesSelect.options.remove(1);
                }
                
                try {
                    const profiles = JSON.parse(localStorage.getItem('customerProfiles')) || {};
                    Object.keys(profiles).forEach(name => {
                        const option = document.createElement('option');
                        option.value = `local:${name}`;
                        option.textContent = name;
                        savedProfilesSelect.appendChild(option);
                    });
                    
                    const lastUsedProfile = localStorage.getItem('lastUsedProfile');
                    if (lastUsedProfile) {
                        const options = savedProfilesSelect.options;
                        for (let i = 0; i < options.length; i++) {
                            if (options[i].textContent.includes(lastUsedProfile)) {
                                savedProfilesSelect.value = options[i].value;
                                break;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error loading profiles:', error);
                }
            }
            
            function retrieveCustomerProfile() {
                const selectedProfile = savedProfilesSelect.value;
                if (!selectedProfile) {
                    showSuccess('Please select a profile to retrieve');
                    return;
                }
                
                try {
                    let profileData = null;
                    
                    if (selectedProfile.startsWith('local:')) {
                        const profileName = selectedProfile.substring(6);
                        const profiles = JSON.parse(localStorage.getItem('customerProfiles')) || {};
                        profileData = profiles[profileName];
                    }
                    
                    if (!profileData) {
                        showSuccess('Profile not found');
                        return;
                    }
                    
                    resetBtn.click();
                    
                    customerNameInput.value = profileData.customerName;
                    whatsappNumberInput.value = profileData.whatsappNumber || '';
                    salaryInput.value = profileData.salary;
                    loanTypeSelect.value = profileData.loanType;
                    closureFeeInput.value = profileData.closureFee || '';
                    disbursalDateInput.value = profileData.disbursalDate;
                    firstPaymentDateInput.value = profileData.firstPaymentDate;
                    multiplesOfSalaryInput.value = profileData.multiplesOfSalary;
                    tenureMonthsInput.value = profileData.tenureMonths;
                    loanAmountInput.value = profileData.loanAmount;
                    reducingRateInput.value = profileData.reducingRate;
                    preferredEMIInput.value = profileData.preferredEMI || '';
                    specialNote.value = profileData.specialNote;
                    netAmountCheckbox.checked = profileData.netAmountChecked !== undefined ? profileData.netAmountChecked : true;
                    
                    if (profileData.dbrThreshold !== undefined) {
                        dbrThreshold = profileData.dbrThreshold;
                        dbrToggle.checked = dbrThreshold === 49.99;
                    }
                    
                    if (loanTypeSelect.value === 'topup-0-30' || loanTypeSelect.value === 'topup-30-60') {
                        closureFeeContainer.classList.remove('hidden');
                    } else {
                        closureFeeContainer.classList.add('hidden');
                    }
                    
                    if (profileData.creditCards && profileData.creditCards.length > 0) {
                        const firstCardElement = document.querySelector('.credit-card-entry');
                        firstCardElement.querySelector('.card-bank-select').value = profileData.creditCards[0].bank;
                        firstCardElement.querySelector('.credit-card-amount').value = profileData.creditCards[0].limit;
                        firstCardElement.querySelector('.credit-card-new-limit').value = profileData.creditCards[0].newLimit || '';
                        firstCardElement.querySelector('.credit-card-outstanding').value = profileData.creditCards[0].outstanding;
                        
                        if (profileData.creditCards[0].originalOutstanding) {
                            originalOutstandingValues.set(0, parseFloat(profileData.creditCards[0].originalOutstanding));
                        }
                        
                        handleBankSelection(firstCardElement);
                        if (profileData.creditCards[0].settleAmount) {
                            firstCardElement.querySelector('.credit-card-settle-amount').value = profileData.creditCards[0].settleAmount;
                        }
                        
                        if (profileData.creditCards[0].settled) {
                            settledCards.set(0, profileData.creditCards[0].originalOutstanding || profileData.creditCards[0].outstanding);
                            firstCardElement.classList.add('card-settled');
                            const settleBtn = firstCardElement.querySelector('.settle-card-btn');
                            settleBtn.textContent = 'Unsettle';
                            settleBtn.classList.remove('custom-btn');
                            settleBtn.classList.add('bg-gradient-to-r', 'from-red-500', 'to-red-600');
                        }
                        
                        for (let i = 1; i < profileData.creditCards.length; i++) {
                            addCreditCardBtn.click();
                            
                            const cardElements = document.querySelectorAll('.credit-card-entry');
                            const newCard = cardElements[cardElements.length - 1];
                            
                            newCard.querySelector('.card-bank-select').value = profileData.creditCards[i].bank;
                            newCard.querySelector('.credit-card-amount').value = profileData.creditCards[i].limit;
                            newCard.querySelector('.credit-card-new-limit').value = profileData.creditCards[i].newLimit || '';
                            newCard.querySelector('.credit-card-outstanding').value = profileData.creditCards[i].outstanding;
                            
                            if (profileData.creditCards[i].originalOutstanding) {
                                originalOutstandingValues.set(i, parseFloat(profileData.creditCards[i].originalOutstanding));
                            }
                            
                            handleBankSelection(newCard);
                            if (profileData.creditCards[i].settleAmount) {
                                newCard.querySelector('.credit-card-settle-amount').value = profileData.creditCards[i].settleAmount;
                            }
                            
                            if (profileData.creditCards[i].settled) {
                                settledCards.set(i, profileData.creditCards[i].originalOutstanding || profileData.creditCards[i].outstanding);
                                newCard.classList.add('card-settled');
                                const settleBtn = newCard.querySelector('.settle-card-btn');
                                settleBtn.textContent = 'Unsettle';
                                settleBtn.classList.remove('custom-btn');
                                settleBtn.classList.add('bg-gradient-to-r', 'from-red-500', 'to-red-600');
                            }
                        }
                    }
                    
                    if (profileData.existingLoans && profileData.existingLoans.length > 0) {
                        for (let i = 0; i < profileData.existingLoans.length; i++) {
                            addLoansBtn.click();
                            
                            const loanElements = document.querySelectorAll('.existing-loan-entry');
                            const loan = loanElements[i];
                            
                            loan.querySelector('.loan-bank').value = profileData.existingLoans[i].bank || 'ADCB';
                            loan.querySelector('.loan-type').value = profileData.existingLoans[i].type;
                            loan.querySelector('.loan-installment').value = profileData.existingLoans[i].installment;
                            loan.querySelector('.loan-outstanding').value = profileData.existingLoans[i].outstanding;
                            
                            if (profileData.existingLoans[i].settled) {
                                settledLoans.add(i);
                                loan.classList.add('loan-settled');
                                const settleBtn = loan.querySelector('.settle-loan-btn');
                                settleBtn.textContent = 'Unsettle';
                                settleBtn.classList.remove('custom-btn');
                                settleBtn.classList.add('bg-gradient-to-r', 'from-red-500', 'to-red-600');
                            }
                        }
                    }
                    
                    if (profileData.addbackData && Object.keys(profileData.addbackData).length > 0) {
                        addbackData = JSON.parse(JSON.stringify(profileData.addbackData));
                        setupAddbacksFromData(addbackData);
                    }
                    
                    localStorage.setItem('lastUsedProfile', profileData.customerName);
                    
                    updateGrossSalary();
                    updateDBRCalculator();
                    updateEMICalculator();
                    updatePaymentDate();
                    updateTotalPaymentLabel();
                    
                    showSuccess('Profile retrieved successfully!');
                } catch (error) {
                    console.error('Error retrieving profile:', error);
                    showSuccess('Error retrieving profile. Please try again.');
                }
            }
            
            function deleteCustomerProfile() {
                const selectedProfile = savedProfilesSelect.value;
                if (!selectedProfile) {
                    showSuccess('Please select a profile to delete');
                    return;
                }
                
                const profileName = selectedProfile.includes(':') ? 
                    selectedProfile.split(':').slice(-1)[0] : selectedProfile;
                
                if (!showConfirmDialog(`Are you sure you want to delete the profile "${profileName}"?`, () => {
                    try {
                        if (selectedProfile.startsWith('local:')) {
                            const profileName = selectedProfile.substring(6);
                            const existingProfiles = JSON.parse(localStorage.getItem('customerProfiles')) || {};
                            
                            if (existingProfiles[profileName]) {
                                delete existingProfiles[profileName];
                                localStorage.setItem('customerProfiles', JSON.stringify(existingProfiles));
                                showSuccess('Profile deleted successfully!');
                            } else {
                                showSuccess('Profile not found');
                            }
                        }
                        
                        if (localStorage.getItem('lastUsedProfile') === profileName) {
                            localStorage.removeItem('lastUsedProfile');
                        }
                        
                        loadSavedProfiles();
                        
                        savedProfilesSelect.value = '';
                        
                    } catch (error) {
                        console.error('Error deleting profile:', error);
                        showSuccess('Error deleting profile. Please try again.');
                    }
                })) {
                    return;
                }
            }
            
            function showConfirmDialog(message, onConfirm) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                        <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                        <div class="flex justify-end space-x-3">
                            <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">Cancel</button>
                            <button class="confirm-btn px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded">Confirm</button>
                        </div>
                    </div>
                `;
                
                const cancelBtn = modal.querySelector('.cancel-btn');
                const confirmBtn = modal.querySelector('.confirm-btn');
                
                cancelBtn.addEventListener('click', () => {
                    modal.remove();
                });
                
                confirmBtn.addEventListener('click', () => {
                    modal.remove();
                    onConfirm();
                });
                
                document.body.appendChild(modal);
                return true;
            }
            
            function setupAddbacksFromData(data) {
                if (!data || Object.keys(data).length === 0) return;
                
                while (addbacksContainer.children.length > 1) {
                    addbacksContainer.removeChild(addbacksContainer.lastChild);
                }
                dynamicAddbackFields.innerHTML = '';
                addbackCount = 1;
                
                addbackData = JSON.parse(JSON.stringify(data));
                
                const indices = Object.keys(data).map(k => parseInt(k));
                const maxIndex = Math.max(...indices);
                
                const firstAddbackSelect = addbacksContainer.querySelector('.addback-entry .addback-type');
                if (data[0] && data[0].type) {
                    firstAddbackSelect.value = data[0].type;
                    
                    createAddbackTypeFields(firstAddbackSelect);
                    
                    for (let i = 1; i <= maxIndex; i++) {
                        if (data[i] && data[i].type) {
                            addMoreAddbackBtn.click();
                            
                            const addbackEntries = addbacksContainer.querySelectorAll('.addback-entry');
                            const lastEntry = addbackEntries[addbackEntries.length - 1];
                            const typeSelect = lastEntry.querySelector('.addback-type');
                            typeSelect.value = data[i].type;
                            
                            createAddbackTypeFields(typeSelect);
                        }
                    }
                    
                    setTimeout(() => {
                        setAddbackValues(data);
                    }, 500);
                }
            }
            
            function setAddbackValues(data) {
                Object.keys(data).forEach(index => {
                    index = parseInt(index);
                    const addbackType = data[index].type;
                    const values = data[index].values || {};
                    
                    const fieldsContainer = document.getElementById(`addback-fields-${index}`);
                    if (!fieldsContainer) return;
                    
                    if (addbackType === 'hra' || addbackType === 'airfare') {
                        if (values.period) {
                            const periodValue = values.period;
                            const radioId = `${addbackType}${periodValue.charAt(0).toUpperCase() + periodValue.slice(1)}-${index}`;
                            const radioBtn = document.getElementById(radioId);
                            
                            if (radioBtn) {
                                radioBtn.checked = true;
                                
                                if (values.amount) {
                                    const amountInput = fieldsContainer.querySelector(`.${addbackType}-amount`);
                                    if (amountInput) {
                                        amountInput.value = values.amount;
                                    }
                                }
                                
                                addbackData[index] = addbackData[index] || {};
                                addbackData[index].type = addbackType;
                                addbackData[index].values = addbackData[index].values || {};
                                addbackData[index].values.period = periodValue;
                                if (values.amount) {
                                    addbackData[index].values.amount = values.amount;
                                }
                                
                                const changeEvent = new Event('change', { bubbles: true });
                                radioBtn.dispatchEvent(changeEvent);
                                
                                const clickEvent = new MouseEvent('click', {
                                    bubbles: true,
                                    cancelable: true,
                                    view: window
                                });
                                radioBtn.dispatchEvent(clickEvent);
                                
                                if (radioBtn.onclick) {
                                    radioBtn.onclick();
                                }
                            }
                        }
                    } else if (['overtime', 'servicecharge', 'incentives', 'telephone'].includes(addbackType)) {
                        for (let i = 1; i <= 6; i++) {
                            if (values[`month${i}`]) {
                                const monthInput = fieldsContainer.querySelector(`.${addbackType}-amount-${i}`);
                                if (monthInput) {
                                    monthInput.value = values[`month${i}`];
                                    
                                    addbackData[index] = addbackData[index] || {};
                                    addbackData[index].type = addbackType;
                                    addbackData[index].values = addbackData[index].values || {};
                                    addbackData[index].values[`month${i}`] = values[`month${i}`];
                                    
                                    const inputEvent = new Event('input', { bubbles: true });
                                    monthInput.dispatchEvent(inputEvent);
                                }
                            }
                        }
                    }
                });
                
                setTimeout(() => {
                    updateGrossSalary();
                }, 100);
            }
            
            function saveTemporaryState() {
                const tempState = {
                    customerName: customerNameInput.value,
                    whatsappNumber: whatsappNumberInput.value, 
                    salary: salaryInput.value,
                    loanType: loanTypeSelect.value,
                    closureFee: closureFeeInput.value,
                    disbursalDate: disbursalDateInput.value,
                    firstPaymentDate: firstPaymentDateInput.value,
                    multiplesOfSalary: multiplesOfSalaryInput.value,
                    tenureMonths: tenureMonthsInput.value,
                    loanAmount: loanAmountInput.value,
                    reducingRate: reducingRateInput.value,
                    preferredEMI: preferredEMIInput.value,
                    specialNote: specialNote.value,
                    netAmountChecked: netAmountCheckbox.checked,
                    dbrThreshold: dbrThreshold,
                    
                    creditCards: Array.from(document.querySelectorAll('.credit-card-entry')).map((entry, index) => {
                        return {
                            bank: entry.querySelector('.card-bank-select').value,
                            limit: entry.querySelector('.credit-card-amount').value,
                            newLimit: entry.querySelector('.credit-card-new-limit').value,
                            outstanding: entry.querySelector('.credit-card-outstanding').value,
                            settled: settledCards.has(index),
                            originalOutstanding: originalOutstandingValues.get(index) || entry.querySelector('.credit-card-outstanding').value,
                            settleAmount: entry.querySelector('.credit-card-settle-amount').value
                        };
                    }),
                    
                    existingLoans: Array.from(document.querySelectorAll('.existing-loan-entry')).map((entry, index) => {
                        return {
                            bank: entry.querySelector('.loan-bank').value,
                            type: entry.querySelector('.loan-type').value,
                            installment: entry.querySelector('.loan-installment').value,
                            outstanding: entry.querySelector('.loan-outstanding').value,
                            settled: settledLoans.has(index)
                        };
                    }),
                    
                    addbackData: JSON.parse(JSON.stringify(addbackData))
                };
                
                localStorage.setItem('tempFormState', JSON.stringify(tempState));
            }
            
            function loadTemporaryState() {
                try {
                    const tempState = JSON.parse(localStorage.getItem('tempFormState'));
                    
                    if (!tempState) return;
                    
                    customerNameInput.value = tempState.customerName || '';
                    whatsappNumberInput.value = tempState.whatsappNumber || '';
                    salaryInput.value = tempState.salary || '';
                    loanTypeSelect.value = tempState.loanType || 'fresh-0-30';
                    closureFeeInput.value = tempState.closureFee || '';
                    disbursalDateInput.value = tempState.disbursalDate || today.toISOString().split('T')[0];
                    firstPaymentDateInput.value = tempState.firstPaymentDate || nextMonth.toISOString().split('T')[0];
                    multiplesOfSalaryInput.value = tempState.multiplesOfSalary || '20';
                    tenureMonthsInput.value = tempState.tenureMonths || '48';
                    loanAmountInput.value = tempState.loanAmount || '';
                    reducingRateInput.value = tempState.reducingRate || '10';
                    preferredEMIInput.value = tempState.preferredEMI || '';
                    specialNote.value = tempState.specialNote || '';
                    netAmountCheckbox.checked = tempState.netAmountChecked !== undefined ? tempState.netAmountChecked : true;
                    
                    if (tempState.dbrThreshold !== undefined) {
                        dbrThreshold = tempState.dbrThreshold;
                        dbrToggle.checked = dbrThreshold === 49.99;
                    }
                    
                    if (loanTypeSelect.value === 'topup-0-30' || loanTypeSelect.value === 'topup-30-60') {
                        closureFeeContainer.classList.remove('hidden');
                    } else {
                        closureFeeContainer.classList.add('hidden');
                    }
                    
                    if (tempState.creditCards && tempState.creditCards.length > 0) {
                        const firstCardElement = document.querySelector('.credit-card-entry');
                        firstCardElement.querySelector('.card-bank-select').value = tempState.creditCards[0].bank || 'ADCB';
                        firstCardElement.querySelector('.credit-card-amount').value = tempState.creditCards[0].limit || '';
                        firstCardElement.querySelector('.credit-card-new-limit').value = tempState.creditCards[0].newLimit || '';
                        firstCardElement.querySelector('.credit-card-outstanding').value = tempState.creditCards[0].outstanding || '';
                        
                        if (tempState.creditCards[0].originalOutstanding) {
                            originalOutstandingValues.set(0, parseFloat(tempState.creditCards[0].originalOutstanding));
                        }
                        
                        handleBankSelection(firstCardElement);
                        if (tempState.creditCards[0].settleAmount) {
                            firstCardElement.querySelector('.credit-card-settle-amount').value = tempState.creditCards[0].settleAmount;
                        }
                        
                        if (tempState.creditCards[0].settled) {
                            settledCards.set(0, tempState.creditCards[0].originalOutstanding || tempState.creditCards[0].outstanding);
                            firstCardElement.classList.add('card-settled');
                            const settleBtn = firstCardElement.querySelector('.settle-card-btn');
                            settleBtn.textContent = 'Unsettle';
                            settleBtn.classList.remove('custom-btn');
                            settleBtn.classList.add('bg-gradient-to-r', 'from-red-500', 'to-red-600');
                        }
                        
                        for (let i = 1; i < tempState.creditCards.length; i++) {
                            addCreditCardBtn.click();
                            
                            const cardElements = document.querySelectorAll('.credit-card-entry');
                            const newCard = cardElements[cardElements.length - 1];
                            
                            newCard.querySelector('.card-bank-select').value = tempState.creditCards[i].bank || 'ADCB';
                            newCard.querySelector('.credit-card-amount').value = tempState.creditCards[i].limit || '';
                            newCard.querySelector('.credit-card-new-limit').value = tempState.creditCards[i].newLimit || '';
                            newCard.querySelector('.credit-card-outstanding').value = tempState.creditCards[i].outstanding || '';
                            
                            if (tempState.creditCards[i].originalOutstanding) {
                                originalOutstandingValues.set(i, parseFloat(tempState.creditCards[i].originalOutstanding));
                            }
                            
                            handleBankSelection(newCard);
                            if (tempState.creditCards[i].settleAmount) {
                                newCard.querySelector('.credit-card-settle-amount').value = tempState.creditCards[i].settleAmount;
                            }
                            
                            if (tempState.creditCards[i].settled) {
                                settledCards.set(i, tempState.creditCards[i].originalOutstanding || tempState.creditCards[i].outstanding);
                                newCard.classList.add('card-settled');
                                const settleBtn = newCard.querySelector('.settle-card-btn');
                                settleBtn.textContent = 'Unsettle';
                                settleBtn.classList.remove('custom-btn');
                                settleBtn.classList.add('bg-gradient-to-r', 'from-red-500', 'to-red-600');
                            }
                        }
                    }
                    
                    if (tempState.existingLoans && tempState.existingLoans.length > 0) {
                        for (let i = 0; i < tempState.existingLoans.length; i++) {
                            addLoansBtn.click();
                            
                            const loanElements = document.querySelectorAll('.existing-loan-entry');
                            const loan = loanElements[i];
                            
                            loan.querySelector('.loan-bank').value = tempState.existingLoans[i].bank || 'ADCB';
                            loan.querySelector('.loan-type').value = tempState.existingLoans[i].type || 'Personal Loan';
                            loan.querySelector('.loan-installment').value = tempState.existingLoans[i].installment || '';
                            loan.querySelector('.loan-outstanding').value = tempState.existingLoans[i].outstanding || '';
                            
                            if (tempState.existingLoans[i].settled) {
                                settledLoans.add(i);
                                loan.classList.add('loan-settled');
                                const settleBtn = loan.querySelector('.settle-loan-btn');
                                settleBtn.textContent = 'Unsettle';
                                settleBtn.classList.remove('custom-btn');
                                settleBtn.classList.add('bg-gradient-to-r', 'from-red-500', 'to-red-600');
                            }
                        }
                    }
                    
                    if (tempState.addbackData && Object.keys(tempState.addbackData).length > 0) {
                        addbackData = JSON.parse(JSON.stringify(tempState.addbackData));
                        setupAddbacksFromData(addbackData);
                    }
                    
                    setTimeout(() => {
                        updateGrossSalary();
                        updateDBRCalculator();
                        updateEMICalculator();
                        updatePaymentDate();
                        updateTotalPaymentLabel();
                    }, 500);
                    
                } catch (error) {
                    console.error('Error loading temporary state:', error);
                }
            }
            
            function createAddbackTypeFields(selectElement) {
                const addbackType = selectElement.value;
                const addbackEntry = selectElement.closest('.addback-entry');
                const index = Array.from(addbacksContainer.querySelectorAll('.addback-entry')).indexOf(addbackEntry);
                
                const existingFields = document.getElementById(`addback-fields-${index}`);
                if (existingFields) {
                    existingFields.remove();
                    delete addbackData[index];
                }
                
                if (!addbackType) return;
                
                const fieldsContainer = document.createElement('div');
                fieldsContainer.id = `addback-fields-${index}`;
                fieldsContainer.classList.add('mt-2', 'p-3', 'border', 'border-gray-200', 'dark:border-gray-600', 'rounded-lg');
                
                let html = '';
                
                addbackData[index] = {
                    type: addbackType,
                    values: {}
                };
                
                switch(addbackType) {
                    case 'hra':
                    case 'airfare':
                        html = `
                            <h3 class="font-semibold mb-2 text-gray-700 dark:text-gray-300 text-sm">${addbackType === 'hra' ? 'HRA' : 'Airfare Allowance'}</h3>
                            <div class="flex items-center gap-4 mb-2">
                                <div class="flex items-center">
                                    <input type="radio" id="${addbackType}Yearly-${index}" name="${addbackType}Period-${index}" value="yearly" class="mr-2">
                                    <label for="${addbackType}Yearly-${index}" class="text-gray-700 dark:text-gray-300 text-sm">Yearly</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="${addbackType}Monthly-${index}" name="${addbackType}Period-${index}" value="monthly" class="mr-2">
                                    <label for="${addbackType}Monthly-${index}" class="text-gray-700 dark:text-gray-300 text-sm">Monthly</label>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 gap-2">
                                <div class="flex items-center">
                                    <label class="text-gray-700 dark:text-gray-300 w-1/3 text-sm">Amount:</label>
                                    <input type="number" class="${addbackType}-amount border rounded-md p-2 text-sm dark:bg-gray-800 dark:text-white dark:border-gray-600 w-2/3">
                                </div>
                            </div>
                        `;
                        break;
                    case 'overtime':
                    case 'servicecharge':
                    case 'incentives':
                    case 'telephone':
                        const title = {
                            'overtime': 'Over-time',
                            'servicecharge': 'Service Charge',
                            'incentives': 'Incentives',
                            'telephone': 'Telephone Allowance'
                        }[addbackType];
                        
                        html = `<h3 class="font-semibold mb-2 text-gray-700 dark:text-gray-300 text-sm">${title}</h3>`;
                        
                        html += '<div class="grid grid-cols-2 gap-2">';
                        for (let i = 1; i <= 6; i++) {
                            html += `
                                <div class="flex items-center">
                                    <label class="text-gray-700 dark:text-gray-300 w-1/3 text-sm">Month ${i}:</label>
                                    <input type="number" class="${addbackType}-amount-${i} border rounded-md p-1.5 text-sm dark:bg-gray-800 dark:text-white dark:border-gray-600 w-2/3">
                                </div>
                            `;
                        }
                        html += '</div>';
                        break;
                }
                
                fieldsContainer.innerHTML = html;
                dynamicAddbackFields.appendChild(fieldsContainer);
                
                if (addbackType === 'hra' || addbackType === 'airfare') {
                    const yearlyRadio = document.getElementById(`${addbackType}Yearly-${index}`);
                    const monthlyRadio = document.getElementById(`${addbackType}Monthly-${index}`);
                    
                    yearlyRadio.addEventListener('change', function() {
                        if (this.checked) {
                            addbackData[index].values.period = 'yearly';
                            updateGrossSalary();
                        }
                    });
                    
                    monthlyRadio.addEventListener('change', function() {
                        if (this.checked) {
                            addbackData[index].values.period = 'monthly';
                            updateGrossSalary();
                        }
                    });
                    
                    const amountInput = fieldsContainer.querySelector(`.${addbackType}-amount`);
                    amountInput.addEventListener('input', function() {
                        addbackData[index].values.amount = this.value;
                        updateGrossSalary();
                    });
                } else if (['overtime', 'servicecharge', 'incentives', 'telephone'].includes(addbackType)) {
                    for (let i = 1; i <= 6; i++) {
                        const amountInput = fieldsContainer.querySelector(`.${addbackType}-amount-${i}`);
                        amountInput.addEventListener('input', function() {
                            if (!addbackData[index].values) addbackData[index].values = {};
                            addbackData[index].values[`month${i}`] = this.value;
                            updateGrossSalary();
                        });
                    }
                }
            }
            
            function updateGrossSalary() {
                const salary = parseFloat(salaryInput.value) || 0;
                let totalAddbacks = 0;
                
                Object.keys(addbackData).forEach(index => {
                    const addback = addbackData[index];
                    if (!addback || !addback.type) return;
                    
                    const values = addback.values || {};
                    
                    if (addback.type === 'hra' || addback.type === 'airfare') {
                        const amount = parseFloat(values.amount) || 0;
                        
                        if (amount > 0) {
                            if (values.period === 'yearly') {
                                totalAddbacks += amount / 12;
                            } else if (values.period === 'monthly') {
                                totalAddbacks += amount;
                            }
                        }
                    } else if (['overtime', 'servicecharge', 'incentives', 'telephone'].includes(addback.type)) {
                        let sixMonthTotal = 0;
                        
                        for (let i = 1; i <= 6; i++) {
                            const monthAmount = parseFloat(values[`month${i}`]) || 0;
                            sixMonthTotal += monthAmount;
                        }
                        
                        if (addback.type === 'telephone') {
                            totalAddbacks += sixMonthTotal / 6;
                        } else {
                            totalAddbacks += sixMonthTotal / 6;
                        }
                    }
                });
                
                const grossSalary = salary + totalAddbacks;
                grossSalaryInput.value = formatNumber(grossSalary.toFixed(2));
                
                updateDBRCalculator();
                updateEMICalculator();
            }
            
            function calculateStandardEMI(principal, rate, tenure) {
                const monthlyRate = rate / 12 / 100;
                const emi = principal * monthlyRate * Math.pow(1 + monthlyRate, tenure) / (Math.pow(1 + monthlyRate, tenure) - 1);
                return isNaN(emi) || !isFinite(emi) ? 0 : emi;
            }
            
            function getGracePeriodFromLoanType(loanType) {
                switch(loanType) {
                    case 'fresh-0-30':
                    case 'topup-0-30':
                        return 0;
                    case 'fresh-30-60':
                    case 'topup-30-60':
                        return 1;
                    case 'takeover-60-90':
                        return 2;
                    default:
                        return 0;
                }
            }
            
            function calculateEMIWithGracePeriod(principal, rate, tenure, loanType) {
                if (!principal || !rate || !tenure || !loanType) return 0;
                
                const monthlyRate = rate / 12 / 100;
                const gracePeriodMonths = getGracePeriodFromLoanType(loanType);
                
                if (gracePeriodMonths === 0) {
                    return calculateStandardEMI(principal, rate, tenure);
                } else if (gracePeriodMonths === 1) {
                    const interest1Month = principal * monthlyRate;
                    const newPrincipal = principal + interest1Month;
                    return calculateStandardEMI(newPrincipal, rate, tenure);
                } else if (gracePeriodMonths === 2) {
                    const interest2Months = principal * monthlyRate * 2;
                    const newPrincipal = principal + interest2Months;
                    return calculateStandardEMI(newPrincipal, rate, tenure);
                }
                
                return 0;
            }
            
            function calculateProcessingFees(loanAmount) {
                const processingFeePercent = loanAmount * 0.0105;
                
                if (processingFeePercent > 2625) {
                    return 2625;
                } else if (processingFeePercent < 525) {
                    return 525;
                } else {
                    return processingFeePercent;
                }
            }
            
            function getDayRangeFromLoanType(loanType) {
                switch(loanType) {
                    case 'fresh-0-30':
                    case 'topup-0-30':
                        return [0, 30];
                    case 'fresh-30-60':
                    case 'topup-30-60':
                        return [31, 60];
                    case 'takeover-60-90':
                        return [61, 90];
                    default:
                        return [0, 90];
                }
            }
            
            creditCardsContainer.addEventListener('click', function(e) {
                if (e.target.classList.contains('settle-card-btn')) {
                    const cardEntry = e.target.closest('.credit-card-entry');
                    const cardIndex = Array.from(document.querySelectorAll('.credit-card-entry')).indexOf(cardEntry);
                    const outstandingInput = cardEntry.querySelector('.credit-card-outstanding');
                    const settleAmountInput = cardEntry.querySelector('.credit-card-settle-amount');
                    const bankSelect = cardEntry.querySelector('.card-bank-select');
                    
                    if (settledCards.has(cardIndex)) {
                        const originalOutstanding = settledCards.get(cardIndex);
                        settledCards.delete(cardIndex);
                        cardEntry.classList.remove('card-settled');
                        e.target.textContent = 'Settle';
                        e.target.classList.add('custom-btn');
                        e.target.classList.remove('bg-gradient-to-r', 'from-red-500', 'to-red-600');
                        
                        outstandingInput.value = originalOutstanding;
                        originalOutstandingValues.set(cardIndex, originalOutstanding);
                    } else {
                        const currentOutstanding = parseFloat(outstandingInput.value) || 0;
                        settledCards.set(cardIndex, currentOutstanding);
                        cardEntry.classList.add('card-settled');
                        e.target.textContent = 'Unsettle';
                        e.target.classList.remove('custom-btn');
                        e.target.classList.add('bg-gradient-to-r', 'from-red-500', 'to-red-600');
                    }
                    
                    updateDBRCalculator();
                }
            });
            
            function updateDBRCalculator() {
                const grossSalary = parseFloat(grossSalaryInput.value.replace(/,/g, '')) || 0;
                
                let totalExistingLoansInstallments = 0;
                document.querySelectorAll('.existing-loan-entry').forEach((entry, index) => {
                    if (!settledLoans.has(index)) {
                        const installmentInput = entry.querySelector('.loan-installment');
                        totalExistingLoansInstallments += parseFloat(installmentInput.value) || 0;
                    }
                });
                
                let totalCCLimit = 0;
                let totalCCOutstanding = 0;
                
                document.querySelectorAll('.credit-card-entry').forEach((entry, index) => {
                    const limitInput = entry.querySelector('.credit-card-amount');
                    const newLimitInput = entry.querySelector('.credit-card-new-limit');
                    const outstandingInput = entry.querySelector('.credit-card-outstanding');
                    const settleAmountInput = entry.querySelector('.credit-card-settle-amount');
                    const bankSelect = entry.querySelector('.card-bank-select');
                    
                    const originalLimit = parseFloat(limitInput.value) || 0;
                    const newLimitValue = newLimitInput.value;
                    const newLimit = newLimitValue !== '' ? parseFloat(newLimitValue) : null;
                    const outstanding = parseFloat(outstandingInput.value) || 0;
                    
                    const effectiveLimit = newLimit !== null ? newLimit : originalLimit;
                    
                    if (!settledCards.has(index)) {
                        totalCCLimit += effectiveLimit;
                    }
                    
                    if (settledCards.has(index)) {
                        const originalOutstanding = settledCards.get(index) || outstanding;
                        totalCCOutstanding += originalOutstanding;
                    } else {
                        if (bankSelect.value === 'ADCB' && !settleAmountInput.classList.contains('hidden')) {
                            const settleAmount = parseFloat(settleAmountInput.value) || 0;
                            if (settleAmount > 0) {
                                totalCCOutstanding += settleAmount;
                            }
                        }
                    }
                });
                
                totalCCLimitInput.value = formatNumber(totalCCLimit.toFixed(2));
                
                const dbrRate = 0.05;
                const dbrCC = totalCCLimit * dbrRate;
                dbrCCInput.value = formatNumber(dbrCC.toFixed(2));
                
                let totalExistingLoansOutstanding = 0;
                document.querySelectorAll('.existing-loan-entry').forEach((entry, index) => {
                    if (settledLoans.has(index)) {
                        const outstandingInput = entry.querySelector('.loan-outstanding');
                        totalExistingLoansOutstanding += parseFloat(outstandingInput.value) || 0;
                    }
                });
                
                const totalOutstanding = totalCCOutstanding + totalExistingLoansOutstanding;
                totalOutstandingInput.value = formatNumber(totalOutstanding.toFixed(2));
                
                const allowedLiability = grossSalary / 2;
                allowedLiabilityInput.value = formatNumber(allowedLiability.toFixed(2));
                
                const emi = parseFloat(emiInput.value.replace(/,/g, '')) || 0;
                
                const totalLiabilities = totalExistingLoansInstallments + dbrCC;
                totalLiabilitiesInput.value = formatNumber(totalLiabilities.toFixed(2));
                
                const newTotalLiabilities = totalLiabilities + emi;
                newTotalLiabilitiesInput.value = formatNumber(newTotalLiabilities.toFixed(2));
                
                const availableLiability = allowedLiability - newTotalLiabilities;
                availableLiabilityInput.value = formatNumber(availableLiability.toFixed(2));
                
                const dbrPercentage = (newTotalLiabilities / grossSalary) * 100;
                dbrPercentageInput.value = dbrPercentage.toFixed(2);
                
                if (dbrPercentage >= dbrThreshold) {
                    dbrCalculatorSection.classList.add('dbr-warning-flash');
                    emiCalculatorSection.classList.add('dbr-warning-flash');
                    
                    dbrPercentageInput.classList.add('dbr-high');
                    
                    setTimeout(() => {
                        dbrCalculatorSection.classList.remove('dbr-warning-flash');
                        emiCalculatorSection.classList.remove('dbr-warning-flash');
                    }, 3000);
                } else {
                    dbrPercentageInput.classList.remove('dbr-high');
                }
                
                checkLoanAmountWithDBR();
                
                suggestCreditCardLimitOrSettlement();
                
                updateCashInHand();
                
                updateLoanMultiples();
            }
            
            function updateLoanMultiples() {
                const loanAmount = parseFloat(loanAmountInput.value) || 0;
                const salary = parseFloat(salaryInput.value) || 0;
                
                if (loanAmount > 0 && salary > 0) {
                    const multiples = loanAmount / salary;
                    loanMultiplesInput.value = multiples.toFixed(2) + 'x';
                } else {
                    loanMultiplesInput.value = '';
                }
            }
            
            function checkLoanAmountWithDBR() {
                const grossSalary = parseFloat(grossSalaryInput.value.replace(/,/g, '')) || 0;
                const loanAmount = parseFloat(loanAmountInput.value) || 0;
                const reducingRate = parseFloat(reducingRateInput.value) || 0;
                const tenureMonths = parseInt(tenureMonthsInput.value) || 0;
                const loanType = loanTypeSelect.value;
                
                if (grossSalary <= 0 || loanAmount <= 0) {
                    loanAmountError.classList.add('hidden');
                    return;
                }
                
                const emi = calculateEMIWithGracePeriod(loanAmount, reducingRate, tenureMonths, loanType);
                
                let totalExistingLoansInstallments = 0;
                document.querySelectorAll('.existing-loan-entry').forEach((entry, index) => {
                    if (!settledLoans.has(index)) {
                        const installmentInput = entry.querySelector('.loan-installment');
                        totalExistingLoansInstallments += parseFloat(installmentInput.value) || 0;
                    }
                });
                
                let totalCCLimit = 0;
                document.querySelectorAll('.credit-card-entry').forEach((entry, index) => {
                    if (!settledCards.has(index)) {
                        const limitInput = entry.querySelector('.credit-card-amount');
                        const newLimitInput = entry.querySelector('.credit-card-new-limit');
                        
                        const originalLimit = parseFloat(limitInput.value) || 0;
                        const newLimitValue = newLimitInput.value;
                        const newLimit = newLimitValue !== '' ? parseFloat(newLimitValue) : null;
                        
                        const effectiveLimit = newLimit !== null ? newLimit : originalLimit;
                        totalCCLimit += effectiveLimit;
                    }
                });
                
                const dbrRate = 0.05;
                const dbrCC = totalCCLimit * dbrRate;
                const currentLiabilities = totalExistingLoansInstallments + dbrCC;
                
                const totalLiabilitiesWithEMI = currentLiabilities + emi;
                
                const dbrPercentage = (totalLiabilitiesWithEMI / grossSalary) * 100;
                
                const allowedLiability = grossSalary * (dbrThreshold / 100);
                const availableForEMI = allowedLiability - currentLiabilities;
                
                let low = 0;
                let high = grossSalary * 100;
                let idealLoanAmount = 0;
                
                while (high - low > 1) {
                    const mid = (low + high) / 2;
                    const testEMI = calculateEMIWithGracePeriod(mid, reducingRate, tenureMonths, loanType);
                    
                    if (testEMI <= availableForEMI) {
                        low = mid;
                        idealLoanAmount = mid;
                    } else {
                        high = mid;
                    }
                }
                
                if (dbrPercentage >= dbrThreshold) {
                    loanAmountError.textContent = `Error: Loan Amount Will Exceed DBR Limit! Ideal amount: AED ${formatNumber(Math.floor(idealLoanAmount))}`;
                    loanAmountError.classList.remove('hidden');
                } else {
                    loanAmountError.classList.add('hidden');
                }
            }
            
            function suggestCreditCardLimitOrSettlement() {
                const grossSalary = parseFloat(grossSalaryInput.value.replace(/,/g, '')) || 0;
                const dbrPercentage = parseFloat(dbrPercentageInput.value) || 0;
                
                if (grossSalary <= 0) {
                    ccSuggestionContainer.classList.add('hidden');
                    return;
                }
                
                let hasADCBOutstandingAlert = false;
                let adcbSettlementAmount = 0;
                
                document.querySelectorAll('.credit-card-entry').forEach((entry, index) => {
                    const bankSelect = entry.querySelector('.card-bank-select');
                    const newLimitInput = entry.querySelector('.credit-card-new-limit');
                    const outstandingInput = entry.querySelector('.credit-card-outstanding');
                    
                    if (bankSelect.value === 'ADCB' && !settledCards.has(index)) {
                        const newLimit = parseFloat(newLimitInput.value) || 0;
                        const outstanding = parseFloat(outstandingInput.value) || 0;
                        
                        if (newLimit > 0 && outstanding > newLimit) {
                            hasADCBOutstandingAlert = true;
                            adcbSettlementAmount = outstanding + 500 - newLimit;
                        }
                    }
                });
                
                if (hasADCBOutstandingAlert || dbrPercentage >= dbrThreshold) {
                    suggestionTitle.textContent = 'SETTLEMENT SUGGESTION';
                    
                    if (hasADCBOutstandingAlert) {
                        ccSuggestionText.textContent = `For ADCB Credit Card: Settle AED ${formatNumber(adcbSettlementAmount.toFixed(2))} to align with the new limit and maintain a buffer.`;
                    } else {
                        const currentNewTotalLiabilities = parseFloat(newTotalLiabilitiesInput.value.replace(/,/g, '')) || 0;
                        const allowedLiability = grossSalary * (dbrThreshold / 100);
                        const excessLiability = currentNewTotalLiabilities - allowedLiability;
                        
                        if (excessLiability > 0) {
                            const ccLimitReductionNeeded = excessLiability / 0.05;
                            
                            const currentTotalCCLimit = parseFloat(totalCCLimitInput.value.replace(/,/g, '')) || 0;
                            const targetCCLimit = Math.max(0, currentTotalCCLimit - ccLimitReductionNeeded);
                            
                            let adcbSuggestion = '';
                            const adcbCards = Array.from(document.querySelectorAll('.credit-card-entry')).filter(entry => 
                                entry.querySelector('.card-bank-select').value === 'ADCB'
                            );
                            
                            if (adcbCards.length > 0) {
                                const adcbCard = adcbCards[0];
                                const creditLimit = parseFloat(adcbCard.querySelector('.credit-card-amount').value) || 0;
                                const outstanding = parseFloat(adcbCard.querySelector('.credit-card-outstanding').value) || 0;
                                const newLimitInput = adcbCard.querySelector('.credit-card-new-limit');
                                const newLimitValue = parseFloat(newLimitInput.value) || 0;
                                
                                if (creditLimit > 0) {
                                    const suggestedNewLimit = Math.max(3000, creditLimit - ccLimitReductionNeeded);
                                    
                                    if (suggestedNewLimit < 3000) {
                                        adcbSuggestion = ` For ADCB Credit Card: Cancel the card as the required limit would be below AED 3,000.`;
                                    } else {
                                        if (newLimitValue > 0 && outstanding > newLimitValue) {
                                            const settlementAmount = outstanding - newLimitValue;
                                            adcbSuggestion = ` For ADCB Credit Card: Reduce limit to AED ${formatNumber(suggestedNewLimit.toFixed(2))} and settle AED ${formatNumber(settlementAmount.toFixed(2))}.`;
                                        } else {
                                            const settlementAmount = Math.max(0, outstanding + 500 - suggestedNewLimit);
                                            adcbSuggestion = ` For ADCB Credit Card: Reduce limit to AED ${formatNumber(suggestedNewLimit.toFixed(2))} and settle AED ${formatNumber(settlementAmount.toFixed(2))}.`;
                                        }
                                    }
                                }
                            }
                            
                            ccSuggestionText.textContent = `Your DBR exceeds ${dbrThreshold}%. To bring it within limit, reduce total credit card limits to AED ${formatNumber(targetCCLimit.toFixed(2))}.${adcbSuggestion}`;
                        } else {
                            ccSuggestionText.textContent = `Your DBR is at the limit. Consider reducing credit card limits or settling outstanding amounts.`;
                        }
                    }
                    
                    ccSuggestionText.classList.remove('cc-suggestion-text');
                    ccSuggestionText.classList.add('settlement-suggestion-text');
                    ccSuggestionContainer.classList.remove('hidden');
                } else {
                    suggestionTitle.textContent = 'CREDIT CARD SUGGESTION';
                    
                    const availableLiability = parseFloat(availableLiabilityInput.value.replace(/,/g, '')) || 0;
                    
                    const dbrRate = 5;
                    const optimalCCLimit = availableLiability / (dbrRate/100);
                    
                    let hideForADCBSettled = false;
                    document.querySelectorAll('.credit-card-entry').forEach((entry, index) => {
                        const bankSelect = entry.querySelector('.card-bank-select');
                        if (bankSelect.value === 'ADCB' && settledCards.has(index)) {
                            hideForADCBSettled = true;
                        }
                    });
                    
                    if (hideForADCBSettled) {
                        ccSuggestionContainer.classList.add('hidden');
                    } else if (availableLiability > 0 && optimalCCLimit >= 3000) {
                        ccSuggestionContainer.classList.remove('hidden');
                        ccSuggestionText.textContent = `Based on your available liability of AED ${formatNumber(availableLiability.toFixed(2))} and current DBR of ${dbrPercentage.toFixed(2)}%, the optimal credit card limit for you would be AED ${formatNumber(optimalCCLimit.toFixed(2))}. This would keep your DBR within the ${dbrThreshold}% limit.`;
                        ccSuggestionText.classList.add('cc-suggestion-text');
                        ccSuggestionText.classList.remove('settlement-suggestion-text');
                    } else if (optimalCCLimit < 3000 && availableLiability > 0) {
                        ccSuggestionContainer.classList.add('hidden');
                    } else {
                        ccSuggestionContainer.classList.remove('hidden');
                        ccSuggestionText.textContent = `Your current liabilities exceed or are close to the ${dbrThreshold}% DBR limit. It is not recommended to apply for any credit cards at this time.`;
                        ccSuggestionText.classList.add('cc-suggestion-text');
                        ccSuggestionText.classList.remove('settlement-suggestion-text');
                    }
                }
            }
            
            function updateEMICalculator() {
                const salary = parseFloat(salaryInput.value) || 0;
                const multiplesOfSalary = parseFloat(multiplesOfSalaryInput.value) || 0;
                const loanAmount = parseFloat(loanAmountInput.value) || 0;
                const reducingRate = parseFloat(reducingRateInput.value) || 0;
                const tenureMonths = parseInt(tenureMonthsInput.value) || 0;
                const loanType = loanTypeSelect.value;
                
                const maxLoanEligibility = salary * multiplesOfSalary;
                maxLoanEligibilityInput.value = formatNumber(maxLoanEligibility.toFixed(2));
                
                const flatRate = reducingRate / 1.833;
                flatRateInput.value = flatRate.toFixed(2);
                
                if (loanAmount > 0 && reducingRate > 0 && tenureMonths > 0) {
                    const emi = calculateEMIWithGracePeriod(loanAmount, reducingRate, tenureMonths, loanType);
                    emiInput.value = formatNumber(emi.toFixed(2));
                    
                    const totalPayment = emi * tenureMonths;
                    totalPaymentInput.value = formatNumber(totalPayment.toFixed(2));
                    
                    const totalInterest = totalPayment - loanAmount;
                    totalInterestInput.value = formatNumber(totalInterest.toFixed(2));
                    
                    const processingFees = calculateProcessingFees(loanAmount);
                    processingFeesInput.value = formatNumber(processingFees.toFixed(2));
                    
                    updateLoanMultiples();
                    
                    updateDBRCalculator();
                } else {
                    emiInput.value = '';
                    totalPaymentInput.value = '';
                    totalInterestInput.value = '';
                    processingFeesInput.value = '';
                    loanMultiplesInput.value = '';
                }
                
                updateTotalPaymentLabel();
            }
            
            function validatePaymentDate() {
                const disbursalDate = new Date(disbursalDateInput.value);
                const firstPaymentDate = new Date(firstPaymentDateInput.value);
                const loanType = loanTypeSelect.value;
                
                if (!disbursalDate || !firstPaymentDate) {
                    return true;
                }
                
                const daysDifference = Math.floor((firstPaymentDate - disbursalDate) / (1000 * 60 * 60 * 24));
                
                const [minDays, maxDays] = getDayRangeFromLoanType(loanType);
                
                if (daysDifference < minDays || daysDifference > maxDays) {
                    dateErrorMsg.textContent = `Error: First Payment Date Must Be Between ${minDays} and ${maxDays} Days After Disbursal Date.`;
                    dateErrorMsg.classList.remove('hidden');
                    return false;
                } else if (firstPaymentDate <= disbursalDate) {
                    dateErrorMsg.textContent = 'Error: First Payment Date Must Be After Disbursal Date.';
                    dateErrorMsg.classList.remove('hidden');
                    return false;
                } else {
                    dateErrorMsg.classList.add('hidden');
                    return true;
                }
            }
            
            function generateEMISchedule() {
                const loanAmount = parseFloat(loanAmountInput.value) || 0;
                const reducingRate = parseFloat(reducingRateInput.value) || 0;
                const tenureMonths = parseInt(tenureMonthsInput.value) || 0;
                const loanType = loanTypeSelect.value;
                
                if (loanAmount <= 0 || tenureMonths <= 0) {
                    return [];
                }
                
                let initialPrincipal = loanAmount;
                const monthlyRate = reducingRate / 12 / 100;
                const gracePeriodMonths = getGracePeriodFromLoanType(loanType);
                
                if (gracePeriodMonths === 1) {
                    const interest1Month = loanAmount * monthlyRate;
                    initialPrincipal = loanAmount + interest1Month;
                } else if (gracePeriodMonths === 2) {
                    const interest2Months = loanAmount * monthlyRate * 2;
                    initialPrincipal = loanAmount + interest2Months;
                }
                
                const emi = calculateStandardEMI(initialPrincipal, reducingRate, tenureMonths);
                let remainingPrincipal = initialPrincipal;
                const schedule = [];
                
                for (let month = 1; month <= tenureMonths; month++) {
                    const interestForMonth = remainingPrincipal * monthlyRate;
                    const principalForMonth = emi - interestForMonth;
                    remainingPrincipal -= principalForMonth;
                    
                    schedule.push({
                        month,
                        emi,
                        principal: principalForMonth,
                        interest: interestForMonth,
                        balance: remainingPrincipal < 0 ? 0 : remainingPrincipal
                    });
                }
                
                return schedule;
            }
            
            function displayEMIChart() {
                const schedule = generateEMISchedule();
                if (schedule.length === 0) {
                    showSuccess('Please enter valid loan amount, rate and tenure first.');
                    return;
                }
                
                emiChartSection.classList.remove('hidden');
                emiChartSection.scrollIntoView({ behavior: 'smooth' });
                
                const months = schedule.map(entry => entry.month);
                const principal = schedule.map(entry => entry.principal);
                const interest = schedule.map(entry => entry.interest);
                
                if (emiChart) {
                    emiChart.destroy();
                }
                
                const ctx = document.getElementById('emiChart').getContext('2d');
                emiChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: 'Principal',
                                data: principal,
                                backgroundColor: '#00bfff',
                                borderColor: '#008b8b',
                                borderWidth: 1
                            },
                            {
                                label: 'Interest',
                                data: interest,
                                backgroundColor: '#f783ac',
                                borderColor: '#a61e4d',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true,
                                title: {
                                    display: true,
                                    text: 'Month'
                                }
                            },
                            y: {
                                stacked: true,
                                title: {
                                    display: true,
                                    text: 'Amount (AED)'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'EMI Breakdown - Principal vs. Interest',
                                font: {
                                    size: 16
                                }
                            }
                        }
                    }
                });
                
                const tableBody = document.getElementById('emiScheduleBody');
                tableBody.innerHTML = '';
                
                for (let i = 0; i < schedule.length; i++) {
                    const entry = schedule[i];
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="border border-gray-300 p-2 text-center">${entry.month}</td>
                        <td class="border border-gray-300 p-2 text-right">${formatNumber(entry.emi.toFixed(2))}</td>
                        <td class="border border-gray-300 p-2 text-right">${formatNumber(entry.principal.toFixed(2))}</td>
                        <td class="border border-gray-300 p-2 text-right">${formatNumber(entry.interest.toFixed(2))}</td>
                        <td class="border border-gray-300 p-2 text-right">${formatNumber(entry.balance.toFixed(2))}</td>
                    `;
                    tableBody.appendChild(row);
                }
            }
            
            function displayEMIChartStandalone() {
                const schedule = generateEMISchedule();
                if (schedule.length === 0) {
                    showSuccess('Please enter valid loan amount, rate and tenure in the main tab first.');
                    return;
                }
                
                emiChartModal.classList.remove('hidden');
                
                const months = schedule.map(entry => entry.month);
                const principal = schedule.map(entry => entry.principal);
                const interest = schedule.map(entry => entry.interest);
                
                if (emiChartStandalone) {
                    emiChartStandalone.destroy();
                }
                
                const ctx = document.getElementById('emiChartStandalone').getContext('2d');
                emiChartStandalone = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: 'Principal',
                                data: principal,
                                backgroundColor: '#00bfff',
                                borderColor: '#008b8b',
                                borderWidth: 1
                            },
                            {
                                label: 'Interest',
                                data: interest,
                                backgroundColor: '#f783ac',
                                borderColor: '#a61e4d',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true,
                                title: {
                                    display: true,
                                    text: 'Month'
                                }
                            },
                            y: {
                                stacked: true,
                                title: {
                                    display: true,
                                    text: 'Amount (AED)'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'EMI Breakdown - Principal vs. Interest',
                                font: {
                                    size: 16
                                }
                            }
                        }
                    }
                });
                
                const tableBody = document.getElementById('emiScheduleBodyStandalone');
                tableBody.innerHTML = '';
                
                for (let i = 0; i < schedule.length; i++) {
                    const entry = schedule[i];
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="border border-gray-300 p-2 text-center">${entry.month}</td>
                        <td class="border border-gray-300 p-2 text-right">${formatNumber(entry.emi.toFixed(2))}</td>
                        <td class="border border-gray-300 p-2 text-right">${formatNumber(entry.principal.toFixed(2))}</td>
                        <td class="border border-gray-300 p-2 text-right">${formatNumber(entry.interest.toFixed(2))}</td>
                        <td class="border border-gray-300 p-2 text-right">${formatNumber(entry.balance.toFixed(2))}</td>
                    `;
                    tableBody.appendChild(row);
                }
            }
            
            function findOptimalLoanAmount() {
                const grossSalary = parseFloat(grossSalaryInput.value.replace(/,/g, '')) || 0;
                const currentDBR = parseFloat(dbrPercentageInput.value) || 0;
                
                if (grossSalary <= 0) {
                    showSuccess('Please Enter A Valid Salary Amount First.');
                    return;
                }
                
                if (currentDBR <= dbrThreshold) {
                    showSuccess(`Your DBR is already within the ${dbrThreshold}% limit. No optimization needed.`);
                    return;
                }
                
                const reducingRate = parseFloat(reducingRateInput.value) || 0;
                const tenureMonths = parseInt(tenureMonthsInput.value) || 0;
                const loanType = loanTypeSelect.value;
                
                if (reducingRate <= 0 || tenureMonths <= 0) {
                    showSuccess('Please enter valid reducing rate and tenure first.');
                    return;
                }
                
                const allowedLiability = grossSalary * (dbrThreshold / 100);
                
                let totalExistingLoansInstallments = 0;
                document.querySelectorAll('.existing-loan-entry').forEach((entry, index) => {
                    if (!settledLoans.has(index)) {
                        const installmentInput = entry.querySelector('.loan-installment');
                        totalExistingLoansInstallments += parseFloat(installmentInput.value) || 0;
                    }
                });
                
                let totalCCLimit = 0;
                document.querySelectorAll('.credit-card-entry').forEach((entry, index) => {
                    if (!settledCards.has(index)) {
                        const limitInput = entry.querySelector('.credit-card-amount');
                        const newLimitInput = entry.querySelector('.credit-card-new-limit');
                        
                        const originalLimit = parseFloat(limitInput.value) || 0;
                        const newLimitValue = newLimitInput.value;
                        const newLimit = newLimitValue !== '' ? parseFloat(newLimitValue) : null;
                        
                        const effectiveLimit = newLimit !== null ? newLimit : originalLimit;
                        totalCCLimit += effectiveLimit;
                    }
                });
                
                const dbrRate = 0.05;
                const dbrCC = totalCCLimit * dbrRate;
                
                const currentLiabilities = totalExistingLoansInstallments + dbrCC;
                
                const availableForEMI = allowedLiability - currentLiabilities;
                
                if (availableForEMI <= 0) {
                    showSuccess(`Your Current Liabilities Already Exceed The ${dbrThreshold}% DBR Limit. Cannot Calculate Optimal Loan Amount.`);
                    return;
                }
                
                let low = 0;
                let high = grossSalary * 100;
                let optimalLoanAmount = 0;
                
                while (high - low > 1) {
                    const mid = (low + high) / 2;
                    const emi = calculateEMIWithGracePeriod(mid, reducingRate, tenureMonths, loanType);
                    
                    if (emi <= availableForEMI) {
                        low = mid;
                        optimalLoanAmount = mid;
                    } else {
                        high = mid;
                    }
                }
                
                loanAmountInput.value = Math.floor(optimalLoanAmount);
                
                showSuccess(`Optimal loan amount: AED ${formatNumber(Math.floor(optimalLoanAmount))} suggested to keep DBR within ${dbrThreshold}%.`);
                
                updateEMICalculator();
            }
            
            function updateBankComparisonModal() {
                const bank1LoanAmount = parseFloat(bank1LoanAmountModal.value) || 0;
                const bank1Tenure = parseInt(bank1TenureModal.value) || 0;
                const bank1Rate = parseFloat(bank1RateModal.value) || 0;
                
                if (bank1LoanAmount > 0 && bank1Tenure > 0 && bank1Rate > 0) {
                    const bank1EMI = calculateStandardEMI(bank1LoanAmount, bank1Rate, bank1Tenure);
                    bank1EMIModal.value = formatNumber(bank1EMI.toFixed(2));
                    
                    const bank1TotalInterest = (bank1EMI * bank1Tenure) - bank1LoanAmount;
                    bank1TotalInterestModal.value = formatNumber(bank1TotalInterest.toFixed(2));
                }
                
                const bank2LoanAmount = parseFloat(bank2LoanAmountModal.value) || 0;
                const bank2Tenure = parseInt(bank2TenureModal.value) || 0;
                const bank2Rate = parseFloat(bank2RateModal.value) || 0;
                
                if (bank2LoanAmount > 0 && bank2Tenure > 0 && bank2Rate > 0) {
                    const bank2EMI = calculateStandardEMI(bank2LoanAmount, bank2Rate, bank2Tenure);
                    bank2EMIModal.value = formatNumber(bank2EMI.toFixed(2));
                    
                    const bank2TotalInterest = (bank2EMI * bank2Tenure) - bank2LoanAmount;
                    bank2TotalInterestModal.value = formatNumber(bank2TotalInterest.toFixed(2));
                }
                
                if (bank1LoanAmount > 0 && bank2LoanAmount > 0) {
                    const bank1Name = bank1NameModal.value || 'Bank 1';
                    const bank2Name = bank2NameModal.value || 'Bank 2';
                    const bank1TotalInterest = parseFloat(bank1TotalInterestModal.value.replace(/,/g, '')) || 0;
                    const bank2TotalInterest = parseFloat(bank2TotalInterestModal.value.replace(/,/g, '')) || 0;
                    
                    if (bank1TotalInterest < bank2TotalInterest) {
                        comparisonResult.innerHTML = `<span class="font-bold">${bank1Name}</span> Offers The Better Deal With <span class="font-bold">AED ${formatNumber(bank1TotalInterest.toFixed(2))}</span> In Total Interest Compared To <span class="font-bold">AED ${formatNumber(bank2TotalInterest.toFixed(2))}</span> From ${bank2Name}. <span class="font-bold">You Save AED ${formatNumber((bank2TotalInterest - bank1TotalInterest).toFixed(2))}</span> With ${bank1Name}.`;
                    } else if (bank2TotalInterest < bank1TotalInterest) {
                        comparisonResult.innerHTML = `<span class="font-bold">${bank2Name}</span> Offers The Better Deal With <span class="font-bold">AED ${formatNumber(bank2TotalInterest.toFixed(2))}</span> In Total Interest Compared To <span class="font-bold">AED ${formatNumber(bank1TotalInterest.toFixed(2))}</span> From ${bank1Name}. <span class="font-bold">You Save AED ${formatNumber((bank1TotalInterest - bank2TotalInterest).toFixed(2))}</span> With ${bank2Name}.`;
                    } else {
                        comparisonResult.innerHTML = `Both Banks Offer The Same Total Interest Of <span class="font-bold">AED ${formatNumber(bank1TotalInterest.toFixed(2))}</span>.`;
                    }
                }
            }
            
            shareLoanBtn.addEventListener('click', function() {
                let loanTypeDisplay = loanTypeSelect.value || '';
                if (loanTypeDisplay) {
                    loanTypeDisplay = loanTypeDisplay.replace(/(fresh|topup|takeover)(-)(\d+)(-)(\d+)/i, (match, p1, p2, p3, p4, p5) => {
                        return p1.charAt(0).toUpperCase() + p1.slice(1) + " (" + p3 + "-" + p5 + " days)";
                    });
                }
                
                document.getElementById('shareLoanType').textContent = loanTypeDisplay;
                document.getElementById('shareMaxLoanEligibility').textContent = maxLoanEligibilityInput.value;
                document.getElementById('shareTenure').textContent = `${tenureMonthsInput.value} Months`;
                document.getElementById('shareLoanAmount').textContent = loanAmountInput.value;
                document.getElementById('shareReducingRate').textContent = `${reducingRateInput.value}%`;
                document.getElementById('shareFlatRate').textContent = `${flatRateInput.value}%`;
                document.getElementById('shareEmi').textContent = emiInput.value;
                document.getElementById('shareProcessingFees').textContent = processingFeesInput.value;
                document.getElementById('shareTotalOutstanding').textContent = totalOutstandingInput.value;
                document.getElementById('shareCashInHand').textContent = cashInHandInput.value;
                
                const paymentDate = paymentDateInput.value;
                document.getElementById('sharePaymentDate').textContent = paymentDate;
                
                const loanType = loanTypeSelect.value;
                const shareTotalPaymentLabel = document.getElementById('shareTotalPaymentLabel');
                const shareTotalPayment = document.getElementById('shareTotalPayment');
                const shareTotalInterest = document.getElementById('shareTotalInterest');
                const closureFee = parseFloat(closureFeeInput.value) || 0;
                
                if ((loanType === 'topup-0-30' || loanType === 'topup-30-60') && closureFee > 0) {
                    shareTotalPaymentLabel.textContent = 'Closure Fee (AED):';
                    shareTotalPayment.textContent = formatNumber(closureFee.toFixed(2));
                } else {
                    shareTotalPaymentLabel.textContent = 'Total Payment (AED):';
                    shareTotalPayment.textContent = totalPaymentInput.value;
                }
                
                shareTotalInterest.textContent = totalInterestInput.value;
                
                const schedule = generateEMISchedule();
                const scheduleBody = document.getElementById('shareEmiSchedule');
                scheduleBody.innerHTML = '';
                
                if (schedule.length === 0) {
                    scheduleBody.innerHTML = '<tr><td colspan="5" class="text-center p-2">No schedule data available</td></tr>';
                } else {
                    for (let i = 0; i < schedule.length; i++) {
                        const entry = schedule[i];
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${entry.month}</td>
                            <td>${formatNumber(entry.emi.toFixed(2))}</td>
                            <td>${formatNumber(entry.principal.toFixed(2))}</td>
                            <td>${formatNumber(entry.interest.toFixed(2))}</td>
                            <td>${formatNumber(entry.balance.toFixed(2))}</td>
                        `;
                        scheduleBody.appendChild(row);
                    }
                }
                
                shareModal.classList.remove('hidden');
            });
            
            generateEmiChartBtn.addEventListener('click', function() {
                displayEMIChartStandalone();
            });
            
            loanComparisonBtn.addEventListener('click', function() {
                bank1NameModal.value = "ADCB";
                bank1LoanAmountModal.value = loanAmountInput.value;
                bank1TenureModal.value = tenureMonthsInput.value;
                bank1RateModal.value = reducingRateInput.value;
                
                updateBankComparisonModal();
                loanComparisonModal.classList.remove('hidden');
            });
            
            exportPdfBtn.addEventListener('click', function() {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const successIndicator = document.getElementById('successIndicator');
                const messageEl = document.getElementById('successMessage');
                messageEl.textContent = 'Generating PDF...';
                successIndicator.classList.remove('hidden');
                
                const loanInfoContainer = document.querySelector('.loan-info-container');
                
                html2canvas(loanInfoContainer, { scale: 1.1 }).then(canvas => {
                    const imgData = canvas.toDataURL('image/jpeg', 0.95);
                    const imgWidth = 185;
                    const imgHeight = Math.min((canvas.height * imgWidth) / canvas.width, 280);
                    
                    pdf.addImage(imgData, 'JPEG', 10, 10, imgWidth, imgHeight);
                    
                    const customerName = customerNameInput.value.trim();
                    const filename = customerName ? 
                        `Loan_Information_${customerName.replace(/\s+/g, '_')}.pdf` : 
                        'Loan_Information.pdf';
                    
                    pdf.save(filename);
                    
                    setTimeout(() => {
                        successIndicator.classList.add('hidden');
                    }, 1500);
                });
            });

            printPageBtn.addEventListener('click', function() {
                const printWindow = window.open('', '_blank');
                
                const loanInfoContainer = document.querySelector('.loan-info-container').cloneNode(true);
                
                const styleElement = document.createElement('style');
                styleElement.textContent = `
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    h2 { text-align: center; margin-bottom: 20px; }
                    .grid-cols-2 { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; }
                    .border { border: 1px solid #ddd; border-radius: 5px; overflow: hidden; flex: 1; min-width: 300px; }
                    table { width: 100%; border-collapse: collapse; }
                    td { padding: 8px; border-bottom: 1px solid #ddd; }
                    td:first-child { background-color: #f5f5f5; font-weight: bold; width: 50%; }
                    h3 { margin-top: 20px; margin-bottom: 10px; }
                    .emi-table { width: 100%; border-collapse: collapse; }
                    .emi-table th { background-color: #5492A8; color: white; text-align: center; padding: 6px; border: 1px solid #ddd; }
                    .emi-table td { text-align: right; padding: 4px 6px; border: 1px solid #ddd; }
                    .emi-table td:first-child { text-align: center; }
                    @media print { body { margin: 0; } }
                `;
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Loan Information</title>
                        ${styleElement.outerHTML}
                    </head>
                    <body>
                        <h2>Loan Information</h2>
                        ${loanInfoContainer.outerHTML}
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                printWindow.onload = function() {
                    printWindow.print();
                    printWindow.onafterprint = function() {
                        printWindow.close();
                    };
                };
            });
            
            function prepareWhatsAppMessage() {
                const maxLoanEligibility = parseFloat(maxLoanEligibilityInput.value.replace(/,/g, '')) || 0;
                const tenureMonths = parseInt(tenureMonthsInput.value) || 0;
                const loanAmount = parseFloat(loanAmountInput.value) || 0;
                const reducingRate = parseFloat(reducingRateInput.value) || 0;
                const flatRate = parseFloat(flatRateInput.value) || 0;
                const emi = parseFloat(emiInput.value.replace(/,/g, '')) || 0;
                const totalPayment = parseFloat(totalPaymentInput.value.replace(/,/g, '')) || 0;
                const totalInterest = parseFloat(totalInterestInput.value.replace(/,/g, '')) || 0;
                const processingFees = parseFloat(processingFeesInput.value.replace(/,/g, '')) || 0;
                const cashInHand = parseFloat(cashInHandInput.value.replace(/,/g, '')) || 0;
                const totalOutstanding = parseFloat(totalOutstandingInput.value.replace(/,/g, '')) || 0;
                const paymentDate = paymentDateInput.value;
                const customerName = customerNameInput.value.trim();
                const specialNoteText = specialNote.value;
                const closureFee = parseFloat(closureFeeInput.value) || 0;
                
                let message = "";
                
                if (customerName) {
                    message += `*Customer: ${customerName}*\n\n`;
                }
                
                message += "*Loan Details*\n";
                message += `Loan Amount: AED ${formatNumber(loanAmount.toFixed(2))}\n`;
                message += `Monthly Installement: AED ${formatNumber(emi.toFixed(2))}\n`;
                message += `Tenure: ${tenureMonths} Months\n`;
                message += `Reducing Rate: ${reducingRate}%\n`;
                message += `Flat Rate: ${flatRate.toFixed(2)}%\n`;
                message += `Max Loan Eligibity: AED ${formatNumber(maxLoanEligibility.toFixed(2))}\n`;
                message += `Grace Period: ${paymentDate}\n`;
                message += `Total Payment: AED ${formatNumber(totalPayment.toFixed(2))}\n`;
                message += `Processing Fees(+VAT): AED ${formatNumber(processingFees.toFixed(2))}\n`;
                message += `Insurance Fees: AED 0\n`;
                
                if (closureFee > 0) {
                    message += `Closure Fee: AED ${formatNumber(closureFee.toFixed(2))}\n`;
                }
                
                message += `Current Outstanding: AED ${formatNumber(totalOutstanding.toFixed(2))}\n`;
                message += `Cash In Hand: AED ${formatNumber(cashInHand.toFixed(2))}\n\n`;
                
                let autoSpecialNote = '';
                
                document.querySelectorAll('.existing-loan-entry').forEach((entry, index) => {
                    if (settledLoans.has(index)) {
                        const bank = entry.querySelector('.loan-bank').value;
                        const type = entry.querySelector('.loan-type').value;
                        const outstanding = entry.querySelector('.loan-outstanding').value;
                        autoSpecialNote += ` ${bank} ${type} outstanding AED ${formatNumber(parseFloat(outstanding).toFixed(2))} settled from loan proceeds\n`;
                    }
                });
                
                const adcbCards = [];
                let adcbCrossSellingCount = 0;
                
                document.querySelectorAll('.credit-card-entry').forEach((entry, index) => {
                    const bank = entry.querySelector('.card-bank-select').value;
                    
                    if (bank === 'ADCB') {
                        adcbCards.push({ entry, index });
                    }
                });
                
                adcbCards.forEach((card, position) => {
                    const { entry, index } = card;
                    const bank = entry.querySelector('.card-bank-select').value;
                    const creditLimit = entry.querySelector('.credit-card-amount').value;
                    const newLimit = entry.querySelector('.credit-card-new-limit').value;
                    const outstanding = entry.querySelector('.credit-card-outstanding').value;
                    const settleAmount = entry.querySelector('.credit-card-settle-amount').value;
                    
                    if (settledCards.has(index)) {
                        const originalOutstanding = settledCards.get(index) || outstanding;
                        autoSpecialNote += ` ${bank} Credit Card settle amount of AED ${formatNumber(parseFloat(originalOutstanding).toFixed(2))} from loan proceeds.\n`;
                    } else {
                        if (position > 0 && adcbCrossSellingCount < 3) {
                            const effectiveLimit = newLimit ? parseFloat(newLimit) : parseFloat(creditLimit);
                            if (effectiveLimit > 0) {
                                autoSpecialNote += ` ${bank} Cross sell credit card with the limit of AED ${formatNumber(effectiveLimit.toFixed(2))}\n`;
                                adcbCrossSellingCount++;
                            }
                        }
                        
                        if (newLimit && parseFloat(newLimit) !== parseFloat(creditLimit)) {
                            let noteText = ` ${bank} Credit Card limit reduce from AED ${formatNumber(parseFloat(creditLimit).toFixed(2))} to AED ${formatNumber(parseFloat(newLimit).toFixed(2))}`;
                            if (settleAmount && parseFloat(settleAmount) > 0) {
                                noteText += ` and settle AED ${formatNumber(parseFloat(settleAmount).toFixed(2))} from loan proceeds`;
                            }
                            autoSpecialNote += noteText + '\n';
                        }
                    }
                });
                
                document.querySelectorAll('.credit-card-entry').forEach((entry, index) => {
                    const bank = entry.querySelector('.card-bank-select').value;
                    const creditLimit = entry.querySelector('.credit-card-amount').value;
                    const newLimit = entry.querySelector('.credit-card-new-limit').value;
                    const outstanding = entry.querySelector('.credit-card-outstanding').value;
                    const settleAmount = entry.querySelector('.credit-card-settle-amount').value;
                    
                    if (bank !== 'ADCB') {
                        if (settledCards.has(index)) {
                            const originalOutstanding = settledCards.get(index) || outstanding;
                            autoSpecialNote += ` ${bank} Credit Card settle amount of AED ${formatNumber(parseFloat(originalOutstanding).toFixed(2))} from loan proceeds.\n`;
                        } else if (newLimit && parseFloat(newLimit) !== parseFloat(creditLimit)) {
                            let noteText = ` ${bank} Credit Card limit reduce from AED ${formatNumber(parseFloat(creditLimit).toFixed(2))} to AED ${formatNumber(parseFloat(newLimit).toFixed(2))}`;
                            if (settleAmount && parseFloat(settleAmount) > 0) {
                                noteText += ` and settle AED ${formatNumber(parseFloat(settleAmount).toFixed(2))} from loan proceeds`;
                            }
                            autoSpecialNote += noteText + '\n';
                        }
                    }
                });
                
                let finalSpecialNote = '';
                if (specialNoteText.trim()) {
                    const lines = specialNoteText.split('\n');
                    lines.forEach(line => {
                        if (line.trim()) {
                            finalSpecialNote += ` ${line.trim()}\n`;
                        }
                    });
                }
                if (autoSpecialNote) {
                    finalSpecialNote += autoSpecialNote;
                }
                
                if (finalSpecialNote) {
                    message += `Special Note:\n${finalSpecialNote}\n`;
                }
                
                message += "-------------------------\n";
                message += "_The specifics of the installment plan and associated offerings may vary slightly based on the information provided in your profile._";
                
                return encodeURIComponent(message);
            }
            
            let cardCount = 1;
            addCreditCardBtn.addEventListener('click', function() {
                if (cardCount >= 10) {
                    showSuccess('Maximum 10 credit cards allowed');
                    return;
                }
                
                cardCount++;
                const creditCardDiv = document.createElement('div');
                creditCardDiv.classList.add('credit-card-entry', 'mb-2');
                creditCardDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <div class="flex items-center gap-1 w-full">
                            <label class="text-gray-700 dark:text-gray-300 font-medium flex-1">Credit Card ${cardCount}:</label>
                            <input type="text" placeholder="Settle Amount" class="credit-card-settle-amount border rounded-md p-1 text-xs dark:bg-gray-800 dark:text-white dark:border-gray-600 hidden w-20" pattern="[0-9]*\.?[0-9]*">
                            <button class="settle-card-btn custom-btn text-white px-2 py-1 rounded text-xs w-14 text-center">Settle</button>
                        </div>
                    </div>
                    <div class="flex gap-2 items-center">
                        <select class="card-bank-select border rounded-md p-2 text-sm dark:bg-gray-800 dark:text-white dark:border-gray-600" style="width: 25%;">
                            <option value="ADCB">ADCB</option>
                            <option value="ENBD">ENBD</option>
                            <option value="EIB">EIB</option>
                            <option value="FAB">FAB</option>
                            <option value="ADIB">ADIB</option>
                            <option value="CBD">CBD</option>
                            <option value="HSBC">HSBC</option>
                            <option value="CITI">CITI</option>
                            <option value="SCB">SCB</option>
                            <option value="MASHREQ">MASHREQ</option>
                            <option value="DIB">DIB</option>
                            <option value="RAK">RAK</option>
                            <option value="OTHER">OTHER</option>
                        </select>
                        <input type="text" placeholder="Credit Limit" class="credit-card-amount border rounded-md p-2 text-sm dark:bg-gray-800 dark:text-white dark:border-gray-600" style="width: 25%;" pattern="[0-9]*">
                        <input type="text" placeholder="New Limit" class="credit-card-new-limit border rounded-md p-2 text-sm dark:bg-gray-800 dark:text-white dark:border-gray-600" style="width: 25%;" pattern="[0-9]*">
                        <input type="text" placeholder="Outstanding" class="credit-card-outstanding border rounded-md p-2 text-sm dark:bg-gray-800 dark:text-white dark:border-gray-600" style="width: 25%;" pattern="[0-9]*">
                    </div>
                `;
                creditCardsContainer.appendChild(creditCardDiv);
                
                removeCreditCardBtn.disabled = false;
                
                const newBankSelect = creditCardDiv.querySelector('.card-bank-select');
                const newCreditCardInput = creditCardDiv.querySelector('.credit-card-amount');
                const newCreditCardNewLimitInput = creditCardDiv.querySelector('.credit-card-new-limit');
                const newOutstandingInput = creditCardDiv.querySelector('.credit-card-outstanding');
                const newSettleAmountInput = creditCardDiv.querySelector('.credit-card-settle-amount');
                
                newBankSelect.addEventListener('change', function() {
                    handleBankSelection(creditCardDiv);
                });
                
                newCreditCardInput.addEventListener('input', function() {
                    this.value = this.value.replace(/[^0-9]/g, '');
                    validateOutstandingVsLimit(creditCardDiv);
                    updateDBRCalculator();
                });
                
                newCreditCardNewLimitInput.addEventListener('input', function() {
                    this.value = this.value.replace(/[^0-9]/g, '');
                    validateADCBNewLimit(creditCardDiv);
                    validateOutstandingVsLimit(creditCardDiv);
                    updateDBRCalculator();
                });
                
                newOutstandingInput.addEventListener('input', function() {
                    this.value = this.value.replace(/[^0-9]/g, '');
                    const cardIndex = Array.from(document.querySelectorAll('.credit-card-entry')).indexOf(creditCardDiv);
                    const bankSelect = creditCardDiv.querySelector('.card-bank-select');
                    
                    if (bankSelect.value !== 'ADCB' || !originalOutstandingValues.has(cardIndex)) {
                        const currentValue = parseFloat(this.value) || 0;
                        originalOutstandingValues.set(cardIndex, currentValue);
                    }
                    
                    validateOutstandingVsLimit(creditCardDiv);
                    updateDBRCalculator();
                });
                
                newSettleAmountInput.addEventListener('input', function() {
                    this.value = this.value.replace(/[^0-9.]/g, '');
                    const parts = this.value.split('.');
                    if (parts.length > 2) {
                        this.value = parts[0] + '.' + parts[1];
                    }
                });
                
                newSettleAmountInput.addEventListener('blur', function() {
                    handleSettleAmountChange(creditCardDiv);
                });
                
                handleBankSelection(creditCardDiv);
            });
            
            removeCreditCardBtn.addEventListener('click', function() {
                if (cardCount > 1) {
                    const creditCardEntries = document.querySelectorAll('.credit-card-entry');
                    const lastEntry = creditCardEntries[creditCardEntries.length - 1];
                    const lastEntryIndex = Array.from(document.querySelectorAll('.credit-card-entry')).indexOf(lastEntry);
                    
                    if (settledCards.has(lastEntryIndex)) {
                        settledCards.delete(lastEntryIndex);
                    }
                    if (originalOutstandingValues.has(lastEntryIndex)) {
                        originalOutstandingValues.delete(lastEntryIndex);
                    }
                    
                    lastEntry.remove();
                    cardCount--;
                    
                    if (cardCount === 1) {
                        removeCreditCardBtn.disabled = true;
                    }
                    
                    updateDBRCalculator();
                }
            });
            
            addbacksContainer.addEventListener('change', function(e) {
                if (e.target.classList.contains('addback-type')) {
                    createAddbackTypeFields(e.target);
                }
            });
            
            addMoreAddbackBtn.addEventListener('click', function() {
                addbackCount++;
                
                const addbackDiv = document.createElement('div');
                addbackDiv.classList.add('grid', 'grid-cols-3', 'gap-2', 'items-center', 'addback-entry', 'mt-2');
                addbackDiv.innerHTML = `
                    <label class="text-gray-700 dark:text-gray-300 font-medium">Add-back ${addbackCount}:</label>
                    <div class="col-span-2">
                        <select class="addback-type border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white dark:border-gray-600 w-full">
                            <option value="">Select Add-back Type</option>
                            <option value="hra">HRA</option>
                            <option value="airfare">Airfare Allowance</option>
                            <option value="overtime">Over-time</option>
                            <option value="servicecharge">Service Charge</option>
                            <option value="incentives">Incentives</option>
                            <option value="telephone">Telephone Allowance</option>
                        </select>
                    </div>
                `;
                
                addbacksContainer.appendChild(addbackDiv);
                
                removeAddbackBtn.disabled = false;
            });
            
            removeAddbackBtn.addEventListener('click', function() {
                if (addbackCount > 1) {
                    const addbackEntries = addbacksContainer.querySelectorAll('.addback-entry');
                    const lastAddbackEntry = addbackEntries[addbackEntries.length - 1];
                    
                    const index = Array.from(addbacksContainer.querySelectorAll('.addback-entry')).indexOf(lastAddbackEntry);
                    
                    lastAddbackEntry.remove();
                    
                    const fieldsContainer = document.getElementById(`addback-fields-${index}`);
                    if (fieldsContainer) {
                        fieldsContainer.remove();
                    }
                    
                    delete addbackData[index];
                    
                    addbackCount--;
                    
                    if (addbackCount === 1) {
                        removeAddbackBtn.disabled = true;
                    }
                    
                    updateGrossSalary();
                }
            });
            
            resetBtn.addEventListener('click', function() {
                customerNameInput.value = '';
                whatsappNumberInput.value = '';
                salaryInput.value = '';
                grossSalaryInput.value = '';
                document.querySelector('.credit-card-amount').value = '';
                document.querySelector('.credit-card-new-limit').value = '';
                document.querySelector('.credit-card-outstanding').value = '';
                document.querySelector('.credit-card-settle-amount').classList.remove('hidden');
                loanTypeSelect.value = 'fresh-0-30';
                closureFeeInput.value = '';
                closureFeeContainer.classList.add('hidden');
                multiplesOfSalaryInput.value = '20';
                tenureMonthsInput.value = '48';
                loanAmountInput.value = '';
                loanMultiplesInput.value = '';
                reducingRateInput.value = '10';
                preferredEMIInput.value = '';
                specialNote.value = '';
                netAmountCheckbox.checked = true;
                
                dbrThreshold = 49.00;
                dbrToggle.checked = false;
                
                settledCards.clear();
                settledLoans.clear();
                originalOutstandingValues.clear();
                
                const creditCardEntries = document.querySelectorAll('.credit-card-entry');
                for (let i = 1; i < creditCardEntries.length; i++) {
                    creditCardEntries[i].remove();
                }
                cardCount = 1;
                removeCreditCardBtn.disabled = true;
                
                const firstCardEntry = document.querySelector('.credit-card-entry');
                firstCardEntry.classList.remove('card-settled');
                const firstSettleBtn = firstCardEntry.querySelector('.settle-card-btn');
                firstSettleBtn.textContent = 'Settle';
                firstSettleBtn.classList.add('custom-btn');
                firstSettleBtn.classList.remove('bg-gradient-to-r', 'from-red-500', 'to-red-600');
                
                const firstBankSelect = firstCardEntry.querySelector('.card-bank-select');
                firstBankSelect.value = 'ADCB';
                handleBankSelection(firstCardEntry);
                
                existingLoansContainer.innerHTML = '';
                existingLoansContainer.classList.add('hidden');
                existingLoanCount = 0;
                removeLoansBtn.disabled = true;
                
                const addbackEntries = document.querySelectorAll('.addback-entry');
                for (let i = 1; i < addbackEntries.length; i++) {
                    addbackEntries[i].remove();
                }
                addbackCount = 1;
                removeAddbackBtn.disabled = true;
                
                dynamicAddbackFields.innerHTML = '';
                addbackData = {};
                
                const firstAddbackSelect = document.querySelector('.addback-type');
                if (firstAddbackSelect) {
                    firstAddbackSelect.value = '';
                }
                
                const today = new Date();
                disbursalDateInput.value = today.toISOString().split('T')[0];
                const nextMonth = new Date(today);
                nextMonth.setMonth(nextMonth.getMonth() + 1);
                firstPaymentDateInput.value = nextMonth.toISOString().split('T')[0];
                updatePaymentDate();
                
                savedProfilesSelect.value = '';
                
                localStorage.removeItem('lastUsedProfile');
                
                emiChartSection.classList.add('hidden');
                loanComparisonModal.classList.add('hidden');
                shareModal.classList.add('hidden');
                emiChartModal.classList.add('hidden');
                
                dbrCalculatorSection.classList.remove('dbr-warning-flash');
                emiCalculatorSection.classList.remove('dbr-warning-flash');
                
                dbrPercentageInput.classList.remove('dbr-high');
                
                document.querySelectorAll('.outstanding-warning').forEach(element => {
                    element.classList.remove('outstanding-warning');
                });
                
                updateDBRCalculator();
                updateEMICalculator();
                updateTotalPaymentLabel();
            });
            
            findOptimalLoanBtn.addEventListener('click', findOptimalLoanAmount);
            
            disbursalDateInput.addEventListener('change', function() {
                adjustFirstPaymentDate();
                validatePaymentDate();
                updatePaymentDate();
                updateEMICalculator();
            });
            
            bank1NameModal.addEventListener('input', updateBankComparisonModal);
            bank1LoanAmountModal.addEventListener('input', updateBankComparisonModal);
            bank1TenureModal.addEventListener('input', updateBankComparisonModal);
            bank1RateModal.addEventListener('input', updateBankComparisonModal);
            bank2NameModal.addEventListener('input', updateBankComparisonModal);
            bank2LoanAmountModal.addEventListener('input', updateBankComparisonModal);
            bank2TenureModal.addEventListener('input', updateBankComparisonModal);
            bank2RateModal.addEventListener('input', updateBankComparisonModal);
            
            sendWhatsAppBtn.addEventListener('click', function() {
                const phoneNumber = whatsappNumberInput.value.replace(/\D/g, '');
                if (!phoneNumber) {
                    showSuccess('Please Enter A Valid WhatsApp Number');
                    return;
                }
                
                const message = prepareWhatsAppMessage();
                window.open(`https://wa.me/${phoneNumber}?text=${message}`, '_blank');
            });
            
            updateGrossSalary();
            updateDBRCalculator();
            updateEMICalculator();
            updatePaymentDate();
            updateTotalPaymentLabel();
        });
    </script>
</body>
</html>
