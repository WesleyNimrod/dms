<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calling System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tahoma:wght@400;700&display=swap');
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        
        body {
            font-family: 'Tahoma', Geneva, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .main-container {
            width: 100%;
            min-height: 100vh;
            padding: 8px 8px 8px 8px;
            margin: 0;
        }
        
        .custom-btn {
            background: linear-gradient(135deg, #6F2C4F 0%, #262a5a 100%);
            transition: all 0.3s;
        }
        
        .custom-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .gradient-primary {
            background: linear-gradient(135deg, #6F2C4F 0%, #262a5a 100%);
        }
        
        .success-indicator {
            background: rgb(22, 163, 74);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            position: fixed;
            top: 20px;
            right: 20px;
            animation: fadeOut 2s forwards;
            animation-delay: 1s;
            z-index: 100;
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #6F2C4F;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Table styling */
        .calling-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .calling-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .calling-table tr:hover {
            background-color: #ddd;
        }

        .calling-table td {
            padding: 8px;
            position: relative;
        }

        /* Row selection */
        .calling-table tr.selected {
            background-color: rgba(111, 44, 79, 0.2) !important;
        }

        /* Duplicate group styling */
        .calling-table tr.duplicate-group {
            border-left: 4px solid #f59e0b;
        }

        .calling-table tr.duplicate-group:first-of-type {
            border-top: 2px solid #f59e0b;
        }

        .calling-table tr.duplicate-group:last-of-type {
            border-bottom: 2px solid #f59e0b;
        }

        .selection-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* Editable cell styling */
        .editable {
            position: relative;
            cursor: text;
            transition: background-color 0.2s;
        }

        .editable:hover {
            background-color: rgba(111, 44, 79, 0.1);
        }

        .editable.active {
            background-color: rgba(111, 44, 79, 0.15);
            outline: 2px solid #6F2C4F;
        }

        /* Copyable cell styling */
        .copyable {
            cursor: pointer;
            position: relative;
            user-select: all;
        }

        .copyable::after {
            content: "Copied!";
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }

        .copyable.copied::after {
            opacity: 1;
            animation: fadeAfterCopy 1.5s forwards;
        }

        @keyframes fadeAfterCopy {
            0% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* Draggable styling */
        .draggable {
            cursor: grab;
        }

        .draggable.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .drop-zone {
            background-color: rgba(111, 44, 79, 0.1);
            border: 2px dashed #6F2C4F;
        }

        /* Filter inputs */
        .filter-container {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-item {
            flex: 1;
            min-width: 120px;
        }

        /* Scrollable table container */
        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
            width: 100%;
        }

        /* Call buttons */
        .call-btn {
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            color: white;
            margin-right: 8px;
            transition: transform 0.2s;
        }
        
        .call-btn:hover {
            transform: scale(1.1);
        }

        .direct-call {
            background-color: #16a34a;
        }
        
        .teams-call {
            background-color: #4f46e5;
        }
        
        .whatsapp-call {
            background-color: #25D366;
        }
        
        .comment-btn {
            background-color: #eab308;
        }

        /* Icon buttons */
        .icon-btn {
            padding: 8px 12px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            cursor: pointer;
            border: none;
            color: white;
            min-width: 40px;
            height: 40px;
        }

        .icon-btn:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }

        .icon-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-refresh { background-color: #6F2C4F; }
        .btn-sheet { background-color: #16a34a; }
        .btn-undo { background-color: #6b7280; }
        .btn-show-more { background-color: #6b7280; }
        .btn-add-new { background-color: #059669; }
        .btn-copy { background-color: #3b82f6; }
        .btn-delete { background-color: #ef4444; }
        .btn-duplicate { background-color: #f59e0b; }
        .btn-duplicate.active { background-color: #d97706; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); }
        .btn-filter { background-color: #8b5cf6; }
        .btn-filter.active { background-color: #7c3aed; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); }

        /* Result dropdown styling */
        .result-dropdown {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* Table header */
        .calling-table th {
            background-color: #6F2C4F;
            color: white;
            text-align: left;
            padding: 10px 8px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* Salary sorting buttons */
        .salary-sort {
            display: flex;
            flex-direction: column;
            margin-left: 5px;
        }

        .salary-sort button {
            background: #6F2C4F;
            color: white;
            border: none;
            padding: 2px 4px;
            cursor: pointer;
            font-size: 10px;
            margin: 1px 0;
        }

        .salary-sort button:hover {
            background: #5a2340;
        }

        .salary-sort button.active {
            background: #8b5cf6;
        }
        
        /* Error message */
        .error-message {
            color: #ef4444;
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ef4444;
            border-radius: 4px;
            background-color: rgba(239, 68, 68, 0.1);
        }
        
        /* Placeholder content for empty table */
        .table-placeholder {
            padding: 30px;
            text-align: center;
            color: #6b7280;
        }
        
        /* Semi-transparent section background */
        .section-header {
            background-color: rgba(111, 44, 79, 0.08);
            border-left: 4px solid #6F2C4F;
            padding: 10px 15px;
            border-radius: 0 4px 4px 0;
        }
        
        /* Undo indicator */
        .undo-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .undo-btn {
            background: white;
            color: black;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .undo-btn:hover {
            background: #eee;
        }
        
        /* Tooltip */
        .tooltip {
            position: relative;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 120px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .modal-close {
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .modal-close:hover {
            color: black;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .comment-textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-size: 16px;
        }

        /* Form styling */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .form-input:focus {
            outline: none;
            border-color: #6F2C4F;
            box-shadow: 0 0 0 2px rgba(111, 44, 79, 0.2);
        }

        .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            background-color: white;
        }

        .form-select:focus {
            outline: none;
            border-color: #6F2C4F;
            box-shadow: 0 0 0 2px rgba(111, 44, 79, 0.2);
        }

        /* Input with button */
        .input-with-button {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .input-with-button input {
            flex: 1;
        }

        .paste-btn {
            background-color: #6F2C4F;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .paste-btn:hover {
            background-color: #5a2340;
        }

        /* Comment toggle */
        .comment-mode-toggle {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        /* Call Counter */
        .call-counter {
            display: inline-flex;
            align-items: center;
            background-color: #6F2C4F;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            margin-left: 10px;
            font-size: 14px;
        }
        
        .call-counter i {
            margin-right: 5px;
        }
        
        /* Editable cells */
        .editable-cell {
            position: relative;
            cursor: pointer;
        }
        
        .editable-cell.editing {
            padding: 0;
        }
        
        .editable-cell input {
            width: 100%;
            padding: 8px;
            border: 1px solid #6F2C4F;
            border-radius: 4px;
        }

        /* Selection info */
        .selection-info {
            background-color: rgba(111, 44, 79, 0.1);
            border: 1px solid #6F2C4F;
            border-radius: 4px;
            padding: 8px 12px;
            margin-bottom: 10px;
            display: none;
        }

        .selection-info.show {
            display: block;
        }

        /* Confirm Dialog */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .confirm-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .confirm-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        /* Filter visibility toggle */
        .filters-hidden {
            display: none !important;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .main-container {
                padding: 4px 4px 4px 4px;
            }
            
            .filter-container {
                gap: 4px;
            }
            
            .filter-item {
                min-width: 100px;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-tahoma">
    <div class="main-container">
        
        <div class="bg-white p-3 rounded-lg shadow-md mb-3">
            <div class="flex flex-wrap justify-between items-center mb-4">
                <div class="section-header flex items-center">
                    <h2 class="text-xl font-bold text-[#6F2C4F]">Calling List</h2>
                    <div class="call-counter ml-3">
                        <i class="fas fa-phone-volume"></i>
                        <span id="callCounter">0</span> calls today
                    </div>
                    <p class="text-gray-600 text-sm ml-4" id="recordsInfo">Showing 0 records</p>
                </div>
                <div class="flex gap-2 flex-wrap">
                    <button id="refreshBtn" class="icon-btn btn-refresh tooltip" title="Refresh Data">
                        <i class="fas fa-sync-alt"></i>
                        <span class="tooltip-text">Refresh Data</span>
                    </button>
                    <button id="showMoreBtn" class="icon-btn btn-show-more tooltip hidden" title="Show More">
                        <i class="fas fa-expand-alt"></i>
                        <span class="tooltip-text">Show More</span>
                    </button>
                    <a href="https://docs.google.com/spreadsheets/d/1VfEPU_2EvNqB6g2ldAzD05fvwFigL1yN3L0wLOwZP4o/edit?gid=276425933#gid=276425933" target="_blank" class="icon-btn btn-sheet tooltip" title="Open Sheet">
                        <i class="fas fa-file-excel"></i>
                        <span class="tooltip-text">Open Sheet</span>
                    </a>
                    <button id="undoBtn" class="icon-btn btn-undo tooltip" title="Undo">
                        <i class="fas fa-undo"></i>
                        <span class="tooltip-text">Undo last change</span>
                    </button>
                    <button id="addNewBtn" class="icon-btn btn-add-new tooltip" title="Add New Record">
                        <i class="fas fa-plus"></i>
                        <span class="tooltip-text">Add New Record</span>
                    </button>
                    <button id="copyBtn" class="icon-btn btn-copy tooltip" title="Copy Selected" disabled>
                        <i class="fas fa-copy"></i>
                        <span class="tooltip-text">Copy Selected</span>
                    </button>
                    <button id="deleteBtn" class="icon-btn btn-delete tooltip" title="Delete Selected" disabled>
                        <i class="fas fa-trash"></i>
                        <span class="tooltip-text">Delete Selected</span>
                    </button>
                    <button id="duplicateBtn" class="icon-btn btn-duplicate tooltip" title="Show Duplicates">
                        <i class="fas fa-clone"></i>
                        <span class="tooltip-text">Show Duplicates</span>
                    </button>
                    <button id="filterBtn" class="icon-btn btn-filter tooltip" title="Filter Mode">
                        <i class="fas fa-search"></i>
                        <span class="tooltip-text">Contains Search</span>
                    </button>
                </div>
            </div>
            
            <div id="selectionInfo" class="selection-info">
                <span id="selectionCount">0</span> rows selected
            </div>

            <div class="mb-4" id="filtersContainer">
                <div class="flex justify-between items-center">
                    <h3 class="font-semibold text-lg mb-2 text-[#6F2C4F]">Filters</h3>
                    <button id="clearFiltersBtn" class="text-sm text-blue-600">Clear All</button>
                </div>
                <div class="filter-container">
                    <div class="filter-item">
                        <select id="resultFilter" class="w-full border rounded-md p-2 text-base">
                            <option value="">All Results</option>
                            <option value="To Call">To Call</option>
                            <option value="No Answer">No Answer</option>
                            <option value="Busy">Busy</option>
                            <option value="DNCR">DNCR</option>
                            <option value="Not Interested">Not Interested</option>
                            <option value="Interested">Interested</option>
                            <option value="ROI Inquired">ROI Inquired</option>
                            <option value="Call back">Call back</option>
                            <option value="On Hold">On Hold</option>
                            <option value="In Future, Shared details">In Future, Shared details</option>
                            <option value="Switched off">Switched off</option>
                            <option value="Referal">Referal</option>
                            <option value="Completed">Completed</option>
                            <option value="Rejected">Rejected</option>
                            <option value="Option 1">Option 1</option>
                            <option value="Option 2">Option 2</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <input type="text" id="mobileFilter" placeholder="Filter by mobile" class="w-full border rounded-md p-2 text-base">
                    </div>
                    <div class="filter-item">
                        <input type="text" id="nameFilter" placeholder="Filter by name" class="w-full border rounded-md p-2 text-base">
                    </div>
                    <div class="filter-item">
                        <input type="text" id="companyFilter" placeholder="Filter by company" class="w-full border rounded-md p-2 text-base">
                    </div>
                    <div class="filter-item">
                        <input type="text" id="schemeFilter" placeholder="Filter by scheme" class="w-full border rounded-md p-2 text-base">
                    </div>
                    <div class="filter-item">
                        <input type="text" id="bankFilter" placeholder="Filter by bank" class="w-full border rounded-md p-2 text-base">
                    </div>
                    <div class="filter-item">
                        <input type="number" id="salaryFilter" placeholder="Min salary" class="w-full border rounded-md p-2 text-base">
                    </div>
                </div>
            </div>
        </div>
        <div class="bg-white p-3 rounded-lg shadow-md">
            <div class="table-container">
                <table id="callingTable" class="calling-table" style="border-spacing: 0;">
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" id="selectAllCheckbox" class="selection-checkbox">
                            </th>
                            <th style="width: 110px;">Actions</th>
                            <th style="width: 150px;">Result</th>
                            <th style="width: 120px;">Mobile</th>
                            <th>Name</th>
                            <th>Company</th>
                            <th>Scheme</th>
                            <th>Bank</th>
                            <th style="width: 100px;">
                                <div style="display: flex; align-items: center;">
                                    Salary
                                    <div class="salary-sort">
                                        <button id="sortSalaryAsc" title="Sort Ascending">▲</button>
                                        <button id="sortSalaryDesc" title="Sort Descending">▼</button>
                                    </div>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="callingTableBody">
                        <tr>
                            <td colspan="9" class="table-placeholder">
                                <div class="py-8">
                                    <i class="fas fa-spinner fa-spin text-3xl mb-4 text-[#6F2C4F]"></i>
                                    <p>Loading data, please wait...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="errorContainer" class="hidden error-message">
                <i class="fas fa-exclamation-triangle mr-2"></i> <span id="errorMessage">Error loading data</span>
            </div>
        </div>
    </div>

    <div id="successIndicator" class="success-indicator hidden">
        <span id="successMessage">Operation successful!</span>
    </div>

    <div id="loadingIndicator" class="loading-indicator hidden">
        <div class="spinner"></div>
    </div>

    <div id="undoNotification" class="undo-indicator hidden">
        <span id="undoMessage">Change saved!</span>
        <button id="undoChangeBtn" class="undo-btn">Undo</button>
    </div>

    <!-- Add New Record Modal -->
    <div id="addNewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="text-lg font-semibold">Add New Record</h3>
                <span class="modal-close" id="addNewModalClose">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addNewForm">
                    <div class="form-group">
                        <label class="form-label" for="newDate">Date</label>
                        <input type="date" id="newDate" class="form-input" tabindex="1">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="newResult">Result *</label>
                        <select id="newResult" class="form-select" required tabindex="2">
                            <option value="">Select Result</option>
                            <option value="To Call">To Call</option>
                            <option value="No Answer">No Answer</option>
                            <option value="Busy">Busy</option>
                            <option value="DNCR">DNCR</option>
                            <option value="Not Interested">Not Interested</option>
                            <option value="Interested">Interested</option>
                            <option value="ROI Inquired">ROI Inquired</option>
                            <option value="Call back">Call back</option>
                            <option value="On Hold">On Hold</option>
                            <option value="In Future, Shared details">In Future, Shared details</option>
                            <option value="Switched off">Switched off</option>
                            <option value="Referal">Referal</option>
                            <option value="Completed">Completed</option>
                            <option value="Rejected">Rejected</option>
                            <option value="Option 1">Option 1</option>
                            <option value="Option 2">Option 2</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="newMobile">Mobile *</label>
                        <div class="input-with-button">
                            <input type="text" id="newMobile" class="form-input" required pattern="[0-9]*" title="Only numbers allowed" tabindex="3">
                            <button type="button" class="paste-btn" id="pasteMobileBtn" tabindex="-1">
                                <i class="fas fa-paste"></i> Paste
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="newCmName">CM Name</label>
                        <div class="input-with-button">
                            <input type="text" id="newCmName" class="form-input" tabindex="4">
                            <button type="button" class="paste-btn" id="pasteCmNameBtn" tabindex="-1">
                                <i class="fas fa-paste"></i> Paste
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="newCompanyName">Company Name *</label>
                        <div class="input-with-button">
                            <input type="text" id="newCompanyName" class="form-input" required style="text-transform: uppercase;" tabindex="5">
                            <button type="button" class="paste-btn" id="pasteCompanyNameBtn" tabindex="-1">
                                <i class="fas fa-paste"></i> Paste
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="newScheme">Scheme</label>
                        <input type="text" id="newScheme" class="form-input" style="text-transform: uppercase;" tabindex="6">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="newBanking">Banking</label>
                        <input type="text" id="newBanking" class="form-input" style="text-transform: uppercase;" tabindex="7">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="newSalary">Salary</label>
                        <input type="text" id="newSalary" class="form-input" pattern="[0-9]*" title="Only numbers allowed" tabindex="8">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="cancelAddNewBtn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400" tabindex="10">Cancel</button>
                <button type="button" id="saveAddNewBtn" class="custom-btn text-white py-2 px-4 rounded-md" tabindex="9">Save Record</button>
            </div>
        </div>
    </div>

    <!-- Comment Modal -->
    <div id="commentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="text-lg font-semibold">Add Comment</h3>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <p class="mb-2">Enter your comment for <span id="commentName" class="font-semibold"></span></p>
                <textarea id="commentText" class="comment-textarea" placeholder="Type your comment here..."></textarea>
                <input type="hidden" id="commentRowIndex">
                <input type="hidden" id="commentColumn">
                <div class="comment-mode-toggle">
                    <label class="flex items-center">
                        <input type="radio" name="commentType" value="sheet" checked>
                        <span class="ml-2">Add sheet comment (yellow triangle)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="commentType" value="value">
                        <span class="ml-2">Update result value</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelCommentBtn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400">Cancel</button>
                <button id="saveCommentBtn" class="custom-btn text-white py-2 px-4 rounded-md">Save Comment</button>
            </div>
        </div>
    </div>

    <div id="confirmDialog" class="confirm-dialog">
        <div class="confirm-content">
            <h3 class="text-lg font-semibold mb-4">Confirm Action</h3>
            <p id="confirmMessage">Are you sure?</p>
            <div class="confirm-buttons">
                <button id="confirmCancel" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400">Cancel</button>
                <button id="confirmOk" class="bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // *** IMPORTANT: Replace 'YOUR_WEB_APP_URL_HERE' with your actual Google Apps Script Web App URL ***
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwBKFBLV1ayE1-RIsdbr11-dZ0yGcFxnwkyoOJXnQrH-vbtSH1sjTCQzBlJTdyufOeOXA/exec'; 
        const BATCH_SIZE = 50; // Number of records to load initially / per "Show More" click
        let allData = [];
        let displayedData = [];
        let currentIndex = 0;
        let lastUndoAction = null;
        const columnNames = ["Select", "Actions", "Result", "Mobile", "Name", "Company", "Scheme", "Bank", "Salary"];
        let callCount = 0;
        let longPressTimer;
        let priorityResultOptions = ["To Call", "Interested", "Referal", "Option 1", "Option 2", "No Answer", "Busy"];
        let changedRows = {}; // Track which rows have been changed today
        let selectedRows = new Set();
        let isDuplicateMode = false;
        let isExactSearch = false; // Filter mode toggle
        let currentSalarySortOrder = 'none'; // none, asc, desc
        let draggedElement = null;
        let dragSourceRowIndex = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Load call count and changed rows from localStorage if available
            loadCallData();
            
            // Check if we need to reset the call counter (new day)
            checkAndResetDailyCounter();
            
            // Set current date as default
            document.getElementById('newDate').value = new Date().toISOString().split('T')[0];
            
            // Initial data load
            fetchCallingData();

            // Event Listeners
            document.getElementById('refreshBtn').addEventListener('click', fetchCallingData);
            document.getElementById('showMoreBtn').addEventListener('click', loadMoreData);
            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
            document.getElementById('undoBtn').addEventListener('click', undoLastChange);
            document.getElementById('saveCommentBtn').addEventListener('click', saveComment);
            document.getElementById('cancelCommentBtn').addEventListener('click', hideCommentModal);
            document.querySelector('.modal-close').addEventListener('click', hideCommentModal);
            document.getElementById('copyBtn').addEventListener('click', copySelectedRows);
            document.getElementById('deleteBtn').addEventListener('click', deleteSelectedRows);
            document.getElementById('duplicateBtn').addEventListener('click', toggleDuplicateMode);
            document.getElementById('selectAllCheckbox').addEventListener('change', toggleSelectAll);
            document.getElementById('filterBtn').addEventListener('click', toggleFilterMode);

            // Salary sorting listeners
            document.getElementById('sortSalaryAsc').addEventListener('click', () => sortBySalary('asc'));
            document.getElementById('sortSalaryDesc').addEventListener('click', () => sortBySalary('desc'));

            // Add New Record Modal listeners
            document.getElementById('addNewBtn').addEventListener('click', showAddNewModal);
            document.getElementById('addNewModalClose').addEventListener('click', hideAddNewModal);
            document.getElementById('cancelAddNewBtn').addEventListener('click', hideAddNewModal);
            document.getElementById('saveAddNewBtn').addEventListener('click', saveNewRecord);

            // Paste button listeners
            document.getElementById('pasteMobileBtn').addEventListener('click', () => pasteToField('newMobile'));
            document.getElementById('pasteCmNameBtn').addEventListener('click', () => pasteToField('newCmName'));
            document.getElementById('pasteCompanyNameBtn').addEventListener('click', () => pasteToField('newCompanyName'));

            // Confirm dialog listeners
            document.getElementById('confirmCancel').addEventListener('click', hideConfirmDialog);
            document.getElementById('confirmOk').addEventListener('click', executeConfirmedAction);

            // Filter listeners
            document.getElementById('resultFilter').addEventListener('change', applyFilters);
            document.getElementById('mobileFilter').addEventListener('input', applyFilters);
            document.getElementById('nameFilter').addEventListener('input', applyFilters);
            document.getElementById('companyFilter').addEventListener('input', applyFilters);
            document.getElementById('schemeFilter').addEventListener('input', applyFilters);
            document.getElementById('bankFilter').addEventListener('input', applyFilters);
            document.getElementById('salaryFilter').addEventListener('input', applyFilters);

            // Mobile number validation
            document.getElementById('newMobile').addEventListener('input', function(e) {
                let value = e.target.value;
                // Remove any non-digit characters
                value = value.replace(/\D/g, '');
                // Remove prefixes
                if (value.startsWith('971') || value.startsWith('0')) {
                    if (value.startsWith('971')) {
                        value = value.substring(3);
                    } else if (value.startsWith('0')) {
                        value = value.substring(1);
                    }
                }
                e.target.value = value;
            });

            // Salary validation
            document.getElementById('newSalary').addEventListener('input', function(e) {
                let value = e.target.value;
                // Remove any non-digit characters and spaces
                value = value.replace(/[^\d]/g, '');
                e.target.value = value;
            });

            // Title case transformation for CM Name
            document.getElementById('newCmName').addEventListener('input', function(e) {
                this.value = toTitleCase(this.value);
            });

            // Add keyboard navigation for modal form
            const formFields = ['newDate', 'newResult', 'newMobile', 'newCmName', 'newCompanyName', 'newScheme', 'newBanking', 'newSalary'];
            
            formFields.forEach((fieldId, index) => {
                const field = document.getElementById(fieldId);
                field.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === 'Tab') {
                        e.preventDefault();
                        const nextIndex = (index + 1) % formFields.length;
                        if (nextIndex === 0) {
                            // Focus on Save button after last field
                            document.getElementById('saveAddNewBtn').focus();
                        } else {
                            document.getElementById(formFields[nextIndex]).focus();
                        }
                    }
                });
            });

            // Title case function
            function toTitleCase(str) {
                return str.replace(/\w\S*/g, function(txt) {
                    return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
                });
            }

            // Sort by salary
            function sortBySalary(order) {
                // Update button states
                document.getElementById('sortSalaryAsc').classList.remove('active');
                document.getElementById('sortSalaryDesc').classList.remove('active');
                
                if (order === 'asc') {
                    document.getElementById('sortSalaryAsc').classList.add('active');
                    currentSalarySortOrder = 'asc';
                } else {
                    document.getElementById('sortSalaryDesc').classList.add('active');
                    currentSalarySortOrder = 'desc';
                }

                displayedData.sort((a, b) => {
                    const salaryA = parseFloat(a.Salary || 0);
                    const salaryB = parseFloat(b.Salary || 0);
                    
                    if (order === 'asc') {
                        return salaryA - salaryB;
                    } else {
                        return salaryB - salaryA;
                    }
                });

                currentIndex = 0;
                populateTable(true);
            }

            // Paste function
            async function pasteToField(fieldId) {
                try {
                    const text = await navigator.clipboard.readText();
                    const field = document.getElementById(fieldId);
                    if (fieldId === 'newMobile') {
                        // Clean mobile number
                        let cleanMobile = text.replace(/\D/g, '');
                        if (cleanMobile.startsWith('971')) {
                            cleanMobile = cleanMobile.substring(3);
                        } else if (cleanMobile.startsWith('0')) {
                            cleanMobile = cleanMobile.substring(1);
                        }
                        field.value = cleanMobile;
                    } else if (fieldId === 'newCmName') {
                        field.value = toTitleCase(text);
                    } else {
                        field.value = text;
                    }
                    field.focus();
                } catch (err) {
                    showError('Failed to paste from clipboard');
                }
            }

            // Toggle filter mode
            function toggleFilterMode() {
                isExactSearch = !isExactSearch;
                const btn = document.getElementById('filterBtn');
                
                if (isExactSearch) {
                    btn.classList.add('active');
                    btn.title = 'Exact Search Mode';
                    btn.querySelector('.tooltip-text').textContent = 'Exact Search';
                } else {
                    btn.classList.remove('active');
                    btn.title = 'Contains Search Mode';
                    btn.querySelector('.tooltip-text').textContent = 'Contains Search';
                }
                
                applyFilters();
            }

            // Format phone number with country code
            function formatPhoneWithCountryCode(phone) {
                if (!phone) return '';
                
                // Remove any non-digit characters
                const digits = phone.toString().replace(/\D/g, '');
                
                // If it already starts with 971, don't add it again
                if (digits.startsWith('971')) {
                    return digits;
                }
                
                // If it starts with 0, remove the 0 before adding 971
                if (digits.startsWith('0')) {
                    return '971' + digits.substring(1);
                }
                
                // Otherwise, just add 971 as prefix
                return '971' + digits;
            }

            // Get result priority order
            function getResultPriority(result) {
                const priority = priorityResultOptions.indexOf(result);
                return priority === -1 ? 999 : priority;
            }

            // Fetch data from Google Sheet
            async function fetchCallingData() {
                showLoadingIndicator();
                hideError();
                try {
                    const response = await fetch(`${WEB_APP_URL}?action=getCallingData`);
                    const result = await response.json();

                    if (result.success) {
                        allData = result.data;
                        selectedRows.clear();
                        updateSelectionUI();
                        applyFilters(); // Apply filters to the newly fetched data
                        showSuccessIndicator('Data refreshed!');
                    } else {
                        showError(result.error || 'Failed to fetch data.');
                    }
                } catch (error) {
                    console.error('Error fetching data:', error);
                    showError('Network error or invalid Apps Script URL. Check console for details.');
                } finally {
                    hideLoadingIndicator();
                }
            }

            // Show Add New Modal
            function showAddNewModal() {
                document.getElementById('addNewModal').style.display = 'flex';
                // Reset form and set current date
                document.getElementById('addNewForm').reset();
                document.getElementById('newDate').value = new Date().toISOString().split('T')[0];
                // Focus on first field
                document.getElementById('newDate').focus();
            }

            // Hide Add New Modal
            function hideAddNewModal() {
                document.getElementById('addNewModal').style.display = 'none';
            }

            // Save new record
            async function saveNewRecord() {
                const formData = {
                    action: 'addCallingRecord',
                    date: document.getElementById('newDate').value || new Date().toISOString().split('T')[0],
                    result: document.getElementById('newResult').value,
                    mobile: document.getElementById('newMobile').value,
                    cmName: document.getElementById('newCmName').value || '',
                    companyName: document.getElementById('newCompanyName').value,
                    scheme: document.getElementById('newScheme').value || '',
                    banking: document.getElementById('newBanking').value || '',
                    salary: document.getElementById('newSalary').value || ''
                };

                // Validation
                if (!formData.result || !formData.mobile || !formData.companyName) {
                    showError('Please fill in all required fields (Result, Mobile, Company Name)');
                    return;
                }

                showLoadingIndicator();
                try {
                    const response = await fetch(WEB_APP_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams(formData)
                    });
                    
                    const result = await response.json();

                    if (result.success) {
                        showSuccessIndicator('New record added successfully!');
                        hideAddNewModal();
                        fetchCallingData(); // Refresh data
                    } else {
                        showError(result.error || 'Failed to add new record');
                    }
                } catch (error) {
                    console.error('Error adding record:', error);
                    showError('Network error during record addition');
                } finally {
                    hideLoadingIndicator();
                }
            }

            // Apply filters and populate table
            function applyFilters() {
                const resultFilter = document.getElementById('resultFilter').value.toLowerCase();
                const mobileFilter = document.getElementById('mobileFilter').value.toLowerCase();
                const nameFilter = document.getElementById('nameFilter').value.toLowerCase();
                const companyFilter = document.getElementById('companyFilter').value.toLowerCase();
                const schemeFilter = document.getElementById('schemeFilter').value.toLowerCase();
                const bankFilter = document.getElementById('bankFilter').value.toLowerCase();
                const salaryFilter = parseFloat(document.getElementById('salaryFilter').value);

                // Filter data
                let filteredData = allData.filter(record => {
                    let matchesResult, matchesMobile, matchesName, matchesCompany, matchesScheme, matchesBank;
                    
                    if (isExactSearch) {
                        // Exact search mode
                        matchesResult = resultFilter === "" || (record.Result && record.Result.toLowerCase() === resultFilter);
                        matchesMobile = mobileFilter === "" || (record.Mobile && record.Mobile.toString().toLowerCase() === mobileFilter);
                        matchesName = nameFilter === "" || (record.Name && record.Name.toLowerCase() === nameFilter);
                        matchesCompany = companyFilter === "" || (record.Company && record.Company.toLowerCase() === companyFilter);
                        matchesScheme = schemeFilter === "" || (record.Scheme && record.Scheme.toLowerCase() === schemeFilter);
                        matchesBank = bankFilter === "" || (record.Bank && record.Bank.toLowerCase() === bankFilter);
                    } else {
                        // Contains search mode (default)
                        matchesResult = resultFilter === "" || (record.Result && record.Result.toLowerCase().includes(resultFilter));
                        matchesMobile = mobileFilter === "" || (record.Mobile && record.Mobile.toString().toLowerCase().includes(mobileFilter));
                        matchesName = nameFilter === "" || (record.Name && record.Name.toLowerCase().includes(nameFilter));
                        matchesCompany = companyFilter === "" || (record.Company && record.Company.toLowerCase().includes(companyFilter));
                        matchesScheme = schemeFilter === "" || (record.Scheme && record.Scheme.toLowerCase().includes(schemeFilter));
                        matchesBank = bankFilter === "" || (record.Bank && record.Bank.toLowerCase().includes(bankFilter));
                    }
                    
                    const matchesSalary = isNaN(salaryFilter) || parseFloat(record.Salary || 0) >= salaryFilter;
                    
                    return matchesResult && matchesMobile && matchesName && matchesCompany && matchesScheme && matchesBank && matchesSalary;
                });

                // If in duplicate mode, filter to show only duplicates
                if (isDuplicateMode) {
                    filteredData = filterDuplicates(filteredData);
                }

                // Apply default priority sorting if no filters applied
                if (!resultFilter && !mobileFilter && !nameFilter && !companyFilter && !schemeFilter && !bankFilter && isNaN(salaryFilter) && !isDuplicateMode) {
                    filteredData.sort((a, b) => getResultPriority(a.Result) - getResultPriority(b.Result));
                }

                displayedData = filteredData;
                currentIndex = 0; // Reset index for new filtered data
                populateTable(true); // Clear and repopulate
            }

            // Filter to show only duplicates based on Mobile
            function filterDuplicates(data) {
                const mobileMap = {};

                // Build map to track all records by mobile number
                data.forEach(record => {
                    const mobile = record.Mobile ? record.Mobile.toString().trim() : '';
                    if (mobile) {
                        if (!mobileMap[mobile]) {
                            mobileMap[mobile] = [];
                        }
                        mobileMap[mobile].push(record);
                    }
                });

                // Find all records that have duplicates and group them
                const duplicateGroups = [];
                Object.entries(mobileMap).forEach(([mobile, records]) => {
                    if (records.length > 1) {
                        // Sort records within each group by name for consistency
                        records.sort((a, b) => {
                            const nameA = (a.Name || '').toLowerCase();
                            const nameB = (b.Name || '').toLowerCase();
                            return nameA.localeCompare(nameB);
                        });
                        duplicateGroups.push({ mobile, records });
                    }
                });

                // Sort groups by mobile number
                duplicateGroups.sort((a, b) => a.mobile.localeCompare(b.mobile));

                // Flatten the grouped records while maintaining group order
                const duplicateArray = [];
                duplicateGroups.forEach(group => {
                    duplicateArray.push(...group.records);
                });

                return duplicateArray;
            }

            // Toggle duplicate mode
            function toggleDuplicateMode() {
                isDuplicateMode = !isDuplicateMode;
                const btn = document.getElementById('duplicateBtn');
                
                if (isDuplicateMode) {
                    btn.classList.add('active');
                    btn.title = 'Show All Records';
                    btn.querySelector('.tooltip-text').textContent = 'Show All Records';
                } else {
                    btn.classList.remove('active');
                    btn.title = 'Show Duplicates';
                    btn.querySelector('.tooltip-text').textContent = 'Show Duplicates';
                }
                
                applyFilters();
            }

            // Handle drag and drop
            function handleDragStart(e, element, rowIndex, columnName, value) {
                draggedElement = element;
                dragSourceRowIndex = rowIndex;
                element.classList.add('dragging');
                e.dataTransfer.setData('text/plain', value);
                e.dataTransfer.setData('application/json', JSON.stringify({
                    rowIndex: rowIndex,
                    columnName: columnName,
                    value: value
                }));
            }

            function handleDragEnd(e, element) {
                element.classList.remove('dragging');
                draggedElement = null;
                dragSourceRowIndex = null;
                // Remove all drop zones
                document.querySelectorAll('.drop-zone').forEach(el => el.classList.remove('drop-zone'));
            }

            function handleDragOver(e) {
                e.preventDefault();
            }

            function handleDragEnter(e, element) {
                if (draggedElement && element !== draggedElement) {
                    element.classList.add('drop-zone');
                }
            }

            function handleDragLeave(e, element) {
                element.classList.remove('drop-zone');
            }

            function handleDrop(e, element, targetRowIndex, targetColumnName) {
                e.preventDefault();
                element.classList.remove('drop-zone');
                
                if (draggedElement && targetRowIndex !== dragSourceRowIndex) {
                    const sourceData = JSON.parse(e.dataTransfer.getData('application/json'));
                    const targetValue = element.textContent;
                    
                    // Swap values
                    updateCell(sourceData.rowIndex, sourceData.columnName, targetValue, sourceData.value);
                    updateCell(targetRowIndex, targetColumnName, sourceData.value, targetValue);
                }
            }

            // Populate table with data
            function populateTable(clearExisting = false) {
                const tableBody = document.getElementById('callingTableBody');
                if (clearExisting) {
                    tableBody.innerHTML = '';
                }

                if (displayedData.length === 0 && clearExisting) {
                    tableBody.innerHTML = `<tr><td colspan="${columnNames.length}" class="table-placeholder">No records found.</td></tr>`;
                    document.getElementById('showMoreBtn').classList.add('hidden');
                    document.getElementById('recordsInfo').textContent = `Showing 0 records`;
                    return;
                }

                const fragment = document.createDocumentFragment();
                const endIndex = Math.min(currentIndex + BATCH_SIZE, displayedData.length);

                for (let i = currentIndex; i < endIndex; i++) {
                    const record = displayedData[i];
                    const row = document.createElement('tr');
                    row.dataset.rowIndex = record.rowIndex;
                    
                    // Add duplicate group styling if in duplicate mode
                    if (isDuplicateMode) {
                        row.classList.add('duplicate-group');
                    }
                    
                    // Selection checkbox column
                    const selectCell = document.createElement('td');
                    selectCell.style.width = '40px';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'selection-checkbox row-checkbox';
                    checkbox.dataset.rowIndex = record.rowIndex;
                    checkbox.addEventListener('change', handleRowSelection);
                    selectCell.appendChild(checkbox);
                    row.appendChild(selectCell);
                    
                    // Actions column
                    const actionsCell = document.createElement('td');
                    actionsCell.style.width = '110px';
                    
                    // Format the mobile number with country code
                    const formattedMobile = formatPhoneWithCountryCode(record.Mobile || '');
                    
                    // Direct call button
                    const directCallBtn = document.createElement('a');
                    directCallBtn.href = `tel:+${formattedMobile}`;
                    directCallBtn.classList.add('call-btn', 'direct-call', 'tooltip');
                    directCallBtn.title = `Call ${record.Name || 'Unknown'}`;
                    directCallBtn.innerHTML = '<i class="fas fa-phone"></i><span class="tooltip-text">Call</span>';
                    
                    // Teams call button
                    const teamsBtn = document.createElement('a');
                    teamsBtn.href = `https://teams.microsoft.com/l/call/0/0?users=4:${formattedMobile}`;
                    teamsBtn.target = "_blank";
                    teamsBtn.classList.add('call-btn', 'teams-call', 'tooltip');
                    teamsBtn.title = `Teams Call ${record.Name || 'Unknown'}`;
                    teamsBtn.innerHTML = '<i class="fas fa-users"></i><span class="tooltip-text">Teams</span>';
                    
                    // WhatsApp button
                    const whatsappBtn = document.createElement('a');
                    whatsappBtn.href = `https://wa.me/${formattedMobile}?text=Hello ${encodeURIComponent(record.Name || '')},`;
                    whatsappBtn.target = "_blank";
                    whatsappBtn.classList.add('call-btn', 'whatsapp-call', 'tooltip');
                    whatsappBtn.title = `WhatsApp ${record.Name || 'Unknown'}`;
                    whatsappBtn.innerHTML = '<i class="fab fa-whatsapp"></i><span class="tooltip-text">WhatsApp</span>';
                    
                    // Comment button
                    const commentBtn = document.createElement('button');
                    commentBtn.classList.add('call-btn', 'comment-btn', 'tooltip');
                    commentBtn.dataset.rowIndex = record.rowIndex;
                    commentBtn.dataset.columnName = 'Result';
                    commentBtn.innerHTML = '<i class="fas fa-comment"></i><span class="tooltip-text">Add Comment</span>';
                    
                    actionsCell.appendChild(directCallBtn);
                    actionsCell.appendChild(teamsBtn);
                    actionsCell.appendChild(whatsappBtn);
                    actionsCell.appendChild(commentBtn);
                    row.appendChild(actionsCell);

                    // Data columns
                    columnNames.slice(2).forEach(colName => {
                        const cell = document.createElement('td');
                        const value = record[colName] || '';
                        
                        if (colName === 'Result') {
                            // Result dropdown with updated values
                            const select = document.createElement('select');
                            select.className = 'result-dropdown';
                            
                            // Create empty option first
                            const emptyOption = document.createElement('option');
                            emptyOption.value = '';
                            emptyOption.textContent = 'Select Result';
                            select.appendChild(emptyOption);
                            
                            // All possible result options (updated)
                            const resultOptions = [
                                'To Call', 'No Answer', 'Busy', 'DNCR', 'Not Interested', 
                                'Interested', 'ROI Inquired', 'Call back', 'On Hold',
                                'In Future, Shared details', 'Switched off', 'Referal',
                                'Completed', 'Rejected', 'Option 1', 'Option 2'
                            ];
                            
                            // Add all result options
                            resultOptions.forEach(option => {
                                const optionEl = document.createElement('option');
                                optionEl.value = option;
                                optionEl.textContent = option;
                                if (value === option) {
                                    optionEl.selected = true;
                                }
                                select.appendChild(optionEl);
                            });
                            
                            // Add change event listener
                            select.addEventListener('change', function() {
                                const oldValue = value;
                                const newValue = this.value;
                                updateCell(record.rowIndex, colName, newValue, oldValue);
                                // Track this row as changed and maybe increment counter
                                trackRowChange(record.rowIndex);
                            });
                            cell.appendChild(select);
                        } else if (colName === 'Mobile') {
                            // Click to copy, long press to edit, drag to move
                            cell.textContent = value;
                            cell.classList.add('copyable', 'editable-cell', 'draggable');
                            cell.draggable = true;
                            
                            // Click to copy
                            cell.addEventListener('click', function(e) {
                                if (!longPressTimer) {
                                    copyToClipboard(this.textContent, this);
                                }
                            });
                            
                            // Long press to edit
                            cell.addEventListener('mousedown', function(e) {
                                const element = this;
                                longPressTimer = setTimeout(function() {
                                    makeEditable(element, record.rowIndex, colName, value);
                                    longPressTimer = null;
                                }, 1000);
                            });
                            
                            cell.addEventListener('mouseup', function() {
                                if (longPressTimer) {
                                    clearTimeout(longPressTimer);
                                    longPressTimer = null;
                                }
                            });
                            
                            cell.addEventListener('mouseleave', function() {
                                if (longPressTimer) {
                                    clearTimeout(longPressTimer);
                                    longPressTimer = null;
                                }
                            });
                            
                            // Touch events
                            cell.addEventListener('touchstart', function(e) {
                                const element = this;
                                longPressTimer = setTimeout(function() {
                                    makeEditable(element, record.rowIndex, colName, value);
                                    longPressTimer = null;
                                }, 1000);
                            });
                            
                            cell.addEventListener('touchend', function() {
                                if (longPressTimer) {
                                    clearTimeout(longPressTimer);
                                    longPressTimer = null;
                                }
                            });
                            
                            // Drag events
                            cell.addEventListener('dragstart', (e) => handleDragStart(e, cell, record.rowIndex, colName, value));
                            cell.addEventListener('dragend', (e) => handleDragEnd(e, cell));
                            cell.addEventListener('dragover', handleDragOver);
                            cell.addEventListener('dragenter', (e) => handleDragEnter(e, cell));
                            cell.addEventListener('dragleave', (e) => handleDragLeave(e, cell));
                            cell.addEventListener('drop', (e) => handleDrop(e, cell, record.rowIndex, colName));
                            
                        } else if (colName === 'Name') {
                            // Click to copy, long press to edit (title case), drag to move
                            cell.textContent = value;
                            cell.classList.add('copyable', 'editable-cell', 'draggable');
                            cell.draggable = true;
                            
                            // Click to copy
                            cell.addEventListener('click', function(e) {
                                if (!longPressTimer) {
                                    copyToClipboard(this.textContent, this);
                                }
                            });
                            
                            // Long press to edit
                            cell.addEventListener('mousedown', function(e) {
                                const element = this;
                                longPressTimer = setTimeout(function() {
                                    makeEditableTitleCase(element, record.rowIndex, colName, value);
                                    longPressTimer = null;
                                }, 1000);
                            });
                            
                            cell.addEventListener('mouseup', function() {
                                if (longPressTimer) {
                                    clearTimeout(longPressTimer);
                                    longPressTimer = null;
                                }
                            });
                            
                            cell.addEventListener('mouseleave', function() {
                                if (longPressTimer) {
                                    clearTimeout(longPressTimer);
                                    longPressTimer = null;
                                }
                            });
                            
                            // Touch events
                            cell.addEventListener('touchstart', function(e) {
                                const element = this;
                                longPressTimer = setTimeout(function() {
                                    makeEditableTitleCase(element, record.rowIndex, colName, value);
                                    longPressTimer = null;
                                }, 1000);
                            });
                            
                            cell.addEventListener('touchend', function() {
                                if (longPressTimer) {
                                    clearTimeout(longPressTimer);
                                    longPressTimer = null;
                                }
                            });
                            
                            // Drag events
                            cell.addEventListener('dragstart', (e) => handleDragStart(e, cell, record.rowIndex, colName, value));
                            cell.addEventListener('dragend', (e) => handleDragEnd(e, cell));
                            cell.addEventListener('dragover', handleDragOver);
                            cell.addEventListener('dragenter', (e) => handleDragEnter(e, cell));
                            cell.addEventListener('dragleave', (e) => handleDragLeave(e, cell));
                            cell.addEventListener('drop', (e) => handleDrop(e, cell, record.rowIndex, colName));
                            
                        } else if (colName === 'Company' || colName === 'Bank' || colName === 'Scheme') {
                            // Click to copy for Company, long press to edit (uppercase), drag to move
                            cell.textContent = value;
                            cell.classList.add('editable-cell', 'draggable');
                            if (colName === 'Company') {
                                cell.classList.add('copyable');
                            }
                            cell.draggable = true;
                            
                            // Click to copy for Company only
                            if (colName === 'Company') {
                                cell.addEventListener('click', function(e) {
                                    if (!longPressTimer) {
                                        copyToClipboard(this.textContent, this);
                                    }
                                });
                            }
                            
                            // Long press to edit
                            cell.addEventListener('mousedown', function(e) {
                                const element = this;
                                longPressTimer = setTimeout(function() {
                                    makeEditableUppercase(element, record.rowIndex, colName, value);
                                    longPressTimer = null;
                                }, 1000);
                            });
                            
                            cell.addEventListener('mouseup', function() {
                                if (longPressTimer) {
                                    clearTimeout(longPressTimer);
                                    longPressTimer = null;
                                }
                            });
                            
                            cell.addEventListener('mouseleave', function() {
                                if (longPressTimer) {
                                    clearTimeout(longPressTimer);
                                    longPressTimer = null;
                                }
                            });
                            
                            // Touch events
                            cell.addEventListener('touchstart', function(e) {
                                const element = this;
                                longPressTimer = setTimeout(function() {
                                    makeEditableUppercase(element, record.rowIndex, colName, value);
                                    longPressTimer = null;
                                }, 1000);
                            });
                            
                            cell.addEventListener('touchend', function() {
                                if (longPressTimer) {
                                    clearTimeout(longPressTimer);
                                    longPressTimer = null;
                                }
                            });
                            
                            // Drag events
                            cell.addEventListener('dragstart', (e) => handleDragStart(e, cell, record.rowIndex, colName, value));
                            cell.addEventListener('dragend', (e) => handleDragEnd(e, cell));
                            cell.addEventListener('dragover', handleDragOver);
                            cell.addEventListener('dragenter', (e) => handleDragEnter(e, cell));
                            cell.addEventListener('dragleave', (e) => handleDragLeave(e, cell));
                            cell.addEventListener('drop', (e) => handleDrop(e, cell, record.rowIndex, colName));
                            
                        } else if (colName === 'Salary') {
                            // Long press to edit, drag to move
                            cell.textContent = value;
                            cell.classList.add('editable-cell', 'draggable');
                            cell.draggable = true;
                            
                            // Long press to edit
                            cell.addEventListener('mousedown', function(e) {
                                const element = this;
                                longPressTimer = setTimeout(function() {
                                    makeEditable(element, record.rowIndex, colName, value);
                                    longPressTimer = null;
                                }, 1000);
                            });
                            
                            cell.addEventListener('mouseup', function() {
                                if (longPressTimer) {
                                    clearTimeout(longPressTimer);
                                    longPressTimer = null;
                                }
                            });
                            
                            cell.addEventListener('mouseleave', function() {
                                if (longPressTimer) {
                                    clearTimeout(longPressTimer);
                                    longPressTimer = null;
                                }
                            });
                            
                            // Touch events
                            cell.addEventListener('touchstart', function(e) {
                                const element = this;
                                longPressTimer = setTimeout(function() {
                                    makeEditable(element, record.rowIndex, colName, value);
                                    longPressTimer = null;
                                }, 1000);
                            });
                            
                            cell.addEventListener('touchend', function() {
                                if (longPressTimer) {
                                    clearTimeout(longPressTimer);
                                    longPressTimer = null;
                                }
                            });
                            
                            // Drag events
                            cell.addEventListener('dragstart', (e) => handleDragStart(e, cell, record.rowIndex, colName, value));
                            cell.addEventListener('dragend', (e) => handleDragEnd(e, cell));
                            cell.addEventListener('dragover', handleDragOver);
                            cell.addEventListener('dragenter', (e) => handleDragEnter(e, cell));
                            cell.addEventListener('dragleave', (e) => handleDragLeave(e, cell));
                            cell.addEventListener('drop', (e) => handleDrop(e, cell, record.rowIndex, colName));
                        }
                        row.appendChild(cell);
                    });
                    fragment.appendChild(row);
                }

                tableBody.appendChild(fragment);
                currentIndex = endIndex;

                // Attach event listeners for dynamically added buttons
                attachButtonListeners(tableBody);

                updateRecordsInfo();
                updateSelectAllCheckbox();
            }

            // Make a cell editable with uppercase transformation
            function makeEditableUppercase(cell, rowIndex, columnName, currentValue) {
                cell.classList.add('editing');
                cell.innerHTML = '';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentValue;
                input.style.textTransform = 'uppercase';
                input.classList.add('edit-input');
                
                // Force uppercase as user types
                input.addEventListener('input', function() {
                    this.value = this.value.toUpperCase();
                });
                
                cell.appendChild(input);
                input.focus();
                
                // Handle saving on blur or Enter key
                input.addEventListener('blur', function() {
                    saveEditedCell(cell, rowIndex, columnName, this.value.toUpperCase(), currentValue);
                });
                
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        saveEditedCell(cell, rowIndex, columnName, this.value.toUpperCase(), currentValue);
                    } else if (e.key === 'Escape') {
                        cell.innerHTML = currentValue;
                        cell.classList.remove('editing');
                    }
                });
            }

            // Make a cell editable with title case transformation
            function makeEditableTitleCase(cell, rowIndex, columnName, currentValue) {
                cell.classList.add('editing');
                cell.innerHTML = '';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentValue;
                input.classList.add('edit-input');
                
                // Force title case as user types
                input.addEventListener('input', function() {
                    this.value = toTitleCase(this.value);
                });
                
                cell.appendChild(input);
                input.focus();
                
                // Handle saving on blur or Enter key
                input.addEventListener('blur', function() {
                    saveEditedCell(cell, rowIndex, columnName, toTitleCase(this.value), currentValue);
                });
                
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        saveEditedCell(cell, rowIndex, columnName, toTitleCase(this.value), currentValue);
                    } else if (e.key === 'Escape') {
                        cell.innerHTML = currentValue;
                        cell.classList.remove('editing');
                    }
                });
            }

            // Handle row selection
            function handleRowSelection(event) {
                const rowIndex = event.target.dataset.rowIndex;
                const row = event.target.closest('tr');
                
                if (event.target.checked) {
                    selectedRows.add(rowIndex);
                    row.classList.add('selected');
                } else {
                    selectedRows.delete(rowIndex);
                    row.classList.remove('selected');
                }
                
                updateSelectionUI();
            }

            // Toggle select all
            function toggleSelectAll() {
                const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                const rowCheckboxes = document.querySelectorAll('.row-checkbox');
                
                rowCheckboxes.forEach(checkbox => {
                    const rowIndex = checkbox.dataset.rowIndex;
                    const row = checkbox.closest('tr');
                    
                    if (selectAllCheckbox.checked) {
                        checkbox.checked = true;
                        selectedRows.add(rowIndex);
                        row.classList.add('selected');
                    } else {
                        checkbox.checked = false;
                        selectedRows.delete(rowIndex);
                        row.classList.remove('selected');
                    }
                });
                
                updateSelectionUI();
            }

            // Update selection UI
            function updateSelectionUI() {
                const selectionInfo = document.getElementById('selectionInfo');
                const selectionCount = document.getElementById('selectionCount');
                const copyBtn = document.getElementById('copyBtn');
                const deleteBtn = document.getElementById('deleteBtn');
                
                const count = selectedRows.size;
                selectionCount.textContent = count;
                
                if (count > 0) {
                    selectionInfo.classList.add('show');
                    copyBtn.disabled = false;
                    deleteBtn.disabled = false;
                } else {
                    selectionInfo.classList.remove('show');
                    copyBtn.disabled = true;
                    deleteBtn.disabled = true;
                }
            }

            // Update select all checkbox state
            function updateSelectAllCheckbox() {
                const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                const rowCheckboxes = document.querySelectorAll('.row-checkbox');
                const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
                
                if (checkedCount === 0) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                } else if (checkedCount === rowCheckboxes.length) {
                    selectAllCheckbox.checked = true;
                    selectAllCheckbox.indeterminate = false;
                } else {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = true;
                }
            }

            // Copy selected rows
            function copySelectedRows() {
                if (selectedRows.size === 0) {
                    showError('No rows selected');
                    return;
                }

                const selectedData = [];
                selectedRows.forEach(rowIndex => {
                    const record = allData.find(r => r.rowIndex == rowIndex);
                    if (record) {
                        selectedData.push(`${record.Name || ''}\t${record.Mobile || ''}`);
                    }
                });

                const textToCopy = selectedData.join('\n');
                
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showSuccessIndicator(`Copied ${selectedRows.size} contacts to clipboard`);
                }).catch(err => {
                    showError('Failed to copy to clipboard');
                    console.error('Copy failed:', err);
                });
            }

            // Delete selected rows
            function deleteSelectedRows() {
                if (selectedRows.size === 0) {
                    showError('No rows selected');
                    return;
                }

                showConfirmDialog(
                    `Are you sure you want to delete ${selectedRows.size} selected rows? This action cannot be undone.`,
                    async () => {
                        showLoadingIndicator();
                        try {
                            const rowsToDelete = Array.from(selectedRows);
                            const response = await fetch(`${WEB_APP_URL}?action=deleteCallingRows&rows=${rowsToDelete.join(',')}`);
                            const result = await response.json();

                            if (result.success) {
                                showSuccessIndicator(`Deleted ${selectedRows.size} rows successfully`);
                                selectedRows.clear();
                                updateSelectionUI();
                                fetchCallingData(); // Refresh data
                            } else {
                                showError(result.error || 'Failed to delete rows');
                            }
                        } catch (error) {
                            console.error('Error deleting rows:', error);
                            showError('Network error during deletion');
                        } finally {
                            hideLoadingIndicator();
                        }
                    }
                );
            }

            // Make a cell editable
            function makeEditable(cell, rowIndex, columnName, currentValue) {
                cell.classList.add('editing');
                cell.innerHTML = '';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentValue;
                input.classList.add('edit-input');
                
                cell.appendChild(input);
                input.focus();
                
                // Handle saving on blur or Enter key
                input.addEventListener('blur', function() {
                    saveEditedCell(cell, rowIndex, columnName, this.value, currentValue);
                });
                
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        saveEditedCell(cell, rowIndex, columnName, this.value, currentValue);
                    } else if (e.key === 'Escape') {
                        cell.innerHTML = currentValue;
                        cell.classList.remove('editing');
                    }
                });
            }
            
            // Save edited cell value
            function saveEditedCell(cell, rowIndex, columnName, newValue, oldValue) {
                if (newValue !== oldValue) {
                    updateCell(rowIndex, columnName, newValue, oldValue);
                }
                
                cell.textContent = newValue;
                cell.classList.remove('editing');
            }

            function loadMoreData() {
                populateTable(false); // Do not clear existing data
            }

            function updateRecordsInfo() {
                const recordsInfo = document.getElementById('recordsInfo');
                if (isDuplicateMode) {
                    recordsInfo.textContent = `Showing ${Math.min(currentIndex, displayedData.length)} of ${displayedData.length} duplicate records`;
                } else {
                    recordsInfo.textContent = `Showing ${Math.min(currentIndex, displayedData.length)} of ${displayedData.length} records`;
                }

                const showMoreBtn = document.getElementById('showMoreBtn');
                
                if (currentIndex < displayedData.length) {
                    showMoreBtn.classList.remove('hidden');
                } else {
                    showMoreBtn.classList.add('hidden');
                }
            }

            // Clear filter inputs
            function clearFilters() {
                document.getElementById('resultFilter').value = "";
                document.getElementById('mobileFilter').value = "";
                document.getElementById('nameFilter').value = "";
                document.getElementById('companyFilter').value = "";
                document.getElementById('schemeFilter').value = "";
                document.getElementById('bankFilter').value = "";
                document.getElementById('salaryFilter').value = "";
                applyFilters();
            }

            // Attach event listeners for call and comment buttons
            function attachButtonListeners(container) {
                container.querySelectorAll('.direct-call').forEach(button => {
                    button.removeEventListener('click', handleCallClick);
                    button.addEventListener('click', handleCallClick);
                });
                container.querySelectorAll('.teams-call').forEach(button => {
                    button.removeEventListener('click', handleTeamsClick);
                    button.addEventListener('click', handleTeamsClick);
                });
                container.querySelectorAll('.whatsapp-call').forEach(button => {
                    button.removeEventListener('click', handleWhatsappClick);
                    button.addEventListener('click', handleWhatsappClick);
                });
                container.querySelectorAll('.comment-btn').forEach(button => {
                    button.removeEventListener('click', handleCommentClick);
                    button.addEventListener('click', handleCommentClick);
                });
            }

            function handleCallClick(event) {
                const mobile = this.getAttribute('href').replace('tel:+', '');
                if (mobile) {
                    incrementCallCounter();
                    window.location.href = `tel:+${mobile}`;
                } else {
                    showError('Mobile number not available.');
                }
            }
            
            function handleTeamsClick(event) {
                const mobile = this.getAttribute('href').replace('https://teams.microsoft.com/l/call/0/0?users=4:+971', '');
                if (mobile) {
                    incrementCallCounter();
                }
            }

            function handleWhatsappClick(event) {
                const mobile = this.getAttribute('href').replace('https://wa.me/', '').split('?')[0];
                if (mobile) {
                    incrementCallCounter();
                }
            }

            function handleCommentClick() {
                const rowIndex = this.dataset.rowIndex;
                const columnName = this.dataset.columnName;
                const customerName = this.closest('tr').querySelector('td:nth-child(5)').textContent; 
                showCommentModal(rowIndex, columnName, customerName);
            }

            // Track row changes for call counter
            function trackRowChange(rowIndex) {
                const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                
                // If this row hasn't been changed today
                if (!changedRows[rowIndex]) {
                    // Mark as changed
                    changedRows[rowIndex] = today;
                    // Increment call counter
                    incrementCallCounter();
                    // Save updated tracking data
                    saveCallData();
                }
            }

            // Update cell value in Google Sheet
            async function updateCell(rowIndex, columnName, newValue, oldValue) {
                showLoadingIndicator();
                hideError();
                try {
                    const response = await fetch(`${WEB_APP_URL}?action=updateCallingCell&row=${rowIndex}&column=${columnName}&value=${encodeURIComponent(newValue)}`);
                    const result = await response.json();

                    if (result.success) {
                        showSuccessIndicator('Cell updated successfully!');
                        // Store undo information
                        lastUndoAction = {
                            action: 'update',
                            rowIndex: rowIndex,
                            columnName: columnName,
                            oldValue: oldValue,
                            newValue: newValue
                        };
                        showUndoNotification();
                    } else {
                        showError(result.error || 'Failed to update cell.');
                        // Revert the UI change if update failed
                        revertCellUpdate(rowIndex, columnName, oldValue);
                    }
                } catch (error) {
                    console.error('Error updating cell:', error);
                    showError('Network error during cell update. Check console for details.');
                    revertCellUpdate(rowIndex, columnName, oldValue);
                } finally {
                    hideLoadingIndicator();
                }
            }

            function revertCellUpdate(rowIndex, columnName, oldValue) {
                const tableBody = document.getElementById('callingTableBody');
                const rows = tableBody.querySelectorAll('tr');
                
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    if (row.dataset.rowIndex == rowIndex) {
                        const cells = row.querySelectorAll('td');
                        const colIndexInHtmlTable = columnNames.indexOf(columnName);
                        if (colIndexInHtmlTable !== -1) {
                            const targetCell = cells[colIndexInHtmlTable];
                            if (columnName === 'Result') {
                                targetCell.querySelector('.result-dropdown').value = oldValue;
                            } else {
                                targetCell.textContent = oldValue;
                            }
                            break;
                        }
                    }
                }
            }

            async function undoLastChange() {
                if (!lastUndoAction) {
                    showError('No action to undo.');
                    return;
                }

                showLoadingIndicator();
                hideUndoNotification();
                try {
                    const { action, rowIndex, columnName, oldValue } = lastUndoAction;
                    let response;
                    let result;

                    if (action === 'update') {
                        response = await fetch(`${WEB_APP_URL}?action=updateCallingCell&row=${rowIndex}&column=${columnName}&value=${encodeURIComponent(oldValue)}`);
                        result = await response.json();

                        if (result.success) {
                            showSuccessIndicator('Last change undone!');
                            fetchCallingData();
                            
                            if (columnName === 'Result' && changedRows[rowIndex]) {
                                delete changedRows[rowIndex];
                                decrementCallCounter();
                                saveCallData();
                            }
                            
                            lastUndoAction = null;
                        } else {
                            showError(result.error || 'Failed to undo change.');
                        }
                    }
                } catch (error) {
                    console.error('Error undoing change:', error);
                    showError('Network error during undo. Check console for details.');
                } finally {
                    hideLoadingIndicator();
                }
            }

            // Function to handle saving the comment
            async function saveComment() {
                const rowIndex = document.getElementById('commentRowIndex').value;
                const column = document.getElementById('commentColumn').value;
                const commentText = document.getElementById('commentText').value;
                const commentType = document.querySelector('input[name="commentType"]:checked').value;

                if (!commentText.trim()) {
                    showError('Comment cannot be empty.');
                    return;
                }

                showLoadingIndicator();
                try {
                    let apiUrl = `${WEB_APP_URL}`;
                    let successMessage = '';

                    if (commentType === 'sheet') {
                        apiUrl += `?action=addCallingCellComment&row=${rowIndex}&column=${column}&comment=${encodeURIComponent(commentText)}`;
                        successMessage = 'Comment added to cell!';
                    } else if (commentType === 'value') {
                        apiUrl += `?action=updateCallingCell&row=${rowIndex}&column=${column}&value=${encodeURIComponent(commentText)}`;
                        successMessage = 'Cell value updated!';
                        trackRowChange(rowIndex);
                    }
                    
                    const response = await fetch(apiUrl);
                    const result = await response.json();

                    if (result.success) {
                        showSuccessIndicator(successMessage);
                        hideCommentModal();
                        if (commentType === 'value') {
                            fetchCallingData();
                        }
                    } else {
                        showError(result.error || 'Unknown error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showError('Failed to add comment: ' + error.message);
                } finally {
                    hideLoadingIndicator();
                }
            }
            
            // Call counter functions
            function incrementCallCounter() {
                callCount++;
                document.getElementById('callCounter').textContent = callCount;
                saveCallData();
            }
            
            function decrementCallCounter() {
                if (callCount > 0) {
                    callCount--;
                    document.getElementById('callCounter').textContent = callCount;
                    saveCallData();
                }
            }
            
            function saveCallData() {
                const today = new Date().toISOString().split('T')[0];
                localStorage.setItem('callCount', callCount.toString());
                localStorage.setItem('callCountDate', today);
                localStorage.setItem('changedRows', JSON.stringify(changedRows));
            }
            
            function loadCallData() {
                const storedCount = localStorage.getItem('callCount');
                if (storedCount !== null) {
                    callCount = parseInt(storedCount, 10);
                    document.getElementById('callCounter').textContent = callCount;
                }
                
                const storedChangedRows = localStorage.getItem('changedRows');
                if (storedChangedRows) {
                    changedRows = JSON.parse(storedChangedRows);
                }
            }
            
            function checkAndResetDailyCounter() {
                const today = new Date().toISOString().split('T')[0];
                const lastDate = localStorage.getItem('callCountDate');
                
                if (lastDate !== today) {
                    callCount = 0;
                    changedRows = {};
                    document.getElementById('callCounter').textContent = '0';
                    saveCallData();
                }
            }

            // Modal functions
            function showCommentModal(rowIndex, columnName, customerName) {
                document.getElementById('commentModal').style.display = 'flex';
                document.getElementById('commentRowIndex').value = rowIndex;
                document.getElementById('commentColumn').value = columnName;
                document.getElementById('commentName').textContent = customerName;
                document.getElementById('commentText').value = '';
                document.querySelector('input[name="commentType"][value="sheet"]').checked = true;
            }

            function hideCommentModal() {
                document.getElementById('commentModal').style.display = 'none';
            }

            // Confirm dialog functions
            function showConfirmDialog(message, onConfirm) {
                document.getElementById('confirmMessage').textContent = message;
                document.getElementById('confirmDialog').style.display = 'flex';
                
                // Store the confirm action
                document.getElementById('confirmOk').onclick = () => {
                    hideConfirmDialog();
                    onConfirm();
                };
            }

            function hideConfirmDialog() {
                document.getElementById('confirmDialog').style.display = 'none';
            }

            function executeConfirmedAction() {
                // This will be overridden by showConfirmDialog
            }

            // Utility functions
            function showLoadingIndicator() {
                document.getElementById('loadingIndicator').classList.remove('hidden');
            }

            function hideLoadingIndicator() {
                document.getElementById('loadingIndicator').classList.add('hidden');
            }

            function showSuccessIndicator(message) {
                const indicator = document.getElementById('successIndicator');
                document.getElementById('successMessage').textContent = message;
                indicator.classList.remove('hidden');
                indicator.style.opacity = '1';
                indicator.style.animation = 'none';
                void indicator.offsetWidth;
                indicator.style.animation = 'fadeOut 2s forwards';
            }

            function showError(message) {
                const errorContainer = document.getElementById('errorContainer');
                document.getElementById('errorMessage').textContent = message;
                errorContainer.classList.remove('hidden');
            }

            function hideError() {
                document.getElementById('errorContainer').classList.add('hidden');
            }

            function showUndoNotification() {
                const undoNotification = document.getElementById('undoNotification');
                undoNotification.classList.remove('hidden');
            }

            function hideUndoNotification() {
                document.getElementById('undoNotification').classList.add('hidden');
            }

            function copyToClipboard(text, element) {
                navigator.clipboard.writeText(text).then(() => {
                    element.classList.add('copied');
                    setTimeout(() => {
                        element.classList.remove('copied');
                    }, 1500);
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                });
            }

            // Close modal if clicked outside (disabled for Add New Modal)
            window.addEventListener('click', function(event) {
                const commentModal = document.getElementById('commentModal');
                const confirmDialog = document.getElementById('confirmDialog');
                
                if (event.target === commentModal) {
                    hideCommentModal();
                }
                if (event.target === confirmDialog) {
                    hideConfirmDialog();
                }
                // Note: Add New Modal doesn't close on outside click as requested
            });
        });
    </script>
</body>
</html>
